<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lucid — Aide à la décision</title>
  <!-- Inter variable (axe wght + opsz) — police principale 2026 -->
  <!-- Plus Jakarta Sans conservé pour compatibilité des classes existantes -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Lora:wght@600;700&display=swap"
    rel="stylesheet">
  <style>
    /* ── TOKENS ─────────────────────────────── */
    :root {
      /* ── Police principale 2026 : Inter variable ── */
      --font-sans: 'Inter', 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif;

      /* ── Palette oklch 2026 (vivacité perceptuelle uniforme) ── */
      /* --primary est le bleu-sarcelle principal, --accent est l'ambre "dopamine" */
      --primary:     oklch(65% 0.15 240);   /* Bleu-sarcelle moderne */
      --accent:      oklch(70% 0.2  80);    /* Ambre vif énergisant   */
      --score-low:   oklch(55% 0.18 25);    /* Rouge score faible      */
      --score-mid:   oklch(70% 0.18 80);    /* Ambre score moyen       */
      --score-high:  oklch(65% 0.17 145);   /* Vert score élevé        */

      /* ── Backgrounds & surfaces ── */
      --bg: #f7f8f8;
      --bg2: #eef0f2;
      --white: #ffffff;
      --glass-bg: rgba(255, 255, 255, 0.65);

      /* ── Borders & ombres ── */
      --border: rgba(0, 0, 0, 0.08);
      --border2: rgba(0, 0, 0, 0.15);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.12);

      /* ── Textes ── */
      --ink: #0f172a;
      --ink2: #334155;
      --muted: #64748b;
      --muted2: #94a3b8;

      /* ── Couleurs sémantiques (conservées pour compat) ── */
      --teal: #059669;
      --teal2: #10b981;
      --teal-bg: #ecfdf5;
      --teal-bd: #a7f3d0;
      --green: #16a34a;
      --green-bg: #dcfce7;
      --red: #dc2626;
      --red-bg: #fee2e2;
      --amber: #d97706;
      --amber-bg: #fef3c7;

      /* ── Rayons ── */
      --r: 20px;
      --r-sm: 12px;

      /* ── Composants spéciaux ── */
      --sel-box-bg: rgba(255, 255, 255, 0.4);
      --sel-box-border: rgba(255, 255, 255, 0.6);
      --sel-head-border: rgba(255, 255, 255, 0.4);
      --sel-head-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.5));
      --sel-item-bg: radial-gradient(circle at top left, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.2));
      --sel-item-border: rgba(255, 255, 255, 0.5);
      /* Verdict card (results) */
      --verdict-bg: #fffbea;
      --verdict-border: #f0d080;
      /* Scenario impact cards */
      --scenario-card-bg: radial-gradient(circle at top left, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.3));
      --scenario-card-border: rgba(255, 255, 255, 0.9);
      --scenario-dot-shadow: 0 0 0 3px rgba(255, 255, 255, 0.7);

      /* ── Hint pour les contrôles navigateur (scrollbars, inputs) ── */
      color-scheme: light;
    }

    /* ─── Variables dark auto (système) ───────── */
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        color-scheme: dark;
        --bg: #0f172a;
        --bg2: #1e293b;
        --glass-bg: rgba(30, 41, 59, 0.7);
        --border: rgba(255, 255, 255, 0.1);
        --border2: rgba(255, 255, 255, 0.2);
        --ink: #f8fafc;
        --ink2: #cbd5e1;
        --muted: #94a3b8;
        --muted2: #cbd5e1;
        --white: #1e293b;
        --teal-bg: rgba(5, 150, 105, 0.15);
        --teal-bd: rgba(5, 150, 105, 0.3);
        --green-bg: rgba(22, 163, 74, 0.15);
        --red-bg: rgba(220, 38, 38, 0.15);
        --amber-bg: rgba(217, 119, 6, 0.15);
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.4);
        --sel-box-bg: rgba(30, 41, 59, 0.4);
        --sel-box-border: rgba(255, 255, 255, 0.1);
        --sel-head-border: rgba(255, 255, 255, 0.1);
        --sel-head-bg: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(30, 41, 59, 0.5));
        --sel-item-bg: radial-gradient(circle at top left, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
        --sel-item-border: rgba(255, 255, 255, 0.12);
        --verdict-bg: rgba(250, 240, 190, 0.06);
        --verdict-border: rgba(240, 208, 128, 0.12);
        --scenario-card-bg: radial-gradient(circle at top left, rgba(30, 41, 59, 0.9), rgba(30, 41, 59, 0.5));
        --scenario-card-border: rgba(71, 84, 103, 0.6);
        --scenario-dot-shadow: 0 0 0 3px rgba(71, 84, 103, 0.8);
      }
    }

    /* ─── Variables dark forcé (toggle manuel) ── */
    /* Spécificité (0,1,1) > (0,1,0) de :root → override media query */
    html[data-theme="dark"] {
      color-scheme: dark;
      --bg: #0f172a;
      --bg2: #1e293b;
      --glass-bg: rgba(30, 41, 59, 0.7);
      --border: rgba(255, 255, 255, 0.1);
      --border2: rgba(255, 255, 255, 0.2);
      --ink: #f8fafc;
      --ink2: #cbd5e1;
      --muted: #94a3b8;
      --muted2: #cbd5e1;
      --white: #1e293b;
      --teal-bg: rgba(5, 150, 105, 0.15);
      --teal-bd: rgba(5, 150, 105, 0.3);
      --green-bg: rgba(22, 163, 74, 0.15);
      --red-bg: rgba(220, 38, 38, 0.15);
      --amber-bg: rgba(217, 119, 6, 0.15);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.4);
      --sel-box-bg: rgba(30, 41, 59, 0.4);
      --sel-box-border: rgba(255, 255, 255, 0.1);
      --sel-head-border: rgba(255, 255, 255, 0.1);
      --sel-head-bg: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(30, 41, 59, 0.5));
      --sel-item-bg: radial-gradient(circle at top left, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
      --sel-item-border: rgba(255, 255, 255, 0.12);
      --verdict-bg: rgba(250, 240, 190, 0.06);
      --verdict-border: rgba(240, 208, 128, 0.12);
      --scenario-card-bg: radial-gradient(circle at top left, rgba(30, 41, 59, 0.9), rgba(30, 41, 59, 0.5));
      --scenario-card-border: rgba(71, 84, 103, 0.6);
      --scenario-dot-shadow: 0 0 0 3px rgba(71, 84, 103, 0.8);
    }

    /* ─── Variables light forcé (override dark système) ─ */
    html[data-theme="light"] {
      color-scheme: light;
      --bg: #f7f8f8;
      --bg2: #eef0f2;
      --glass-bg: rgba(255, 255, 255, 0.65);
      --border: rgba(0, 0, 0, 0.08);
      --border2: rgba(0, 0, 0, 0.15);
      --ink: #0f172a;
      --ink2: #334155;
      --muted: #64748b;
      --muted2: #94a3b8;
      --white: #ffffff;
      --teal-bg: #ecfdf5;
      --teal-bd: #a7f3d0;
      --green-bg: #dcfce7;
      --red-bg: #fee2e2;
      --amber-bg: #fef3c7;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.12);
      --sel-box-bg: rgba(255, 255, 255, 0.4);
      --sel-box-border: rgba(255, 255, 255, 0.6);
      --sel-head-border: rgba(255, 255, 255, 0.4);
      --sel-head-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.5));
      --sel-item-bg: radial-gradient(circle at top left, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.2));
      --sel-item-border: rgba(255, 255, 255, 0.5);
      --verdict-bg: #fffbea;
      --verdict-border: #f0d080;
      --scenario-card-bg: radial-gradient(circle at top left, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.3));
      --scenario-card-border: rgba(255, 255, 255, 0.9);
      --scenario-dot-shadow: 0 0 0 3px rgba(255, 255, 255, 0.7);
    }

    /* ── RESET ───────────────────────────────── */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      height: 100dvh;
      overflow: hidden;
    }

    body {
      background: var(--bg);
      background-image: radial-gradient(circle at top left, var(--bg2), transparent 50%), radial-gradient(circle at bottom right, var(--teal-bg), transparent 50%);
      color: var(--ink);
      /* Inter variable = meilleure lisibilité + optimisation optique (opsz) */
      font-family: var(--font-sans);
      font-size: 15px;
      line-height: 1.6;
      /* Lissage sub-pixel pour Inter */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ── PAGES ───────────────────────────────── */
    .page {
      display: none;
      height: 100vh;
      height: 100dvh;
      flex-direction: column;
      overflow: hidden;
    }

    .page.active {
      display: flex;
    }

    /* Contenu scrollable sous le header */
    .page-scroll {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    /* ── HEADER ──────────────────────────────── */
    .app-header {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 14px 28px;
      display: flex;
      align-items: center;
      flex-shrink: 0;
      z-index: 50;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .app-header .step-progress {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .app-header .lang-switcher {
      margin-left: auto;
      position: static;
    }

    .logo {
      font-family: 'Lora', serif;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--ink);
      letter-spacing: -.02em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .logo-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--teal);
      display: inline-block;
    }

    /* Step progress in header */
    .step-progress {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0;
    }

    .sp-step {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 6px 14px;
      border-radius: 30px;
      font-size: .75rem;
      font-weight: 600;
      color: var(--muted);
      transition: all .2s;
    }

    .sp-step.active {
      background: var(--teal-bg);
      color: var(--teal);
    }

    .sp-step.done {
      color: var(--muted2);
    }

    .sp-num {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .72rem;
      font-weight: 700;
      background: var(--bg2);
      color: var(--muted);
      flex-shrink: 0;
      transition: all .2s;
    }

    .sp-step.active .sp-num {
      background: var(--teal);
      color: #fff;
    }

    .sp-step.done .sp-num {
      background: var(--green);
      color: #fff;
    }

    .sp-arrow {
      color: var(--muted2);
      font-size: .75rem;
      padding: 0 2px;
    }

    /* ── MAIN ────────────────────────────────── */
    .main {
      padding: 36px 28px 72px;
      max-width: 960px;
      margin: 0 auto;
      width: 100%;
      min-height: 100%;
    }

    /* ── ANIMATIONS ──────────────────────────── */
    @keyframes up {
      from {
        opacity: 0;
        transform: translateY(14px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    .anim {
      animation: up .4s ease both;
    }

    .d1 {
      animation-delay: .05s
    }

    .d2 {
      animation-delay: .1s
    }

    .d3 {
      animation-delay: .16s
    }

    .d4 {
      animation-delay: .22s
    }

    /* ── TYPOGRAPHY ──────────────────────────── */
    .page-eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: .72rem;
      font-weight: 700;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--teal);
      background: var(--teal-bg);
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid var(--teal-bd);
      margin-bottom: 14px;
    }

    .page-title {
      font-family: 'Lora', serif;
      font-size: clamp(1.7rem, 3.5vw, 2.4rem);
      font-weight: 700;
      line-height: 1.2;
      color: var(--ink);
      margin-bottom: 8px;
    }

    .page-sub {
      font-size: .93rem;
      color: var(--muted);
      line-height: 1.65;
      max-width: 520px;
      margin-bottom: 32px;
    }

    /* ── CARDS ───────────────────────────────── */
    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.2s ease;
    }

    .card:hover {
      transform: scale(1.01) translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* ── FORM ────────────────────────────────── */
    .field {
      margin-bottom: 18px;
    }

    .field>label {
      display: block;
      font-size: .78rem;
      font-weight: 700;
      color: var(--ink2);
      margin-bottom: 6px;
      letter-spacing: .02em;
    }

    input[type=text],
    textarea,
    select {
      width: 100%;
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: var(--r-sm);
      color: var(--ink);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: .95rem;
      padding: 12px 14px;
      outline: none;
      resize: none;
      appearance: none;
      transition: border-color .18s, box-shadow .18s;
    }

    input[type=text]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--teal2);
      box-shadow: 0 0 0 3px rgba(45, 125, 90, .12);
    }

    input[type=text]::placeholder,
    textarea::placeholder {
      color: var(--muted2);
    }

    /* Dark mode should use a slightly darker placeholder so examples aren’t too bright */
    @media (prefers-color-scheme: dark) {

      input[type=text]::placeholder,
      textarea::placeholder {
        color: var(--muted);
        /* darker than --muted2 in dark themes */
      }
    }

    /* ── BUTTONS ─────────────────────────────── */
    .btn {
      font-family: 'Inter', 'Manrope', system-ui, sans-serif;
      font-size: .9rem;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 999px;
      /* Pill shape */
      border: none;
      cursor: pointer;
      transition: all .2s cubic-bezier(0.16, 1, 0.3, 1);
      display: inline-flex;
      align-items: center;
      gap: 7px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--teal), var(--teal2));
      color: #fff;
      box-shadow: 0 4px 14px rgba(5, 150, 105, 0.25);
    }

    .btn-primary:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 24px rgba(5, 150, 105, 0.35);
    }

    .btn-secondary {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      color: var(--ink);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--border2);
      background: var(--bg2);
      transform: translateY(-1px);
    }

    .btn-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 32px;
      gap: 12px;
    }

    /* ── MASCOT ──────────────────────────────── */
    .mascot-wrap {
      margin-bottom: 4px;
      animation: up .5s ease both;
      flex-shrink: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mascot {
      width: 160px;
      aspect-ratio: 10/9;
      max-height: 20dvh;
    }

    /* ── INTRO PAGE ──────────────────────────── */
    #page-intro {
      background: var(--bg);
      height: 100vh;
      height: 100dvh;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .intro-wrap {
      width: 100%;
      min-height: 100%;
      display: flex;
      align-items: safe center;
      justify-content: center;
      padding: max(24px, env(safe-area-inset-top)) 20px max(32px, env(safe-area-inset-bottom));
      box-sizing: border-box;
    }

    .intro-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      width: 100%;
      max-width: 600px;
      flex-shrink: 1;
    }

    @media(max-height:700px) {
      .mascot {
        width: 100px !important;
      }

      .mascot-wrap {
        margin-bottom: 4px;
      }

      .intro-wrap {
        align-items: flex-start;
      }
    }

    @media(max-height:560px) {
      .mascot-wrap {
        display: none;
      }
    }

    .intro-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--teal-bg);
      color: var(--teal);
      border: 1px solid var(--teal-bd);
      font-size: .72rem;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      padding: 4px 12px;
      border-radius: 20px;
      margin-bottom: 14px;
      animation: up .5s ease both;
      flex-shrink: 0;
    }

    .intro-logo {
      font-family: 'Lora', serif;
      font-size: clamp(2.8rem, 9vw, 6.5rem);
      font-weight: 700;
      color: var(--ink);
      line-height: 1;
      margin-bottom: 10px;
      flex-shrink: 0;
      animation: up .5s .08s ease both;
    }

    .intro-logo span {
      color: var(--teal);
    }

    .intro-tagline {
      font-size: clamp(.88rem, 2vw, 1.1rem);
      color: var(--muted);
      font-weight: 400;
      max-width: 420px;
      margin: 0 auto 20px;
      animation: up .5s .16s ease both;
      flex-shrink: 0;
    }

    .intro-how {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      width: 100%;
      margin: 0 auto 24px;
      animation: up .5s .24s ease both;
      flex-shrink: 0;
    }

    .how-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 14px 10px;
      text-align: center;
    }

    .how-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--teal);
      color: #fff;
      font-size: .75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
    }

    .how-title {
      font-size: .8rem;
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 3px;
    }

    .how-desc {
      font-size: .7rem;
      color: var(--muted);
      line-height: 1.4;
    }

    .intro-start-btn {
      animation: up .5s .32s ease both;
      font-size: 1rem;
      padding: 14px 40px;
      border-radius: 12px;
      background: var(--teal);
      color: #fff;
      border: none;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(45, 125, 90, .3);
      width: 100%;
      max-width: 320px;
    }

    .intro-start-btn:hover {
      background: var(--teal2);
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(45, 125, 90, .35);
    }

    /* On very small screens, hide how-cards description text */
    @media(max-height:640px) {
      .how-desc {
        display: none;
      }

      .how-card {
        padding: 10px 8px;
      }

      .intro-how {
        margin-bottom: 12px;
      }

      .intro-tagline {
        margin-bottom: 10px;
      }
    }

    /* ── AI INTERPRETATION ───────────────────── */
    .interp-box {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1.5px solid var(--teal-bd);
      border-radius: var(--r);
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .interp-head {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 18px;
      background: var(--teal-bg);
      border-bottom: 1px solid var(--teal-bd);
    }

    .interp-head-title {
      font-size: .88rem;
      font-weight: 700;
      color: var(--teal);
    }

    .interp-badge {
      font-size: .62rem;
      font-weight: 700;
      letter-spacing: .08em;
      background: var(--teal);
      color: #fff;
      padding: 2px 8px;
      border-radius: 5px;
      text-transform: uppercase;
    }

    .interp-body {
      padding: 20px 22px;
    }

    .interp-text {
      font-size: .95rem;
      color: var(--ink2);
      line-height: 1.75;
      font-weight: 400;
    }

    .interp-text strong {
      color: var(--ink);
      font-weight: 700;
    }

    /* Loading skeleton */
    .interp-loading {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px 22px;
    }

    .skel {
      height: 14px;
      border-radius: 6px;
      background: linear-gradient(90deg, var(--bg) 25%, var(--bg2) 50%, var(--bg) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
    }

    .skel.w100 {
      width: 100%;
    }

    .skel.w80 {
      width: 80%;
    }

    .skel.w60 {
      width: 60%;
    }

    @keyframes shimmer {
      from {
        background-position: 200% 0
      }

      to {
        background-position: -200% 0
      }
    }

    /* ── STEP 1 — OPTIONS ────────────────────── */
    .decision-card {
      padding: 24px;
      margin-bottom: 20px;
      position: relative;
      overflow: visible;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 14px;
    }

    .opt-card {
      border-radius: var(--r);
      overflow: hidden;
      border: 1px solid var(--border);
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .opt-card:hover {
      transform: scale(1.01) translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .opt-card-head {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 16px;
      cursor: pointer;
      user-select: none;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      transition: background .15s;
    }

    .opt-card-head:hover {
      background: var(--bg2);
    }

    .opt-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .opt-letter {
      font-size: .72rem;
      font-weight: 800;
      letter-spacing: .1em;
      text-transform: uppercase;
    }

    .opt-name-preview {
      margin-left: auto;
      font-size: .82rem;
      color: var(--muted);
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .opt-chevron {
      color: var(--muted2);
      font-size: .75rem;
      transition: transform .2s;
      margin-left: 6px;
    }

    .opt-card.open .opt-chevron {
      transform: rotate(180deg);
    }

    .opt-card-body {
      padding: 16px;
      display: none;
    }

    .opt-card.open .opt-card-body {
      display: block;
    }

    .opt-rm {
      width: 26px;
      height: 26px;
      border-radius: 7px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      font-size: .8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .15s;
      font-family: 'Plus Jakarta Sans', sans-serif;
      flex-shrink: 0;
    }

    .opt-rm:hover {
      background: var(--red-bg);
      border-color: var(--red);
      color: var(--red);
    }

    .add-option-btn {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px dashed var(--border2);
      border-radius: var(--r);
      padding: 14px 18px;
      cursor: pointer;
      font-family: 'Inter', 'Manrope', system-ui, sans-serif;
      font-size: .85rem;
      font-weight: 600;
      color: var(--muted);
      transition: all .2s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .add-option-btn:hover {
      border-color: var(--teal2);
      color: var(--teal);
      background: var(--teal-bg);
      transform: translateY(-1px);
    }

    .add-option-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all .18s;
    }

    .add-option-btn:hover .add-option-icon {
      background: var(--teal);
      color: #fff;
      border-color: var(--teal);
    }

    /* ── STEP 2 — CRITERIA ───────────────────── */
    .criteria-intro {
      background: var(--teal-bg);
      border: 1px solid var(--teal-bd);
      border-radius: var(--r);
      padding: 14px 18px;
      margin-bottom: 22px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: .85rem;
      color: var(--teal);
      line-height: 1.5;
    }

    .criteria-intro-icon {
      font-size: 1.1rem;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .cat-tabs {
      display: flex;
      gap: 7px;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }

    .cat-tab {
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: 30px;
      color: var(--muted);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: .78rem;
      font-weight: 600;
      padding: 6px 14px;
      cursor: pointer;
      transition: all .15s;
    }

    .cat-tab:hover {
      border-color: var(--border2);
      color: var(--ink2);
    }

    .cat-tab.active {
      border-color: var(--teal);
      color: var(--teal);
      background: var(--teal-bg);
    }

    .crit-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
      margin-bottom: 22px;
    }

    .crit-pill {
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: var(--r-sm);
      padding: 11px 13px;
      cursor: pointer;
      transition: all .15s;
      display: flex;
      align-items: flex-start;
      gap: 9px;
      user-select: none;
    }

    .crit-pill:hover {
      border-color: var(--border2);
      box-shadow: var(--shadow);
      transform: translateY(-1px);
    }

    .crit-pill.on {
      border-color: var(--teal);
      background: var(--teal-bg);
      box-shadow: 0 1px 4px rgba(5, 150, 105, 0.2);
    }

    .crit-check {
      width: 18px;
      height: 18px;
      border-radius: 5px;
      background: var(--bg);
      border: 1.5px solid var(--border2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .65rem;
      flex-shrink: 0;
      margin-top: 1px;
      transition: all .15s;
    }

    .crit-pill.on .crit-check {
      background: var(--teal);
      border-color: var(--teal);
      color: #fff;
    }

    .crit-icon {
      font-size: .95rem;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .crit-name {
      font-size: .82rem;
      font-weight: 600;
      color: var(--ink);
    }

    .crit-hint {
      font-size: .7rem;
      color: var(--muted);
      margin-top: 2px;
      line-height: 1.4;
    }

    .custom-form {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px dashed var(--border2);
      border-radius: var(--r);
      margin-bottom: 32px;
      overflow: hidden;
      transition: all .2s;
    }

    /* ─── HISTORY & INSIGHTS ────────────────── */
    .hist-btn-home {
      position: absolute;
      top: 20px;
      left: 20px;
      background: var(--white);
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: .8rem;
      font-weight: 600;
      color: var(--ink2);
      cursor: pointer;
      transition: all .15s;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 60;
    }

    .hist-btn-home:hover {
      border-color: var(--teal);
      color: var(--teal);
    }

    .hist-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .hist-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-left: 3px solid var(--border);
      border-radius: var(--r);
      padding: 18px 20px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, .05);
      transition: box-shadow .2s, transform .2s, border-left-color .2s;
      position: relative;
    }

    .hist-card-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: .85rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .15s, color .15s;
      line-height: 1;
    }

    .hist-card-close:hover {
      background: rgba(220, 38, 38, .1);
      color: var(--red);
    }

    .hist-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, .09);
      border-left-color: var(--teal);
    }

    .hist-card.hc-done {
      border-left-color: var(--teal);
    }

    .hist-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .hist-date {
      font-size: .68rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 4px;
    }

    .hist-title {
      font-family: 'Lora', serif;
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--ink);
      margin-bottom: 6px;
      line-height: 1.35;
    }

    .hist-meta {
      font-size: .8rem;
      color: var(--ink2);
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .hist-badge {
      font-size: .65rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .hb-pending {
      background: var(--bg2);
      color: var(--muted);
    }

    .hb-done {
      background: var(--teal-bg);
      color: var(--teal);
    }

    .hist-actions {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .hist-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 13px;
      border-radius: 20px;
      font-size: .73rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s, color .15s, border-color .15s;
      border: 1.5px solid transparent;
      line-height: 1;
    }

    .hist-action-btn.resume {
      color: var(--teal);
      border-color: var(--teal-bd);
      background: var(--teal-bg);
    }

    .hist-action-btn.resume:hover {
      background: var(--teal);
      color: #fff;
      border-color: var(--teal);
    }

    .hist-action-btn.delete {
      color: var(--red);
      border-color: rgba(220, 38, 38, .2);
      background: rgba(220, 38, 38, .05);
      margin-left: auto;
    }

    .hist-action-btn.delete:hover {
      background: var(--red);
      color: #fff;
      border-color: var(--red);
    }

    @media (max-width: 480px) {
      .hist-card {
        padding: 14px 16px;
      }

      .hist-action-btn.delete {
        margin-left: 0;
      }
    }

    .insight-box {
      background: linear-gradient(135deg, var(--teal-bg) 0%, #fff 100%);
      border: 1px solid var(--teal-bd);
      border-radius: var(--r);
      padding: 18px;
      margin-bottom: 24px;
    }

    .insight-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      align-items: flex-start;
    }

    .insight-icon {
      font-size: 1.2rem;
      background: #fff;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, .05);
      flex-shrink: 0;
    }

    .insight-txt {
      font-size: .9rem;
      color: var(--ink2);
      line-height: 1.5;
    }

    .insight-txt strong {
      color: var(--teal);
    }

    @media (prefers-color-scheme: dark) {
      .insight-box {
        background: linear-gradient(135deg, var(--teal-bg) 0%, var(--bg2) 100%);
      }

      .insight-txt {
        color: var(--ink);
      }
    }

    .update-form {
      background: var(--bg2);
      padding: 18px;
      border-radius: 12px;
      margin-top: 14px;
      border: 1px solid var(--border);
    }

    .upd-form-title {
      font-weight: 700;
      font-size: .9rem;
      color: var(--ink);
      margin-bottom: 3px;
    }

    .upd-form-desc {
      font-size: .78rem;
      color: var(--muted);
      margin-bottom: 16px;
    }

    .upd-score-widget {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px 16px 16px;
      margin-bottom: 14px;
    }

    .upd-score-emoji {
      font-size: 2.8rem;
      line-height: 1;
      user-select: none;
      transition: transform .1s;
    }

    .upd-score-emoji.bump {
      transform: scale(1.3);
    }

    .upd-score-row {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .upd-score-display {
      display: flex;
      align-items: baseline;
      gap: 2px;
    }

    .upd-score-val {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--ink);
      min-width: 38px;
      text-align: center;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }

    .upd-score-denom {
      font-size: .85rem;
      color: var(--muted);
    }

    .upd-gauge {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .upd-gauge-bar {
      height: 100%;
      border-radius: 10px;
      transition: width .35s cubic-bezier(.4, 0, .2, 1), background-color .35s;
    }

    .delta-tag {
      font-weight: 700;
      font-size: .75rem;
    }

    .delta-up {
      color: var(--teal);
    }

    .delta-down {
      color: var(--red);
    }

    .hist-score-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .hist-score-block {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .hist-score-label {
      font-size: .6rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .07em;
      color: var(--muted);
      padding-left: 2px;
    }

    .hist-score-arrow {
      color: var(--muted);
      font-size: .85rem;
      margin-bottom: 5px;
    }

    .hist-score-pill {
      display: inline-flex;
      align-items: baseline;
      gap: 1px;
      padding: 3px 10px;
      border-radius: 20px;
      font-weight: 700;
      line-height: 1.3;
    }

    .hist-score-pill .pill-denom {
      font-size: .65rem;
      font-weight: 400;
      opacity: .7;
    }

    .hist-score-pill.initial {
      background: var(--bg2);
      border: 1.5px solid var(--border);
      color: var(--ink);
      font-size: 1.15rem;
      padding: 4px 13px;
    }

    .hist-winner-name {
      font-size: .8rem;
      color: var(--ink2);
      margin-bottom: 7px;
      font-weight: 500;
    }

    .hist-score-pill.actual-up {
      background: var(--teal-bg);
      color: var(--teal);
      font-size: .9rem;
    }

    .hist-score-pill.actual-down {
      background: rgba(220, 38, 38, .09);
      color: var(--red);
      font-size: .9rem;
    }

    .hist-delta-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: .7rem;
      font-weight: 800;
      letter-spacing: .02em;
    }

    .hist-delta-badge.up {
      background: rgba(20, 184, 166, .14);
      color: var(--teal);
    }

    .hist-delta-badge.down {
      background: rgba(220, 38, 38, .1);
      color: var(--red);
    }

    @media (prefers-color-scheme: dark) {
      .hist-delta-badge.up {
        background: rgba(20, 184, 166, .22);
      }

      .hist-delta-badge.down {
        background: rgba(220, 38, 38, .18);
      }
    }

    .custom-form-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      cursor: pointer;
      user-select: none;
      transition: background .15s;
    }

    .custom-form-head:hover {
      background: var(--bg2);
    }

    .custom-form-title {
      font-size: .85rem;
      font-weight: 600;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .custom-form.open .custom-form-title {
      color: var(--ink2);
    }

    .custom-form-body {
      display: none;
      padding: 18px;
      background: var(--bg);
      border-top: 1px solid var(--border2);
    }

    .custom-form.open .custom-form-body {
      display: block;
    }

    .custom-form.open .opt-chevron {
      transform: rotate(180deg);
    }

    .custom-row {
      display: grid;
      grid-template-columns: 1fr 70px 1fr;
      gap: 10px;
      align-items: end;
    }

    /* Selected criteria box */
    .selected-box {
      background: var(--sel-box-bg);
      border: 1px solid var(--sel-box-border);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
    }

    .selected-box-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--sel-head-border);
      background: var(--sel-head-bg);
    }

    .selected-box-head h3 {
      font-size: .85rem;
      font-weight: 700;
      color: var(--ink2);
    }

    .sel-count {
      background: var(--teal);
      color: #fff;
      font-size: .7rem;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 999px;
    }

    .sel-list {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sel-item {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid var(--sel-item-border);
      background: var(--sel-item-bg);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
    }

    .sel-item:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.22);
      border-color: rgba(255, 255, 255, 0.36);
    }

    /* accent bar depending on importance (simple mode) */
    .sel-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      border-top-left-radius: var(--r);
      border-bottom-left-radius: var(--r);
      background: var(--teal);
      transition: background .3s;
    }

    .sel-item.weight-1::before {
      background: var(--teal);
    }

    .sel-item.weight-2::before {
      background: var(--amber);
    }

    .sel-item.weight-3::before {
      background: var(--red);
    }

    .sel-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }

    .sel-item-controls {
      display: flex;
      align-items: center;
      margin-top: 10px;
      gap: 12px;
    }

    .weight-group {
      display: flex;
      gap: 6px;
    }

    .weight-btn {
      font-size: .78rem;
      padding: 6px 12px;
      border-radius: var(--r-sm);
      border: 1px solid var(--border);
      background: var(--sel-item-bg);
      color: var(--ink2);
      cursor: pointer;
      transition: background .2s, color .2s;
    }

    .weight-btn.active {
      background: var(--teal);
      color: #fff;
      border-color: var(--teal);
    }

    .weight-btn:hover {
      background: var(--teal2);
      color: #fff;
    }

    /* ensure enough left padding to accomodate accent bar */
    .sel-item {
      padding-left: 22px;
    }

    .sel-item-top {
      display: flex;
      align-items: center;
      gap: 14px;
      position: relative;
    }

    .sel-icon {
      font-size: 1rem;
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.7) 40%, rgba(255, 255, 255, 0) 100%);
    }

    .sel-name {
      font-size: .86rem;
      font-weight: 600;
      color: var(--ink2);
      flex: 1;
      min-width: 120px;
    }

    .sel-hint {
      font-size: .7rem;
      color: var(--muted);
      margin-top: 2px;
      line-height: 1.3;
    }

    .inv-tag {
      font-size: .63rem;
      background: var(--amber-bg);
      color: var(--amber);
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #f0d080;
      font-weight: 600;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .weight-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex-shrink: 0;
      align-items: flex-end;
    }

    .sens-wrap {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .sens-wrap .weight-lbl {
      align-self: center;
    }

    .weight-lbl {
      font-size: .62rem;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: .05em;
      text-transform: uppercase;
    }

    /* inversion toggle styled as a modern pill button */
    .inv-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      min-width: 70px;
      font-size: .72rem;
      padding: 6px 14px;
      border-radius: 999px;
      background: var(--glass-bg);
      border: 1px solid var(--border2);
      color: var(--muted2);
      cursor: pointer;
      font-family: 'Plus Jakarta Sans', sans-serif;
      white-space: nowrap;
      font-weight: 600;
      transition: background .2s ease, border-color .2s ease, color .2s ease, transform .2s ease;
      flex-shrink: 0;
      align-self: flex-end;
      position: relative;
      margin-left: auto;
      /* push away from weight buttons */
    }

    /* arrow indicator before text: up/down state */
    .inv-btn::before {
      content: '↑';
      font-size: .75rem;
      display: inline-block;
      margin-right: 4px;
      transition: transform .2s;
    }

    .inv-btn.on::before {
      content: '↓';
    }

    .inv-btn:hover {
      transform: translateY(-1px);
      background: var(--bg2);
    }

    .inv-btn.on {
      border-color: var(--amber);
      background: var(--amber-bg);
      color: var(--amber);
    }

    .inv-btn.on:hover {
      background: var(--amber-bd);
    }

    .rm-btn {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.0);
      border: 1px solid rgba(248, 113, 113, 0.4);
      color: var(--muted);
      cursor: pointer;
      font-size: .8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
      transition: background .16s ease, border-color .16s ease, color .16s ease, transform .16s ease;
    }

    .rm-btn:hover {
      background: rgba(248, 113, 113, 0.16);
      border-color: var(--red);
      color: var(--red);
      transform: translateY(-1px);
    }

    .empty-hint {
      text-align: center;
      padding: 28px;
      color: var(--muted);
      font-size: .85rem;
    }

    /* ── STEP 3 — EVALUATION ─────────────────── */
    .eval-grid {
      display: grid;
      gap: 20px;
    }

    .eval-col-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-radius: 20px 20px 0 0;
      border: 1px solid var(--border);
      border-bottom: none;
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.2s ease, box-shadow 0.2s ease, border-radius 0.4s cubic-bezier(0.16, 1, 0.3, 1), border-bottom-color 0.4s ease;
    }

    .eval-col-head.collapsed {
      border-radius: 20px;
      border-bottom: 1px solid var(--border);
    }

    .eval-col-head:hover {
      background: rgba(255, 255, 255, 0.08);
      box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.05);
    }

    .eval-col-name {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.05rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .opt-badge {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: .62rem;
      font-weight: 800;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.4);
      color: inherit;
      border: 1px solid currentColor;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
    }

    @media (prefers-color-scheme: dark) {
      .opt-badge {
        background: rgba(0, 0, 0, 0.15);
      }
    }

    .eval-live-score {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      background: rgba(255, 255, 255, 0.4);
      padding: 4px 12px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
    }

    .eval-live-num {
      font-family: 'Lora', serif;
      font-size: 1.7rem;
      font-weight: 700;
      line-height: 1;
      letter-spacing: -0.02em;
    }

    .eval-live-label {
      font-size: .65rem;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 2px;
    }

    .eval-col-body {
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 20px 20px;
      overflow: hidden;
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
      transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.3s ease, border-color 0.4s ease;
      max-height: 2000px;
    }

    .eval-col-body.collapsed {
      max-height: 0;
      border-color: transparent !important;
      box-shadow: none;
    }

    .eval-col-body:hover {
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
    }

    .collapse-btn-s3 {
      background: transparent;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: transform 0.2s;
    }

    .collapse-btn-s3 svg {
      transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .collapse-btn-s3.collapsed svg {
      transform: rotate(180deg);
    }

    .eval-col-head:hover .collapse-btn-s3 {
      transform: scale(1.1);
    }


    /* Stepper */
    .sl-item {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s ease;
    }

    .sl-item:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    @media (prefers-color-scheme: dark) {
      .sl-item:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .eval-live-score {
        background: rgba(0, 0, 0, 0.15);
      }
    }

    .sl-item:last-child {
      border-bottom: none;
    }

    .sl-head {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .rm-crit-btn-s3 {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: transparent;
      border: 1px solid rgba(248, 113, 113, 0.3);
      color: var(--muted);
      cursor: pointer;
      font-size: .7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all .2s;
      margin-left: auto;
    }

    .rm-crit-btn-s3:hover {
      background: rgba(248, 113, 113, 0.15);
      border-color: var(--red);
      color: var(--red);
      transform: scale(1.05);
    }

    .sl-label {
      font-size: .85rem;
      font-weight: 600;
      color: var(--ink);
      flex: 1;
    }

    .crit-name-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.4);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      color: var(--fg);
    }

    @media (prefers-color-scheme: dark) {
      .crit-name-badge {
        background: rgba(255, 255, 255, 0.05);
      }
    }

    .sl-wtag {
      font-size: .62rem;
      background: var(--amber-bg);
      color: var(--amber);
      padding: 3px 8px;
      border-radius: 6px;
      border: 1px solid #f0d080;
      font-weight: 700;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(217, 119, 6, 0.1);
    }

    .stepper {
      display: grid;
      grid-template-columns: 48px 1fr 48px;
      align-items: center;
      gap: 16px;
    }

    .stepper-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--ink2);
      font-size: 1.4rem;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Plus Jakarta Sans', sans-serif;
      transition: all .2s cubic-bezier(0.16, 1, 0.3, 1);
      flex-shrink: 0;
      touch-action: manipulation;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
    }

    .stepper-btn:hover {
      border-color: var(--teal2);
      color: var(--teal);
      background: var(--teal-bg);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(5, 150, 105, 0.15);
    }

    .stepper-btn:active {
      transform: scale(.92) translateY(0);
      background: var(--border);
      box-shadow: none;
    }

    .stepper-track {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .fluid-track {
      display: flex;
      width: 100%;
      height: 28px;
      align-items: center;
      gap: 12px;
      padding: 0 4px;
    }

    .fluid-bar {
      flex: 1;
      height: 10px;
      border-radius: 999px;
      background: var(--border);
      overflow: hidden;
      position: relative;
      cursor: pointer;
      touch-action: none;
      /* Allows pointer events on touch without scrolling */
    }

    .fluid-bar-fill {
      height: 100%;
      border-radius: 999px;
      width: 50%;
      /* JS will control */
      transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1), background 0.4s ease, box-shadow 0.4s ease;
      background: var(--teal);
    }

    .stepper-val {
      font-family: 'Lora', serif;
      font-size: 1.8rem;
      font-weight: 700;
      line-height: 1;
      transition: color .2s;
      min-width: 32px;
      text-align: center;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .stepper-emoji {
      font-size: 1.45rem;
      flex-shrink: 0;
      transition: opacity .15s, transform .3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      user-select: none;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.08));
    }

    .stepper-emoji:hover {
      transform: scale(1.15) !important;
    }

    .sl-wtag-modern .sl-wtag {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: .65rem;
      background: var(--amber-bg);
      color: var(--amber);
      padding: 4px 10px;
      border-radius: 8px;
      border: 1px solid rgba(217, 119, 6, 0.3);
      font-weight: 800;
      letter-spacing: 0.03em;
      box-shadow: 0 2px 6px rgba(217, 119, 6, 0.1);
    }

    .sl-wtag-modern .swing-wtag {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: .65rem;
      background: rgba(16, 185, 129, 0.1);
      color: var(--teal);
      border: 1px solid rgba(16, 185, 129, 0.3);
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 800;
      letter-spacing: 0.03em;
      box-shadow: 0 2px 6px rgba(16, 185, 129, 0.1);
    }

    /* ── NOTES ───────────────────────────────── */
    .notes-row {
      display: grid;
      gap: 14px;
      margin-top: 20px;
    }

    .notes-lbl {
      font-size: .75rem;
      font-weight: 700;
      color: var(--ink2);
      margin-bottom: 6px;
      display: block;
    }

    /* ══════════════════════════════════════════
   PAGE RÉSULTATS
   ══════════════════════════════════════════ */

    /* Le conteneur utilise .main comme les autres pages */
    #resContent {
      padding: 0;
    }

    /* ── SCORE CARDS RECTANGULAIRES ─────────── */
    /* ── SCORE CARDS — modern / minimal ─────── */
    .sc-cards-row {
      display: grid;
      gap: 14px;
      margin: 18px 0 24px;
      align-items: start;
    }

    .sc-card {
      /* glassmorphism-inspired container */
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 18px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
      transition: transform .25s ease, box-shadow .25s ease;
      overflow: hidden;
      position: relative;
    }

    .sc-card:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
    }

    .sc-card:hover {
      transform: scale(1.015);
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
    }

    .sc-card-winner::before,
    .sc-card-accent {
      display: none;
    }

    /* ── Corps unique (pas de header band séparé) ── */
    .sc-card-body {
      padding: 14px 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .sc-card-left {
      flex: 1;
      min-width: 0;
    }

    /* Ligne 1 : badge rang + nom */
    .sc-card-top {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      min-width: 0;
    }

    .sc-card-rank {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 24px;
      font-size: .65rem;
      font-weight: 600;
      letter-spacing: .08em;
      text-transform: uppercase;
      white-space: nowrap;
      flex-shrink: 0;
      opacity: 0.9;
      backdrop-filter: blur(4px);
      background: rgba(255, 255, 255, 0.4);
    }

    .sc-card-name {
      font-size: .88rem;
      font-weight: 700;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    /* Ligne 2 : score gauche */
    .sc-card-score {
      margin-bottom: 14px;
      position: relative;
    }

    .sc-score-display {
      display: flex;
      align-items: baseline;
      gap: 4px;
      margin-bottom: 6px;
    }

    .sc-card-num {
      font-size: 2.4rem;
      font-weight: 600;
      line-height: 1;
      letter-spacing: -0.03em;
      transition: transform .2s ease;
      opacity: 0.9;
    }

    .sc-card:hover .sc-card-num {
      transform: scale(1.03);
    }

    .sc-card-den {
      font-size: .95rem;
      font-weight: 600;
      opacity: .65;
    }

    /* Barre fine — 5 px */
    .sc-score-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 6px;
      overflow: hidden;
      opacity: 0.75;
    }

    .sc-score-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width .9s cubic-bezier(.4, 0, .2, 1);
    }

    /* Ligne 3 : accordéon critères */
    .sc-card-crits-wrap {
      border-top: 1px solid var(--border);
      margin-top: 2px;
    }

    .sc-card-crits-toggle {
      width: 100%;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px 0 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--muted);
      font-size: .64rem;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-family: inherit;
      transition: color .2s ease;
    }

    .sc-card-crits-toggle:hover {
      color: var(--ink2);
    }

    .sc-card-crits-toggle-icon {
      font-size: .68rem;
      transition: transform .25s ease;
      flex-shrink: 0;
    }

    .sc-card-crits-wrap.open .sc-card-crits-toggle-icon {
      transform: rotate(180deg);
    }

    .sc-card-crits {
      display: none;
      flex-direction: column;
      gap: 7px;
      padding-bottom: 2px;
    }

    .sc-card-crits-wrap.open .sc-card-crits {
      display: flex;
    }

    .sc-mini-crit {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: .72rem;
      font-weight: 500;
    }

    .sc-mini-crit-name {
      width: 90px;
      flex-shrink: 0;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sc-mini-bar {
      flex: 1;
      height: 3px;
      background: var(--bg2);
      border-radius: 2px;
      overflow: hidden;
    }

    .sc-mini-bar-fill {
      height: 100%;
      border-radius: 2px;
    }

    .sc-mini-crit-val {
      width: 14px;
      flex-shrink: 0;
      text-align: right;
      font-weight: 700;
      font-size: .65rem;
    }

    /* ── Insights points forts / faibles ── */
    .sc-insights {
      border-top: 1px solid var(--border);
      margin-top: 10px;
      padding-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .sc-insight {
      display: flex;
      align-items: flex-start;
      gap: 5px;
      font-size: .74rem;
      line-height: 1.45;
      color: var(--ink2);
    }

    .sc-insight-dot {
      font-size: .65rem;
      font-weight: 800;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .sc-insight-pro .sc-insight-dot {
      color: var(--teal);
    }

    .sc-insight-con .sc-insight-dot {
      color: var(--muted);
    }

    .sc-insight strong {
      font-weight: 700;
      color: var(--ink);
    }

    /* ── Écart / Proximité (diff-info) ── */
    .sc-diff-info {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
      margin-top: 7px;
    }

    .sc-diff-gap {
      font-size: .75rem;
      font-weight: 700;
      color: #e53935;
      background: rgba(229, 57, 53, .08);
      padding: 2px 7px;
      border-radius: 5px;
      white-space: nowrap;
    }

    .sc-diff-prox {
      font-size: .75rem;
      font-weight: 500;
      color: var(--muted);
      white-space: nowrap;
    }

    .sc-trophy {
      font-size: .85rem;
      flex-shrink: 0;
      margin-left: 2px;
    }

    /* Delta scénario */
    .sc-card-delta {
      font-size: .65rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 5px;
      margin-bottom: 6px;
      display: inline-block;
    }

    .sc-card-delta.up {
      background: rgba(45, 125, 90, .1);
      color: var(--teal);
    }

    .sc-card-delta.down {
      background: rgba(192, 57, 43, .07);
      color: var(--red);
    }

    .sc-card-delta.same {
      display: none;
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      .sc-card {
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.28);
      }

      .sc-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.42);
      }

      /* Lisibilité insights & diff-info en mode sombre */
      .sc-insight-pro .sc-insight-dot {
        color: #2dd4bf;
      }

      .sc-insight-con .sc-insight-dot {
        color: #94a3b8;
      }

      .sc-diff-gap {
        color: #f87171;
        background: rgba(248, 113, 113, 0.12);
      }
    }

    /* ── VERDICT ENCADRÉ ─────────────────────── */
    .verdict-inline {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 12px;
      margin-bottom: 6px;
      background: var(--verdict-bg);
      border: 1.5px solid var(--verdict-border);
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
      backdrop-filter: blur(6px);
    }

    .verdict-inline-emoji {
      font-size: 1.5rem;
      flex-shrink: 0;
      line-height: 1.2;
    }

    .verdict-inline-text {
      flex: 1;
      min-width: 0;
    }

    .verdict-inline-title {
      font-family: 'Lora', serif;
      font-size: 1rem;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 3px;
    }

    .verdict-title-amber {
      color: #92700a;
    }

    @media (prefers-color-scheme: dark) {
      .verdict-title-amber {
        color: #fbbf24;
      }
    }

    .verdict-title-green {
      color: var(--teal);
    }

    @media (prefers-color-scheme: dark) {
      .verdict-title-green {
        color: #14b8a6;
      }
    }

    .verdict-inline-sub {
      font-size: .8rem;
      color: var(--ink2);
      line-height: 1.5;
    }

    /* ── LAYOUT RÉSULTATS ────────────────────── */
    .res-cols {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 0;
    }

    @media(max-width:700px) {
      .res-cols {
        grid-template-columns: 1fr;
      }

      .sc-cards-row {
        grid-template-columns: 1fr !important;
      }
    }

    .res-section {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .res-section+.res-section {
      margin-top: 0;
    }

    .res-section-head {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    .res-section-icon {
      font-size: .95rem;
    }

    .res-section-title {
      font-size: .72rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .09em;
      color: var(--muted2);
      flex: 1;
    }

    .res-section-body {
      padding: 18px;
    }

    /* Interp IA */
    .res-interp-badge {
      display: inline-flex;
      align-items: center;
      font-size: .58rem;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      background: var(--teal-bg);
      color: var(--teal);
      padding: 2px 7px;
      border-radius: 5px;
      border: 1px solid var(--teal-bd);
    }

    .res-interp-text {
      font-size: .84rem;
      color: var(--ink2);
      line-height: 1.75;
    }

    .res-interp-text p {
      margin-bottom: .75em;
    }

    .res-interp-text p:last-child {
      margin-bottom: 0;
    }

    .res-interp-text strong {
      color: var(--ink);
      font-weight: 700;
    }

    .res-interp-loading {
      display: flex;
      gap: 8px;
    }

    /* Radar */
    .res-radar-wrap {
      display: flex;
      justify-content: center;
      background: transparent;
    }

    .res-radar-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
      font-size: .75rem;
      color: var(--ink2);
      font-weight: 500;
      justify-content: center;
      align-items: center;
    }

    /* Bouton point d'interrogation */
    .radar-help-btn {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--bg2);
      border: 1.5px solid var(--border2);
      color: var(--muted);
      font-size: .7rem;
      font-weight: 800;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      transition: all .15s;
      flex-shrink: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .radar-help-btn:hover {
      background: var(--teal-bg);
      border-color: var(--teal);
      color: var(--teal);
    }

    /* Encadré explicatif — caché par défaut */
    .radar-how {
      display: none;
      margin-top: 12px;
      padding: 16px 18px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }

    .radar-how.open {
      display: block;
    }

    /* Lignes décoratives en arrière-plan */
    .radar-how::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(-45deg,
          transparent,
          transparent 18px,
          rgba(45, 125, 90, 0.04) 18px,
          rgba(45, 125, 90, 0.04) 19px);
      pointer-events: none;
    }

    /* Accent coloré en haut à gauche */
    .radar-how::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: linear-gradient(to bottom, var(--teal), transparent);
      border-radius: 12px 0 0 12px;
    }

    .radar-how-title {
      font-size: .65rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: var(--teal);
      margin-bottom: 12px;
      position: relative;
    }

    .radar-how-items {
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
    }

    .radar-how-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: .76rem;
      color: var(--ink2);
      line-height: 1.55;
    }

    .radar-how-item strong {
      color: var(--ink);
      font-weight: 700;
    }

    .radar-how-icon {
      font-size: .85rem;
      flex-shrink: 0;
      margin-top: 1px;
      width: 24px;
      height: 24px;
      background: var(--teal-bg);
      border: 1px solid var(--teal-bd);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Dividers */
    .res-divider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 28px 0 14px;
      color: var(--muted2);
    }

    .res-divider::before,
    .res-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(to right,
          var(--border),
          var(--border) 50%,
          transparent 100%);
    }

    .res-divider::after {
      background: linear-gradient(to left,
          var(--border),
          var(--border) 50%,
          transparent 100%);
    }

    .res-divider-label {
      font-size: .65rem;
      font-weight: 900;
      letter-spacing: .12em;
      text-transform: uppercase;
      white-space: nowrap;
      color: var(--teal);
      background: linear-gradient(135deg, var(--teal-bg), rgba(16, 185, 129, 0.05));
      padding: 6px 14px;
      border-radius: 30px;
      border: 1px solid var(--teal-bd);
    }

    @media (prefers-color-scheme: dark) {

      .res-divider::before,
      .res-divider::after {
        background: linear-gradient(to right,
            rgba(255, 255, 255, 0.1),
            rgba(255, 255, 255, 0.1) 50%,
            transparent 100%);
      }

      .res-divider::after {
        background: linear-gradient(to left,
            rgba(255, 255, 255, 0.1),
            rgba(255, 255, 255, 0.1) 50%,
            transparent 100%);
      }

      .res-divider-label {
        background: linear-gradient(135deg, rgba(5, 150, 105, 0.12), rgba(16, 185, 129, 0.04));
        border-color: rgba(5, 150, 105, 0.25);
      }
    }

    /* Actions */
    .res-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 28px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 10px;
    }

    /* ── PANNEAU SCÉNARIO ────────────────────── */
    .scenario-panel {
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .scenario-panel-head {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 18px;
      cursor: pointer;
      user-select: none;
      transition: background .15s;
    }

    .scenario-panel-head:hover {
      background: var(--bg);
    }

    .scenario-panel-icon {
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .scenario-panel-text {
      flex: 1;
      min-width: 0;
    }

    .scenario-panel-title {
      font-size: .82rem;
      font-weight: 700;
      color: var(--ink);
    }

    .scenario-panel-sub {
      font-size: .68rem;
      color: var(--muted);
      line-height: 1.3;
      margin-top: 1px;
    }

    .scenario-panel-chevron {
      color: var(--muted2);
      font-size: .8rem;
      transition: transform .22s;
      margin-left: 6px;
    }

    .scenario-panel.open .scenario-panel-chevron {
      transform: rotate(180deg);
    }

    .scenario-panel-body {
      display: none;
      border-top: 1px solid var(--border);
    }

    .scenario-panel.open .scenario-panel-body {
      display: block;
    }

    /* ── ONGLETS SCÉNARIO ────────────────────── */
    .sc-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    .sc-tab {
      flex: 1;
      padding: 9px 12px;
      font-size: .78rem;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      border: none;
      background: none;
      border-bottom: 2px solid transparent;
      transition: color .15s, border-color .15s;
      font-family: 'Plus Jakarta Sans', sans-serif;
      user-select: none;
    }

    .sc-tab.active {
      color: var(--teal);
      border-bottom-color: var(--teal);
      background: var(--white);
    }

    .sc-tab-content {
      padding: 14px 18px 18px;
    }

    .sc-tab-pane {
      display: none;
    }

    .sc-tab-pane.active {
      display: block;
    }

    /* Filtres émotions */
    .emotion-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    .emotion-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: .75rem;
      font-weight: 600;
      border: 1.5px solid var(--border);
      background: var(--bg);
      color: var(--ink2);
      cursor: pointer;
      transition: all .15s;
      user-select: none;
    }

    .emotion-chip:hover {
      border-color: var(--teal);
      color: var(--teal);
    }

    .emotion-chip.active {
      background: var(--teal-bg);
      border-color: var(--teal);
      color: var(--teal);
    }

    .emotion-chip-count {
      font-size: .65rem;
      font-weight: 700;
      background: var(--border2);
      color: var(--muted);
      padding: 1px 5px;
      border-radius: 8px;
    }

    .emotion-chip.active .emotion-chip-count {
      background: var(--teal);
      color: #fff;
    }

    .emotion-crit-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px;
    }

    .emotion-crit-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: .7rem;
      font-weight: 600;
      padding: 2px 9px;
      border-radius: 14px;
      border: 1px solid;
    }

    .emotion-crit-tag.included {
      background: rgba(124, 58, 237, .07);
      color: #7c3aed;
      border-color: rgba(124, 58, 237, .25);
    }

    .emotion-crit-tag.excluded {
      background: var(--bg);
      color: var(--muted2);
      border-color: var(--border);
      text-decoration: line-through;
      opacity: .6;
    }

    .emotion-none {
      font-size: .8rem;
      color: var(--muted);
      font-style: italic;
      padding: 8px 0;
    }

    .emotion-insight {
      margin-top: 12px;
      padding: 11px 13px;
      background: rgba(124, 58, 237, .05);
      border: 1px solid rgba(124, 58, 237, .18);
      border-radius: 9px;
      font-size: .8rem;
      color: var(--ink2);
      line-height: 1.6;
    }

    .emotion-insight strong {
      color: #7c3aed;
    }

    /* Critères scénario */
    .scenario-reset {
      font-size: .73rem;
      font-weight: 600;
      color: var(--teal);
      background: none;
      border: none;
      cursor: pointer;
      font-family: 'Plus Jakarta Sans', sans-serif;
      padding: 0;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .scenario-reset:hover {
      color: var(--teal2);
    }

    .sc-crit-list {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 10px;
      clear: both;
    }

    .sc-crit-row {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 8px 11px;
      border-radius: 8px;
      border: 1.5px solid var(--border);
      background: var(--bg);
      transition: all .15s;
    }

    .sc-crit-row.off {
      opacity: .45;
    }

    .sc-crit-row.off .sc-crit-name {
      text-decoration: line-through;
    }

    .sc-crit-icon {
      font-size: .9rem;
      flex-shrink: 0;
    }

    .sc-crit-name {
      font-size: .8rem;
      font-weight: 600;
      color: var(--ink);
      flex: 1;
    }

    .sc-crit-weight {
      font-size: .62rem;
      background: var(--amber-bg);
      color: var(--amber);
      padding: 2px 5px;
      border-radius: 4px;
      border: 1px solid #f0d080;
      font-weight: 700;
      flex-shrink: 0;
    }

    .sc-crit-inv {
      font-size: .62rem;
      background: var(--bg2);
      color: var(--muted);
      padding: 2px 5px;
      border-radius: 4px;
      border: 1px solid var(--border2);
      font-weight: 600;
      flex-shrink: 0;
    }

    .scenario-summary {
      margin-top: 12px;
      padding: 10px 13px;
      background: var(--teal-bg);
      border: 1px solid var(--teal-bd);
      border-radius: 9px;
      font-size: .79rem;
      color: var(--ink2);
      line-height: 1.6;
    }

    .scenario-summary strong {
      color: var(--teal2);
    }

    /* Mini toggle */
    .mini-toggle {
      position: relative;
      width: 34px;
      height: 20px;
      flex-shrink: 0;
    }

    .mini-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .mini-toggle-track {
      position: absolute;
      inset: 0;
      background: var(--border2);
      border-radius: 10px;
      transition: background .2s cubic-bezier(0.16, 1, 0.3, 1);
      cursor: pointer;
    }

    .mini-toggle input:checked+.mini-toggle-track {
      background: var(--teal);
    }

    .mini-toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0, 0, 0, .2);
      transition: transform .2s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events: none;
    }

    .mini-toggle input:checked~.mini-toggle-thumb {
      transform: translateX(14px);
    }

    /* Scores scénario (delta) */
    .fear-opt-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .fear-opt-row:last-child {
      border-bottom: none;
    }

    .fear-opt-name {
      font-size: .8rem;
      font-weight: 700;
      flex: 1;
      min-width: 0;
    }

    .fear-scores {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .fear-score-block {
      text-align: center;
    }

    .fear-score-val {
      font-family: 'Lora', serif;
      font-size: 1.1rem;
      font-weight: 700;
      line-height: 1;
    }

    .fear-score-lbl {
      font-size: .55rem;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: .04em;
    }

    .fear-arrow {
      color: var(--muted2);
      font-size: .9rem;
    }

    .fear-delta {
      font-size: .72rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 5px;
    }

    .fear-delta.up {
      background: rgba(45, 125, 90, .1);
      color: var(--teal);
    }

    .fear-delta.down {
      background: rgba(192, 57, 43, .07);
      color: var(--red);
    }

    .fear-delta.same {
      display: none;
    }

    /* ── TABLEAU BREAKDOWN ───────────────────── */
    .bk-table {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
      overflow-x: auto;
    }

    .bk-row {
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border);
      transition: background .2s ease;
    }

    .bk-row:last-child {
      border-bottom: none;
    }

    .bk-row.hdr {
      background: linear-gradient(90deg,
          var(--teal-bg) 0%,
          rgba(16, 185, 129, 0.05) 50%,
          var(--bg) 100%);
      border-bottom: 1.5px solid var(--teal-bd);
      font-weight: 700;
    }

    .bk-row:not(.hdr):nth-child(odd) {
      background: rgba(0, 0, 0, 0.01);
    }

    @media (prefers-color-scheme: dark) {
      .bk-row.hdr {
        background: linear-gradient(90deg,
            rgba(5, 150, 105, 0.1) 0%,
            rgba(5, 150, 105, 0.04) 50%,
            rgba(255, 255, 255, 0.02) 100%);
        border-bottom-color: rgba(5, 150, 105, 0.25);
      }

      .bk-row:not(.hdr):nth-child(odd) {
        background: rgba(255, 255, 255, 0.01);
      }
    }

    .bk-row:not(.hdr):hover {
      background: var(--bg2);
      transform: translateX(2px);
    }

    .bk-cell {
      padding: 12px 14px;
      font-size: .8rem;
    }

    .bk-cell.crit-col {
      width: 200px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      color: var(--ink);
      font-weight: 500;
    }

    .bk-cell.hdr-cell {
      color: var(--teal);
      font-weight: 800;
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    .bk-cell.opt-col {
      flex: 1;
      min-width: 100px;
    }

    .opt-cell-in {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .opt-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      font-size: .85rem;
      font-weight: 800;
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }

    .mini-bar {
      flex: 1;
      height: 6px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    @media (prefers-color-scheme: dark) {
      .mini-bar {
        background: rgba(255, 255, 255, 0.06);
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);
      }
    }

    .mini-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width .3s ease;
    }

    .inv-tag {
      font-size: .62rem;
      color: var(--red);
      background: var(--red-bg);
      padding: 3px 7px;
      border-radius: 5px;
      border: 1px solid rgba(220, 38, 38, 0.3);
      font-weight: 800;
      letter-spacing: .02em;
      white-space: nowrap;
    }

    @media (prefers-color-scheme: dark) {
      .inv-tag {
        background: rgba(220, 38, 38, 0.15);
        border-color: rgba(220, 38, 38, 0.35);
        color: #ff6b6b;
      }
    }

    /* ── MOBILE ADAPTATION FOR BREAKDOWN TABLE ── */
    @media(max-width:768px) {
      .bk-table {
        border-radius: 12px;
      }

      .bk-cell {
        padding: 11px 12px;
        font-size: .78rem;
      }

      .bk-cell.crit-col {
        width: 140px;
      }

      .opt-pill {
        width: 26px;
        height: 26px;
        font-size: .8rem;
      }

      .mini-bar {
        height: 5px;
      }
    }

    @media(max-width:640px) {
      .bk-table {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .bk-cell {
        padding: 10px 11px;
        font-size: .75rem;
      }

      .bk-cell.crit-col {
        width: 120px;
        gap: 6px;
      }

      .bk-cell.crit-col>span {
        flex-basis: 100%;
      }

      .opt-pill {
        width: 24px;
        height: 24px;
        font-size: .75rem;
      }

      .mini-bar {
        height: 4px;
      }

      .opt-cell-in {
        gap: 6px;
      }
    }

    /* ── NOTES ───────────────────────────────── */
    .notes-res {
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .notes-res-head {
      padding: 12px 18px;
      border-bottom: 1px solid var(--border);
      font-size: .8rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .09em;
      color: var(--muted2);
      background: var(--bg);
    }

    .notes-res-body {
      display: grid;
    }

    .note-col {
      padding: 15px 18px;
    }

    .note-col-lbl {
      font-size: .65rem;
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
      margin-bottom: 7px;
    }

    .note-col-txt {
      font-size: .82rem;
      color: var(--muted);
      line-height: 1.65;
      font-style: italic;
    }

    /* ── ACTIONS ─────────────────────────────── */
    .res-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 28px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 10px;
    }

    @media(max-width:640px) {
      .res-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        /* keep normal flow so actions sit at page bottom, not fixed on scroll */
        padding: 16px;
        margin: 20px -16px 0;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid var(--border);
      }

      .res-actions .btn {
        width: 100%;
        justify-content: center;
        padding: 14px 8px;
      }
    }

    /* ── DIVIDER SECTION ─────────────────────── */
    /* Fallback score cards (updateScenarioScores) */
    .scores-row {
      display: none;
    }

    .score-card,
    .sc-body,
    .sc-top-band,
    .sc-main,
    .rank-badge,
    .sc-name,
    .sc-gauge,
    .sc-gauge-track,
    .sc-gauge-fill,
    .sc-gauge-label,
    .sc-num,
    .sc-denom,
    .sc-scenario-delta {
      display: revert;
    }

    .sc-scenario-delta.same {
      display: none;
    }

    /* ── LANG SWITCHER ───────────────────────── */
    .lang-switcher {
      position: absolute;
      top: 18px;
      right: 20px;
      display: flex;
      gap: 4px;
      background: var(--bg2);
      border-radius: 8px;
      padding: 3px;
      border: 1px solid var(--border);
    }

    .lang-btn {
      padding: 4px 10px;
      font-size: .72rem;
      font-weight: 700;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: all .15s;
      font-family: 'Plus Jakarta Sans', sans-serif;
      letter-spacing: .04em;
    }

    .lang-btn.active {
      background: var(--white);
      color: var(--teal);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    [data-tip] {
      position: relative;
      cursor: help;
    }

    [data-tip]::after {
      content: attr(data-tip);
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--ink);
      color: #fff;
      font-size: .7rem;
      padding: 5px 9px;
      border-radius: 6px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity .15s;
      z-index: 100;
    }

    [data-tip]:hover::after {
      opacity: 1;
    }

    /* ── FEAR TOGGLE ─────────────────────────── */
    .fear-box {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: var(--r);
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .fear-head {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
      transition: background .15s;
    }

    .fear-head:hover {
      background: var(--bg);
    }

    .fear-icon {
      font-size: 1.4rem;
      flex-shrink: 0;
    }

    .fear-head-text {
      flex: 1;
    }

    .fear-head-title {
      font-size: .92rem;
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 2px;
    }

    .fear-head-sub {
      font-size: .75rem;
      color: var(--muted);
      line-height: 1.4;
    }

    /* Toggle switch */
    .toggle-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .toggle-label {
      font-size: .75rem;
      font-weight: 600;
      color: var(--muted);
      transition: color .2s;
      white-space: nowrap;
    }

    .toggle-label.on {
      color: var(--teal);
    }

    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .toggle-track {
      position: absolute;
      inset: 0;
      background: var(--border2);
      border-radius: 12px;
      transition: background .2s cubic-bezier(0.16, 1, 0.3, 1);
      cursor: pointer;
    }

    .toggle input:checked+.toggle-track {
      background: var(--teal);
    }

    .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
      transition: transform .2s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events: none;
    }

    .toggle input:checked~.toggle-thumb {
      transform: translateX(20px);
    }

    /* Fear body — criteria tags + comparison */
    .fear-body {
      border-top: 1px solid var(--border);
      padding: 16px 20px;
      display: none;
    }

    .fear-box.open .fear-body {
      display: block;
    }

    .fear-crits {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 16px;
    }

    .fear-crit-tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: .72rem;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 20px;
      border: 1px solid;
    }

    .fear-crit-tag.active {
      background: rgba(124, 58, 237, 0.08);
      color: #7c3aed;
      border-color: rgba(124, 58, 237, 0.3);
    }

    .fear-crit-tag.inactive {
      background: var(--bg);
      color: var(--muted2);
      border-color: var(--border);
      text-decoration: line-through;
      opacity: .6;
    }

    .fear-comparison {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .fear-comparison .fear-opt-row {
      flex: 1;
      min-width: 130px;
      flex-direction: column;
      align-items: flex-start;
    }

    .fear-comparison .fear-opt-name {
      min-width: unset;
      margin-bottom: 8px;
    }

    .fear-comparison .fear-scores {
      flex: unset;
      flex-wrap: wrap;
    }

    .fear-opt-row {
      background: var(--bg);
      border-radius: 10px;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .fear-opt-name {
      font-size: .82rem;
      font-weight: 700;
      min-width: 90px;
    }

    .fear-scores {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      flex-wrap: wrap;
    }

    .fear-score-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 64px;
    }

    .fear-score-val {
      font-family: 'Lora', serif;
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1;
    }

    .fear-score-lbl {
      font-size: .62rem;
      color: var(--muted);
      font-weight: 500;
      margin-top: 1px;
    }

    .fear-arrow {
      font-size: 1rem;
      color: var(--muted2);
    }

    .fear-delta {
      font-size: .78rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 6px;
    }

    .fear-delta.up {
      background: rgba(45, 125, 90, .08);
      color: var(--teal);
    }

    .fear-delta.down {
      background: rgba(192, 57, 43, .06);
      color: var(--red);
    }

    .fear-delta.same {
      background: var(--bg2);
      color: var(--muted);
    }

    .fear-insight {
      margin-top: 14px;
      padding: 12px 14px;
      background: rgba(124, 58, 237, 0.05);
      border: 1px solid rgba(124, 58, 237, 0.18);
      border-radius: 10px;
      font-size: .82rem;
      color: var(--ink2);
      line-height: 1.6;
    }

    .fear-insight strong {
      color: #7c3aed;
    }

    .fear-none {
      font-size: .82rem;
      color: var(--muted);
      font-style: italic;
      padding: 8px 0;
    }

    /* ── Scenario impact cards (glassmorphism) ───────────────── */

    .scenario-impact-wrapper {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      flex-direction: column-reverse;
      gap: 14px;
    }

    .scenario-impact-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width:720px) {
      .scenario-impact-wrapper {
        flex-direction: column-reverse;
        flex-direction: column;
      }

      .scenario-impact-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
      }
    }

    .scenario-impact-card {
      position: relative;
      padding: 18px 20px;
      border-radius: 18px;
      background: var(--scenario-card-bg);
      border: 1px solid var(--scenario-card-border);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.08);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 12px;
      animation: scenarioCardIn .35s cubic-bezier(0.16, 1, 0.3, 1);
      transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.2s;
    }

    .scenario-impact-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
    }

    .scenario-impact-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.48), transparent 55%);
      opacity: .34;
      pointer-events: none;
    }

    .scenario-impact-card>* {
      position: relative;
      z-index: 1;
    }

    .scenario-impact-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .scenario-impact-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: .82rem;
      font-weight: 600;
      color: var(--ink2);
      letter-spacing: .01em;
    }

    .scenario-impact-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      box-shadow: var(--scenario-dot-shadow);
    }

    .scenario-impact-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .scenario-impact-scores {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 10px;
    }

    .scenario-score {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .scenario-score-caption {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: var(--muted);
    }

    .scenario-score-value-main {
      font-size: 2.2rem;
      font-weight: 800;
      letter-spacing: -.04em;
      line-height: 1;
      color: var(--teal);
    }

    .scenario-score-value-base {
      font-size: 1rem;
      font-weight: 600;
      color: var(--muted2);
    }

    .scenario-delta-badge {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .9rem;
      font-weight: 700;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.18);
      border: 1px solid transparent;
      transition: transform .18s ease, box-shadow .18s ease;
    }

    .scenario-delta-up {
      background: rgba(34, 197, 94, 0.12);
      border-color: rgba(34, 197, 94, 0.55);
      color: #15803d;
    }

    @media (prefers-color-scheme: dark) {
      .scenario-delta-up {
        background: rgba(34, 197, 94, 0.25);
        border-color: rgba(34, 197, 94, 0.75);
        color: #4ade80;
      }
    }

    .scenario-delta-down {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(239, 68, 68, 0.55);
      color: #b91c1c;
    }

    @media (prefers-color-scheme: dark) {
      .scenario-delta-down {
        background: rgba(239, 68, 68, 0.25);
        border-color: rgba(239, 68, 68, 0.75);
        color: #fca5a5;
      }
    }

    .scenario-delta-same {
      background: rgba(148, 163, 184, 0.14);
      border-color: rgba(148, 163, 184, 0.45);
      color: #475569;
    }

    @media (prefers-color-scheme: dark) {
      .scenario-delta-same {
        background: rgba(148, 163, 184, 0.25);
        border-color: rgba(148, 163, 184, 0.65);
        color: #cbd5e1;
      }
    }

    .scenario-impact-card:hover .scenario-delta-badge {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.24);
    }

    .scenario-impact-global {
      /* margin-top: 14px; /* Remplacé par `gap` sur le wrapper */
      display: flex;
      justify-content: center;
      text-align: center;
    }

    .scenario-impact-global-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .78rem;
      color: var(--muted);
      background: rgba(24, 23, 20, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .scenario-impact-footer {
      margin-top: 4px;
    }

    .scenario-impact-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 500;
      color: var(--muted);
      background: rgba(24, 23, 20, 0.06);
    }

    @keyframes scenarioCardIn {
      from {
        opacity: 0;
        transform: translateY(8px) scale(.98);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* ── SCENARIO PANEL ──────────────────────── */
    .scenario-box {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: var(--r);
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .scenario-head {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
      transition: background .15s;
    }

    .scenario-head:hover {
      background: var(--bg);
    }

    .scenario-head-icon {
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    .scenario-head-text {
      flex: 1;
    }

    .scenario-head-title {
      font-size: .92rem;
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 2px;
    }

    .scenario-head-sub {
      font-size: .75rem;
      color: var(--muted);
      line-height: 1.4;
    }

    .scenario-chevron {
      color: var(--muted2);
      font-size: .8rem;
      transition: transform .22s;
    }

    .scenario-box.open .scenario-chevron {
      transform: rotate(180deg);
    }

    .scenario-body {
      display: none;
      border-top: 1px solid var(--border);
      padding: 16px 20px 20px;
    }

    .scenario-box.open .scenario-body {
      display: block;
    }

    .scenario-reset {
      font-size: .75rem;
      font-weight: 600;
      color: var(--teal);
      background: none;
      border: none;
      cursor: pointer;
      font-family: 'Plus Jakarta Sans', sans-serif;
      padding: 0;
      text-decoration: underline;
      text-underline-offset: 2px;
      float: right;
    }

    .scenario-reset:hover {
      color: var(--teal2);
    }

    .sc-crit-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
      clear: both;
    }

    .sc-crit-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      border-radius: 9px;
      border: 1.5px solid var(--border);
      background: var(--bg);
      transition: all .15s;
    }

    .sc-crit-row.off {
      opacity: .45;
    }

    .sc-crit-row.off .sc-crit-name {
      text-decoration: line-through;
    }

    .sc-crit-icon {
      font-size: .95rem;
      flex-shrink: 0;
    }

    .sc-crit-name {
      font-size: .82rem;
      font-weight: 600;
      color: var(--ink);
      flex: 1;
    }

    .sc-crit-weight {
      font-size: .65rem;
      background: var(--amber-bg);
      color: var(--amber);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #f0d080;
      font-weight: 700;
      flex-shrink: 0;
    }

    .sc-crit-inv {
      font-size: .65rem;
      background: var(--bg2);
      color: var(--muted);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid var(--border2);
      font-weight: 600;
      flex-shrink: 0;
    }

    /* Mini toggle — smaller than the fear one */
    .mini-toggle {
      position: relative;
      width: 36px;
      height: 20px;
      flex-shrink: 0;
    }

    .mini-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .mini-toggle-track {
      position: absolute;
      inset: 0;
      background: var(--border2);
      border-radius: 10px;
      transition: background .18s;
      cursor: pointer;
    }

    .mini-toggle input:checked+.mini-toggle-track {
      background: var(--teal);
    }

    .mini-toggle-thumb {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .2);
      transition: transform .18s;
      pointer-events: none;
    }

    .mini-toggle input:checked~.mini-toggle-thumb {
      transform: translateX(16px);
    }

    /* Dynamic score cards */
    .sc-num {
      transition: color .2s;
    }

    .sc-bar-fill {
      transition: width .4s ease, background .2s;
    }

    .sc-scenario-delta {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: .72rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 6px;
      margin-left: 6px;
      vertical-align: middle;
    }

    .sc-scenario-delta.up {
      background: rgba(45, 125, 90, .1);
      color: var(--teal);
    }

    .sc-scenario-delta.down {
      background: rgba(192, 57, 43, .07);
      color: var(--red);
    }

    .sc-scenario-delta.same {
      display: none;
    }

    .scenario-summary {
      margin-top: 14px;
      padding: 11px 14px;
      background: var(--teal-bg);
      border: 1px solid var(--teal-bd);
      border-radius: 9px;
      font-size: .8rem;
      color: var(--ink2);
      line-height: 1.6;
    }

    .scenario-summary strong {
      color: var(--teal);
    }

    /* ══════════════════════════════════════════
   MODIF SWING — Pondération par Swing Weighting
   ══════════════════════════════════════════ */

    /* Toggle méthode de pondération */
    .method-toggle-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    .method-lbl {
      font-size: .75rem;
      font-weight: 700;
      color: var(--ink2);
      margin-right: 2px;
      white-space: nowrap;
    }

    .method-btn {
      padding: 6px 14px;
      border-radius: 20px;
      border: 1.5px solid var(--border);
      background: var(--white);
      color: var(--muted);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: .78rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .18s;
    }

    .method-btn:hover {
      border-color: var(--border2);
      color: var(--ink2);
    }

    .method-btn.active {
      border-color: var(--teal);
      background: var(--teal-bg);
      color: var(--teal);
    }

    /* Encadré info swing */
    .swing-info {
      margin: 8px 8px 4px;
      padding: 12px 15px;
      background: var(--teal-bg);
      border: 1px solid var(--teal-bd);
      border-radius: var(--r-sm);
      font-size: .8rem;
      color: var(--teal);
      line-height: 1.6;
    }

    /* Item dans la liste swing — glassmorphism */
    .swing-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      margin: 6px 4px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.26), rgba(255, 255, 255, 0.05));
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.18);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      position: relative;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
      transition: opacity .15s, box-shadow .18s ease, transform .18s ease, border-color .18s ease, background .18s ease;
    }

    .swing-item:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.24);
    }

    .swing-item.swing-first {
      border-color: var(--teal-bd);
      background: linear-gradient(135deg, rgba(45, 125, 90, 0.16), rgba(255, 255, 255, 0.16));
    }

    .swing-rank-num {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      flex-shrink: 0;
      margin-top: 1px;
      background: linear-gradient(135deg, var(--teal), var(--teal2));
      color: #fff;
      font-size: .78rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.25);
    }

    .swing-first .swing-rank-num {
      background: linear-gradient(135deg, var(--ink), #111827);
    }

    .swing-item {
      transition: opacity .15s, box-shadow .18s ease, transform .18s ease;
    }

    .swing-item.dragging {
      opacity: .35;
    }

    .swing-item.drag-over-above {
      box-shadow: 0 -2px 0 0 var(--teal);
      border-top-color: var(--teal);
    }

    .swing-item.drag-over-below {
      box-shadow: 0 2px 0 0 var(--teal);
      border-bottom-color: var(--teal);
    }

    /* Feedback visuel pendant le long press (avant que le drag démarre) */
    .swing-item.press-holding {
      transform: scale(0.97);
      box-shadow: 0 4px 18px rgba(0, 0, 0, .13);
      border-color: var(--teal-bd);
      position: relative;
      z-index: 10;
    }

    .swing-ghost {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      opacity: .88;
      border-radius: var(--r-sm);
      box-shadow: 0 8px 28px rgba(0, 0, 0, .18);
      background: var(--white);
      padding: 10px 12px;
      border: 1.5px solid var(--teal);
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Small animation applied to an item when it's dropped into place */
    @keyframes swingDrop {
      0% {
        transform: translateY(-10px) scale(.98);
        opacity: .9;
        box-shadow: 0 6px 18px rgba(15, 23, 42, .12);
      }

      50% {
        transform: translateY(4px) scale(1.03);
        opacity: 1;
        box-shadow: 0 18px 48px rgba(15, 23, 42, .22);
        border-color: var(--teal);
      }

      100% {
        transform: none;
        opacity: 1;
        box-shadow: 0 10px 30px rgba(15, 23, 42, .18);
      }
    }

    .animate-drop {
      animation: swingDrop 360ms cubic-bezier(.2, .9, .3, 1) both;
      will-change: transform, box-shadow;
    }

    /* Give the rank number a short bounce to draw attention */
    @keyframes rankBounce {
      0% {
        transform: scale(1);
      }

      40% {
        transform: scale(1.18);
      }

      100% {
        transform: scale(1);
      }
    }

    .animate-drop .swing-rank-num {
      animation: rankBounce 360ms cubic-bezier(.2, .9, .3, 1) both;
      will-change: transform;
    }

    /* FIN MODIF DRAG AND DROP */

    /* Contenu principal swing item */
    .swing-item-main {
      flex: 1;
      min-width: 0;
    }

    .swing-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      padding-right: 4px;
      flex-wrap: wrap;
      /* allow name to break onto multiple lines on narrow screens */
    }

    .swing-name-group {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
    }

    .swing-item-name {
      font-size: .86rem;
      font-weight: 600;
      color: var(--ink2);
    }

    .swing-item-sub {
      font-size: .72rem;
      color: var(--muted);
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Champs worst/best/points */
    .swing-fields {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .swing-field-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      flex: 1;
      min-width: 80px;
    }

    .swing-field-lbl {
      font-size: .62rem;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .swing-field-inp {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1.5px solid var(--border);
      background: var(--white);
      color: var(--ink);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: .8rem;
      width: 100%;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }

    .swing-field-inp:focus {
      border-color: var(--teal2);
      box-shadow: 0 0 0 3px rgba(45, 125, 90, .12);
    }

    /* Zone points + badge % */
    .swing-points-wrap {
      display: flex;
      flex-direction: column;
      gap: 3px;
      flex-shrink: 0;
    }

    .swing-points-inp {
      width: 60px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1.5px solid var(--border);
      text-align: center;
      background: var(--white);
      color: var(--ink);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: .88rem;
      font-weight: 700;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }

    .swing-points-inp:focus:not([readonly]) {
      border-color: var(--teal2);
      box-shadow: 0 0 0 3px rgba(45, 125, 90, .12);
    }

    .swing-points-inp[readonly] {
      background: var(--teal-bg);
      border-color: var(--teal-bd);
      color: var(--teal);
      cursor: default;
    }

    .swing-weight-tag {
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.14);
      color: #0e7490;
      padding: 4px 10px;
      font-size: .78rem;
      font-weight: 700;
      min-width: 52px;
      text-align: center;
    }

    /* Column grouping invert button + percentage to save horizontal space */
    .swing-weight-col {
      display: flex;
      flex-direction: row;
      /* default horizontal on desktop */
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    /* mobile adaptation: stack vertical and put percentage above button */
    @media (max-width: 600px) {
      .swing-weight-col {
        flex-direction: column;
      }

      .swing-weight-tag {
        order: -1;
        /* show percent first */
      }

      .swing-item-name {
        font-size: .86rem;
        /* match simple method exactly */
      }
    }

    /* dark mode: make percentage badge more visible */
    @media (prefers-color-scheme: dark) {
      .swing-weight-tag {
        background: rgba(56, 189, 248, 0.28);
        color: #cffafe;
        /* lighter text for contrast */
      }

      .swing-item {
        background: linear-gradient(135deg, rgba(51, 65, 85, 0.90) 0%, rgba(30, 41, 59, 0.75) 100%);
        border-color: rgba(255, 255, 255, 0.14);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.40);
      }

      .swing-item:hover {
        box-shadow: 0 10px 32px rgba(0, 0, 0, 0.52);
      }
    }

    /* Badge poids swing dans step 3 */
    .swing-wtag {
      font-size: .62rem;
      background: var(--teal-bg);
      color: var(--teal);
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid var(--teal-bd);
      font-weight: 700;
      flex-shrink: 0;
    }

    @media (prefers-color-scheme: dark) {
      .swing-wtag {
        color: #14b8a6;
        background: rgba(20, 184, 166, 0.15);
        border-color: rgba(20, 184, 166, 0.35);
      }
    }

    /* FIN MODIF SWING */

    /* ── RESPONSIVE ──────────────────────────── */
    @media(max-width:640px) {
      .app-header {
        padding: 12px 16px;
      }

      .main {
        padding: 22px 16px 60px;
      }

      .intro-how {
        grid-template-columns: 1fr;
      }

      .sp-step span:not(.sp-num) {
        display: none;
      }

      .custom-row {
        grid-template-columns: 1fr 1fr;
      }

      .analysis-body {
        grid-template-columns: 1fr;
      }

      .an-col:first-child {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .notes-res-body {
        grid-template-columns: 1fr !important;
      }

      .note-col {
        border-right: none !important;
        border-bottom: 1px solid var(--border);
      }

      /* Scores cards — rank badge inline on mobile */
      .scores-row {
        grid-template-columns: 1fr !important;
      }

      .rank-badge {
        position: static;
        display: inline-flex;
        margin-bottom: 8px;
      }

      .sc-letter {
        padding-right: 0;
      }

      .eval-grid {
        grid-template-columns: 1fr !important;
      }

      .eval-col-name {
        font-size: .88rem;
      }

      /* Stepper: shrink buttons, tighten gap */
      .stepper {
        grid-template-columns: 38px 1fr 38px;
        gap: 6px;
      }

      .stepper-btn {
        width: 38px;
        height: 38px;
        font-size: 1.1rem;
      }

      /* Prevent pip row from pushing layout */
      .pip-row {
        gap: 3px;
      }

      .pip {
        border-radius: 3px;
      }

      /* Notes row single column */
      .notes-row {
        grid-template-columns: 1fr !important;
      }

      /* Critères sélectionnés — mobile : empilement propre, bouton à droite */
      .sel-item {
        padding-left: 16px;
        padding-right: 16px;
      }

      .sel-item .rm-btn {
        position: static;
        transform: none;
      }

      /* MODIF SWING — Cacher la poignée de drag sur mobile pour plus d'espace */
      .swing-drag-handle {
        display: none;
      }

      /* MODIF SWING — Aligner les boutons de méthode sur mobile */
      .method-lbl {
        flex-basis: 100%;
        text-align: center;
        margin-right: 0;
        margin-bottom: 6px;
      }

      .method-toggle-bar .method-btn {
        flex-grow: 1;
      }
    }

    @media print {
      body {
        background: #fff;
      }

      .app-header button,
      .res-actions,
      .btn-row {
        display: none !important;
      }

      .page {
        display: none !important;
      }

      #page-results {
        display: flex !important;
      }
    }

    /* ══════════════════════════════════════════
       PARTIE 1 — DARK MODE TOGGLE
       Bouton discret lune/soleil dans les headers
       ══════════════════════════════════════════ */

    /* Bouton toggle discret — icône lune/soleil */
    .dark-toggle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--glass-bg);
      border: 1px solid var(--border);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
      /* Transition douce sur tous les états */
      transition: background 0.2s ease, border-color 0.2s ease,
                  transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      -webkit-tap-highlight-color: transparent;
    }

    .dark-toggle:hover {
      background: var(--bg2);
      border-color: var(--border2);
      /* Légère rotation indique l'interactivité */
      transform: rotate(15deg) scale(1.1);
    }

    .dark-toggle:active {
      transform: rotate(30deg) scale(0.95);
    }

    /* ══════════════════════════════════════════
       PARTIE 3A — ANIMATIONS MICRO-INTERACTIONS
       ══════════════════════════════════════════ */

    /* Pulse sur le score live quand la valeur change */
    @keyframes scorePulse {
      0%   { transform: scale(1); }
      35%  { transform: scale(1.22);
             text-shadow: 0 0 12px currentColor; }
      65%  { transform: scale(0.96); }
      100% { transform: scale(1); }
    }

    .score-pulse {
      animation: scorePulse 0.38s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
    }

    /* Glow flash sur la barre de score live */
    @keyframes barGlow {
      0%   { box-shadow: none; }
      50%  { box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3); }
      100% { box-shadow: none; }
    }

    .bar-glow {
      animation: barGlow 0.4s ease both;
    }

    /* Fade-in slide-up pour l'ajout d'options / critères */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: none; }
    }

    .fade-in-up {
      animation: fadeInUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    /* Shake d'erreur amélioré */
    @keyframes shakeEnhanced {
      0%, 100% { transform: translateX(0); }
      15%       { transform: translateX(-6px); }
      30%       { transform: translateX(5px); }
      45%       { transform: translateX(-4px); }
      60%       { transform: translateX(3px); }
      75%       { transform: translateX(-2px); }
    }

    /* ══════════════════════════════════════════
       PARTIE 3B — BARRE FLUIDE AMÉLIORÉE
       Thumb indicator pour rendre le slider visible
       ══════════════════════════════════════════ */

    /* Conteneur barre fluid — on déborde pour le thumb */
    .fluid-bar {
      position: relative;
      overflow: visible !important;   /* override le overflow:hidden existant */
    }

    /* Fond de la barre (clip interne) */
    .fluid-bar-track {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: var(--border);
      overflow: hidden;
    }

    /* Thumb = indicateur de position draggable */
    .fluid-thumb {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid currentColor;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      pointer-events: none;         /* les événements passent au conteneur */
      transition: left 0.3s cubic-bezier(0.16, 1, 0.3, 1),
                  width 0.2s ease, height 0.2s ease,
                  box-shadow 0.2s ease;
      /* La couleur du bord est celle de la fill (propagée via color) */
      color: var(--teal);
      z-index: 2;
    }

    /* Au survol/drag, le thumb grossit légèrement */
    .fluid-bar:hover .fluid-thumb,
    .fluid-bar:active .fluid-thumb {
      width: 22px;
      height: 22px;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* ══════════════════════════════════════════
       PARTIE 3C — BARRE DE SCORE RÉSULTATS
       Gradient dynamique rouge → jaune → vert
       ══════════════════════════════════════════ */

    /* La couleur de la barre de score dans les cartes résultat
       est maintenant gérée via une variable CSS inline --sc-hue
       injectée par JS pour chaque option */
    .sc-score-bar-fill[style*="--sc-hue"] {
      /* Le gradient se base sur la teinte pour simuler rouge → vert */
      background: hsl(var(--sc-hue, 120), 60%, 48%) !important;
      transition: width 0.9s cubic-bezier(0.4, 0, 0.2, 1),
                  background 0.5s ease !important;
    }

    /* ══════════════════════════════════════════
       PARTIE 2 — AMÉLIORATIONS BUTTONS & FOCUS
       Glow hover sur .btn-primary
       ══════════════════════════════════════════ */

    /* Glow dynamique sur les boutons primaires — plus fort qu'avant */
    .btn-primary:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 8px 28px rgba(5, 150, 105, 0.42),
                  0 0 0 3px rgba(5, 150, 105, 0.15) !important;
    }

    /* Focus visible accessible (outline) sur tous les boutons */
    .btn:focus-visible,
    .stepper-btn:focus-visible,
    .dark-toggle:focus-visible {
      outline: 2.5px solid var(--teal);
      outline-offset: 3px;
    }

    /* Transition plus fluide sur les stepper-btn */
    .stepper-btn {
      transition: all 0.18s cubic-bezier(0.16, 1, 0.3, 1) !important;
    }

    /* Score bar animée au chargement des résultats */
    @keyframes barExpand {
      from { width: 0 !important; opacity: 0.6; }
      to   { opacity: 1; }
    }

    .sc-score-bar-fill {
      animation: barExpand 0.9s cubic-bezier(0.4, 0, 0.2, 1) both;
    }

    /* ══════════════════════════════════════════
       PARTIE 2 — SCORE LIVE COULEUR ÉVOLUTIVE
       Le score affiché dans l'en-tête d'option
       passe du rouge au vert selon la valeur
       ══════════════════════════════════════════ */

    /* La couleur est injectée via style="color:..." par JS */
    .eval-live-num {
      transition: color 0.35s ease, transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- ══════════════════════════ INTRO ══════════════════════════ -->
    <div class="page active" id="page-intro">
      <!-- Sélecteur de langue -->
      <button class="hist-btn-home" onclick="nav('page-history');renderHistory()">📜 <span
          data-i18n="hist_btn">Historique</span></button>
      <div class="lang-switcher">
        <button class="lang-btn active" id="btn-fr" onclick="setLang('fr')">FR</button>
        <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
      </div>
      <!-- Toggle thème discret — lune/soleil -->
      <button class="dark-toggle" onclick="cycleTheme()" id="darkToggle0" aria-label="Thème" title="Thème clair/sombre" style="position:absolute;top:20px;right:20px">🌙</button>
      <div class="intro-wrap">
        <div class="intro-inner">

          <!-- Hibou cartoon animé -->
          <div class="mascot-wrap">
            <lottie-player class="mascot" src="owl.json" background="transparent" speed="1" autoplay aria-hidden="true">
            </lottie-player>
          </div>

          <div class="intro-badge" data-i18n="badge">✦ Outil d'aide à la décision</div>
          <div class="intro-logo">Lucid<span>.</span></div>
          <div class="intro-tagline" data-i18n="tagline">Comparez vos options avec Lucid et prenez vos décisions en
            toute confiance.</div>

          <div class="intro-how">
            <div class="how-card">
              <div class="how-num">1</div>
              <div class="how-title" data-i18n="how1_title">Posez votre question</div>
              <div class="how-desc" data-i18n="how1_desc">Formulez votre situation et listez les options à comparer.
              </div>
            </div>
            <div class="how-card">
              <div class="how-num">2</div>
              <div class="how-title" data-i18n="how2_title">Choisissez vos critères</div>
              <div class="how-desc" data-i18n="how2_desc">Sélectionnez ce qui compte vraiment pour vous.</div>
            </div>
            <div class="how-card">
              <div class="how-num">3</div>
              <div class="how-title" data-i18n="how3_title">Obtenez votre analyse</div>
              <div class="how-desc" data-i18n="how3_desc">Lucid calcule les scores et vous présente un résultat clair.
              </div>
            </div>
          </div>

          <button class="intro-start-btn" onclick="nav('page-step1')" data-i18n="start_btn">Commencer →</button>
          <p style="margin-top:12px;font-size:.75rem;color:var(--muted2)" data-i18n="footer_note">Gratuit · Aucun compte
            requis · 100% privé</p>
        </div>
      </div>
    </div>

    <!-- ══════════════════════════ STEP 1 ══════════════════════════ -->
    <div class="page" id="page-step1">
      <div class="app-header">
        <div class="logo">
          <div class="logo-dot"></div>Lucid
        </div>
        <div class="step-progress" id="sp1"></div>
        <div class="lang-switcher" style="margin-left:auto;position:static">
          <button class="lang-btn active" id="btn-fr2" onclick="setLang('fr')">FR</button>
          <button class="lang-btn" id="btn-en2" onclick="setLang('en')">EN</button>
        </div>
        <button class="dark-toggle" onclick="cycleTheme()" aria-label="Thème" title="Thème clair/sombre" style="margin-left:8px">🌙</button>
      </div>
      <div class="page-scroll">
        <div class="main">
          <div class="page-eyebrow anim" data-i18n="s1_eyebrow">Étape 1 sur 3</div>
          <div class="page-title anim d1" data-i18n="s1_title">Quelle décision devez-vous prendre ?</div>
          <div class="page-sub anim d2" data-i18n="s1_sub">Formulez votre situation et renseignez les options que vous
            envisagez.</div>

          <div class="card decision-card anim d2">
            <div class="field" style="margin-bottom:0">
              <label for="inp-dec">📝 Votre décision en une phrase</label>
              <textarea id="inp-dec" rows="2"
                placeholder="Ex : Dois-je accepter ce nouvel emploi ou rester dans mon poste actuel ?"></textarea>
            </div>
          </div>

          <div class="anim d3">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
              <label style="font-size:.85rem;font-weight:700;color:var(--ink2)" data-i18n="opt_section_label">🔀 Vos
                options</label>
              <span id="opt-count-lbl"
                style="font-size:.75rem;color:var(--muted);background:var(--bg2);padding:3px 10px;border-radius:20px;font-weight:600">2
                options</span>
            </div>
            <div class="options-list" id="optBuilder"></div>
            <button class="add-option-btn" id="addOptBtn" onclick="addOption()">
              <div class="add-option-icon">+</div>
              <span data-i18n="opt_add_label">Ajouter une option</span> <span
                style="color:var(--muted2);font-weight:400" data-i18n="opt_add_max">(max 6)</span>
            </button>
          </div>

          <div class="btn-row anim d4">
            <button class="btn btn-secondary" onclick="nav('page-intro')" data-i18n="back_intro">← Retour</button>
            <button class="btn btn-primary" onclick="validateStep1()" data-i18n="s1_next">Choisir mes critères
              →</button>
          </div>
        </div>
      </div><!-- /page-scroll -->
    </div>

    <!-- ══════════════════════════ STEP 2 ══════════════════════════ -->
    <div class="page" id="page-step2">
      <div class="app-header">
        <div class="logo">
          <div class="logo-dot"></div>Lucid
        </div>
        <div class="step-progress" id="sp2"></div>
        <div class="lang-switcher">
          <button class="lang-btn active" id="btn-fr3" onclick="setLang('fr')">FR</button>
          <button class="lang-btn" id="btn-en3" onclick="setLang('en')">EN</button>
        </div>
        <button class="dark-toggle" onclick="cycleTheme()" aria-label="Thème" title="Thème clair/sombre" style="margin-left:8px">🌙</button>
      </div>
      <div class="page-scroll">
        <div class="main">
          <div class="page-eyebrow" data-i18n="s2_eyebrow">Étape 2 sur 3</div>
          <div class="page-title" data-i18n="s2_title">Qu'est-ce qui compte pour vous ?</div>
          <div class="page-sub" data-i18n="s2_sub">Sélectionnez les critères importants dans votre situation. Vous
            pouvez en choisir autant que vous voulez.</div>

          <div class="criteria-intro">
            <div class="criteria-intro-icon">💡</div>
            <div data-i18n="s2_hint">Cliquez sur les critères pour les sélectionner. Vous pourrez ensuite ajuster leur
              <strong>importance</strong> (poids) et choisir si un score élevé est positif ou négatif pour ce critère.
            </div>
          </div>

          <div class="cat-tabs" id="catTabs"></div>
          <div class="crit-grid" id="critGrid"></div>

          <div class="custom-form" id="customCritBox">
            <div class="custom-form-head" onclick="document.getElementById('customCritBox').classList.toggle('open')">
              <div class="custom-form-title" data-i18n="custom_title">✦ Ajouter un critère personnalisé</div>
              <div class="opt-chevron">▾</div>
            </div>
            <div class="custom-form-body">
              <div class="custom-row">
                <div class="field" style="margin:0"><label data-i18n="custom_name">Nom</label><input type="text"
                    id="cust-name" placeholder="Ex : Impact sur ma famille"></div>
                <div class="field" style="margin:0"><label data-i18n="custom_icon">Icône</label><input type="text"
                    id="cust-icon" placeholder="🎯" style="text-align:center"></div>
                <div class="field" style="margin:0">
                  <label data-i18n="custom_cat">Catégorie</label>
                  <select id="cust-cat">
                    <option>Finance</option>
                    <option>Pro</option>
                    <option selected>Perso</option>
                    <option>Social</option>
                    <option>Stratégique</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-secondary" style="margin-top:12px;font-size:.8rem;padding:9px 18px"
                onclick="addCustom()" data-i18n="custom_add">+ Ajouter ce critère</button>
            </div>
          </div>

          <div class="selected-box">
            <div class="selected-box-head">
              <h3 data-i18n="sel_title">✅ Critères sélectionnés</h3>
              <div class="sel-count" id="crit-badge">0</div>
            </div>
            <div class="sel-list" id="activeList">
              <div class="empty-hint" data-i18n="sel_empty">👆 Sélectionnez au moins 2 critères ci-dessus pour continuer
              </div>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn btn-secondary" onclick="nav('page-step1')" data-i18n="back">← Retour</button>
            <button class="btn btn-primary" onclick="validateStep2()" data-i18n="s2_next">Évaluer mes options →</button>
          </div>
        </div>
      </div><!-- /page-scroll -->
    </div>

    <!-- ══════════════════════════ STEP 3 ══════════════════════════ -->
    <div class="page" id="page-step3">
      <div class="app-header">
        <div class="logo">
          <div class="logo-dot"></div>Lucid
        </div>
        <div class="step-progress" id="sp3"></div>
        <div class="lang-switcher">
          <button class="lang-btn active" id="btn-fr4" onclick="setLang('fr')">FR</button>
          <button class="lang-btn" id="btn-en4" onclick="setLang('en')">EN</button>
        </div>
        <button class="dark-toggle" onclick="cycleTheme()" aria-label="Thème" title="Thème clair/sombre" style="margin-left:8px">🌙</button>
      </div>
      <div class="page-scroll">
        <div class="main">
          <div class="page-eyebrow" data-i18n="s3_eyebrow">Étape 3 sur 3</div>
          <div class="page-title" id="eval-title" data-i18n="s3_title">Notez chaque option</div>
          <div class="page-sub" data-i18n="s3_sub">Pour chaque critère, donnez une note de <strong>1</strong> (très
            faible) à <strong>10</strong> (excellent) à chaque option. Le score global se met à jour en direct.</div>

          <div class="eval-grid" id="evalGrid"></div>
          <div class="notes-row" id="notesRow"></div>

          <div class="btn-row">
            <button class="btn btn-secondary" onclick="nav('page-step2')" data-i18n="back">← Retour</button>
            <button class="btn btn-primary" onclick="showResults()" data-i18n="s3_next">Voir mon analyse →</button>
          </div>
        </div>
      </div><!-- /page-scroll -->
    </div>

    <!-- ══════════════════════════ HISTORY ══════════════════════════ -->
    <div class="page" id="page-history">
      <div class="app-header">
        <div class="logo">
          <div class="logo-dot"></div>Lucid
        </div>
        <div class="lang-switcher" style="margin-left:auto">
          <button class="lang-btn active" id="btn-fr6" onclick="setLang('fr')">FR</button>
          <button class="lang-btn" id="btn-en6" onclick="setLang('en')">EN</button>
        </div>
        <button class="dark-toggle" onclick="cycleTheme()" aria-label="Thème" title="Thème clair/sombre" style="margin-left:8px">🌙</button>
      </div>
      <div class="page-scroll">
        <div class="main">
          <div class="page-eyebrow" data-i18n="hist_eyebrow">Vos décisions</div>
          <div class="page-title" data-i18n="hist_title">Historique & Insights</div>

          <div id="insightsArea"></div>

          <div class="res-divider"><span class="res-divider-label" data-i18n="hist_list_title">Décisions
              archivées</span></div>
          <div class="hist-list" id="histList"></div>

          <div class="btn-row">
            <button class="btn btn-secondary" onclick="nav('page-intro')" data-i18n="back_intro">← Retour à
              l'accueil</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ══════════════════════════ RESULTS ══════════════════════════ -->
    <div class="page" id="page-results">
      <div class="app-header">
        <div class="logo">
          <div class="logo-dot"></div>Lucid
        </div>
        <div class="step-progress" id="sp4"></div>
        <div class="lang-switcher">
          <button class="lang-btn active" id="btn-fr5" onclick="setLang('fr')">FR</button>
          <button class="lang-btn" id="btn-en5" onclick="setLang('en')">EN</button>
        </div>
        <button class="dark-toggle" onclick="cycleTheme()" aria-label="Thème" title="Thème clair/sombre" style="margin-left:8px">🌙</button>
      </div>
      <div class="page-scroll" id="resScroll">
        <div id="resContent"></div>
      </div>
    </div>

  </div>

  <script>
    /* ══════════════════════════════════════════
       DARK MODE TOGGLE (manuel)
       Cycle : auto → dark → light → auto
       Persistance via localStorage
       ══════════════════════════════════════════ */

    /** Retourne l'icône emoji selon le thème actif */
    function _themeIcon(t) {
      return t === 'dark' ? '☀️' : t === 'light' ? '🌙' : '🌓';
    }

    /** Applique le thème sur <html> et met à jour tous les boutons toggle */
    function applyTheme(t) {
      const html = document.documentElement;
      // 'auto' = pas d'attribut (le media-query prend le relais)
      if (t === 'auto')       html.removeAttribute('data-theme');
      else if (t === 'dark')  html.setAttribute('data-theme', 'dark');
      else                    html.setAttribute('data-theme', 'light');

      // Mise à jour de l'icône sur tous les boutons toggle de la page
      document.querySelectorAll('.dark-toggle').forEach(btn => {
        btn.textContent = _themeIcon(t);
        btn.title = t === 'dark'  ? 'Mode sombre (cliquer pour clair)'
                  : t === 'light' ? 'Mode clair (cliquer pour auto)'
                  : 'Mode auto (cliquer pour sombre)';
      });
    }

    /** Cycle : auto → dark → light → auto */
    function cycleTheme() {
      const cur = localStorage.getItem('lucid-theme') || 'auto';
      const next = cur === 'auto' ? 'dark' : cur === 'dark' ? 'light' : 'auto';
      localStorage.setItem('lucid-theme', next);
      applyTheme(next);
    }

    // Initialisation au chargement
    (function initTheme() {
      const saved = localStorage.getItem('lucid-theme') || 'auto';
      applyTheme(saved);
    })();

    /* ══════════════════════════════════════════
       SCORE COLOR HELPER
       Retourne une couleur hsl selon un score 0-100
       (rouge → jaune → vert) pour jauges et live scores
       ══════════════════════════════════════════ */

    /** t ∈ [0,1] → hue 0-120 → couleur hsl lisible sur fond clair et sombre */
    function scoreColor(score100) {
      const t = Math.max(0, Math.min(100, score100)) / 100;
      const hue = Math.round(t * 120); // 0 = rouge, 60 = jaune, 120 = vert
      // lightness adaptée au mode sombre
      const dark = document.documentElement.getAttribute('data-theme') === 'dark'
                || (!document.documentElement.hasAttribute('data-theme')
                    && window.matchMedia('(prefers-color-scheme: dark)').matches);
      const l = dark ? 58 : 44;
      return `hsl(${hue}, 62%, ${l}%)`;
    }

    /* ─── I18N ───────────────────────────────── */
    let LANG = 'fr';

    const T = {
      fr: {
        /* Intro */
        badge: '✦ Outil d\'aide à la décision',
        tagline: 'Comparez vos options avec Lucid et prenez vos décisions en toute confiance.',
        how1_title: 'Posez votre question',
        how1_desc: 'Formulez votre situation et listez les options à comparer.',
        how2_title: 'Choisissez vos critères',
        how2_desc: 'Sélectionnez ce qui compte vraiment pour vous.',
        how3_title: 'Obtenez votre analyse',
        how3_desc: 'Lucid calcule les scores et vous présente un résultat clair.',
        start_btn: 'Commencer →',
        footer_note: 'Gratuit · Aucun compte requis · 100% privé',
        hist_btn: 'Historique',
        /* Step 1 */
        s1_eyebrow: 'Étape 1 sur 3',
        s1_title: 'Quelle décision devez-vous prendre ?',
        s1_sub: 'Formulez votre situation et renseignez les options que vous envisagez.',
        s1_next: 'Choisir mes critères →',
        back_intro: '← Retour',
        inp_dec_lbl: '📝 Votre décision en une phrase',
        inp_dec_ph: 'Ex : Dois-je accepter ce nouvel emploi ou rester dans mon poste actuel ?',
        opt_name_lbl: 'Nom de l\'option',
        opt_name_ph: 'Ex : Rester à Paris',
        opt_desc_lbl: 'Description courte',
        opt_desc_opt: '(optionnel)',
        opt_desc_ph: 'Ex : Stabilité, famille proche…',
        opt_add: '+ Ajouter une option',
        opt_section_label: '🔀 Vos options',
        opt_add_label: 'Ajouter une option',
        opt_add_max: '(max 6)',
        err_name: 'Veuillez donner un nom à chaque option.',
        /* Step 2 */
        s2_eyebrow: 'Étape 2 sur 3',
        s2_title: 'Qu\'est-ce qui compte pour vous ?',
        s2_sub: 'Sélectionnez les critères importants dans votre situation. Vous pouvez en choisir autant que vous voulez.',
        s2_hint: 'Cliquez sur les critères pour les sélectionner. Vous pourrez ensuite ajuster leur <strong>importance</strong> (poids) et choisir si un score élevé est positif ou négatif pour ce critère.',
        custom_title: '✦ Ajouter un critère personnalisé',
        custom_name: 'Nom',
        custom_icon: 'Icône',
        custom_cat: 'Catégorie',
        custom_add: '+ Ajouter ce critère',
        custom_ph: 'Ex : Impact sur ma famille',
        sel_title: '✅ Critères sélectionnés',
        sel_empty: '👆 Sélectionnez au moins 2 critères ci-dessus pour continuer',
        back: '← Retour',
        s2_next: 'Évaluer mes options →',
        err_crit: 'Veuillez sélectionner au moins 2 critères.',
        lbl_importance: 'Importance',
        lbl_sens: 'Sens',
        inv_off: 'Normal',
        inv_on: 'Inversé',
        inv_tip_off: 'Actuellement : score élevé = bon',
        inv_tip_on: 'Actuellement : score élevé = mauvais',
        inv_tag: 'inversé',
        /* Step 3 */
        s3_eyebrow: 'Étape 3 sur 3',
        s3_title: 'Notez chaque option',
        s3_sub: 'Pour chaque critère, donnez une note de <strong>1</strong> (très faible) à <strong>10</strong> (excellent) à chaque option. Le score global se met à jour en direct.',
        s3_next: 'Voir mon analyse →',
        notes_ph: '💭 Notes personnelles sur cette option…',
        notes_lbl: (ltr, name) => `Notes libres — Option ${ltr} (${name})`,
        /* Results */
        res_eyebrow: '✦ Votre analyse',
        save_track: '💾 Enregistrer & Suivre',
        save_done: '✅ Décision archivée !',
        export_pdf: '🖨️ Exporter en PDF',
        new_decision: '↺ Nouvelle décision',
        back_notes: '← Modifier mes notes',
        res_tie_title: 'Résultat très serré !',
        res_tie_sub: (diff) => `Seulement ${diff} point${diff > 1 ? 's' : ''} d'écart — les deux premières options sont quasiment équivalentes. Faites confiance à votre intuition.`,
        res_win_sub: (diff) => `Avantage de ${diff} points sur vos critères pondérés. N'oubliez pas de prendre en compte vos notes et votre ressenti.`,
        rank_labels: ['🥇 1ère option', '🥈 2ème option', '🥉 3ème option'],
        div_scores: 'Scores',
        div_visual: 'Profil visuel',
        div_detail: 'Détail par critère',
        div_synth: 'Synthèse',
        div_notes: 'Notes personnelles',
        div_explore: 'Exploration',
        bk_crit: 'Critère',
        interp_title: 'Interprétation personnalisée',
        analysis_title: 'Analyse synthétique',
        analysis_badge: 'Automatique',
        pros_title: (name) => `✦ Points forts de "${name}"`,
        cons_title: '⚠ Points d\'attention',
        no_notes: 'Aucune note',
        notes_head: '📝 Vos notes personnelles',
        fear_title: 'Et si la peur n\'était pas un facteur ?',
        fear_sub: 'Lucid masque les critères liés au risque et à la prudence pour révéler votre choix sans biais de peur.',
        scenario_title: 'Testez vos scénarios',
        scenario_sub: 'Activez ou désactivez des critères pour recalculer les scores instantanément.',
        scenario_reset: 'Tout réactiver',
        scenario_active: (a, t) => `${a} / ${t} critères actifs`,
        sc_inv: '↓ inversé',
        sc_toggle_on: 'Désactiver ce critère',
        sc_toggle_off: 'Activer ce critère',
        /* History */
        hist_eyebrow: 'Vos décisions',
        hist_title: 'Historique & Insights',
        hist_list_title: 'Décisions archivées',
        hist_empty: 'Aucune décision archivée pour le moment.',
        hist_pending: 'À suivre',
        hist_reviewed: 'Revue',
        hist_update_btn: 'Mettre à jour le résultat',
        hist_upd_title: 'Mise à jour du résultat',
        hist_upd_desc: 'Avec le recul, comment évaluez-vous l\'option choisie ?',
        hist_global_score: 'Note globale actuelle (1-10)',
        hist_comment: 'Commentaire (Qu\'est-ce qui s\'est passé ?)',
        hist_save_upd: 'Enregistrer le suivi',
        hist_edit_decision: 'Reprendre cette décision',
        hist_delete: 'Supprimer',
        hist_delete_confirm: 'Supprimer définitivement cette décision de votre historique ?',
        ins_title: 'Insights personnels',
        ins_optimism: (delta) => `Vous avez tendance à être <strong>${delta > 0 ? 'pessimiste' : 'optimiste'}</strong> : vos résultats réels sont en moyenne ${Math.abs(delta)} pts ${delta > 0 ? 'supérieurs' : 'inférieurs'} à vos prévisions.`,
        ins_blindspot: (crit) => `Attention au critère <strong>"${crit}"</strong> : c'est souvent là que la réalité déçoit par rapport à l'attente.`,
        ins_winner: (pct) => `Dans <strong>${pct}%</strong> des cas, vous confirmez que l'option gagnante était bien la bonne.`,
        ins_nodata: 'Archivez et mettez à jour au moins 2 décisions pour débloquer vos insights personnels.',
        /* Scenario insights */
        sc_all_active: `✅ Tous les critères sont actifs — c'est votre analyse complète, sans filtre.`,
        sc_switched: (dis, newN, gainSign, oldN, s, p1, p2) => `🔄 Sans ${dis}, le classement <strong>s'inverse</strong> : <strong>"${newN}"</strong> passe en tête (${gainSign} pts), devant <strong>"${oldN}"</strong>. Ce${s} critère${s} ${p1} donc un rôle décisif en faveur de l'option initiale.`,
        sc_reduced: (winN, gapDiff, dis, s, p2) => `⚠️ <strong>"${winN}"</strong> reste en tête, mais son avantage se réduit de <strong>${gapDiff} points</strong> sans ${dis}. Ce${s} critère${s} ${p2} une part importante de son avance — la décision serait plus serrée sans ${s ? 'eux' : 'lui'}.`,
        sc_wider: (winN, extra, dis, s, p3) => `✅ Sans ${dis}, <strong>"${winN}"</strong> se détache encore davantage (+${extra} pts d'écart supplémentaires). Ce${s} critère${s} ${p3} — son avance repose sur d'autres facteurs.`,
        sc_diverge: (gN, gd, lN, ld, dis, p4) => `📊 Ce scénario révèle une divergence nette : <strong>"${gN}"</strong> gagne +${gd} pts tandis que <strong>"${lN}"</strong> en perd ${ld}. ${dis} ${p4} donc différemment sur chaque option.`,
        sc_nochange: (dis, max, s, p5) => `📌 Désactiver ${dis} ne change presque rien aux scores (moins de ${max} pts d'écart). Ce${s} critère${s} ${p5} dans cette décision — les autres facteurs portent l'essentiel du résultat.`,
        sc_fallback: (dis, impN, sign, s, p6) => `🎯 Sans ${dis}, l'option la plus impactée est <strong>"${impN}"</strong> (${sign} pts). Le classement reste identique, mais ce scénario montre à quel point ce${s} critère${s} ${p6} la position de cette option.`,
        /* Fear panel */
        fear_toggle_lbl_on: '🎭 Critères masqués (liés à la peur)',
        fear_toggle_lbl_off: '🔍 Critères détectés comme liés à la peur',
        fear_none: "Aucun critère lié à la peur ou au risque n'a été sélectionné dans votre analyse.",
        fear_score_real: 'Score réel',
        fear_score_fearless: 'Sans peur',
        fear_delta_lbl: (sign, d) => `${sign}${d} pts sans peur`,
        fear_switched: (fearlessN, normalN) => `💡 Sans les critères de prudence, <strong>"${fearlessN}"</strong> passerait en tête — alors que <strong>"${normalN}"</strong> gagne dans l'analyse complète. Ce que cela révèle : <strong>c'est probablement la peur qui oriente votre décision vers "${normalN}"</strong>. Est-ce un choix voulu ou un réflexe de prudence ?`,
        fear_gains: (optN, pts) => `💡 Le classement ne change pas, mais <strong>"${optN}"</strong> gagne <strong>${pts} points</strong> une fois la peur mise de côté. Votre intuition profonde lui est plus favorable que vos chiffres actuels ne le montrent.`,
        fear_loses: (optN, pts) => `💡 Le classement ne change pas, mais <strong>"${optN}"</strong> perd <strong>${pts} points</strong> une fois la peur mise de côté. La prudence vous protège mais pèse aussi sur cette option.`,
        fear_consistent: '💡 Le classement reste identique avec ou sans les critères de peur. Votre décision semble cohérente — elle n\'est pas fortement biaisée par la prudence.',
        /* Step progress */
        sp_labels: ['Mes options', 'Mes critères', 'Mes notes'],
        /* Weights */
        weights: { 1: '×1 Normal', 2: '×2 Important', 3: '×3 Crucial' },
        /* CATS */
        cats: ['Tous', 'Finance', 'Pro', 'Perso', 'Social', 'Stratégique'],
        /* AI prompt lang */
        ai_lang: 'français',
        /* genAnalysis */
        an_score_high: (name, v, w) => `Score élevé sur « ${name} » (${v}/10)${w > 1 ? ` — critère d'importance ×${w}` : ''}. `,
        an_clear: (diff) => `Avantage significatif de ${diff} points — la recommandation est claire.`,
        an_tight: 'Résultat serré — d\'autres facteurs non quantifiables peuvent faire la différence.',
        an_runner: (rName, cName, vR, vW) => `"${rName}" fait mieux sur « ${cName} » (${vR} vs ${vW}).`,
        an_weak: (cName, v, wName) => `Critère crucial « ${cName} » : score faible pour "${wName}" (${v}/10) — à surveiller.`,
        an_no_cons: 'Pas de faiblesse critique identifiée — l\'option est solide sur tous les critères.',
        /* opt builder */
        opt_label: (ltr) => `Option ${ltr}`,
        opt_count: (n) => `${n} option${n > 1 ? 's' : ''}`,
        /* eval */
        eval_title: (dec) => `Notez vos options pour : "${dec}"`,
        /* MODIF SWING */
        swing_method_simple: 'Méthode simple',
        swing_method_swing: '⚖️ Méthode ROC',
        swing_info: 'ℹ️ Classez vos critères du plus (n°1) au moins important. Les poids sont calculés automatiquement via une méthode scientifique (ROC) pour une décroissance naturelle.',
        swing_weight_lbl: 'Poids calculé',
        /* FIN MODIF SWING */
      },
      en: {
        /* Intro */
        badge: '✦ Decision-making tool',
        tagline: 'Compare your options with Lucid and make decisions with confidence.',
        how1_title: 'State your question',
        how1_desc: 'Describe your situation and list the options to compare.',
        how2_title: 'Choose your criteria',
        how2_desc: 'Select what truly matters to you.',
        how3_title: 'Get your analysis',
        how3_desc: 'Lucid calculates scores and presents a clear result.',
        start_btn: 'Get started →',
        footer_note: 'Free · No account required · 100% private',
        hist_btn: 'History',
        /* Step 1 */
        s1_eyebrow: 'Step 1 of 3',
        s1_title: 'What decision are you facing?',
        s1_sub: 'Describe your situation and enter the options you are considering.',
        s1_next: 'Choose my criteria →',
        back_intro: '← Back',
        inp_dec_lbl: '📝 Your decision in one sentence',
        inp_dec_ph: 'e.g. Should I accept this new job or stay in my current position?',
        opt_name_lbl: 'Option name',
        opt_name_ph: 'e.g. Stay in Paris',
        opt_desc_lbl: 'Short description',
        opt_desc_opt: '(optional)',
        opt_desc_ph: 'e.g. Stability, family nearby…',
        opt_add: '+ Add an option',
        opt_section_label: '🔀 Your options',
        opt_add_label: 'Add an option',
        opt_add_max: '(max 6)',
        err_name: 'Please give a name to each option.',
        /* Step 2 */
        s2_eyebrow: 'Step 2 of 3',
        s2_title: 'What matters to you?',
        s2_sub: 'Select the criteria that are important in your situation. You can choose as many as you want.',
        s2_hint: 'Click on criteria to select them. You can then adjust their <strong>importance</strong> (weight) and choose whether a high score is positive or negative for that criterion.',
        custom_title: '✦ Add a custom criterion',
        custom_name: 'Name',
        custom_icon: 'Icon',
        custom_cat: 'Category',
        custom_add: '+ Add this criterion',
        custom_ph: 'e.g. Impact on my family',
        sel_title: '✅ Selected criteria',
        sel_empty: '👆 Select at least 2 criteria above to continue',
        back: '← Back',
        s2_next: 'Evaluate my options →',
        err_crit: 'Please select at least 2 criteria.',
        lbl_importance: 'Importance',
        lbl_sens: 'Direction',
        inv_off: 'Normal',
        inv_on: 'Inverted',
        inv_tip_off: 'Currently: high score = good',
        inv_tip_on: 'Currently: high score = bad',
        inv_tag: 'inverted',
        /* Step 3 */
        s3_eyebrow: 'Step 3 of 3',
        s3_title: 'Rate each option',
        s3_sub: 'For each criterion, give a score from <strong>1</strong> (very low) to <strong>10</strong> (excellent) for each option. The overall score updates live.',
        s3_next: 'See my analysis →',
        notes_ph: '💭 Personal notes on this option…',
        notes_lbl: (ltr, name) => `Free notes — Option ${ltr} (${name})`,
        /* Results */
        res_eyebrow: '✦ Your analysis',
        save_track: '💾 Save & Track',
        save_done: '✅ Decision archived!',
        export_pdf: '🖨️ Export as PDF',
        new_decision: '↺ New decision',
        back_notes: '← Edit my scores',
        res_tie_title: 'Very close result!',
        res_tie_sub: (diff) => `Only ${diff} point${diff > 1 ? 's' : ''} apart — the top two options are nearly equivalent. Trust your instincts.`,
        res_win_sub: (diff) => `${diff}-point advantage on your weighted criteria. Don't forget to factor in your notes and gut feeling.`,
        rank_labels: ['🥇 1st option', '🥈 2nd option', '🥉 3rd option'],
        div_scores: 'Scores',
        div_visual: 'Visual profile',
        div_detail: 'Criterion breakdown',
        div_synth: 'Summary',
        div_notes: 'Personal notes',
        div_explore: 'Explore further',
        bk_crit: 'Criterion',
        interp_title: 'Personalised interpretation',
        analysis_title: 'Summary analysis',
        analysis_badge: 'Automatic',
        pros_title: (name) => `✦ Strengths of "${name}"`,
        cons_title: '⚠ Points of attention',
        no_notes: 'No notes',
        notes_head: '📝 Your personal notes',
        fear_title: 'What if fear wasn\'t a factor?',
        fear_sub: 'Lucid hides risk and caution-related criteria to reveal your choice without fear bias.',
        scenario_title: 'Test your scenarios',
        scenario_sub: 'Enable or disable criteria to instantly recalculate scores.',
        scenario_reset: 'Re-enable all',
        scenario_active: (a, t) => `${a} / ${t} active criteria`,
        sc_inv: '↓ inverted',
        sc_toggle_on: 'Disable this criterion',
        sc_toggle_off: 'Enable this criterion',
        /* History */
        hist_eyebrow: 'Your decisions',
        hist_title: 'History & Insights',
        hist_list_title: 'Archived decisions',
        hist_empty: 'No archived decisions yet.',
        hist_pending: 'Pending',
        hist_reviewed: 'Reviewed',
        hist_update_btn: 'Update outcome',
        hist_upd_title: 'Update outcome',
        hist_upd_desc: 'In hindsight, how do you rate the chosen option?',
        hist_global_score: 'Current global score (1-10)',
        hist_comment: 'Comment (What happened?)',
        hist_save_upd: 'Save follow-up',
        hist_edit_decision: 'Resume this decision',
        hist_delete: 'Delete',
        hist_delete_confirm: 'Permanently delete this decision from your history?',
        ins_title: 'Personal Insights',
        ins_optimism: (delta) => `You tend to be <strong>${delta > 0 ? 'pessimistic' : 'optimistic'}</strong>: actual results are on average ${Math.abs(delta)} pts ${delta > 0 ? 'higher' : 'lower'} than predicted.`,
        ins_blindspot: (crit) => `Watch out for <strong>"${crit}"</strong>: reality often disappoints expectations on this criterion.`,
        ins_winner: (pct) => `In <strong>${pct}%</strong> of cases, you confirm that the winning option was indeed the right choice.`,
        ins_nodata: 'Archive and update at least 2 decisions to unlock your personal insights.',
        /* Scenario insights */
        sc_all_active: '✅ All criteria are active — this is your complete, unfiltered analysis.',
        sc_switched: (dis, newN, gainSign, oldN, s, p1, p2) => `🔄 Without ${dis}, the ranking <strong>flips</strong>: <strong>"${newN}"</strong> takes the lead (${gainSign} pts), ahead of <strong>"${oldN}"</strong>. ${s} ${p1} therefore played a decisive role in favour of the original option.`,
        sc_reduced: (winN, gapDiff, dis, s, p2) => `⚠️ <strong>"${winN}"</strong> stays on top, but its lead shrinks by <strong>${gapDiff} points</strong> without ${dis}. ${s} ${p2} a significant part of its advantage — the decision would be closer without ${LANG === 'en' ? 'it/them' : 'it/them'}.`,
        sc_wider: (winN, extra, dis, s, p3) => `✅ Without ${dis}, <strong>"${winN}"</strong> pulls even further ahead (+${extra} pts extra gap). ${s} ${p3} — its lead rests on other factors.`,
        sc_diverge: (gN, gd, lN, ld, dis, p4) => `📊 This scenario reveals a clear divergence: <strong>"${gN}"</strong> gains +${gd} pts while <strong>"${lN}"</strong> loses ${ld}. ${dis} ${p4} differently on each option.`,
        sc_nochange: (dis, max, s, p5) => `📌 Disabling ${dis} barely changes the scores (less than ${max} pts difference). ${s} ${p5} — the other factors carry most of the result.`,
        sc_fallback: (dis, impN, sign, s, p6) => `🎯 Without ${dis}, the most impacted option is <strong>"${impN}"</strong> (${sign} pts). The ranking stays the same, but this scenario shows how much ${s} ${p6} this option's position.`,
        /* Fear panel */
        fear_toggle_lbl_on: '🎭 Hidden criteria (fear-related)',
        fear_toggle_lbl_off: '🔍 Criteria detected as fear-related',
        fear_none: 'No fear- or risk-related criteria were selected in your analysis.',
        fear_score_real: 'Real score',
        fear_score_fearless: 'Fear-free',
        fear_delta_lbl: (sign, d) => `${sign}${d} pts fear-free`,
        fear_switched: (fearlessN, normalN) => `💡 Without caution criteria, <strong>"${fearlessN}"</strong> would take the lead — while <strong>"${normalN}"</strong> wins in the full analysis. What this reveals: <strong>it's likely fear that steers your decision toward "${normalN}"</strong>. Is this a deliberate choice or a reflex of caution?`,
        fear_gains: (optN, pts) => `💡 The ranking doesn't change, but <strong>"${optN}"</strong> gains <strong>${pts} points</strong> once fear is set aside. Your deeper intuition is more favourable to it than your current numbers show.`,
        fear_loses: (optN, pts) => `💡 The ranking doesn't change, but <strong>"${optN}"</strong> loses <strong>${pts} points</strong> once fear is set aside. Caution protects you but also weighs on this option.`,
        fear_consistent: '💡 The ranking stays the same with or without fear criteria. Your decision seems consistent — it is not strongly biased by caution.',
        /* Step progress */
        sp_labels: ['My options', 'My criteria', 'My scores'],
        /* Weights */
        weights: { 1: '×1 Normal', 2: '×2 Important', 3: '×3 Critical' },
        /* CATS */
        cats: ['All', 'Finance', 'Work', 'Personal', 'Social', 'Strategic'],
        /* AI prompt lang */
        ai_lang: 'English',
        /* genAnalysis */
        an_score_high: (name, v, w) => `High score on "${name}" (${v}/10)${w > 1 ? ` — importance ×${w}` : ''}. `,
        an_clear: (diff) => `Significant ${diff}-point advantage — the recommendation is clear.`,
        an_tight: 'Close result — other non-quantifiable factors may make the difference.',
        an_runner: (rName, cName, vR, vW) => `"${rName}" performs better on "${cName}" (${vR} vs ${vW}).`,
        an_weak: (cName, v, wName) => `Critical criterion "${cName}": low score for "${wName}" (${v}/10) — worth monitoring.`,
        an_no_cons: 'No critical weakness identified — the option is solid across all criteria.',
        /* opt builder */
        opt_label: (ltr) => `Option ${ltr}`,
        opt_count: (n) => `${n} option${n > 1 ? 's' : ''}`,
        /* eval */
        eval_title: (dec) => `Rate your options for: "${dec}"`,
        /* MODIF SWING */
        swing_method_simple: 'Simple method',
        swing_method_swing: '⚖️ ROC Weighting',
        swing_info: 'ℹ️ Rank your criteria from most (#1) to least important. Weights are automatically calculated using a scientific method (ROC) for a natural decay.',
        swing_weight_lbl: 'Calculated Weight',
        /* FIN MODIF SWING */
      }
    };

    /* LIB EN — English criterion names */
    const LIB_EN = {
      fin_gain: { name: 'Financial gain', hint: 'Revenue, salary, profits' },
      fin_risk: { name: 'Financial risk', hint: 'Potential losses, debts' },
      roi: { name: 'Return on investment', hint: 'ROI in the medium/long term' },
      cost: { name: 'Initial cost', hint: 'Upfront investment' },
      fin_stab: { name: 'Financial stability', hint: 'Income security' },
      career: { name: 'Career growth', hint: 'Professional prospects' },
      skills: { name: 'Skill development', hint: 'Learning, upskilling' },
      workload: { name: 'Workload', hint: 'Volume and intensity of work' },
      jobsec: { name: 'Job security', hint: 'Stability and sustainability' },
      autonom: { name: 'Autonomy', hint: 'Freedom to act and decide' },
      flex: { name: 'Schedule flexibility', hint: 'Remote work, flexible hours' },
      recog: { name: 'Recognition', hint: 'Appreciation, prestige' },
      wellb: { name: 'Personal well-being', hint: 'Happiness, fulfilment' },
      stress: { name: 'Stress level', hint: 'Pressure, anxiety generated' },
      health: { name: 'Health impact', hint: 'Effects on physical/mental health' },
      time: { name: 'Free time', hint: 'Leisure, rest, time for yourself' },
      values: { name: 'Values alignment', hint: 'Coherence with your principles' },
      passion: { name: 'Passion & interest', hint: 'Intrinsic motivation' },
      risk: { name: 'Overall risk', hint: 'Uncertainty, exposure to danger' },
      family: { name: 'Family impact', hint: 'Effects on relationships & family life' },
      social: { name: 'Social life', hint: 'Friendships, social environment' },
      ethics: { name: 'Ethics & values', hint: 'Coherence with your moral convictions' },
      repute: { name: 'Reputation', hint: 'Image, social perception' },
      env: { name: 'Environmental impact', hint: 'Ecological footprint' },
      vision: { name: 'Long-term vision', hint: 'Alignment with your 5–10 year goals' },
      innov: { name: 'Innovation', hint: 'Creative potential, disruption' },
      impact: { name: 'Impact & meaning', hint: 'Positive contribution to society' },
      speed: { name: 'Speed of execution', hint: 'Time to results' },
      rev: { name: 'Reversibility', hint: 'Ease of going back' },
      complex: { name: 'Complexity', hint: 'Difficulty of implementation' },
      dep: { name: 'Dependencies', hint: 'Constraints linked to other factors' },
    };

    function tr(key, ...args) {
      const val = T[LANG][key];
      if (typeof val === 'function') return val(...args);
      return val ?? T['fr'][key] ?? key;
    }

    function setLang(lang) {
      LANG = lang;
      /* Toggle active button — all headers */
      ['btn-fr', 'btn-fr2', 'btn-fr3', 'btn-fr4', 'btn-fr5', 'btn-fr6'].forEach(id => {
        const el = document.getElementById(id); if (el) el.classList.toggle('active', lang === 'fr');
      });
      ['btn-en', 'btn-en2', 'btn-en3', 'btn-en4', 'btn-en5', 'btn-en6'].forEach(id => {
        const el = document.getElementById(id); if (el) el.classList.toggle('active', lang === 'en');
      });

      /* Update all static data-i18n elements */
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const val = T[lang][key];
        if (val !== undefined && typeof val === 'string') el.innerHTML = val;
      });

      /* Update placeholders with data-i18n-ph */
      document.querySelectorAll('[data-i18n-ph]').forEach(el => {
        const key = el.getAttribute('data-i18n-ph');
        const val = T[lang][key];
        if (val) el.placeholder = val;
      });

      /* Update select label in inp-dec */
      const decLbl = document.querySelector('label[for="inp-dec"]');
      if (decLbl) decLbl.textContent = tr('inp_dec_lbl');
      const decInp = document.getElementById('inp-dec');
      if (decInp) decInp.placeholder = tr('inp_dec_ph');

      /* Update custom form placeholder */
      const custName = document.getElementById('cust-name');
      if (custName) custName.placeholder = tr('custom_ph');

      /* Update CATS & WEIGHTS globals */
      CATS.length = 0;
      tr('cats').forEach(c => CATS.push(c));
      Object.assign(WEIGHTS, tr('weights'));

      /* Update LIB names/hints if EN */
      LIB.forEach(c => {
        if (lang === 'en' && LIB_EN[c.id]) {
          c._name_fr = c._name_fr || c.name;
          c._hint_fr = c._hint_fr || c.hint;
          c.name = LIB_EN[c.id].name;
          c.hint = LIB_EN[c.id].hint;
          c.cat = ['Finance', 'Pro', 'Perso', 'Social', 'Stratégique'].indexOf(c.cat) >= 0
            ? ['Finance', 'Work', 'Personal', 'Social', 'Strategic'][['Finance', 'Pro', 'Perso', 'Social', 'Stratégique'].indexOf(c.cat)]
            : c.cat;
        } else if (lang === 'fr') {
          if (c._name_fr) { c.name = c._name_fr; c.hint = c._hint_fr; }
          c.cat = ['Finance', 'Work', 'Personal', 'Social', 'Strategic'].indexOf(c.cat) >= 0
            ? ['Finance', 'Pro', 'Perso', 'Social', 'Stratégique'][['Finance', 'Work', 'Personal', 'Social', 'Strategic'].indexOf(c.cat)]
            : c.cat;
        }
      });

      /* Also update selected criteria names */
      S.criteria.forEach(c => {
        const orig = LIB.find(l => l.id === c.id);
        if (orig) { c.name = orig.name; c.hint = orig.hint; }
      });

      /* Update step progress labels */
      renderStepProgress(getCurrentStep());

      /* Re-render open panels */
      renderOptBuilder();
      if (document.getElementById('page-step2').classList.contains('active')) {
        buildCriteriaPage();
      }
      if (document.getElementById('page-step3').classList.contains('active')) {
        buildEvalPage();
      }
      if (document.getElementById('page-history').classList.contains('active')) {
        renderHistory();
      }
    }

    function getCurrentStep() {
      if (document.getElementById('page-step3').classList.contains('active')) return 3;
      if (document.getElementById('page-step2').classList.contains('active')) return 2;
      return 1;
    }


    /* ─── PALETTE ───────────────────────────── */
    const COLORS = [
      { hex: '#0f766e', bg: 'rgba(15,118,110,0.09)', border: 'rgba(15,118,110,0.28)' },
      { hex: '#b45309', bg: 'rgba(180,83,9,0.08)', border: 'rgba(180,83,9,0.26)' },
      { hex: '#6d28d9', bg: 'rgba(109,40,217,0.08)', border: 'rgba(109,40,217,0.26)' },
      { hex: '#c2410c', bg: 'rgba(194,65,12,0.08)', border: 'rgba(194,65,12,0.26)' },
      { hex: '#0e7490', bg: 'rgba(14,116,144,0.08)', border: 'rgba(14,116,144,0.26)' },
      { hex: '#9f1239', bg: 'rgba(159,18,57,0.08)', border: 'rgba(159,18,57,0.26)' },
    ];
    /* Palette mode sombre : teintes -500 (plus claires = lisibles sur fond #1e293b) */
    const COLORS_DARK = [
      { hex: '#14b8a6', bg: 'rgba(20,184,166,0.15)', border: 'rgba(20,184,166,0.35)' }, // teal-500
      { hex: '#f59e0b', bg: 'rgba(245,158,11,0.15)', border: 'rgba(245,158,11,0.35)' }, // amber-500
      { hex: '#8b5cf6', bg: 'rgba(139,92,246,0.15)', border: 'rgba(139,92,246,0.35)' }, // violet-500
      { hex: '#f97316', bg: 'rgba(249,115,22,0.15)', border: 'rgba(249,115,22,0.35)' }, // orange-500
      { hex: '#06b6d4', bg: 'rgba(6,182,212,0.15)', border: 'rgba(6,182,212,0.35)' }, // cyan-500
      { hex: '#f43f5e', bg: 'rgba(244,63,94,0.15)', border: 'rgba(244,63,94,0.35)' }, // rose-500
    ];
    function activeColors() {
      return window.matchMedia?.('(prefers-color-scheme: dark)').matches ? COLORS_DARK : COLORS;
    }
    const LETTERS = ['A', 'B', 'C', 'D', 'E', 'F'];

    /* ─── CRITERIA LIBRARY ──────────────────── */
    const LIB = [
      { id: 'fin_gain', cat: 'Finance', icon: '💰', name: 'Gain financier', hint: 'Revenus, salaire, bénéfices', invert: false, dw: 2 },
      { id: 'fin_risk', cat: 'Finance', icon: '📉', name: 'Risque financier', hint: 'Pertes potentielles, dettes', invert: true, dw: 2 },
      { id: 'roi', cat: 'Finance', icon: '📈', name: 'Retour sur investissement', hint: 'ROI à moyen/long terme', invert: false, dw: 1 },
      { id: 'cost', cat: 'Finance', icon: '🏷️', name: 'Coût initial', hint: 'Investissement de départ', invert: true, dw: 1 },
      { id: 'fin_stab', cat: 'Finance', icon: '🏦', name: 'Stabilité financière', hint: 'Sécurité des revenus', invert: false, dw: 2 },

      { id: 'career', cat: 'Pro', icon: '🚀', name: 'Évolution de carrière', hint: 'Perspectives professionnelles', invert: false, dw: 2 },
      { id: 'skills', cat: 'Pro', icon: '🧠', name: 'Développement compétences', hint: 'Apprentissage, montée en compétence', invert: false, dw: 1 },
      { id: 'workload', cat: 'Pro', icon: '⚡', name: 'Charge de travail', hint: 'Volume et intensité du travail', invert: true, dw: 1 },
      { id: 'jobsec', cat: 'Pro', icon: '🛡️', name: "Sécurité de l'emploi", hint: 'Stabilité et pérennité du poste', invert: false, dw: 2 },
      { id: 'autonom', cat: 'Pro', icon: '🎯', name: 'Autonomie', hint: "Liberté d'action et de décision", invert: false, dw: 1 },
      { id: 'flex', cat: 'Pro', icon: '⏰', name: 'Flexibilité horaire', hint: 'Télétravail, horaires aménageables', invert: false, dw: 1 },
      { id: 'recog', cat: 'Pro', icon: '🏅', name: 'Reconnaissance', hint: 'Valorisation, prestige', invert: false, dw: 1 },

      { id: 'wellb', cat: 'Perso', icon: '❤️', name: 'Bien-être personnel', hint: 'Bonheur, épanouissement', invert: false, dw: 3 },
      { id: 'stress', cat: 'Perso', icon: '😤', name: 'Niveau de stress', hint: 'Pression, anxiété générée', invert: true, dw: 2 },
      { id: 'health', cat: 'Perso', icon: '🌿', name: 'Impact santé', hint: 'Effets sur votre santé physique/mentale', invert: false, dw: 2 },
      { id: 'time', cat: 'Perso', icon: '⏱️', name: 'Temps libre', hint: 'Loisirs, repos, temps pour soi', invert: false, dw: 2 },
      { id: 'values', cat: 'Perso', icon: '🧭', name: 'Alignement valeurs', hint: 'Cohérence avec vos principes', invert: false, dw: 3 },
      { id: 'passion', cat: 'Perso', icon: '🔥', name: 'Passion & intérêt', hint: 'Motivation intrinsèque', invert: false, dw: 2 },
      { id: 'risk', cat: 'Perso', icon: '⚠️', name: 'Risque global', hint: 'Incertitude, exposition au danger', invert: true, dw: 2 },

      { id: 'family', cat: 'Social', icon: '👨‍👩‍👧', name: 'Impact famille', hint: 'Relations avec proches', invert: false, dw: 2 },
      { id: 'social', cat: 'Social', icon: '🤝', name: 'Vie sociale', hint: 'Réseau, amis, interactions', invert: false, dw: 1 },
      { id: 'location', cat: 'Social', icon: '📍', name: 'Qualité du lieu de vie', hint: 'Logement, ville, environnement', invert: false, dw: 1 },
      { id: 'repute', cat: 'Social', icon: '✨', name: 'Réputation / Image', hint: 'Perception des autres', invert: false, dw: 1 },
      { id: 'impact', cat: 'Social', icon: '🌍', name: 'Impact sociétal', hint: 'Utilité pour la société', invert: false, dw: 1 },

      { id: 'lt', cat: 'Stratégique', icon: '🔭', name: 'Vision long terme', hint: 'Bénéfices dans 5–10 ans', invert: false, dw: 2 },
      { id: 'rev', cat: 'Stratégique', icon: '↩️', name: 'Réversibilité', hint: 'Possibilité de revenir en arrière', invert: false, dw: 2 },
      { id: 'opp', cat: 'Stratégique', icon: '🎲', name: 'Opportunité unique', hint: 'Rareté de la chance', invert: false, dw: 1 },
      { id: 'complex', cat: 'Stratégique', icon: '🔧', name: 'Complexité', hint: 'Difficulté de mise en œuvre', invert: true, dw: 1 },
      { id: 'dep', cat: 'Stratégique', icon: '🔗', name: 'Dépendances', hint: 'Contraintes liées à autres facteurs', invert: true, dw: 1 },
    ];

    const CATS = ['Tous', 'Finance', 'Pro', 'Perso', 'Social', 'Stratégique'];
    const WEIGHTS = { 1: '×1 Normal', 2: '×2 Important', 3: '×3 Crucial' };

    /* ─── STATE ─────────────────────────────── */
    let S = {
      decision: '',
      options: [{ name: '', desc: '' }, { name: '', desc: '' }],
      criteria: [],
      scores: {},
      notes: [],
      currentCat: 'Tous',
      weightingMethod: 'simple', // MODIF SWING: 'simple' | 'swing'
    };

    /* ─── NAV ───────────────────────────────── */
    function nav(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderStepProgress(active) {
      ['sp1', 'sp2', 'sp3', 'sp4'].forEach((id, i) => {
        const el = document.getElementById(id); if (!el) return;
        const labels = tr('sp_labels');
        // sp4 = results page: show all steps as done
        const a = id === 'sp4' ? 4 : active;
        el.innerHTML = [1, 2, 3].map(s => {
          const cls = s < a ? 'done' : s === a ? 'active' : '';
          return `<div class="sp-step ${cls}">
        <div class="sp-num">${s < a ? '✓' : s}</div>
        <span>${labels[s - 1]}</span>
      </div>${s < 3 ? '<div class="sp-arrow">›</div>' : ''}`;
        }).join('');
      });
    }
    renderStepProgress(1);

    /* ─── STEP 1 ────────────────────────────── */
    function initOptions() { renderOptBuilder(); }

    function renderOptBuilder() {
      const b = document.getElementById('optBuilder');
      b.innerHTML = '';
      S.options.forEach((opt, i) => {
        const ltr = LETTERS[i];
        const card = document.createElement('div');
        card.className = 'opt-card open'; card.id = `opt-card-${i}`;
        card.innerHTML = `
      <div class="opt-card-head" onclick="toggleOpt(${i})">
        <div class="opt-dot" style="background:${COLORS[0].hex}"></div>
        <div class="opt-letter" style="color:${COLORS[0].hex}">${tr('opt_label', ltr)}</div>
        <div class="opt-name-preview" id="opt-prev-${i}">−</div>
        ${i >= 2 ? `<button class="opt-rm" onclick="event.stopPropagation();removeOpt(${i})" title="Supprimer">✕</button>` : ''}
        <div class="opt-chevron">▾</div>
      </div>
      <div class="opt-card-body">
        <div class="field">
          <label>${tr('opt_name_lbl')}</label>
          <input type="text" id="opt-name-${i}" value="${esc(opt.name)}"
            placeholder="${tr('opt_name_ph')}"
            oninput="S.options[${i}].name=this.value">
        </div>
        <div class="field" style="margin-bottom:0">
          <label>${tr('opt_desc_lbl')} <span style="font-weight:400;color:var(--muted)">${tr('opt_desc_opt')}</span></label>
          <input type="text" id="opt-desc-${i}" value="${esc(opt.desc)}"
            placeholder="${tr('opt_desc_ph')}"
            oninput="S.options[${i}].desc=this.value">
        </div>
      </div>`;
        b.appendChild(card);
      });
      document.getElementById('opt-count-lbl').textContent = tr('opt_count', S.options.length);
      document.getElementById('addOptBtn').style.display = S.options.length >= 6 ? 'none' : 'flex';
    }

    function toggleOpt(i) { document.getElementById(`opt-card-${i}`).classList.toggle('open'); }
    function addOption() {
      if (S.options.length >= 6) return;
      S.options.push({ name: '', desc: '' });
      renderOptBuilder();
      // Animation fade-in sur la dernière option ajoutée
      const newCard = document.getElementById(`opt-card-${S.options.length - 1}`);
      if (newCard) { newCard.classList.add('fade-in-up'); newCard.addEventListener('animationend', () => newCard.classList.remove('fade-in-up'), { once: true }); }
    }
    function removeOpt(i) { if (S.options.length <= 2) return; S.options.splice(i, 1); renderOptBuilder(); }

    function validateStep1() {
      const dec = document.getElementById('inp-dec').value.trim();
      if (!dec) { shake('inp-dec'); return; }
      const allNamed = S.options.every((_, i) => document.getElementById(`opt-name-${i}`)?.value.trim());
      if (!allNamed) { alert(tr('err_name')); return; }
      S.decision = dec;
      S.options = S.options.map((_, i) => ({
        name: document.getElementById(`opt-name-${i}`).value.trim(),
        desc: document.getElementById(`opt-desc-${i}`).value.trim(),
      }));
      S.notes = S.options.map(() => '');
      renderStepProgress(2);
      buildCriteriaPage();
      nav('page-step2');
    }

    initOptions();

    /* ─── STEP 2 ────────────────────────────── */
    function buildCriteriaPage() { S.currentCat = tr('cats')[0]; renderCatTabs(); filterGrid(tr('cats')[0]); renderSelList(); }

    function renderCatTabs() {
      const t = document.getElementById('catTabs'); t.innerHTML = '';
      CATS.forEach(cat => {
        const b = document.createElement('button');
        b.className = 'cat-tab' + (cat === S.currentCat ? ' active' : '');
        b.textContent = cat; b.onclick = () => filterGrid(cat); t.appendChild(b);
      });
    }

    function filterGrid(cat) {
      S.currentCat = cat; renderCatTabs();
      const g = document.getElementById('critGrid'); g.innerHTML = '';
      (cat === tr('cats')[0] ? LIB : LIB.filter(c => c.cat === cat)).forEach(c => {
        const on = S.criteria.some(x => x.id === c.id);
        const pill = document.createElement('div');
        pill.className = 'crit-pill' + (on ? ' on' : ''); pill.id = 'pill-' + c.id;
        pill.innerHTML = `
      <div class="crit-check">${on ? '✓' : ''}</div>
      <div class="crit-icon">${c.icon}</div>
      <div><div class="crit-name">${c.name}</div><div class="crit-hint">${c.hint}</div></div>`;
        pill.onclick = () => toggleCrit(c.id); g.appendChild(pill);
      });
    }

    function toggleCrit(id) {
      const idx = S.criteria.findIndex(c => c.id === id);
      if (idx !== -1) {
        S.criteria.splice(idx, 1);
        // MODIF SWING — renormalise les rangs après suppression
        _swingRenorm();
        // FIN MODIF SWING
      } else {
        const c = LIB.find(c => c.id === id);
        S.criteria.push({
          ...c, weight: c.dw,
          // MODIF SWING
          swingRank: S.criteria.length
          // FIN MODIF SWING
        });
      }
      filterGrid(S.currentCat); renderSelList();
      // Animation fade-in sur le dernier critère ajouté dans la liste sélectionnée
      if (S.criteria.length > 0) {
        const lastItem = document.querySelector('#activeList .sel-item:last-child, #activeList .swing-item:last-child');
        if (lastItem) { lastItem.classList.add('fade-in-up'); lastItem.addEventListener('animationend', () => lastItem.classList.remove('fade-in-up'), { once: true }); }
      }
    }

    function addCustom() {
      const name = document.getElementById('cust-name').value.trim();
      if (!name) { shake('cust-name'); return; }
      const icon = document.getElementById('cust-icon').value.trim() || '🔹';
      const cat = document.getElementById('cust-cat').value;
      S.criteria.push({
        id: 'cust_' + Date.now(), cat, icon, name,
        hint: LANG === 'fr' ? 'Critère personnalisé' : 'Custom criterion',
        invert: false, weight: 1, custom: true,
        // MODIF SWING
        swingRank: S.criteria.length
        // FIN MODIF SWING
      });
      document.getElementById('cust-name').value = '';
      document.getElementById('cust-icon').value = '';
      renderSelList();
      // Animation fade-in sur le dernier critère ajouté
      const lastItem = document.querySelector('#activeList .sel-item:last-child');
      if (lastItem) { lastItem.classList.add('fade-in-up'); lastItem.addEventListener('animationend', () => lastItem.classList.remove('fade-in-up'), { once: true }); }
    }

    function renderSelList() {
      const list = document.getElementById('activeList');
      document.getElementById('crit-badge').textContent = S.criteria.length;

      if (!S.criteria.length) {
        list.innerHTML = `<div class="empty-hint">${tr('sel_empty')}</div>`;
        return;
      }

      // MODIF SWING — Toggle méthode de pondération
      const swingActive = S.weightingMethod === 'swing';
      const methodBar = `
    <div class="method-toggle-bar">
      <span class="method-lbl">${LANG === 'fr' ? 'Pondération :' : 'Weighting:'}</span>
      <button class="method-btn${!swingActive ? ' active' : ''}" onclick="toggleWeightingMethod('simple')">${tr('swing_method_simple')}</button>
      <button class="method-btn${swingActive ? ' active' : ''}" onclick="toggleWeightingMethod('swing')">${tr('swing_method_swing')}</button>
    </div>`;

      if (swingActive) {
        list.innerHTML = methodBar + buildSwingHTML();
        _attachSwingDnD(); // MODIF DRAG AND DROP
        return;
      }
      // FIN MODIF SWING

      // Mode simple (original)
      const simpleItems = S.criteria.map(c => `
    <div class="sel-item weight-${c.weight}" data-id="${c.id}">
      <div class="sel-item-header">
        <div class="sel-icon">${c.icon}</div>
        <div class="sel-name">
          ${c.name}${c.invert ? ` <span class="inv-tag" title="${tr('inv_tip_on')}">${tr('inv_tag')}</span>` : ''}
          ${c.hint ? `<div class="sel-hint">${c.hint}</div>` : ''}
        </div>
        <button class="rm-btn" onclick="rmCrit('${c.id}')" title="${LANG === 'fr' ? 'Retirer' : 'Remove'}">✕</button>
      </div>
      <div class="sel-item-controls">
        <div class="weight-group">
          ${[1, 2, 3].map(w => `<button class="weight-btn${c.weight === w ? ' active' : ''}" onclick="setCW('${c.id}',${w})">${WEIGHTS[w]}</button>`).join('')}
        </div>
        <button class="inv-btn${c.invert ? ' on' : ''}" onclick="toggleInv('${c.id}')" title="${c.invert ? tr('inv_tip_on') : tr('inv_tip_off')}">
          ${c.invert ? tr('inv_on') : tr('inv_off')}
        </button>
      </div>
    </div>`).join('');

      list.innerHTML = methodBar + simpleItems;
    }

    function setCW(id, v) {
      const c = S.criteria.find(x => x.id === id);
      if (c) {
        c.weight = parseInt(v);
        renderSelList();
        if (document.getElementById('page-step3').classList.contains('active')) {
          S.options.forEach((_, i) => refreshLive(i));
        }
      }
    }
    function toggleInv(id) { const c = S.criteria.find(x => x.id === id); if (c) { c.invert = !c.invert; renderSelList(); } }

    /* ════════════════════════════════════════════
       MODIF SWING — Swing Weighting (SMARTS)
       ════════════════════════════════════════════ */

    /** Renormalise les swingRank après ajout/suppression d'un critère.
     *  Garantit que le critère de rang 0 a toujours 100 pts. */
    function _swingRenorm() {
      const sorted = [...S.criteria].sort((a, b) => (a.swingRank ?? 0) - (b.swingRank ?? 0));
      sorted.forEach((c, i) => { c.swingRank = i; });
    }

    /** Active ou désactive le mode Swing. */
    function toggleWeightingMethod(method) {
      S.weightingMethod = method;
      if (method === 'swing') {
        // Initialise les champs swing manquants
        S.criteria.forEach((c, i) => {
          if (c.swingRank === undefined) c.swingRank = i;
        });
        _swingRenorm();
      }
      renderSelList();
      // Rafraîchit les scores live si on est à l'étape 3
      if (document.getElementById('page-step3').classList.contains('active')) {
        S.options.forEach((_, i) => refreshLive(i));
      }
    }

    /** Calcule les poids normalisés pour le mode swing (somme = 1). */
    function getSwingWeights() {
      const sorted = [...S.criteria].sort((a, b) => (a.swingRank ?? 0) - (b.swingRank ?? 0));
      const N = sorted.length;
      if (N === 0) return [];

      // Pre-calculate sums of 1/k to avoid re-computing (ROC formula)
      const one_over_k = Array.from({ length: N + 1 }, (_, i) => i > 0 ? 1 / i : 0);
      const suffix_sums = Array(N + 2).fill(0);
      for (let i = N; i >= 1; i--) {
        suffix_sums[i] = suffix_sums[i + 1] + one_over_k[i];
      }

      const weights = [];
      sorted.forEach((c, index) => {
        const rank = index + 1; // 1-based rank
        weights.push({
          id: c.id,
          weight: (1 / N) * suffix_sums[rank]
        });
      });
      return weights;
    }

    /** Construit le HTML de la liste swing (items classables + champs). */
    function buildSwingHTML() {
      const sorted = [...S.criteria].sort((a, b) => (a.swingRank ?? 0) - (b.swingRank ?? 0));
      const swingWeights = getSwingWeights();

      const infoBox = `
    <div class="swing-info">
      ${tr('swing_info')}
    </div>`;

      const items = sorted.map((c, i) => {
        const isFirst = i === 0;
        const weight = swingWeights.find(w => w.id === c.id)?.weight ?? 0;
        const pct = Math.round(weight * 100);
        return `
      <div class="swing-item" id="swing-item-${c.id}" data-id="${c.id}">
        <div class="swing-rank-num">${i + 1}</div>
        <div class="swing-item-main">
          <div class="swing-item-header">
            <span style="font-size:.9rem;flex-shrink:0">${c.icon}</span>
            <div class="swing-name-group">
              <span class="swing-item-name">${c.name}</span>
              ${c.hint ? `<span class="swing-item-sub">${esc(c.hint)}</span>` : ''}
            </div>
          </div>
        </div>
        <div class="swing-weight-col">
          <button class="inv-btn${c.invert ? ' on' : ''}" onclick="toggleInv('${c.id}')"
            title="${c.invert ? tr('inv_tip_on') : tr('inv_tip_off')}">
            ${c.invert ? tr('inv_on') : tr('inv_off')}
          </button>
          <div class="swing-weight-tag" style="font-size: .8rem; padding: 4px 8px;">${pct}%</div>
        </div>
        <button class="rm-btn" onclick="rmCrit('${c.id}')" title="${LANG === 'fr' ? 'Retirer' : 'Remove'}" style="align-self:center;margin-left:0">✕</button>
      </div>`;
      }).join('');

      return infoBox + items;
    }

    /* ══════════════════════════════════════════
       MODIF DRAG AND DROP — Glisser-déposer pour le classement swing
       ══════════════════════════════════════════ */

    let _dragId = null;           // id du critère en cours de drag souris
    let _touchDragId = null;      // id du critère en cours de drag tactile
    let _touchGhost = null;      // fantôme affiché sous le doigt
    let _touchTargetId = null;      // id de la cible de drop courante
    let _touchBefore = true;      // insérer avant (true) ou après (false) la cible
    let _swingTouchListened = false;// flag anti-duplication des listeners document
    let _longPressTimer = null;    // timer du long press tactile
    let _touchStartX = 0;          // coordonnée X initiale (pour détecter le scroll)
    let _touchStartY = 0;          // coordonnée Y initiale

    /** Réordonne en déplaçant fromId avant/après toId dans les swingRank. */
    function _swingReorder(fromId, toId, before) {
      if (fromId === toId) return;
      const sorted = [...S.criteria].sort((a, b) => (a.swingRank ?? 0) - (b.swingRank ?? 0));
      const fromIdx = sorted.findIndex(c => c.id === fromId);
      if (fromIdx === -1) return;
      const [moved] = sorted.splice(fromIdx, 1);
      const insertAt = before
        ? sorted.findIndex(c => c.id === toId)
        : sorted.findIndex(c => c.id === toId) + 1;
      if (insertAt < 0) return;
      sorted.splice(insertAt, 0, moved);
      sorted.forEach((c, i) => { c.swingRank = i; });
    }

    /** Attache les événements drag souris (HTML5) + tactile après chaque rendu swing. */
    function _attachSwingDnD() {
      document.querySelectorAll('#activeList .swing-item').forEach(item => {
        // Drag souris direct sur l'item
        item.addEventListener('mousedown', () => {
          item.setAttribute('draggable', 'true');
        });

        item.addEventListener('dragstart', e => {
          _dragId = item.dataset.id;
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        item.addEventListener('dragend', () => {
          _dragId = null;
          item.removeAttribute('draggable');
          item.classList.remove('dragging');
          document.querySelectorAll('#activeList .swing-item')
            .forEach(el => el.classList.remove('drag-over-above', 'drag-over-below'));
        });

        item.addEventListener('dragover', e => {
          e.preventDefault();
          if (!_dragId || item.dataset.id === _dragId) return;
          const before = e.clientY < item.getBoundingClientRect().top + item.offsetHeight / 2;
          document.querySelectorAll('#activeList .swing-item')
            .forEach(el => el.classList.remove('drag-over-above', 'drag-over-below'));
          item.classList.add(before ? 'drag-over-above' : 'drag-over-below');
        });

        item.addEventListener('dragleave', e => {
          if (!item.contains(e.relatedTarget))
            item.classList.remove('drag-over-above', 'drag-over-below');
        });

        item.addEventListener('drop', e => {
          e.preventDefault();
          if (!_dragId || item.dataset.id === _dragId) return;
          const before = e.clientY < item.getBoundingClientRect().top + item.offsetHeight / 2;
          const movedId = _dragId;
          _swingReorder(movedId, item.dataset.id, before);
          renderSelList();
          _animateSwingDrop(movedId);
        });
      });

      /* ─── Drag tactile : long press (350 ms) n'importe où sur la carte ─── */
      document.querySelectorAll('#activeList .swing-item').forEach(item => {
        // Empêche le menu contextuel (copier/coller) sur appui long sur mobile
        item.addEventListener('contextmenu', e => e.preventDefault());

        item.addEventListener('touchstart', e => {
          const t = e.touches[0];
          _touchStartX = t.clientX;
          _touchStartY = t.clientY;
          // Capture des coords pour la closure (e.touches peut être recyclé)
          const sx = t.clientX, sy = t.clientY;
          _longPressTimer = setTimeout(() => {
            item.classList.remove('press-holding');
            _startTouchDrag(item, { clientX: sx, clientY: sy });
          }, 350);
          item.classList.add('press-holding');
        }, { passive: true });

        // Annuler si l'utilisateur relâche avant 350 ms (simple tap)
        item.addEventListener('touchend', () => {
          if (_longPressTimer) { clearTimeout(_longPressTimer); _longPressTimer = null; }
          item.classList.remove('press-holding');
        }, { passive: true });

        // Annuler si l'utilisateur commence à scroller (mouvement > 8px)
        item.addEventListener('touchmove', e => {
          if (_touchDragId) return; // déjà en drag → géré par le listener document
          const t = e.touches[0];
          if (Math.abs(t.clientX - _touchStartX) > 8 || Math.abs(t.clientY - _touchStartY) > 8) {
            if (_longPressTimer) { clearTimeout(_longPressTimer); _longPressTimer = null; }
            item.classList.remove('press-holding');
          }
        }, { passive: true });
      });

      // Listeners document ajoutés une seule fois pour toute la session
      if (!_swingTouchListened) {
        _swingTouchListened = true;
        document.addEventListener('touchmove', _swingTouchMove, { passive: false });
        document.addEventListener('touchend', _swingTouchEnd, { passive: false });
        document.addEventListener('touchcancel', _swingTouchEnd, { passive: false });
      }
    }

    /** Démarre le drag tactile : crée le fantôme et marque l'item comme dragging. */
    function _startTouchDrag(item, touch) {
      _touchDragId = item.dataset.id;
      if (navigator.vibrate) navigator.vibrate(30); // retour haptique si dispo
      _touchGhost = item.cloneNode(true);
      _touchGhost.classList.add('swing-ghost');
      _touchGhost.style.width = item.offsetWidth + 'px';
      document.body.appendChild(_touchGhost);
      item.classList.add('dragging');
      _touchGhost.style.left = (touch.clientX - 20) + 'px';
      _touchGhost.style.top = (touch.clientY - item.offsetHeight / 2) + 'px';
    }

    /** Applique une animation à l'élément qui vient d'être déposé. */
    function _animateSwingDrop(movedId) {
      const movedEl = document.getElementById(`swing-item-${movedId}`);
      if (movedEl) {
        // Ensure the element is in the DOM and paint has happened
        requestAnimationFrame(() => {
          movedEl.classList.add('animate-drop');
          // short haptic feedback on capable devices
          try { if (navigator.vibrate) navigator.vibrate(20); } catch (e) { }
          movedEl.addEventListener('animationend', () => {
            movedEl.classList.remove('animate-drop');
          }, { once: true });
        });
      }
    }

    function _swingTouchMove(e) {
      if (!_touchDragId) return;
      e.preventDefault();
      const t = e.touches[0];
      // Déplacer le fantôme
      if (_touchGhost) {
        _touchGhost.style.left = (t.clientX - 20) + 'px';
        _touchGhost.style.top = (t.clientY - 30) + 'px';
      }
      // Trouver la cible sous le doigt
      _touchTargetId = null; _touchBefore = true;
      document.querySelectorAll('#activeList .swing-item').forEach(el => {
        el.classList.remove('drag-over-above', 'drag-over-below');
        if (el.dataset.id === _touchDragId) return;
        const r = el.getBoundingClientRect();
        if (t.clientY >= r.top && t.clientY <= r.bottom) {
          _touchTargetId = el.dataset.id;
          _touchBefore = t.clientY < r.top + r.height / 2;
          el.classList.add(_touchBefore ? 'drag-over-above' : 'drag-over-below');
        }
      });
    }

    function _swingTouchEnd() {
      // Toujours annuler le long press si encore en attente
      if (_longPressTimer) { clearTimeout(_longPressTimer); _longPressTimer = null; }
      document.querySelectorAll('#activeList .swing-item')
        .forEach(el => el.classList.remove('press-holding'));
      if (!_touchDragId) return;
      if (_touchGhost) { _touchGhost.remove(); _touchGhost = null; }
      document.querySelectorAll('#activeList .swing-item')
        .forEach(el => el.classList.remove('dragging', 'drag-over-above', 'drag-over-below'));
      const movedId = _touchDragId;
      if (_touchTargetId) {
        _swingReorder(movedId, _touchTargetId, _touchBefore);
        renderSelList();
        _animateSwingDrop(movedId);
      }
      _touchDragId = null; _touchTargetId = null;
    }

    /* FIN MODIF DRAG AND DROP */

    /* FIN MODIF SWING */
    function rmCrit(id) {
      S.criteria = S.criteria.filter(x => x.id !== id);
      // MODIF SWING — renormalise les rangs après suppression
      _swingRenorm();
      // FIN MODIF SWING
      const pill = document.getElementById('pill-' + id);
      if (pill) { pill.classList.remove('on'); pill.querySelector('.crit-check').textContent = ''; }
      renderSelList();
    }

    function askRmCritStep3(id) {
      if (S.criteria.length <= 2) {
        alert(LANG === 'fr' ? 'Vous devez garder au moins 2 critères.' : 'You must keep at least 2 criteria.');
        return;
      }
      const c = S.criteria.find(x => x.id === id);
      if (!c) return;
      const msg = LANG === 'fr'
        ? `Êtes-vous sûr de vouloir supprimer le critère "${c.name}" ?`
        : `Are you sure you want to delete the criterion "${c.name}"?`;
      if (confirm(msg)) {
        rmCrit(id);
        buildEvalPage();
      }
    }

    function validateStep2() {
      if (S.criteria.length < 2) { alert(tr('err_crit')); return; }
      S.criteria.forEach(c => {
        if (!S.scores[c.id] || S.scores[c.id].length !== S.options.length)
          S.scores[c.id] = S.options.map(() => 5);
      });
      renderStepProgress(3);
      buildEvalPage();
      nav('page-step3');
    }

    /* ─── STEP 3 ────────────────────────────── */

    /* Échelle d'emojis pour le score effectif 1→10 (prend en compte l'inversion) */
    const SCORE_EMOJIS = ['😭', '😞', '😟', '😕', '😐', '🙂', '😊', '😄', '😁', '🤩'];
    function scoreEmoji(val, invert) {
      const eff = invert ? (11 - val) : val;
      return SCORE_EMOJIS[Math.min(10, Math.max(1, eff)) - 1];
    }

    /* ─── JS POUR GÉRER L'OUVERTURE/FERMETURE DES COLONNES (STEP 3) ─── */
    function toggleStep3Col(oi) {
      const body = document.getElementById(`eval-col-body-${oi}`);
      const btn = document.getElementById(`collapse-btn-${oi}`);
      const head = body ? body.previousElementSibling : null;
      if (body) body.classList.toggle('collapsed');
      if (btn) btn.classList.toggle('collapsed');
      if (head) head.classList.toggle('collapsed');
    }

    /* ─── JS POUR GÉRER LE SWIPE DE LA BARRE ─── */
    let _fluidDrag = null;
    function startFluidDrag(e, oi, cid) {
      // Prevent browser default scroll/pan behaviors
      if (e.cancelable) e.preventDefault();
      _fluidDrag = { oi, cid, el: e.currentTarget };
      updateFluidDrag(e);
      document.addEventListener('pointermove', updateFluidDrag);
      document.addEventListener('pointerup', stopFluidDrag);
      document.addEventListener('pointercancel', stopFluidDrag);
    }
    function updateFluidDrag(e) {
      if (!_fluidDrag) return;
      const rect = _fluidDrag.el.getBoundingClientRect();
      let x = e.clientX - rect.left;
      let pct = Math.max(0, Math.min(1, x / rect.width));
      let val = Math.round(pct * 9) + 1; // map 0-1 to 1-10
      // Evite des petits sauts inutiles si la valeur est déjà la même
      if (S.scores[_fluidDrag.cid][_fluidDrag.oi] !== val) {
        setVal(_fluidDrag.oi, _fluidDrag.cid, val);
      }
    }
    function stopFluidDrag() {
      _fluidDrag = null;
      document.removeEventListener('pointermove', updateFluidDrag);
      document.removeEventListener('pointerup', stopFluidDrag);
      document.removeEventListener('pointercancel', stopFluidDrag);
    }

    function buildEvalPage() {
      document.getElementById('eval-title').textContent =
        tr('eval_title', S.decision.substring(0, 50) + (S.decision.length > 50 ? '…' : ''));
      const nOpts = S.options.length;
      const grid = document.getElementById('evalGrid');
      grid.style.gridTemplateColumns = `repeat(${Math.min(nOpts, 2)},1fr)`;
      grid.style.width = '100%';
      grid.innerHTML = '';

      S.options.forEach((opt, oi) => {
        const col = document.createElement('div');
        col.className = 'eval-col';

        const items = S.criteria.map(cr => {
          const v = S.scores[cr.id]?.[oi] ?? 5;
          const inv = cr.invert ? `<span class="inv-tag" title="Score élevé = mauvais pour ce critère">↓</span>` : '';
          // MODIF SWING — badge poids adapté au mode
          let wt = '';
          if (S.weightingMethod === 'swing') {
            const weights = getSwingWeights();
            const pct = Math.round((weights.find(w => w.id === cr.id)?.weight ?? 0) * 100);
            wt = `<span class="swing-wtag">⚖️ ${pct}%</span>`;
          } else if (cr.weight > 1) {
            wt = `<span class="sl-wtag">×${cr.weight}</span>`;
          }
          // Barre fluide avec thumb indicator pour une meilleure affordance de slider
          const pips = `
            <div class="fluid-bar" onpointerdown="startFluidDrag(event, ${oi}, '${cr.id}')" role="slider"
                 aria-valuemin="1" aria-valuemax="10" aria-valuenow="${v}" tabindex="0">
              <div class="fluid-bar-fill" id="pip-${oi}-${cr.id}-fill"></div>
              <div class="fluid-thumb" id="pip-${oi}-${cr.id}-thumb" aria-hidden="true"></div>
            </div>`;
          return `
        <div class="sl-item">
          <div class="sl-head">
            <div class="sl-label"><span class="crit-name-badge">${cr.icon} ${cr.name}</span></div>
            ${inv}
            <div class="sl-wtag-modern">${wt}</div>
            <button class="rm-crit-btn-s3" onclick="askRmCritStep3('${cr.id}')" title="${LANG === 'fr' ? 'Supprimer' : 'Remove'}" aria-label="Remove">✕</button>
          </div>
          <div class="stepper">
            <button class="stepper-btn" onclick="stepVal(${oi},'${cr.id}',-1)" aria-label="Diminuer">−</button>
            <div class="stepper-track">
              <div class="fluid-track">
                ${pips}
                <div class="stepper-emoji" id="se-${oi}-${cr.id}">${scoreEmoji(v, cr.invert ?? false)}</div>
              </div>
              <div class="stepper-val" id="sv-${oi}-${cr.id}">${v}</div>
            </div>
            <button class="stepper-btn" onclick="stepVal(${oi},'${cr.id}',+1)" aria-label="Augmenter">+</button>
          </div>
        </div>`;
        }).join('');

        col.innerHTML = `
      <div class="eval-col-head" onclick="toggleStep3Col(${oi})" style="background:${activeColors()[0].bg};border-color:${activeColors()[0].border}">
        <div class="eval-col-name" style="color:${activeColors()[0].hex}"><span class="opt-badge">Option ${LETTERS[oi]}</span> ${esc(opt.name)}</div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="eval-live-score" style="border: 1px solid ${activeColors()[0].border}">
            <div class="eval-live-num" id="live-${oi}" style="color:${activeColors()[0].hex}">—</div>
            <div class="eval-live-label" style="color:${activeColors()[0].hex}">/ 100</div>
          </div>
          <button class="collapse-btn-s3" id="collapse-btn-${oi}" aria-label="Toggle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${activeColors()[0].hex}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="18 15 12 9 6 15"></polyline>
            </svg>
          </button>
        </div>
      </div>
      <div class="eval-col-body" id="eval-col-body-${oi}" style="border-color:${activeColors()[0].border}">${items}</div>`;

        grid.appendChild(col);
        S.criteria.forEach(cr => renderStepper(oi, cr.id, S.scores[cr.id]?.[oi] ?? 5, cr.invert ?? false));
        refreshLive(oi);
      });

      const notesRow = document.getElementById('notesRow');
      notesRow.style.gridTemplateColumns = `repeat(${Math.min(nOpts, 3)},1fr)`;
      notesRow.innerHTML = S.options.map((opt, oi) => `
    <div>
      <span class="notes-lbl" style="color:${activeColors()[0].hex}">
        ${tr('notes_lbl', LETTERS[oi], esc(opt.name))}
      </span>
      <textarea id="note-${oi}" rows="3"
        placeholder="${tr('notes_ph')}"
        oninput="S.notes[${oi}]=this.value">${esc(S.notes[oi] || '')}</textarea>
    </div>`).join('');
    }

    /* ─── STEPPER COLOR ─────────────────────── */
    function stepColor(raw, invert) {
      const eff = invert ? (11 - raw) : raw;
      const t = (eff - 1) / 9; // normalized 0..1
      // Map 0..1 to hue 0 (red) -> 120 (green)
      const hue = Math.round(t * 120);
      const sat = 50; // softened saturation for less flashy colors
      // Use a slightly lighter lightness in dark mode so colors pop on dark backgrounds
      const darkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const light = darkMode ? 55 : 45;
      return `hsl(${hue} ${sat}% ${light}%)`;
    }

    function renderStepper(oi, cid, val, invert) {
      const color = stepColor(val, invert);
      const vd = document.getElementById(`sv-${oi}-${cid}`);
      if (vd) { vd.textContent = val; vd.style.color = color; }
      const ed = document.getElementById(`se-${oi}-${cid}`);
      if (ed) {
        ed.textContent = scoreEmoji(val, invert);
        const eff = invert ? (11 - val) : val;
        ed.style.transform = eff >= 8 ? 'scale(1.15)' : 'scale(1)';
      }

      const pipFill = document.getElementById(`pip-${oi}-${cid}-fill`);
      if (pipFill) {
        // Fluid mapping: 1 → 10%, 10 → 100%
        const pct = val * 10;
        pipFill.style.width = pct + '%';
        pipFill.style.background = color;
        pipFill.style.boxShadow = `0 0 10px ${color.replace(')', ', 0.4)').replace('hsl', 'hsla')}`;
      }

      // Met à jour la position du thumb indicator (barre de progression)
      const thumb = document.getElementById(`pip-${oi}-${cid}-thumb`);
      if (thumb) {
        // Position = pourcentage de la valeur dans la plage 1-10
        const pct = ((val - 1) / 9) * 100;
        thumb.style.left = pct + '%';
        // La couleur du bord du thumb suit la couleur du score
        thumb.style.borderColor = color;
        // Mise à jour aria-valuenow sur la barre parente
        const bar = thumb.parentElement;
        if (bar) bar.setAttribute('aria-valuenow', val);
      }
    }

    function stepVal(oi, cid, delta) {
      if (!S.scores[cid]) S.scores[cid] = S.options.map(() => 5);
      const next = Math.min(10, Math.max(1, (S.scores[cid][oi] ?? 5) + delta));
      S.scores[cid][oi] = next;
      const cr = S.criteria.find(c => c.id === cid);
      renderStepper(oi, cid, next, cr?.invert ?? false);
      refreshLive(oi);
    }

    function setVal(oi, cid, val) {
      if (!S.scores[cid]) S.scores[cid] = S.options.map(() => 5);
      S.scores[cid][oi] = val;
      const cr = S.criteria.find(c => c.id === cid);
      renderStepper(oi, cid, val, cr?.invert ?? false);
      refreshLive(oi);
    }

    function calcScore(oi) {
      // MODIF SWING — branche Swing Weighting
      if (S.weightingMethod === 'swing') {
        const weights = getSwingWeights();
        let tot = 0;
        S.criteria.forEach(c => {
          let v = S.scores[c.id]?.[oi] ?? 5;
          if (c.invert) v = 11 - v;
          const w = weights.find(x => x.id === c.id)?.weight ?? 0;
          tot += v * w;
        });
        return Math.round((tot / 10) * 100);
      }
      // FIN MODIF SWING
      let tot = 0, max = 0;
      S.criteria.forEach(c => {
        let v = S.scores[c.id]?.[oi] ?? 5;
        if (c.invert) v = 11 - v;
        tot += v * c.weight; max += 10 * c.weight;
      });
      return Math.round((tot / max) * 100);
    }

    function refreshLive(oi) {
      const el = document.getElementById(`live-${oi}`);
      if (!el) return;
      const sc = calcScore(oi);
      const prev = parseInt(el.textContent) || -1;

      el.textContent = sc;

      // Couleur dynamique : rouge (bas) → jaune (moyen) → vert (haut)
      const col = scoreColor(sc);
      el.style.color = col;

      // Pulse animation seulement si la valeur a vraiment changé
      if (prev !== sc) {
        el.classList.remove('score-pulse');
        // Forcer reflow pour relancer l'animation
        void el.offsetWidth;
        el.classList.add('score-pulse');
        el.addEventListener('animationend', () => el.classList.remove('score-pulse'), { once: true });
      }
    }

    /* ─── RESULTS ───────────────────────────── */
    function showResults() {
      S.notes = S.options.map((_, i) => document.getElementById(`note-${i}`)?.value || '');
      buildResults();
      renderStepProgress(4);
      nav('page-results');
      initScenario();
      setTimeout(drawRadar, 150);
      generateInterpretation();
    }

    function buildResults() {
      const scores = S.options.map((_, i) => calcScore(i));
      const ranked = [...S.options.map((_, i) => i)].sort((a, b) => scores[b] - scores[a]);
      const winner = ranked[0], runner = ranked[1];
      const diff = scores[winner] - scores[runner];
      const tie = diff <= 4;
      // Couleurs basées sur le rang : gagnant = vert, 2ème = orange, etc.
      resultColors = {};
      ranked.forEach((oi, rank) => { resultColors[oi] = activeColors()[rank]; });
      const cW = resultColors[winner];

      // Verdict
      let vstyle, vemoji, vtitle, vsub;
      if (tie) {
        vstyle = `background:var(--verdict-bg);border:1.5px solid var(--verdict-border);color:var(--ink)`;
        vemoji = '⚖️';
        vtitle = `<span class="verdict-title-amber">${tr('res_tie_title')}</span>`;
        vsub = tr('res_tie_sub', diff);
      } else {
        vstyle = `background:${cW.bg};border:1.5px solid ${cW.border};color:var(--ink)`;
        vemoji = '🎯';
        vtitle = `<span class="verdict-title-green">"${esc(S.options[winner].name)}" ${LANG === 'fr' ? 'ressort en tête' : 'comes out on top'}</span>`;
        vsub = tr('res_win_sub', diff);
      }

      // Score cards — design moderne / minimaliste
      const ncols = Math.min(S.options.length, 4);
      const scoreCards = ranked.map((oi, rank) => {
        const c = resultColors[oi]; const sc = scores[oi];
        const rankLabels = tr('rank_labels');
        const rankLbl = rank < 3 ? rankLabels[rank] : `#${rank + 1}`;
        // Badge trophée pour le 1er
        const trophyBadge = rank === 0 ? '<span class="sc-trophy">🏆</span>' : '';
        // Écart / proximité vs le 1er
        const maxScore = scores[ranked[0]];
        const gap = sc - maxScore; // 0 pour le gagnant, négatif sinon
        const proximity = maxScore > 0 ? Math.round((sc / maxScore) * 100) : 100;
        const gapLbl = LANG === 'fr' ? 'Écart avec le 1er' : 'Gap vs #1';
        const proxLbl2 = LANG === 'fr' ? 'Proximité' : 'Proximity';
        const diffHTML = `<div class="sc-diff-info">
            ${rank > 0 ? `<span class="sc-diff-gap">${gapLbl} : ${gap} pts</span>` : ''}
            <span class="sc-diff-prox">${proxLbl2} : ${proximity}&thinsp;%</span>
          </div>`;
        // Calcul points forts / faibles par score pondéré effectif
        const allSorted = [...S.criteria].sort((a, b) => {
          const va = S.scores[a.id]?.[oi] ?? 5; const vb = S.scores[b.id]?.[oi] ?? 5;
          const ea = a.invert ? 11 - va : va; const eb = b.invert ? 11 - vb : vb;
          return (eb * b.weight) - (ea * a.weight);
        });
        const topCrits = allSorted.slice(0, 2).filter(cr => {
          const v = S.scores[cr.id]?.[oi] ?? 5;
          return (cr.invert ? 11 - v : v) >= 6;
        });
        const worstCrit = [...allSorted].reverse().find(cr => {
          const v = S.scores[cr.id]?.[oi] ?? 5;
          return (cr.invert ? 11 - v : v) <= 5;
        });
        const prosLbl = LANG === 'fr' ? 'Points forts' : 'Strengths';
        const conLbl = LANG === 'fr' ? 'À surveiller' : 'Watch out';
        const insightHTML = (topCrits.length || worstCrit) ? `<div class="sc-insights">
            ${topCrits.length ? `<div class="sc-insight sc-insight-pro">
              <span class="sc-insight-dot">↑</span>
              <span><strong>${prosLbl} :</strong> ${topCrits.map(cr => cr.name).join(', ')}</span>
            </div>` : ''}
            ${worstCrit ? `<div class="sc-insight sc-insight-con">
              <span class="sc-insight-dot">↓</span>
              <span><strong>${conLbl} :</strong> ${worstCrit.name}</span>
            </div>` : ''}
          </div>` : '';
        return `
      <div class="sc-card${rank === 0 ? ' sc-card-winner' : ''}" style="border-color:${c.hex};background:linear-gradient(145deg,var(--white) 55%,${c.bg})">
        <div class="sc-card-body">
          <div class="sc-card-left">
            <div class="sc-card-top">
              <div class="sc-card-rank" style="background:${c.bg};color:${c.hex}">${rankLbl}</div>
              <div class="sc-card-name">${esc(S.options[oi].name)}</div>
              ${trophyBadge}
            </div>
            <div class="sc-card-score">
              <div class="sc-score-display">
                <div class="sc-card-num" style="color:${c.hex}">${sc}</div>
                <div class="sc-card-den" style="color:${c.hex}">/100</div>
              </div>
              <div class="sc-score-bar">
                <div class="sc-score-bar-fill" style="width:${sc}%;background:${scoreColor(sc)}"></div>
              </div>
            </div>
            ${diffHTML}
            ${insightHTML}
          </div>
        </div>
      </div>`;
      }).join('');

      // Breakdown table
      const bkHeader = `<div class="bk-row hdr">
    <div class="bk-cell crit-col hdr-cell">${tr('bk_crit')}</div>
    ${S.options.map((o, i) => `<div class="bk-cell opt-col hdr-cell" style="color:${resultColors[i].hex};font-weight:800;letter-spacing:.05em">${LETTERS[i]}. <span style="font-weight:700">${esc(o.name)}</span></div>`).join('')}
  </div>`;
      const bkRows = S.criteria.map(cr => {
        const vals = S.options.map((_, i) => S.scores[cr.id]?.[i] ?? 5);
        const maxV = Math.max(...vals);
        return `<div class="bk-row">
      <div class="bk-cell crit-col">
        <span style="display:flex;align-items:center;gap:7px">
          <span style="font-size:1.1em;flex-shrink:0">${cr.icon}</span>
          <span style="flex:1">${cr.name}</span>
        </span>
        <span style="display:flex;align-items:center;gap:5px;flex-wrap:wrap">
          ${(() => {
            // MODIF SWING — badge poids dans breakdown
            if (S.weightingMethod === 'swing') {
              const weights = getSwingWeights();
              const pct = Math.round((weights.find(w => w.id === cr.id)?.weight ?? 0) * 100);
              return `<span style="font-size:.64rem;background:var(--teal-bg);color:var(--teal);padding:3px 7px;border-radius:5px;border:1px solid var(--teal-bd);font-weight:700;white-space:nowrap">⚖️ ${pct}%</span>`;
            }
            return cr.weight > 1 ? `<span style="font-size:.64rem;background:var(--amber-bg);color:var(--amber);padding:3px 7px;border-radius:5px;border:1px solid rgba(217,119,6,.3);font-weight:800;white-space:nowrap">×${cr.weight} ${LANG === 'fr' ? 'Important' : 'Important'}</span>` : '';
            // FIN MODIF SWING
          })()}
          ${cr.invert ? `<span class="inv-tag">↓ Inversé</span>` : ''}
        </span>
      </div>
      ${vals.map((v, i) => {
            const c = resultColors[i]; return `<div class="bk-cell opt-col"><div class="opt-cell-in">
        <div class="opt-pill" style="background:${c.bg};color:${c.hex};font-weight:${v === maxV ? 700 : 400}">${v}</div>
        <div class="mini-bar"><div class="mini-bar-fill" style="width:${v * 10}%;background:${c.hex}"></div></div>
      </div></div>`;
          }).join('')}
    </div>`;
      }).join('');

      // Notes
      const hasNotes = S.notes.some(n => n.trim());
      const notesHTML = hasNotes ? `
    <div class="notes-res" style="margin-top:14px">
      <div class="notes-res-head">${tr('notes_head')}</div>
      <div class="notes-res-body" style="grid-template-columns:repeat(${Math.min(S.options.length, 3)},1fr)">
        ${S.options.map((o, i) => `
          <div class="note-col" style="${i < S.options.length - 1 ? 'border-right:1px solid var(--border)' : ''}">
            <div class="note-col-lbl" style="color:${resultColors[i].hex}">${LETTERS[i]}. ${esc(o.name)}</div>
            <div class="note-col-txt">${esc(S.notes[i]) || `<em style="color:var(--muted2)">${tr('no_notes')}</em>`}</div>
          </div>`).join('')}
      </div>
    </div>`: '';

      document.getElementById('resContent').innerHTML = `

    <!-- ① EN-TÊTE -->
    <div class="main">
      <div class="page-eyebrow anim">${tr('res_eyebrow')}</div>
      <div class="page-title anim d1">${esc(S.decision)}</div>
      <div class="verdict-inline anim d2" style="${vstyle}">
        <span class="verdict-inline-emoji">${vemoji}</span>
        <div class="verdict-inline-text">
          <div class="verdict-inline-title">${vtitle}</div>
          <div class="verdict-inline-sub" id="interpSub">${vsub}</div>
        </div>
      </div>

      <!-- ② SCORES -->
      <div class="sc-cards-row anim d3" id="scoresRow" style="grid-template-columns:repeat(${ncols},1fr)">${scoreCards}</div>

      <!-- ③ SCÉNARIOS — juste sous les scores -->
      <div class="scenario-panel" id="scenarioBox" style="margin-top:14px">
        <div class="scenario-panel-head" onclick="toggleScenarioBox()">
          <span class="scenario-panel-icon">🎛️</span>
          <div class="scenario-panel-text">
            <div class="scenario-panel-title">${tr('scenario_title')}</div>
            <div class="scenario-panel-sub">${tr('scenario_sub')}</div>
          </div>
          <div class="scenario-panel-chevron">▾</div>
        </div>
        <div class="scenario-panel-body">
          <div class="sc-tabs">
            <button class="sc-tab active" onclick="switchScTab('crits',this)">${LANG === 'fr' ? '🎚️ Critères' : '🎚️ Criteria'}</button>
            <button class="sc-tab" onclick="switchScTab('emotions',this)">${LANG === 'fr' ? '🫀 Émotions' : '🫀 Emotions'}</button>
          </div>
          <div class="sc-tab-content">
            <div class="sc-tab-pane active" id="scPaneCrits"></div>
            <div class="sc-tab-pane" id="scPaneEmotions"></div>
          </div>
        </div>
      </div>

      <!-- ④ Profil visuel -->
      <div class="res-divider" style="margin-top:22px"><span class="res-divider-label">${tr('div_visual')}</span></div>
      <div class="res-section">
        <div class="res-section-body" style="padding:16px 20px 20px">
          <div class="res-radar-wrap">
            <canvas id="radarC" width="480" height="380" style="max-width:100%"></canvas>
          </div>
          <div class="res-radar-legend">
            ${S.options.map((o, i) => `<span><span class="leg-dot" style="background:${resultColors[i].hex}"></span>${esc(o.name)}</span>`).join('')}
            <button class="radar-help-btn" onclick="var el=document.getElementById('radarHow');el.classList.toggle('open')" title="${LANG === 'fr' ? 'Comment lire ce graphique ?' : 'How to read this chart?'}">?</button>
          </div>
          <div class="radar-how" id="radarHow">
            <div class="radar-how-title">${LANG === 'fr' ? 'Comment lire ce graphique ?' : 'How to read this chart?'}</div>
            <div class="radar-how-items">
              <div class="radar-how-item">
                <div class="radar-how-icon">⬡</div>
                <div>${LANG === 'fr'
          ? 'Chaque axe représente un critère. <strong>Plus la surface colorée est grande</strong>, meilleure est l\'option sur l\'ensemble des critères.'
          : 'Each axis is a criterion. <strong>The larger the colored area</strong>, the better the option across all criteria.'}</div>
              </div>
              <div class="radar-how-item">
                <div class="radar-how-icon">📍</div>
                <div>${LANG === 'fr'
          ? 'Les <strong>points sur chaque axe</strong> indiquent la note de l\'option pour ce critère (de 0 au centre à 10 à l\'extrémité).'
          : 'The <strong>dots on each axis</strong> show the option\'s score for that criterion (0 at center, 10 at edge).'}</div>
              </div>
              <div class="radar-how-item">
                <div class="radar-how-icon">🔀</div>
                <div>${LANG === 'fr'
          ? 'Une option peut avoir une <strong>grande surface mais être faible sur un axe</strong> — regardez les creux pour identifier ses faiblesses.'
          : 'An option may have a <strong>large area but dip on one axis</strong> — look for indentations to spot weaknesses.'}</div>
              </div>
              ${S.criteria.some(c => c.weight > 1) ? `<div class="radar-how-item">
                <div class="radar-how-icon">⚖️</div>
                <div>${LANG === 'fr'
            ? 'Les critères marqués <strong>×2, ×3…</strong> ont plus d\'importance dans le score final, mais tous les axes sont égaux sur ce graphique.'
            : 'Criteria marked <strong>×2, ×3…</strong> carry more weight in the final score, but all axes appear equal on this chart.'}</div>
              </div>`: ''}
            </div>
          </div>
        </div>
      </div>

      <!-- ⑤ Tableau -->
      <div class="res-divider"><span class="res-divider-label">${tr('div_detail')}</span></div>
      <div class="bk-table">${bkHeader}${bkRows}</div>

      <!-- ⑥ Notes -->
      ${hasNotes ? `<div class="res-divider"><span class="res-divider-label">${tr('div_notes')}</span></div>${notesHTML}` : ''}

      <!-- ⑦ Actions -->
      <div class="res-actions">
        <button class="btn btn-secondary" onclick="nav('page-step3')">${tr('back_notes')}</button>
        <button class="btn btn-secondary" id="btnSaveTrack" onclick="saveAndTrack()">${tr('save_track')}</button>
        <button class="btn btn-secondary" onclick="window.print()">${tr('export_pdf')}</button>
        <button class="btn btn-primary" onclick="restart()">${tr('new_decision')}</button>
      </div>
    </div>`;
    }

    /* ─── AI INTERPRETATION ─────────────────── */
    async function generateInterpretation() {
      const scores = S.options.map((_, i) => calcScore(i));
      const ranked = [...S.options.map((_, i) => i)].sort((a, b) => scores[b] - scores[a]);

      const optionsSummary = S.options.map((o, i) => {
        const critDetails = S.criteria.map(c => {
          const raw = S.scores[c.id]?.[i] ?? 5;
          const eff = c.invert ? 11 - raw : raw;
          return `  - ${c.name} (poids ×${c.weight}${c.invert ? ' [inversé]' : ''}): ${raw}/10 → effectif ${eff}/10`;
        }).join('\n');
        return `Option ${LETTERS[i]} — "${o.name}"${o.desc ? ' (' + o.desc + ')' : ''}
  Score final: ${scores[i]}/100
${critDetails}${S.notes[i] ? '\n  Note personnelle: "' + S.notes[i] + '"' : ''}`;
      }).join('\n\n');

      const rankedNames = ranked.map(i => `"${S.options[i].name}" (${scores[i]} pts)`).join(' > ');
      const crucialCriteria = S.criteria.filter(c => c.weight >= 2).map(c => `${c.name} (×${c.weight})`).join(', ') || 'Aucun';

      const promptLang = tr('ai_lang');
      const prompt = LANG === 'en'
        ? `You are a friendly and direct advisor helping people make important decisions.

The user must decide: "${S.decision}"

Results of their multi-criteria analysis:
Ranking: ${rankedNames}

${optionsSummary}

Most important criteria (×2 or ×3): ${crucialCriteria}

Your mission: Write a short interpretive message (3 to 5 sentences) in English, natural and human.
- Compare the options on the points where they diverge most
- Reveal what the numbers actually say about the user's priorities
- Make a nuanced recommendation taking into account the important criteria
- If it's close, say so and point to what matters most
- Write directly, no title, no bullets, no generic intro
- Style: "Option X is stronger on…", "If you value…", "What the numbers reveal here…"
- Use "you", be warm but factual. 3-5 sentences max.`
        : `Tu es un conseiller bienveillant et direct qui aide les gens à prendre des décisions importantes.

L'utilisateur doit décider : "${S.decision}"

Résultats de son analyse multi-critères :
Classement : ${rankedNames}

${optionsSummary}

Critères les plus importants (×2 ou ×3) : ${crucialCriteria}

Ta mission : Rédige un message interprétatif court (3 à 5 phrases) en français, naturel et humain.
- Compare les options sur les points où elles divergent le plus
- Révèle ce que les chiffres disent vraiment sur ses priorités
- Formule une recommandation nuancée tenant compte des critères importants
- Si serré, dis-le et oriente vers ce qui compte le plus
- Écris directement, sans titre, sans bullet, sans intro générique
- Style : "Option X est plus forte sur…", "Si tu accordes de l'importance à…", "Ce que les chiffres révèlent ici…"
- Tutoie, sois chaleureux mais factuel. 3-5 phrases max.`;

      try {
        const res = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            messages: [{ role: 'user', content: prompt }]
          })
        });
        const data = await res.json();
        const text = data?.content?.[0]?.text || null;
        const el = document.getElementById('interpSub');
        if (!el) return;
        if (text) {
          const formatted = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n\n+/g, ' ')
            .replace(/\n/g, ' ');
          el.innerHTML = formatted;
        } else { throw new Error(); }
      } catch (e) {
        // Fallback local si l'API échoue
        const scores2 = S.options.map((_, i) => calcScore(i));
        const ranked2 = [...S.options.map((_, i) => i)].sort((a, b) => scores2[b] - scores2[a]);
        const w = ranked2[0], r = ranked2[1];
        const diff = scores2[w] - scores2[r];

        const topW = [...S.criteria].sort((a, b) => {
          const va = (a.invert ? 11 - (S.scores[a.id]?.[w] ?? 5) : (S.scores[a.id]?.[w] ?? 5)) * a.weight;
          const vb = (b.invert ? 11 - (S.scores[b.id]?.[w] ?? 5) : (S.scores[b.id]?.[w] ?? 5)) * b.weight;
          return vb - va;
        })[0];
        const topR = [...S.criteria].sort((a, b) => {
          const va = (a.invert ? 11 - (S.scores[a.id]?.[r] ?? 5) : (S.scores[a.id]?.[r] ?? 5)) * a.weight;
          const vb = (b.invert ? 11 - (S.scores[b.id]?.[r] ?? 5) : (S.scores[b.id]?.[r] ?? 5)) * b.weight;
          return vb - va;
        })[0];

        const msg = diff <= 4
          ? (LANG === 'en'
            ? `The two options are very close (${scores2[w]} vs ${scores2[r]} pts).`
            + (topW ? ` "${S.options[w].name}" stands out slightly on <strong>${topW.name}</strong>.` : '')
            + ` In this tight call, trust your instincts.`
            : `Les deux options sont très proches (${scores2[w]} vs ${scores2[r]} pts).`
            + (topW ? ` "${S.options[w].name}" se démarque légèrement sur <strong>${topW.name}</strong>.` : '')
            + ` Dans ce cas serré, fais confiance à ton instinct.`)
          : (LANG === 'en'
            ? `"${S.options[w].name}" comes out on top with a ${diff}-point lead.`
            + (topW ? ` Its main strength: <strong>${topW.name}</strong>.` : '')
            + (topR ? ` "${S.options[r].name}" remains stronger on <strong>${topR.name}</strong> — worth considering if that's a priority.` : '')
            : `"${S.options[w].name}" ressort en tête avec ${diff} points d'avance.`
            + (topW ? ` Son principal atout : <strong>${topW.name}</strong>.` : '')
            + (topR ? ` "${S.options[r].name}" reste plus fort sur <strong>${topR.name}</strong> — à peser si c'est une priorité.` : ''));

        const el2 = document.getElementById('interpSub');
        if (el2) el2.innerHTML = msg;
      }
    }

    /* ─── SCENARIO PANEL UNIFIÉ ──────────────── */

    // Critères actifs dans le scénario
    let S_active = new Set();
    // Émotion active (null = aucune)
    let S_emotion = null;
    // Couleurs basées sur le rang (gagnant=vert, 2ème=orange…) — calculé dans buildResults()
    let resultColors = {};

    // Définition des émotions avec mots-clés
    const EMOTIONS = {
      fear: {
        ids: new Set(['fin_risk', 'risk', 'stress', 'jobsec', 'fin_stab', 'cost', 'rev', 'complex', 'dep', 'workload']),
        words: /risque|peur|stress|sécurité|securite|danger|incertitude|coût|cout|complexité|complexite|difficulté|difficulte|charge|instabilité|instabilite|anxiété|anxiete/i,
        label: { fr: '😨 Peur', en: '😨 Fear' }
      },
      urgency: {
        ids: new Set(['deadline', 'time', 'workload', 'stress']),
        words: /urgence|délai|delai|pression|temps|rapidité|rapidite|vitesse|stress/i,
        label: { fr: '⏱️ Urgence', en: '⏱️ Urgency' }
      },
      ego: {
        ids: new Set(['prestige', 'status', 'recog', 'social', 'rep']),
        words: /prestige|statut|réputation|reputation|reconnaissance|fierté|fierte|image|ego|status/i,
        label: { fr: '🎭 Ego', en: '🎭 Ego' }
      },
    };

    function getEmotionCrits(emotion) {
      const def = EMOTIONS[emotion];
      if (!def) return new Set();
      return new Set(S.criteria.filter(c => {
        if (def.ids.has(c.id)) return true;
        if (c.custom) return def.words.test(c.name);
        return false;
      }).map(c => c.id));
    }

    function initScenario() {
      S_active = new Set(S.criteria.map(c => c.id));
      S_emotion = null;
      renderScenarioBody();
      renderEmotionPane();
    }

    function toggleScenarioBox() {
      const sb = document.getElementById('scenarioBox');
      if (!sb) return;
      sb.classList.toggle('open');
      const body = sb.querySelector('.scenario-panel-body');
      if (body) body.style.display = sb.classList.contains('open') ? 'block' : 'none';
    }

    function switchScTab(tab, el) {
      document.querySelectorAll('.sc-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      document.querySelectorAll('.sc-tab-pane').forEach(p => p.classList.remove('active'));
      const pane = document.getElementById(tab === 'crits' ? 'scPaneCrits' : 'scPaneEmotions');
      if (pane) pane.classList.add('active');
    }

    function calcScoreScenario(oi) {
      // MODIF SWING
      if (S.weightingMethod === 'swing') {
        const weights = getSwingWeights();
        const activeWeights = weights.filter(w => S_active.has(w.id));
        if (!activeWeights.length) return 0;
        const totalW = activeWeights.reduce((sum, w) => sum + w.weight, 0);
        let tot = 0;
        activeWeights.forEach(w => {
          const c = S.criteria.find(x => x.id === w.id);
          if (!c) return;
          let v = S.scores[c.id]?.[oi] ?? 5;
          if (c.invert) v = 11 - v;
          const normW = totalW > 0 ? w.weight / totalW : 0;
          tot += v * normW;
        });
        return Math.round((tot / 10) * 100);
      }
      // FIN MODIF SWING
      let tot = 0, max = 0;
      S.criteria.forEach(c => {
        if (!S_active.has(c.id)) return;
        let v = S.scores[c.id]?.[oi] ?? 5;
        if (c.invert) v = 11 - v;
        tot += v * c.weight; max += 10 * c.weight;
      });
      if (max === 0) return 0;
      return Math.round((tot / max) * 100);
    }

    function calcScoreFiltered(oi, excludeIds) {
      // MODIF SWING
      if (S.weightingMethod === 'swing') {
        const weights = getSwingWeights();
        const activeWeights = weights.filter(w => !excludeIds.has(w.id));
        if (!activeWeights.length) return null;
        const totalW = activeWeights.reduce((sum, w) => sum + w.weight, 0);
        let tot = 0;
        activeWeights.forEach(w => {
          const c = S.criteria.find(x => x.id === w.id);
          if (!c) return;
          let v = S.scores[c.id]?.[oi] ?? 5;
          if (c.invert) v = 11 - v;
          const normW = totalW > 0 ? w.weight / totalW : 0;
          tot += v * normW;
        });
        return Math.round((tot / 10) * 100);
      }
      // FIN MODIF SWING
      let tot = 0, max = 0;
      S.criteria.forEach(c => {
        if (excludeIds.has(c.id)) return;
        let v = S.scores[c.id]?.[oi] ?? 5;
        if (c.invert) v = 11 - v;
        tot += v * c.weight; max += 10 * c.weight;
      });
      if (max === 0) return null;
      return Math.round((tot / max) * 100);
    }

    function toggleScenarioCrit(id) {
      if (S_active.has(id)) S_active.delete(id);
      else S_active.add(id);
      if (S_active.size === 0) S_active.add(id);
      renderScenarioBody();
    }

    function resetScenario() {
      S_active = new Set(S.criteria.map(c => c.id));
      renderScenarioBody();
    }

    function renderScenarioBody() {
      const body = document.getElementById('scPaneCrits');
      if (!body) return;
      const activeCount = S_active.size;
      const rows = S.criteria.map(c => {
        const on = S_active.has(c.id);
        return `
      <div class="sc-crit-row${on ? '' : ' off'}">
        <div class="sc-crit-icon">${c.icon}</div>
        <div class="sc-crit-name">${c.name}</div>
        ${(() => {
            // MODIF SWING — badge poids dans panneau scénario
            if (S.weightingMethod === 'swing') {
              const weights = getSwingWeights();
              const pct = Math.round((weights.find(w => w.id === c.id)?.weight ?? 0) * 100);
              return `<span class="sc-crit-weight" style="background:var(--teal-bg);color:var(--teal);border-color:var(--teal-bd)">⚖️ ${pct}%</span>`;
            }
            return c.weight > 1 ? `<span class="sc-crit-weight">×${c.weight}</span>` : '';
            // FIN MODIF SWING
          })()}
        ${c.invert ? `<span class="sc-crit-inv">${tr('sc_inv')}</span>` : ''}
        <label class="mini-toggle" title="${on ? tr('sc_toggle_on') : tr('sc_toggle_off')}">
          <input type="checkbox" ${on ? 'checked' : ''} onchange="toggleScenarioCrit('${c.id}')">
          <div class="mini-toggle-track"></div>
          <div class="mini-toggle-thumb"></div>
        </label>
      </div>`;
      }).join('');

      // Bloc comparaison de scores — version cards glassmorphism
      const allActive = S_active.size === S.criteria.length;
      const baseScores = S.options.map((_, i) => calcScore(i));
      const scenScores = S.options.map((_, i) => calcScoreScenario(i));
      const ranked = [...S.options.map((_, i) => i)].sort((a, b) => baseScores[b] - baseScores[a]);
      const scenRanked = [...S.options.map((_, i) => i)].sort((a, b) => scenScores[b] - scenScores[a]);
      const switchedWinner = scenRanked[0] !== ranked[0];

      let comparisonBlock = '';
      if (allActive) {
        comparisonBlock = `<div class="scenario-impact-wrapper">
      <div class="scenario-impact-global">
        <span class="scenario-impact-global-pill">
          <span>💡</span>
          <span>${LANG === 'fr'
            ? 'Aucun critère désélectionné — tous les critères sont inclus dans le score.'
            : 'No criteria deselected — all criteria are included in the score.'}</span>
        </span>
      </div>
    </div>`;
      } else {
        const scoreRows = scenRanked.map(oi => {
          const c = resultColors[oi] || activeColors()[oi];
          const bs = baseScores[oi];
          const ss = scenScores[oi];
          const d = ss - bs;
          const sign = d > 0 ? '+' : '';
          const dir = d > 2 ? 'up' : d < -2 ? 'down' : 'same';

          const impactLabel = LANG === 'fr'
            ? (Math.abs(d) <= 2 ? 'Peu d’impact' : Math.abs(d) <= 5 ? 'Impact modéré' : 'Impact fort')
            : (Math.abs(d) <= 2 ? 'Low impact' : Math.abs(d) <= 5 ? 'Moderate impact' : 'Strong impact');

          return `<article class="scenario-impact-card scenario-impact-card-${dir}">
        <header class="scenario-impact-header">
          <div class="scenario-impact-label">
            <span class="scenario-impact-dot" style="background:${c.hex}"></span>
            <span class="scenario-impact-name">${LETTERS[oi]}. ${esc(S.options[oi].name)}</span>
          </div>
          <div class="scenario-delta-badge scenario-delta-${dir}">
            <span class="scenario-delta-sign">${sign}${d}</span>
          </div>
        </header>

        <div class="scenario-impact-scores">
          <div class="scenario-score scenario-score-base">
            <span class="scenario-score-caption">${tr('fear_score_real')}</span>
            <span class="scenario-score-value-base">${bs}</span>
          </div>
          <div class="scenario-score scenario-score-scen">
            <span class="scenario-score-caption">${LANG === 'fr' ? 'Scénario' : 'Scenario'}</span>
            <span class="scenario-score-value-main">${ss}</span>
          </div>
        </div>

        <footer class="scenario-impact-footer">
          <span class="scenario-impact-pill">${impactLabel}</span>
        </footer>
      </article>`;
        }).join('');

        let insight = '';
        if (switchedWinner) {
          const nN = esc(S.options[scenRanked[0]].name), oN = esc(S.options[ranked[0]].name);
          insight = `<div class="scenario-impact-global">
        <span class="scenario-impact-global-pill">
          <span>💡</span>
          <span>${LANG === 'fr'
              ? `Sans ces critères, <strong>"${nN}"</strong> passerait en tête au lieu de <strong>"${oN}"</strong>.`
              : `Without these criteria, <strong>"${nN}"</strong> would take the lead over <strong>"${oN}"</strong>.`}</span>
        </span>
      </div>`;
        } else {
          const maxD = ranked.reduce((b, oi) => {
            const d = scenScores[oi] - baseScores[oi];
            return Math.abs(d) > Math.abs(b.d) ? { oi, d } : b;
          }, { oi: ranked[0], d: 0 });
          if (Math.abs(maxD.d) > 4) {
            insight = `<div class="scenario-impact-global">
          <span class="scenario-impact-global-pill">
            <span>💡</span>
            <span>${LANG === 'fr'
                ? `Le classement reste identique, mais <strong>"${esc(S.options[maxD.oi].name)}"</strong> ${maxD.d > 0 ? 'gagne' : 'perd'} <strong>${Math.abs(maxD.d)} pts</strong> dans ce scénario.`
                : `The ranking stays the same, but <strong>"${esc(S.options[maxD.oi].name)}"</strong> ${maxD.d > 0 ? 'gains' : 'loses'} <strong>${Math.abs(maxD.d)} pts</strong> in this scenario.`}</span>
          </span>
        </div>`;
          } else {
            insight = `<div class="scenario-impact-global">
          <span class="scenario-impact-global-pill">
            <span>💡</span>
            <span>${LANG === 'fr'
                ? 'Le classement reste identique — ces critères ont peu d’impact sur votre décision.'
                : 'The ranking stays the same — these criteria have little impact on your decision.'}</span>
          </span>
        </div>`;
          }
        }

        comparisonBlock = `<div class="scenario-impact-wrapper">
      <div class="scenario-impact-grid">
        ${scoreRows}
      </div>
      ${insight}
    </div>`;
      }

      body.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <span style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em">
        ${tr('scenario_active', activeCount, S.criteria.length)}
      </span>
      <button class="scenario-reset" onclick="resetScenario()">${tr('scenario_reset')}</button>
    </div>
    <div class="sc-crit-list">${rows}</div>
    <div style="margin-top:14px;padding-top:10px;border-top:1px solid var(--border)">${comparisonBlock}</div>`;
    }

    function renderEmotionPane() {
      const pane = document.getElementById('scPaneEmotions');
      if (!pane) return;

      // Chips émotions
      const chips = Object.entries(EMOTIONS).map(([key, def]) => {
        const crits = [...getEmotionCrits(key)];
        const count = crits.length;
        const label = def.label[LANG] || def.label.fr;
        const active = S_emotion === key;
        return `<div class="emotion-chip${active ? ' active' : ''}" onclick="toggleEmotion('${key}')">
      ${label}
      <span class="emotion-chip-count">${count}</span>
    </div>`;
      }).join('');

      pane.innerHTML = `
    <p style="font-size:.75rem;color:var(--muted);margin-bottom:10px;line-height:1.5">
      ${LANG === 'fr'
          ? 'Sélectionnez une émotion pour voir comment vos scores changent si ces critères étaient mis de côté.'
          : 'Select an emotion to see how scores change if those criteria were excluded.'}
    </p>
    <div class="emotion-filters">${chips}</div>
    <div id="emotionResult"></div>`;

      renderEmotionResult();
    }

    function toggleEmotion(key) {
      S_emotion = S_emotion === key ? null : key;
      renderEmotionPane();
      updateScenarioScores();
    }

    function renderEmotionResult() {
      const el = document.getElementById('emotionResult');
      if (!el) return;

      if (!S_emotion) {
        el.innerHTML = `<div class="emotion-none">${LANG === 'fr'
          ? 'Aucune émotion sélectionnée — tous les critères sont inclus.'
          : 'No emotion selected — all criteria are included.'}</div>`;
        return;
      }

      const emotionIds = getEmotionCrits(S_emotion);
      if (emotionIds.size === 0) {
        el.innerHTML = `<div class="emotion-none">${LANG === 'fr'
          ? 'Aucun critère lié à cette émotion n\'a été sélectionné dans votre analyse.'
          : 'No criteria linked to this emotion were selected in your analysis.'}</div>`;
        return;
      }

      const tags = S.criteria.map(c => {
        const excluded = emotionIds.has(c.id);
        return `<span class="emotion-crit-tag ${excluded ? 'excluded' : 'included'}">${c.icon} ${c.name}${excluded ? ' ✕' : ''}</span>`;
      }).join('');

      const normalScores = S.options.map((_, i) => calcScore(i));
      const filteredScores = S.options.map((_, i) => calcScoreFiltered(i, emotionIds));
      const ranked = [...S.options.map((_, i) => i)].sort((a, b) => normalScores[b] - normalScores[a]);
      const filtRanked = [...S.options.map((_, i) => i)].sort((a, b) => (filteredScores[b] ?? 0) - (filteredScores[a] ?? 0));
      const switchedWinner = filtRanked[0] !== ranked[0];

      const cards = ranked.map(oi => {
        const c = resultColors[oi] || activeColors()[oi];
        const ns = normalScores[oi];
        const fs = filteredScores[oi];
        const d = fs !== null ? fs - ns : 0;
        const sign = d > 0 ? '+' : '';
        const dir = fs === null ? 'same' : (d > 2 ? 'up' : d < -2 ? 'down' : 'same');

        const impactLabel = LANG === 'fr'
          ? (fs === null
            ? 'Impact non mesurable'
            : Math.abs(d) <= 2 ? 'Peu d’impact émotionnel' : Math.abs(d) <= 5 ? 'Impact émotionnel modéré' : 'Impact émotionnel fort')
          : (fs === null
            ? 'Impact not measurable'
            : Math.abs(d) <= 2 ? 'Low emotional impact' : Math.abs(d) <= 5 ? 'Moderate emotional impact' : 'Strong emotional impact');

        const scenValue = fs !== null ? fs : '—';

        return `<article class="scenario-impact-card scenario-impact-card-${dir}">
      <header class="scenario-impact-header">
        <div class="scenario-impact-label">
          <span class="scenario-impact-dot" style="background:${c.hex}"></span>
          <span class="scenario-impact-name">${LETTERS[oi]}. ${esc(S.options[oi].name)}</span>
        </div>
        <div class="scenario-delta-badge scenario-delta-${dir}">
          <span class="scenario-delta-sign">${fs !== null ? `${sign}${d}` : '?'}</span>
        </div>
      </header>

      <div class="scenario-impact-scores">
        <div class="scenario-score scenario-score-base">
          <span class="scenario-score-caption">${tr('fear_score_real')}</span>
          <span class="scenario-score-value-base">${ns}</span>
        </div>
        <div class="scenario-score scenario-score-scen">
          <span class="scenario-score-caption">${LANG === 'fr' ? 'Sans émotion' : 'Emotion-free'}</span>
          <span class="scenario-score-value-main">${scenValue}</span>
        </div>
      </div>

      <footer class="scenario-impact-footer">
        <span class="scenario-impact-pill">${impactLabel}</span>
      </footer>
    </article>`;
      }).join('');

      // Insight narratif sous forme de pill globale
      let insight = '';
      if (switchedWinner) {
        const nN = esc(S.options[filtRanked[0]].name), oN = esc(S.options[ranked[0]].name);
        insight = `<div class="scenario-impact-global">
      <span class="scenario-impact-global-pill">
        <span>💡</span>
        <span>${LANG === 'fr'
            ? `Sans ces critères, <strong>"${nN}"</strong> passerait en tête — c'est probablement cette émotion qui oriente votre décision vers <strong>"${oN}"</strong>.`
            : `Without these criteria, <strong>"${nN}"</strong> would take the lead — this emotion may be steering your decision toward <strong>"${oN}"</strong>.`}</span>
      </span>
    </div>`;
      } else {
        const maxD = ranked.reduce((b, oi) => { const d = (filteredScores[oi] ?? 0) - normalScores[oi]; return Math.abs(d) > Math.abs(b.d) ? { oi, d } : b }, { oi: ranked[0], d: 0 });
        if (Math.abs(maxD.d) > 4) {
          insight = `<div class="scenario-impact-global">
        <span class="scenario-impact-global-pill">
          <span>💡</span>
          <span>${LANG === 'fr'
              ? `Le classement reste identique, mais <strong>"${esc(S.options[maxD.oi].name)}"</strong> ${maxD.d > 0 ? 'gagne' : 'perd'} <strong>${Math.abs(maxD.d)} pts</strong> sans ces critères.`
              : `The ranking stays the same, but <strong>"${esc(S.options[maxD.oi].name)}"</strong> ${maxD.d > 0 ? 'gains' : 'loses'} <strong>${Math.abs(maxD.d)} pts</strong> without these criteria.`}</span>
        </span>
      </div>`;
        } else {
          insight = `<div class="scenario-impact-global">
        <span class="scenario-impact-global-pill">
          <span>💡</span>
          <span>${LANG === 'fr'
              ? 'Le classement reste identique — votre décision n\'est pas fortement influencée par cette émotion.'
              : 'The ranking stays the same — your decision is not strongly influenced by this emotion.'}</span>
        </span>
      </div>`;
        }
      }

      const comparisonBlock = `<div class="scenario-impact-wrapper">
    <div class="scenario-impact-grid">
      ${cards}
    </div>
    ${insight}
  </div>`;

      el.innerHTML = `
    <div class="emotion-crit-tags">${tags}</div>
    ${comparisonBlock}`;
    }



    function genScenarioInsight() {
      const disabledCrits = S.criteria.filter(c => !S_active.has(c.id));

      if (disabledCrits.length === 0) {
        return tr('sc_all_active');
      }

      const baseScores = S.options.map((_, i) => calcScore(i));
      const scenScores = S.options.map((_, i) => calcScoreScenario(i));
      const baseRanked = [...S.options.map((_, i) => i)].sort((a, b) => baseScores[b] - baseScores[a]);
      const scenRanked = [...S.options.map((_, i) => i)].sort((a, b) => scenScores[b] - scenScores[a]);

      const baseWinner = baseRanked[0];
      const scenWinner = scenRanked[0];
      const switched = scenWinner !== baseWinner;

      const disabledNames = disabledCrits.map(c => `<strong>${c.name}</strong>`).join(LANG === 'en' ? ' and ' : ' et ');
      const plural = disabledCrits.length > 1;
      const s = plural ? 's' : '';

      const deltas = S.options.map((_, i) => ({ i, d: scenScores[i] - baseScores[i] }));
      const bigGainer = deltas.reduce((a, b) => b.d > a.d ? b : a);
      const bigLoser = deltas.reduce((a, b) => b.d < a.d ? b : a);

      // Cas 1 — classement inversé
      if (switched) {
        const newName = esc(S.options[scenWinner].name);
        const oldName = esc(S.options[baseWinner].name);
        const gain = scenScores[scenWinner] - baseScores[scenWinner];
        const gainSign = gain >= 0 ? `+${gain}` : gain;
        const p1 = LANG === 'en' ? (plural ? 'played' : 'played') : (plural ? 'jouaient' : 'jouait');
        return tr('sc_switched', disabledNames, newName, gainSign, oldName, s, p1);
      }

      // Cas 2 — écart réduit
      const baseGap = baseScores[baseWinner] - baseScores[baseRanked[1]];
      const scenGap = scenScores[scenWinner] - scenScores[scenRanked[1]];
      if (scenGap < baseGap && baseGap - scenGap >= 6) {
        const gapDiff = baseGap - scenGap;
        const p2 = LANG === 'en' ? (plural ? 'constitute' : 'constitutes') : (plural ? 'constituent' : 'constitue');
        return tr('sc_reduced', esc(S.options[baseWinner].name), gapDiff, disabledNames, s, p2);
      }

      // Cas 3 — écart qui se creuse
      if (scenGap > baseGap + 5) {
        const p3 = LANG === 'en'
          ? `${plural ? 'are' : 'is'} not what drives this option's strength`
          : `ne ${plural ? 'sont' : 'est'} pas ce qui fait la force de cette option`;
        return tr('sc_wider', esc(S.options[baseWinner].name), scenGap - baseGap, disabledNames, s, p3);
      }

      // Cas 4 — divergence forte
      if (bigGainer.d >= 8 && bigGainer.i !== bigLoser.i && bigLoser.d <= -8) {
        const gN = esc(S.options[bigGainer.i].name);
        const lN = esc(S.options[bigLoser.i].name);
        const p4 = LANG === 'en' ? (plural ? 'weigh' : 'weighs') : (plural ? 'pèsent' : 'pèse');
        return tr('sc_diverge', gN, bigGainer.d, lN, Math.abs(bigLoser.d), disabledNames, p4);
      }

      // Cas 5 — impact faible
      const maxDelta = Math.max(...deltas.map(d => Math.abs(d.d)));
      if (maxDelta <= 4) {
        const p5 = LANG === 'en'
          ? `${plural ? 'are not' : 'is not'} decisive`
          : `n\u2019est pas déterminant${s}`;
        return tr('sc_nochange', disabledNames, maxDelta + 1, s, p5);
      }

      // Cas 6 — fallback
      const mostImpacted = deltas.reduce((a, b) => Math.abs(b.d) > Math.abs(a.d) ? b : a);
      const sign = mostImpacted.d >= 0 ? `+${mostImpacted.d}` : `${mostImpacted.d}`;
      const p6 = LANG === 'en'
        ? (plural ? 'influence' : 'influences')
        : (plural ? 'influencent' : 'influence');
      return tr('sc_fallback', disabledNames, esc(S.options[mostImpacted.i].name), sign, s, p6);
    }


    function updateScenarioScores() {
      const baseScores = S.options.map((_, i) => calcScore(i));
      const scenScores = S.options.map((_, i) => calcScoreScenario(i));
      const scenRanked = [...S.options.map((_, i) => i)].sort((a, b) => scenScores[b] - scenScores[a]);
      const allActive = S_active.size === S.criteria.length && !S_emotion;

      const row = document.getElementById('scoresRow');
      if (!row) return;

      const rankLabels = tr('rank_labels');
      row.innerHTML = scenRanked.map((oi, rank) => {
        const c = resultColors[oi] || activeColors()[oi];
        const sc = scenScores[oi];
        const base = baseScores[oi];
        const delta = sc - base;
        const rankLbl = rank < 3 ? rankLabels[rank] : `#${rank + 1}`;
        const r = 22, circ = (2 * Math.PI * r).toFixed(2);
        const off = (circ - (sc / 100) * circ).toFixed(2);
        const deltaTag = allActive ? '' :
          `<div class="sc-card-delta ${delta > 2 ? 'up' : delta < -2 ? 'down' : 'same'}">${delta > 0 ? '+' : ''}${delta} pts</div>`;
        const sortedCrits = [...S.criteria].filter(cr => S_active.has(cr.id)).sort((a, b) => {
          const va = S.scores[a.id]?.[oi] ?? 5; const vb = S.scores[b.id]?.[oi] ?? 5;
          const ea = a.invert ? 11 - va : va; const eb = b.invert ? 11 - vb : vb;
          return (eb * b.weight) - (ea * a.weight);
        }).slice(0, 4);
        const miniCrits = sortedCrits.map(cr => {
          const v = S.scores[cr.id]?.[oi] ?? 5; const eff = cr.invert ? 11 - v : v;
          return `<div class="sc-mini-crit">
        <span class="sc-mini-crit-name">${cr.icon} ${cr.name}</span>
        <div class="sc-mini-bar"><div class="sc-mini-bar-fill" style="width:${eff * 10}%;background:${c.hex}"></div></div>
        <span class="sc-mini-crit-val" style="color:${c.hex}">${v}</span>
      </div>`;
        }).join('');
        const critLabel = LANG === 'fr' ? 'Critères' : 'Criteria';
        return `
      <div class="sc-card${rank === 0 ? ' sc-card-winner' : ''}" style="border-color:${c.hex};background:linear-gradient(145deg,var(--white) 55%,${c.bg})">
        <div class="sc-card-body">
          <div class="sc-card-left">
            <div class="sc-card-top">
              <div class="sc-card-rank" style="background:${c.bg};color:${c.hex}">${rankLbl}</div>
              <div class="sc-card-name">${esc(S.options[oi].name)}</div>
            </div>
            <div class="sc-card-score">
              <div class="sc-score-display">
                <div class="sc-card-num" style="color:${c.hex}">${sc}</div>
                <div class="sc-card-den" style="color:${c.hex}">/100</div>
              </div>
              ${deltaTag}
              <div class="sc-score-bar">
                <div class="sc-score-bar-fill" style="width:${sc}%;background:${scoreColor(sc)}"></div>
              </div>
            </div>
            ${miniCrits ? `<div class="sc-card-crits-wrap">
              <button class="sc-card-crits-toggle" onclick="this.closest('.sc-card-crits-wrap').classList.toggle('open')">
                <span>${critLabel}</span>
                <span class="sc-card-crits-toggle-icon">▾</span>
              </button>
              <div class="sc-card-crits">${miniCrits}</div>
            </div>` : ''}
          </div>
        </div>
      </div>`;
      }).join('');

      setTimeout(() => drawRadarScenario(scenScores), 50);
    }



    function genAnalysis(scores, winner, ranked) {
      const wName = S.options[winner].name;
      const pros = [], cons = [];
      const sortW = [...S.criteria].sort((a, b) => {
        let va = S.scores[a.id]?.[winner] ?? 5, vb = S.scores[b.id]?.[winner] ?? 5;
        if (a.invert) va = 11 - va; if (b.invert) vb = 11 - vb;
        return (vb * b.weight) - (va * a.weight);
      });
      sortW.slice(0, 2).forEach(c => {
        const v = S.scores[c.id]?.[winner] ?? 5;
        pros.push(tr('an_score_high', c.name, v, c.weight));
      });
      const diff = scores[ranked[0]] - scores[ranked[1]];
      if (diff > 15) pros.push(tr('an_clear', diff));
      else if (diff <= 4) pros.push(tr('an_tight'));
      if (ranked.length > 1) {
        const ru = ranked[1];
        const sortR = [...S.criteria].sort((a, b) => {
          let va = S.scores[a.id]?.[ru] ?? 5, vb = S.scores[b.id]?.[ru] ?? 5;
          if (a.invert) va = 11 - va; if (b.invert) vb = 11 - vb;
          return (vb * b.weight) - (va * a.weight);
        });
        sortR.slice(0, 2).forEach(c => {
          const vW = S.scores[c.id]?.[winner] ?? 5, vR = S.scores[c.id]?.[ru] ?? 5;
          if (vR > vW) cons.push(tr('an_runner', esc(S.options[ru].name), c.name, vR, vW));
        });
      }
      S.criteria.filter(c => c.weight === 3).forEach(c => {
        const v = S.scores[c.id]?.[winner] ?? 5;
        if (v < 5) cons.push(tr('an_weak', c.name, v, esc(wName)));
      });
      if (!cons.length) cons.push(tr('an_no_cons'));
      return { pros: pros.slice(0, 3), cons: cons.slice(0, 3) };
    }


    function drawRadar() { drawRadarScenario(null); }

    function drawRadarScenario(overrideScores) {
      const canvas = document.getElementById('radarC'); if (!canvas) return;
      const activeCrits = overrideScores
        ? S.criteria.filter(c => S_active.has(c.id))
        : S.criteria;
      if (activeCrits.length < 3) { return; }

      const ctx = canvas.getContext('2d');
      const W = canvas.width, H = canvas.height;
      const cx = W / 2, cy = H / 2;
      const N = activeCrits.length;
      const R = Math.min(W, H) / 2 - 72;
      ctx.clearRect(0, 0, W, H);
      const angle = i => (i / N) * Math.PI * 2 - Math.PI / 2;

      /* Couleurs adaptées au mode sombre */
      const isDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
      const gridOuter = isDark ? 'rgba(255,255,255,0.18)' : 'rgba(0,0,0,0.13)';
      const gridInner = isDark ? 'rgba(255,255,255,0.07)' : 'rgba(0,0,0,0.06)';
      const axisColor = isDark ? 'rgba(255,255,255,0.12)' : 'rgba(0,0,0,0.08)';
      const levelLblColor = isDark ? 'rgba(255,255,255,0.40)' : 'rgba(0,0,0,0.25)';
      const critNameColor = isDark ? '#e2e8f0' : '#555';
      const weightBadgeCol = isDark ? '#fbbf24' : '#b47d0a';

      // Grille de fond
      [2, 4, 6, 8, 10].forEach(lvl => {
        ctx.beginPath();
        activeCrits.forEach((_, i) => {
          const a = angle(i), r = (lvl / 10) * R;
          i === 0 ? ctx.moveTo(cx + r * Math.cos(a), cy + r * Math.sin(a))
            : ctx.lineTo(cx + r * Math.cos(a), cy + r * Math.sin(a));
        });
        ctx.closePath();
        ctx.strokeStyle = lvl === 10 ? gridOuter : gridInner;
        ctx.lineWidth = lvl === 10 ? 1.5 : 1;
        ctx.stroke();
        // Label de niveau sur l'axe du haut
        const labelR = (lvl / 10) * R;
        ctx.font = '9px Plus Jakarta Sans,sans-serif';
        ctx.textAlign = 'center';
        ctx.fillStyle = levelLblColor;
        if (lvl % 4 === 0) ctx.fillText(lvl, cx + 4, cy - labelR + 10);
      });

      // Axes radiaux
      activeCrits.forEach((_, i) => {
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + R * Math.cos(angle(i)), cy + R * Math.sin(angle(i)));
        ctx.strokeStyle = axisColor;
        ctx.lineWidth = 1;
        ctx.stroke();
      });

      // Labels critères
      activeCrits.forEach((c, i) => {
        const a = angle(i);
        const dist = R + 48;
        const x = cx + dist * Math.cos(a);
        const y = cy + dist * Math.sin(a);

        // Fond de label pour lisibilité
        const short = c.name.length > 12 ? c.name.substring(0, 11) + '…' : c.name;
        ctx.font = 'bold 11px Plus Jakarta Sans,sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // Icône
        ctx.font = '13px serif';
        ctx.fillText(c.icon, x, y - 8);

        // Nom
        ctx.font = '10px Plus Jakarta Sans,sans-serif';
        ctx.fillStyle = critNameColor;
        ctx.fillText(short, x, y + 6);

        // Badge poids
        if (c.weight > 1) {
          const bx = x + ctx.measureText(short).width / 2 + 8;
          ctx.font = 'bold 9px Plus Jakarta Sans,sans-serif';
          ctx.fillStyle = weightBadgeCol;
          ctx.fillText(`×${c.weight}`, bx, y + 6);
        }
      });

      // Polygones par option
      S.options.forEach((_, oi) => {
        const col = resultColors[oi] || activeColors()[oi];
        const hex = col.hex.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);

        // Score effectif (invert pris en compte)
        const pts = activeCrits.map((c, i) => {
          const v = S.scores[c.id]?.[oi] ?? 5;
          const eff = c.invert ? 11 - v : v;
          const rad = (eff / 10) * R;
          return [cx + rad * Math.cos(angle(i)), cy + rad * Math.sin(angle(i))];
        });

        ctx.beginPath();
        pts.forEach(([px, py], i) => i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py));
        ctx.closePath();
        ctx.fillStyle = `rgba(${r},${g},${b},0.10)`;
        ctx.fill();
        ctx.strokeStyle = col.hex;
        ctx.lineWidth = 2;
        ctx.stroke();

        // Points sur chaque axe
        pts.forEach(([px, py]) => {
          ctx.beginPath();
          ctx.arc(px, py, 3.5, 0, Math.PI * 2);
          ctx.fillStyle = col.hex;
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 1.5;
          ctx.stroke();
        });
      });
    }

    /* ══════════════════════════════════════════
       HISTORY & INSIGHTS
       ══════════════════════════════════════════ */

    function getDecisions() {
      try { return JSON.parse(localStorage.getItem('lucid_decisions') || '[]'); }
      catch (e) { return []; }
    }

    function saveAndTrack() {
      const scores = S.options.map((_, i) => calcScore(i));
      const ranked = [...S.options.map((_, i) => i)].sort((a, b) => scores[b] - scores[a]);
      const winnerIdx = ranked[0];

      const decision = {
        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
        date: new Date().toISOString(),
        title: S.decision,
        options: S.options,
        criteria: S.criteria,
        scores: S.scores, // raw scores matrix
        finalScores: scores,
        winnerIdx: winnerIdx,
        notes: S.notes,
        weightingMethod: S.weightingMethod,
        status: 'pending', // pending | reviewed
        followUp: null
      };

      const history = getDecisions();
      history.unshift(decision);
      localStorage.setItem('lucid_decisions', JSON.stringify(history));

      const btn = document.getElementById('btnSaveTrack');
      const originalText = btn.textContent;
      btn.textContent = tr('save_done');
      btn.classList.add('btn-primary');
      btn.disabled = true;
      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-primary');
        btn.disabled = false;
      }, 2000);
    }

    function renderHistory() {
      const list = document.getElementById('histList');
      const history = getDecisions();

      renderInsights(history);

      if (history.length === 0) {
        list.innerHTML = `<div class="empty-hint">${tr('hist_empty')}</div>`;
        return;
      }

      list.innerHTML = history.map(d => {
        const date = new Date(d.date).toLocaleDateString(LANG === 'fr' ? 'fr-FR' : 'en-US');
        const winnerName = d.options[d.winnerIdx].name;
        const initialScore = d.finalScores[d.winnerIdx];
        const isReviewed = d.status === 'reviewed';
        const UPD_EMOJIS = ['😭', '😞', '😟', '😕', '😐', '🙂', '😊', '😄', '😁', '🤩'];
        const UPD_COLORS = ['#ef4444', '#ef4444', '#f97316', '#f97316', '#eab308', '#eab308', '#14b8a6', '#14b8a6', '#22c55e', '#22c55e'];
        const initVal = d.followUp?.globalScore || Math.round(initialScore / 10);
        const initEmoji = UPD_EMOJIS[initVal - 1] || '😐';
        const initColor = UPD_COLORS[initVal - 1] || '#eab308';

        let metaHTML = `<span class="hist-badge ${isReviewed ? 'hb-done' : 'hb-pending'}">${isReviewed ? tr('hist_reviewed') : tr('hist_pending')}</span>`;

        const labelPred = LANG === 'fr' ? 'Prédiction' : 'Prediction';
        const labelReal = LANG === 'fr' ? 'Réel' : 'Actual';

        if (isReviewed && d.followUp) {
          const actual = d.followUp.globalScore * 10;
          const delta = actual - initialScore;
          const sign = delta > 0 ? '+' : '';
          const dir = delta >= 0 ? 'up' : 'down';
          const arrow = delta >= 0 ? '↑' : '↓';
          metaHTML += `
            <div class="hist-score-row">
              <div class="hist-score-block">
                <span class="hist-score-label">${labelPred}</span>
                <span class="hist-score-pill initial">${initialScore}<span class="pill-denom">/100</span></span>
              </div>
              <span class="hist-score-arrow">→</span>
              <div class="hist-score-block">
                <span class="hist-score-label">${labelReal}</span>
                <span class="hist-score-pill actual-${dir}">${actual}<span class="pill-denom">/100</span></span>
              </div>
              <span class="hist-delta-badge ${dir}">${sign}${delta} ${arrow}</span>
            </div>`;
        } else {
          metaHTML += `
            <div class="hist-score-row">
              <div class="hist-score-block">
                <span class="hist-score-label">${labelPred}</span>
                <span class="hist-score-pill initial">${initialScore}<span class="pill-denom">/100</span></span>
              </div>
              <span class="hist-winner-name">↳ ${esc(winnerName)}</span>
            </div>`;
        }

        return `
      <div class="hist-card${isReviewed ? ' hc-done' : ''}" id="hist-${d.id}">
        <button class="hist-card-close" onclick="event.stopPropagation();deleteDecision('${d.id}')" title="${tr('hist_delete')}">✕</button>
        <div class="hist-head">
          <div style="padding-right:28px">
            <div class="hist-date">${date}</div>
            <div class="hist-title">${esc(d.title)}</div>
          </div>
        </div>
        <div class="hist-meta">${metaHTML}</div>

        <div id="upd-form-${d.id}" style="display:none" class="update-form">
          <div class="upd-form-title">${tr('hist_upd_title')}</div>
          <div class="upd-form-desc">${tr('hist_upd_desc')}</div>

          <div class="upd-score-widget">
            <div id="upd-emoji-${d.id}" class="upd-score-emoji">${initEmoji}</div>
            <div class="upd-score-row">
              <button class="stepper-btn" onclick="updScore('${d.id}', parseInt(document.getElementById('upd-score-${d.id}').value)-1)">−</button>
              <div class="upd-score-display">
                <span id="upd-score-val-${d.id}" class="upd-score-val">${initVal}</span>
                <span class="upd-score-denom">/10</span>
              </div>
              <button class="stepper-btn" onclick="updScore('${d.id}', parseInt(document.getElementById('upd-score-${d.id}').value)+1)">+</button>
            </div>
            <input type="hidden" id="upd-score-${d.id}" value="${initVal}">
            <div class="upd-gauge">
              <div class="upd-gauge-bar" id="upd-gauge-bar-${d.id}" style="width:${initVal * 10}%;background-color:${initColor}"></div>
            </div>
          </div>

          <div class="field">
            <label>${tr('hist_comment')}</label>
            <textarea id="upd-comment-${d.id}" rows="2">${esc(d.followUp?.comment || '')}</textarea>
          </div>

          <button class="btn btn-primary" onclick="saveUpdate('${d.id}')">${tr('hist_save_upd')}</button>
        </div>

        <div class="hist-actions">
          <button class="btn btn-secondary" style="font-size:.73rem;padding:6px 13px;border-radius:20px" onclick="toggleUpdate('${d.id}')">
            ${isReviewed ? '✏️ Modifier le suivi' : tr('hist_update_btn')}
          </button>
          <button class="hist-action-btn resume" onclick="editDecision('${d.id}')">
            ↩ ${tr('hist_edit_decision')}
          </button>
        </div>
      </div>`;
      }).join('');
    }

    function updScore(id, raw) {
      const v = Math.max(1, Math.min(10, parseInt(raw) || 1));
      document.getElementById('upd-score-' + id).value = v;
      document.getElementById('upd-score-val-' + id).textContent = v;
      const emojis = ['😭', '😞', '😟', '😕', '😐', '🙂', '😊', '😄', '😁', '🤩'];
      const colors = ['#ef4444', '#ef4444', '#f97316', '#f97316', '#eab308', '#eab308', '#14b8a6', '#14b8a6', '#22c55e', '#22c55e'];
      const emojiEl = document.getElementById('upd-emoji-' + id);
      emojiEl.textContent = emojis[v - 1];
      emojiEl.classList.remove('bump');
      void emojiEl.offsetWidth;
      emojiEl.classList.add('bump');
      setTimeout(() => emojiEl.classList.remove('bump'), 120);
      const bar = document.getElementById('upd-gauge-bar-' + id);
      bar.style.width = (v * 10) + '%';
      bar.style.backgroundColor = colors[v - 1];
    }

    function toggleUpdate(id) {
      const form = document.getElementById(`upd-form-${id}`);
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function saveUpdate(id) {
      const history = getDecisions();
      const idx = history.findIndex(d => d.id === id);
      if (idx === -1) return;

      const score = parseInt(document.getElementById(`upd-score-${id}`).value);
      const comment = document.getElementById(`upd-comment-${id}`).value;

      history[idx].status = 'reviewed';
      history[idx].followUp = {
        date: new Date().toISOString(),
        globalScore: score,
        comment: comment
      };

      localStorage.setItem('lucid_decisions', JSON.stringify(history));
      renderHistory();
    }

    function deleteDecision(id) {
      const history = getDecisions();
      const idx = history.findIndex(d => d.id === id);
      if (idx === -1) return;
      if (!confirm(tr('hist_delete_confirm'))) return;
      history.splice(idx, 1);
      localStorage.setItem('lucid_decisions', JSON.stringify(history));
      renderHistory();
    }

    function editDecision(id) {
      const history = getDecisions();
      const dec = history.find(d => d.id === id);
      if (!dec) return;

      S.decision = dec.title || '';
      S.options = Array.isArray(dec.options) ? dec.options : [];
      S.criteria = Array.isArray(dec.criteria) ? dec.criteria : [];
      S.scores = dec.scores || {};
      S.notes = Array.isArray(dec.notes) ? dec.notes : (S.options || []).map(() => '');
      S.weightingMethod = dec.weightingMethod || 'simple';

      nav('page-step1');
      renderStepProgress(1);

      const decInput = document.getElementById('inp-dec');
      if (decInput) decInput.value = S.decision;

      renderOptBuilder();
    }

    function renderInsights(history) {
      const reviewed = history.filter(d => d.status === 'reviewed');
      const box = document.getElementById('insightsArea');

      if (reviewed.length < 2) {
        box.innerHTML = `<div class="insight-box"><div class="insight-row"><div class="insight-icon">🔒</div><div class="insight-txt">${tr('ins_nodata')}</div></div></div>`;
        return;
      }

      // Metric 1: Optimism bias (Predicted vs Actual)
      let totalDelta = 0;
      reviewed.forEach(d => {
        const predicted = d.finalScores[d.winnerIdx]; // /100
        const actual = d.followUp.globalScore * 10;   // /100
        totalDelta += (actual - predicted);
      });
      const avgDelta = Math.round(totalDelta / reviewed.length);

      // Metric 2: Winner confirmation
      // If actual score >= 70 (7/10), we consider it a "good choice" confirmation
      const goodChoices = reviewed.filter(d => d.followUp.globalScore >= 7).length;
      const goodPct = Math.round((goodChoices / reviewed.length) * 100);

      box.innerHTML = `
    <div class="insight-box">
      <div style="font-weight:700;color:var(--teal);margin-bottom:14px;text-transform:uppercase;letter-spacing:.05em;font-size:.75rem">✨ ${tr('ins_title')}</div>
      <div class="insight-row">
        <div class="insight-icon">${avgDelta >= 0 ? '😎' : '🧐'}</div>
        <div class="insight-txt">${tr('ins_optimism', avgDelta)}</div>
      </div>
      <div class="insight-row">
        <div class="insight-icon">🏆</div>
        <div class="insight-txt">${tr('ins_winner', goodPct)}</div>
      </div>
    </div>`;
    }

    /* ─── UTILS ─────────────────────────────── */
    function esc(s) {
      if (!s) return '';
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    function shake(id) {
      const el = document.getElementById(id); if (!el) return;
      el.style.borderColor = 'var(--red)'; el.focus();
      setTimeout(() => el.style.borderColor = '', 1800);
    }
    function restart() {
      S = {
        decision: '', options: [{ name: '', desc: '' }, { name: '', desc: '' }],
        criteria: [], scores: {}, notes: [], currentCat: 'Tous',
        weightingMethod: 'simple' // MODIF SWING — reset méthode
      };
      document.getElementById('inp-dec').value = '';
      renderOptBuilder();
      renderStepProgress(1);
      nav('page-intro');
    }
  </script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@2.0.8/dist/lottie-player.js"></script>
  <script>
    (function () {
      var player = document.querySelector('lottie-player.mascot');
      if (!player) return;
      player.addEventListener('complete', function () {
        setTimeout(function () { player.play(); }, 3000);
      });
    })();
  </script>
</body>

</html>

</html>

</html>