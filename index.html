<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucid — Aide à la décision</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Lora:wght@600;700&display=swap" rel="stylesheet">
<style>
/* ── TOKENS ─────────────────────────────── */
:root {
  --bg:       #f5f4f0;
  --bg2:      #eceae4;
  --white:    #ffffff;
  --border:   #e2dfd8;
  --border2:  #cdc9c0;
  --ink:      #1a1917;
  --ink2:     #3d3b36;
  --muted:    #8a877f;
  --muted2:   #b8b4ac;
  --teal:     #2d7d5a;
  --teal2:    #389e71;
  --teal-bg:  #eef7f2;
  --teal-bd:  #b6ddc9;
  --green:    #2d8a4e;
  --green-bg: #eaf4ee;
  --red:      #c0392b;
  --red-bg:   #fdecea;
  --amber:    #b8820a;
  --amber-bg: #fef6e4;
  --r:        14px;
  --r-sm:     9px;
  --shadow:   0 2px 12px rgba(0,0,0,0.07);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.1);
}

/* ── RESET ───────────────────────────────── */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;height:100dvh;overflow:hidden;}
body{
  background:var(--bg);
  color:var(--ink);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:15px;
  line-height:1.6;
}

/* ── PAGES ───────────────────────────────── */
.page{display:none;height:100vh;height:100dvh;flex-direction:column;overflow:hidden;}
.page.active{display:flex;}

/* Contenu scrollable sous le header */
.page-scroll{
  flex:1;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
}

/* ── HEADER ──────────────────────────────── */
.app-header{
  background:var(--white);
  border-bottom:1px solid var(--border);
  padding:14px 28px;
  display:flex;align-items:center;
  flex-shrink:0;
  z-index:50;
  box-shadow:0 1px 4px rgba(0,0,0,0.05);
}
.app-header .step-progress{
  position:absolute;left:50%;transform:translateX(-50%);
}
.app-header .lang-switcher{
  margin-left:auto;position:static;
}
.logo{
  font-family:'Lora',serif;
  font-size:1.3rem;font-weight:700;
  color:var(--ink);
  letter-spacing:-.02em;
  display:flex;align-items:center;gap:6px;
}
.logo-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--teal);
  display:inline-block;
}

/* Step progress in header */
.step-progress{
  margin-left:auto;
  display:flex;align-items:center;gap:0;
}
.sp-step{
  display:flex;align-items:center;gap:7px;
  padding:6px 14px;border-radius:30px;
  font-size:.75rem;font-weight:600;
  color:var(--muted);
  transition:all .2s;
}
.sp-step.active{background:var(--teal-bg);color:var(--teal);}
.sp-step.done{color:var(--muted2);}
.sp-num{
  width:22px;height:22px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:.72rem;font-weight:700;
  background:var(--bg2);color:var(--muted);
  flex-shrink:0;transition:all .2s;
}
.sp-step.active .sp-num{background:var(--teal);color:#fff;}
.sp-step.done .sp-num{background:var(--green);color:#fff;}
.sp-arrow{color:var(--muted2);font-size:.75rem;padding:0 2px;}

/* ── MAIN ────────────────────────────────── */
.main{
  padding:36px 28px 72px;
  max-width:960px;
  margin:0 auto;
  width:100%;
  min-height:100%;
}

/* ── ANIMATIONS ──────────────────────────── */
@keyframes up{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none}}
.anim{animation:up .4s ease both;}
.d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.16s}.d4{animation-delay:.22s}

/* ── TYPOGRAPHY ──────────────────────────── */
.page-eyebrow{
  display:inline-flex;align-items:center;gap:6px;
  font-size:.72rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;
  color:var(--teal);background:var(--teal-bg);
  padding:4px 12px;border-radius:20px;border:1px solid var(--teal-bd);
  margin-bottom:14px;
}
.page-title{
  font-family:'Lora',serif;
  font-size:clamp(1.7rem,3.5vw,2.4rem);
  font-weight:700;line-height:1.2;
  color:var(--ink);margin-bottom:8px;
}
.page-sub{
  font-size:.93rem;color:var(--muted);
  line-height:1.65;max-width:520px;margin-bottom:32px;
}

/* ── CARDS ───────────────────────────────── */
.card{
  background:var(--white);
  border:1px solid var(--border);
  border-radius:var(--r);
  box-shadow:var(--shadow);
}

/* ── FORM ────────────────────────────────── */
.field{margin-bottom:18px;}
.field>label{
  display:block;font-size:.78rem;font-weight:700;
  color:var(--ink2);margin-bottom:6px;letter-spacing:.02em;
}
input[type=text],textarea,select{
  width:100%;
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:var(--r-sm);
  color:var(--ink);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.95rem;padding:12px 14px;
  outline:none;resize:none;appearance:none;
  transition:border-color .18s,box-shadow .18s;
}
input[type=text]:focus,textarea:focus,select:focus{
  border-color:var(--teal2);
  box-shadow:0 0 0 3px rgba(45,125,90,.12);
}
input[type=text]::placeholder,textarea::placeholder{color:var(--muted2);}

/* ── BUTTONS ─────────────────────────────── */
.btn{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.88rem;font-weight:600;
  padding:11px 22px;border-radius:var(--r-sm);
  border:none;cursor:pointer;
  transition:all .18s;
  display:inline-flex;align-items:center;gap:7px;
}
.btn-primary{background:var(--teal);color:#fff;}
.btn-primary:hover{background:var(--teal2);transform:translateY(-1px);box-shadow:0 6px 20px rgba(45,125,90,.25);}
.btn-secondary{background:var(--white);color:var(--ink2);border:1.5px solid var(--border);}
.btn-secondary:hover{border-color:var(--border2);background:var(--bg);}
.btn-row{display:flex;align-items:center;justify-content:space-between;margin-top:32px;gap:12px;}

/* ── MASCOT ──────────────────────────────── */
.mascot-wrap{
  margin-bottom:4px;
  animation:up .5s ease both;
  flex-shrink:1;
  display:flex;
  align-items:center;
  justify-content:center;
}
.mascot{
  width:160px;
  aspect-ratio:10/9;
  max-height:20dvh;
}

/* ── INTRO PAGE ──────────────────────────── */
#page-intro{
  background:var(--white);
  height:100vh;
  height:100dvh;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
}

.intro-wrap{
  width:100%;
  min-height:100%;
  display:flex;
  align-items:safe center;
  justify-content:center;
  padding:max(24px, env(safe-area-inset-top)) 20px max(32px, env(safe-area-inset-bottom));
  box-sizing:border-box;
}
.intro-inner{
  display:flex;flex-direction:column;
  align-items:center;
  text-align:center;
  width:100%;
  max-width:600px;
  flex-shrink:1;
}

@media(max-height:700px){
  .mascot{ width:100px !important; }
  .mascot-wrap{ margin-bottom:4px; }
  .intro-wrap{ align-items:flex-start; }
}
@media(max-height:560px){
  .mascot-wrap{ display:none; }
}
.intro-badge{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--teal-bg);color:var(--teal);
  border:1px solid var(--teal-bd);
  font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;
  padding:4px 12px;border-radius:20px;margin-bottom:14px;
  animation:up .5s ease both;flex-shrink:0;
}
.intro-logo{
  font-family:'Lora',serif;
  font-size:clamp(2.8rem,9vw,6.5rem);
  font-weight:700;color:var(--ink);line-height:1;
  margin-bottom:10px;flex-shrink:0;
  animation:up .5s .08s ease both;
}
.intro-logo span{color:var(--teal);}
.intro-tagline{
  font-size:clamp(.88rem,2vw,1.1rem);color:var(--muted);
  font-weight:400;max-width:420px;margin:0 auto 20px;
  animation:up .5s .16s ease both;flex-shrink:0;
}
.intro-how{
  display:grid;grid-template-columns:repeat(3,1fr);
  gap:10px;width:100%;margin:0 auto 24px;
  animation:up .5s .24s ease both;flex-shrink:0;
}
.how-card{
  background:var(--bg);border:1px solid var(--border);
  border-radius:var(--r);padding:14px 10px;
  text-align:center;
}
.how-num{
  width:28px;height:28px;border-radius:50%;
  background:var(--teal);color:#fff;
  font-size:.75rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;
  margin:0 auto 8px;
}
.how-title{font-size:.8rem;font-weight:700;color:var(--ink);margin-bottom:3px;}
.how-desc{font-size:.7rem;color:var(--muted);line-height:1.4;}
.intro-start-btn{
  animation:up .5s .32s ease both;
  font-size:1rem;padding:14px 40px;border-radius:12px;
  background:var(--teal);color:#fff;
  border:none;font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;
  cursor:pointer;transition:all .2s;flex-shrink:0;
  box-shadow:0 4px 16px rgba(45,125,90,.3);
  width:100%;max-width:320px;
}
.intro-start-btn:hover{background:var(--teal2);transform:translateY(-2px);box-shadow:0 10px 28px rgba(45,125,90,.35);}

/* On very small screens, hide how-cards description text */
@media(max-height:640px){
  .how-desc{display:none;}
  .how-card{padding:10px 8px;}
  .intro-how{margin-bottom:12px;}
  .intro-tagline{margin-bottom:10px;}
}

/* ── AI INTERPRETATION ───────────────────── */
.interp-box{
  background:var(--white);
  border:1.5px solid var(--teal-bd);
  border-radius:var(--r);
  margin-bottom:24px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.interp-head{
  display:flex;align-items:center;gap:10px;
  padding:13px 18px;
  background:var(--teal-bg);
  border-bottom:1px solid var(--teal-bd);
}
.interp-head-title{font-size:.88rem;font-weight:700;color:var(--teal);}
.interp-badge{
  font-size:.62rem;font-weight:700;letter-spacing:.08em;
  background:var(--teal);color:#fff;
  padding:2px 8px;border-radius:5px;text-transform:uppercase;
}
.interp-body{padding:20px 22px;}
.interp-text{
  font-size:.95rem;color:var(--ink2);line-height:1.75;
  font-weight:400;
}
.interp-text strong{color:var(--ink);font-weight:700;}

/* Loading skeleton */
.interp-loading{
  display:flex;flex-direction:column;gap:10px;padding:20px 22px;
}
.skel{
  height:14px;border-radius:6px;
  background:linear-gradient(90deg,var(--bg) 25%,var(--bg2) 50%,var(--bg) 75%);
  background-size:200% 100%;
  animation:shimmer 1.4s infinite;
}
.skel.w100{width:100%;}
.skel.w80{width:80%;}
.skel.w60{width:60%;}
@keyframes shimmer{from{background-position:200% 0}to{background-position:-200% 0}}

/* ── STEP 1 — OPTIONS ────────────────────── */
.decision-card{
  padding:24px;margin-bottom:20px;
  position:relative;overflow:visible;
}
.options-list{display:flex;flex-direction:column;gap:12px;margin-bottom:14px;}
.opt-card{border-radius:var(--r);overflow:hidden;border:1.5px solid var(--border);background:var(--white);box-shadow:var(--shadow);}
.opt-card-head{
  display:flex;align-items:center;gap:10px;
  padding:13px 16px;cursor:pointer;user-select:none;
  background:var(--bg);border-bottom:1px solid var(--border);
  transition:background .15s;
}
.opt-card-head:hover{background:var(--bg2);}
.opt-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.opt-letter{
  font-size:.72rem;font-weight:800;letter-spacing:.1em;text-transform:uppercase;
}
.opt-name-preview{
  margin-left:auto;font-size:.82rem;color:var(--muted);
  max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.opt-chevron{color:var(--muted2);font-size:.75rem;transition:transform .2s;margin-left:6px;}
.opt-card.open .opt-chevron{transform:rotate(180deg);}
.opt-card-body{padding:16px;display:none;}
.opt-card.open .opt-card-body{display:block;}
.opt-rm{
  width:26px;height:26px;border-radius:7px;
  background:transparent;border:1px solid var(--border);
  color:var(--muted);cursor:pointer;font-size:.8rem;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;
  flex-shrink:0;
}
.opt-rm:hover{background:var(--red-bg);border-color:var(--red);color:var(--red);}

.add-option-btn{
  width:100%;display:flex;align-items:center;gap:10px;
  background:var(--white);border:1.5px dashed var(--border2);
  border-radius:var(--r);padding:14px 18px;
  cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.85rem;font-weight:600;color:var(--muted);
  transition:all .18s;
}
.add-option-btn:hover{border-color:var(--teal2);color:var(--teal);background:var(--teal-bg);}
.add-option-icon{
  width:28px;height:28px;border-radius:8px;
  background:var(--bg);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;transition:all .18s;
}
.add-option-btn:hover .add-option-icon{background:var(--teal);color:#fff;border-color:var(--teal);}

/* ── STEP 2 — CRITERIA ───────────────────── */
.criteria-intro{
  background:var(--amber-bg);border:1px solid #f0d080;
  border-radius:var(--r);padding:14px 18px;
  margin-bottom:22px;
  display:flex;align-items:flex-start;gap:10px;
  font-size:.85rem;color:var(--amber);line-height:1.5;
}
.criteria-intro-icon{font-size:1.1rem;flex-shrink:0;margin-top:1px;}

.cat-tabs{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:18px;}
.cat-tab{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:30px;color:var(--muted);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.78rem;font-weight:600;
  padding:6px 14px;cursor:pointer;transition:all .15s;
}
.cat-tab:hover{border-color:var(--border2);color:var(--ink2);}
.cat-tab.active{border-color:var(--teal);color:var(--teal);background:var(--teal-bg);}

.crit-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:8px;margin-bottom:22px;
}
.crit-pill{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r-sm);padding:11px 13px;
  cursor:pointer;transition:all .15s;
  display:flex;align-items:flex-start;gap:9px;user-select:none;
}
.crit-pill:hover{border-color:var(--border2);box-shadow:var(--shadow);}
.crit-pill.on{border-color:var(--teal);background:var(--teal-bg);box-shadow:0 0 0 1px var(--teal);}
.crit-check{
  width:18px;height:18px;border-radius:5px;
  background:var(--bg);border:1.5px solid var(--border2);
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;flex-shrink:0;margin-top:1px;transition:all .15s;
}
.crit-pill.on .crit-check{background:var(--teal);border-color:var(--teal);color:#fff;}
.crit-icon{font-size:.95rem;flex-shrink:0;margin-top:1px;}
.crit-name{font-size:.82rem;font-weight:600;color:var(--ink);}
.crit-hint{font-size:.7rem;color:var(--muted);margin-top:2px;line-height:1.4;}

.custom-form{
  background:var(--white);border:1.5px dashed var(--border2);
  border-radius:var(--r);margin-bottom:22px;
  overflow:hidden;transition:all .2s;
}
.custom-form-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 18px;cursor:pointer;user-select:none;
  transition:background .15s;
}
.custom-form-head:hover{background:var(--bg2);}
.custom-form-title{
  font-size:.85rem;font-weight:600;color:var(--muted);
  display:flex;align-items:center;gap:10px;
}
.custom-form.open .custom-form-title{color:var(--ink2);}
.custom-form-body{
  display:none;padding:18px;background:var(--bg);
  border-top:1px solid var(--border2);
}
.custom-form.open .custom-form-body{display:block;}
.custom-form.open .opt-chevron{transform:rotate(180deg);}
.custom-row{display:grid;grid-template-columns:1fr 70px 1fr;gap:10px;align-items:end;}

/* Selected criteria box */
.selected-box{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);overflow:hidden;
}
.selected-box-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 18px;border-bottom:1px solid var(--border);
  background:var(--bg);
}
.selected-box-head h3{font-size:.85rem;font-weight:700;color:var(--ink2);}
.sel-count{
  background:var(--teal);color:#fff;
  font-size:.7rem;font-weight:700;padding:2px 9px;border-radius:20px;
}
.sel-list{padding:6px;}
.sel-item{
  display:flex;align-items:center;gap:8px;
  padding:9px 12px;border-radius:8px;transition:background .12s;
  flex-wrap:wrap;
}
.sel-item:hover{background:var(--bg);}
.sel-icon{font-size:.9rem;flex-shrink:0;}
.sel-name{font-size:.82rem;font-weight:500;color:var(--ink);flex:1;min-width:80px;}
.inv-tag{
  font-size:.63rem;background:var(--amber-bg);
  color:var(--amber);padding:2px 6px;border-radius:4px;
  border:1px solid #f0d080;font-weight:600;
  flex-shrink:0;white-space:nowrap;
}
.weight-wrap{
  display:flex;flex-direction:column;gap:2px;flex-shrink:0;
}
.weight-lbl{
  font-size:.62rem;font-weight:700;
  color:var(--muted);letter-spacing:.05em;
  text-transform:uppercase;
}
.weight-sel-wrap{
  position:relative;display:flex;align-items:center;
}
.weight-sel{
  padding:4px 22px 4px 8px;font-size:.72rem;border-radius:6px;
  background:var(--bg);border:1.5px solid var(--border);
  color:var(--ink2);cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;font-weight:600;
  flex-shrink:0;
  appearance:none;-webkit-appearance:none;
}
.weight-chevron{
  position:absolute;right:6px;
  font-size:.6rem;color:var(--muted);
  pointer-events:none;line-height:1;
}
.inv-btn{
  font-size:.63rem;padding:4px 8px;
  background:var(--bg);border:1.5px solid var(--border);
  border-radius:5px;color:var(--muted);cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  white-space:nowrap;font-weight:600;transition:all .12s;
  flex-shrink:0;
  align-self:flex-end;
}
.inv-btn.on{border-color:var(--amber);color:var(--amber);background:var(--amber-bg);}
.rm-btn{
  width:24px;height:24px;border-radius:6px;
  background:transparent;border:1.5px solid var(--border);
  color:var(--muted);cursor:pointer;font-size:.75rem;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;font-family:'Plus Jakarta Sans',sans-serif;transition:all .12s;
}
.rm-btn:hover{background:var(--red-bg);border-color:var(--red);color:var(--red);}
.empty-hint{text-align:center;padding:28px;color:var(--muted);font-size:.85rem;}

/* ── STEP 3 — EVALUATION ─────────────────── */
.eval-grid{display:grid;gap:16px;}
.eval-col-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 18px;border-radius:12px 12px 0 0;
  border:1.5px solid;border-bottom:none;
}
.eval-col-name{font-size:1rem;font-weight:700;}
.eval-live-score{
  display:flex;flex-direction:column;align-items:flex-end;
}
.eval-live-num{
  font-family:'Lora',serif;
  font-size:1.6rem;font-weight:700;line-height:1;
}
.eval-live-label{font-size:.62rem;color:var(--muted);font-weight:500;}

.eval-col-body{border:1.5px solid;border-top:none;border-radius:0 0 12px 12px;overflow:hidden;background:var(--white);}

/* Stepper */
.sl-item{padding:14px 16px;border-bottom:1px solid var(--border);}
.sl-item:last-child{border-bottom:none;}
.sl-head{display:flex;align-items:center;gap:6px;margin-bottom:12px;}
.sl-label{font-size:.8rem;font-weight:600;color:var(--ink);flex:1;}
.sl-wtag{
  font-size:.62rem;background:var(--amber-bg);
  color:var(--amber);padding:2px 6px;border-radius:4px;
  border:1px solid #f0d080;font-weight:700;flex-shrink:0;
}

.stepper{
  display:grid;grid-template-columns:44px 1fr 44px;
  align-items:center;gap:10px;
}
.stepper-btn{
  width:44px;height:44px;border-radius:10px;
  border:1.5px solid var(--border);
  background:var(--bg);color:var(--ink2);
  font-size:1.3rem;font-weight:300;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-family:'Plus Jakarta Sans',sans-serif;
  transition:all .15s;flex-shrink:0;
  touch-action:manipulation;user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.stepper-btn:hover{border-color:var(--border2);background:var(--bg2);}
.stepper-btn:active{transform:scale(.90);background:var(--border);}

.stepper-track{display:flex;flex-direction:column;align-items:center;gap:7px;}

.pip-row{display:flex;gap:4px;align-items:flex-end;width:100%;height:20px;}
.pip{
  flex:1;border-radius:4px;
  background:var(--bg2);border:1px solid var(--border);
  transition:background .15s,height .15s,border-color .15s,transform .1s;
  min-height:8px;
  cursor:pointer;
}
.pip:hover{
  transform:scaleY(1.25);
  background:var(--border2);
  border-color:var(--muted);
}

.stepper-val{
  font-family:'Lora',serif;
  font-size:1.5rem;font-weight:700;line-height:1;
  transition:color .18s;min-width:28px;text-align:center;
}
.stepper-emoji{
  font-size:1.15rem;line-height:1;text-align:center;
  transition:opacity .15s;
  user-select:none;
}

/* ── NOTES ───────────────────────────────── */
.notes-row{display:grid;gap:14px;margin-top:20px;}
.notes-lbl{
  font-size:.75rem;font-weight:700;color:var(--ink2);margin-bottom:6px;display:block;
}

/* ══════════════════════════════════════════
   PAGE RÉSULTATS
   ══════════════════════════════════════════ */

/* Le conteneur utilise .main comme les autres pages */
#resContent{ padding:0; }

/* ── SCORE CARDS RECTANGULAIRES ─────────── */
.sc-cards-row{
  display:grid;
  gap:12px;
  margin:20px 0 24px;
}
.sc-card{
  background:var(--white);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  box-shadow:var(--shadow);
  display:flex;
  transition:box-shadow .2s, transform .2s;
}
.sc-card:hover{ box-shadow:var(--shadow-lg); transform:translateY(-2px); }
.sc-card-winner{ border-width:1px; }

/* Barre colorée à gauche — supprimée */
.sc-card-accent{ display:none; }

.sc-card-body{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 16px;
  gap:12px;
  min-width:0;
}
.sc-card-top{ flex:1; min-width:0; }
.sc-card-rank{
  display:inline-flex;align-items:center;
  font-size:.58rem;font-weight:700;
  padding:2px 8px;border-radius:20px;
  border:1px solid;
  letter-spacing:.05em;
  margin-bottom:6px;
}
.sc-card-name{
  font-family:'Lora',serif;
  font-size:.95rem;font-weight:700;
  color:var(--ink);line-height:1.25;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

/* Jauge circulaire à droite */
.sc-card-gauge{
  position:relative;flex-shrink:0;
  width:52px;height:52px;
}
.sc-card-gauge-label{
  position:absolute;inset:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
}
.sc-card-num{
  font-family:'Lora',serif;
  font-size:1.1rem;font-weight:700;line-height:1;
}
.sc-card-den{
  font-size:.48rem;color:var(--muted);font-weight:600;letter-spacing:.04em;margin-top:1px;
}

.sc-card-left{ flex:1; min-width:0; }
.sc-card-top{ margin-bottom:10px; }

/* Mini critères dans les cards */
.sc-card-crits{ display:flex;flex-direction:column;gap:4px; }
.sc-mini-crit{
  display:flex;align-items:center;gap:6px;
  font-size:.68rem;
}
.sc-mini-crit-name{
  width:90px;flex-shrink:0;
  color:var(--muted);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.sc-mini-bar{
  flex:1;height:3px;background:var(--bg2);border-radius:2px;overflow:hidden;
}
.sc-mini-bar-fill{ height:100%;border-radius:2px; }
.sc-mini-crit-val{
  width:14px;flex-shrink:0;text-align:right;
  font-weight:700;font-size:.65rem;
}

/* Delta scénario sur les cards */
.sc-card-delta{
  font-size:.65rem;font-weight:700;
  padding:2px 6px;border-radius:5px;margin-top:4px;display:inline-block;
}
.sc-card-delta.up{ background:rgba(45,125,90,.1);color:var(--teal); }
.sc-card-delta.down{ background:rgba(192,57,43,.07);color:var(--red); }
.sc-card-delta.same{ display:none; }

/* ── VERDICT ENCADRÉ ─────────────────────── */
.verdict-inline{
  display:flex;align-items:flex-start;gap:12px;
  padding:14px 18px;
  border-radius:12px;
  margin-bottom:6px;
}
.verdict-inline-emoji{ font-size:1.5rem;flex-shrink:0;line-height:1.2; }
.verdict-inline-text{ flex:1;min-width:0; }
.verdict-inline-title{
  font-family:'Lora',serif;
  font-size:1rem;font-weight:700;
  line-height:1.3;margin-bottom:3px;
}
.verdict-inline-sub{
  font-size:.8rem;color:var(--ink2);line-height:1.5;
}

/* ── LAYOUT RÉSULTATS ────────────────────── */
.res-cols{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
  margin-top:0;
}
@media(max-width:700px){
  .res-cols{ grid-template-columns:1fr; }
  .sc-cards-row{ grid-template-columns:1fr!important; }
}

.res-section{
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  box-shadow:var(--shadow);
}
.res-section + .res-section{ margin-top:0; }
.res-section-head{
  display:flex;align-items:center;gap:8px;
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  background:var(--bg);
}
.res-section-icon{ font-size:.95rem; }
.res-section-title{
  font-size:.72rem;font-weight:800;
  text-transform:uppercase;letter-spacing:.09em;
  color:var(--muted2);flex:1;
}
.res-section-body{ padding:18px; }

/* Interp IA */
.res-interp-badge{
  display:inline-flex;align-items:center;
  font-size:.58rem;font-weight:800;letter-spacing:.08em;
  text-transform:uppercase;
  background:var(--teal-bg);color:var(--teal);
  padding:2px 7px;border-radius:5px;
  border:1px solid var(--teal-bd);
}
.res-interp-text{
  font-size:.84rem;color:var(--ink2);line-height:1.75;
}
.res-interp-text p{ margin-bottom:.75em; }
.res-interp-text p:last-child{ margin-bottom:0; }
.res-interp-text strong{ color:var(--ink);font-weight:700; }
.res-interp-loading{ display:flex;flex-direction:column;gap:8px; }

/* Radar */
.res-radar-wrap{ display:flex;justify-content:center; }
.res-radar-legend{
  display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;
  font-size:.75rem;color:var(--ink2);font-weight:500;
  justify-content:center;align-items:center;
}

/* Bouton point d'interrogation */
.radar-help-btn{
  width:20px;height:20px;border-radius:50%;
  background:var(--bg2);border:1.5px solid var(--border2);
  color:var(--muted);font-size:.7rem;font-weight:800;
  cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
  line-height:1;transition:all .15s;flex-shrink:0;
  font-family:'Plus Jakarta Sans',sans-serif;
}
.radar-help-btn:hover{ background:var(--teal-bg);border-color:var(--teal);color:var(--teal); }

/* Encadré explicatif — caché par défaut */
.radar-how{
  display:none;
  margin-top:12px;
  padding:16px 18px;
  background:var(--white);
  border:1px solid var(--border);
  border-radius:12px;
  position:relative;
  overflow:hidden;
}
.radar-how.open{ display:block; }

/* Lignes décoratives en arrière-plan */
.radar-how::before{
  content:'';
  position:absolute;inset:0;
  background-image:
    repeating-linear-gradient(
      -45deg,
      transparent,
      transparent 18px,
      rgba(45,125,90,0.04) 18px,
      rgba(45,125,90,0.04) 19px
    );
  pointer-events:none;
}
/* Accent coloré en haut à gauche */
.radar-how::after{
  content:'';
  position:absolute;top:0;left:0;
  width:3px;height:100%;
  background:linear-gradient(to bottom, var(--teal), transparent);
  border-radius:12px 0 0 12px;
}

.radar-how-title{
  font-size:.65rem;font-weight:800;text-transform:uppercase;
  letter-spacing:.12em;color:var(--teal);
  margin-bottom:12px;
  position:relative;
}
.radar-how-items{ display:flex;flex-direction:column;gap:10px;position:relative; }
.radar-how-item{
  display:flex;align-items:flex-start;gap:10px;
  font-size:.76rem;color:var(--ink2);line-height:1.55;
}
.radar-how-item strong{ color:var(--ink);font-weight:700; }
.radar-how-icon{
  font-size:.85rem;flex-shrink:0;margin-top:1px;
  width:24px;height:24px;
  background:var(--teal-bg);border:1px solid var(--teal-bd);
  border-radius:6px;
  display:flex;align-items:center;justify-content:center;
}

/* Dividers */
.res-divider{
  display:flex;align-items:center;gap:10px;
  margin:22px 0 12px;color:var(--muted2);
}
.res-divider::before,.res-divider::after{
  content:'';flex:1;height:1px;background:var(--border);
}
.res-divider-label{
  font-size:.62rem;font-weight:800;letter-spacing:.12em;
  text-transform:uppercase;white-space:nowrap;
}

/* Actions */
.res-actions{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:28px;padding-top:20px;
  border-top:1px solid var(--border);flex-wrap:wrap;gap:10px;
}

/* ── PANNEAU SCÉNARIO ────────────────────── */
.scenario-panel{
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:14px;
  overflow:hidden;
  box-shadow:var(--shadow);
}
.scenario-panel-head{
  display:flex;align-items:center;gap:10px;
  padding:13px 18px;
  cursor:pointer;user-select:none;
  transition:background .15s;
}
.scenario-panel-head:hover{ background:var(--bg); }
.scenario-panel-icon{ font-size:1.1rem;flex-shrink:0; }
.scenario-panel-text{ flex:1;min-width:0; }
.scenario-panel-title{ font-size:.82rem;font-weight:700;color:var(--ink); }
.scenario-panel-sub{ font-size:.68rem;color:var(--muted);line-height:1.3;margin-top:1px; }
.scenario-panel-chevron{ color:var(--muted2);font-size:.8rem;transition:transform .22s;margin-left:6px; }
.scenario-panel.open .scenario-panel-chevron{ transform:rotate(180deg); }
.scenario-panel-body{ display:none;border-top:1px solid var(--border); }
.scenario-panel.open .scenario-panel-body{ display:block; }

/* ── ONGLETS SCÉNARIO ────────────────────── */
.sc-tabs{
  display:flex;border-bottom:1px solid var(--border);background:var(--bg);
}
.sc-tab{
  flex:1;padding:9px 12px;
  font-size:.78rem;font-weight:600;color:var(--muted);
  cursor:pointer;border:none;background:none;
  border-bottom:2px solid transparent;
  transition:color .15s,border-color .15s;
  font-family:'Plus Jakarta Sans',sans-serif;user-select:none;
}
.sc-tab.active{ color:var(--teal);border-bottom-color:var(--teal);background:var(--white); }
.sc-tab-content{ padding:14px 18px 18px; }
.sc-tab-pane{ display:none; }
.sc-tab-pane.active{ display:block; }

/* Filtres émotions */
.emotion-filters{ display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px; }
.emotion-chip{
  display:inline-flex;align-items:center;gap:5px;
  padding:5px 12px;border-radius:20px;
  font-size:.75rem;font-weight:600;
  border:1.5px solid var(--border);background:var(--bg);color:var(--ink2);
  cursor:pointer;transition:all .15s;user-select:none;
}
.emotion-chip:hover{ border-color:var(--teal);color:var(--teal); }
.emotion-chip.active{ background:var(--teal-bg);border-color:var(--teal);color:var(--teal); }
.emotion-chip-count{
  font-size:.65rem;font-weight:700;
  background:var(--border2);color:var(--muted);padding:1px 5px;border-radius:8px;
}
.emotion-chip.active .emotion-chip-count{ background:var(--teal);color:#fff; }
.emotion-crit-tags{ display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px; }
.emotion-crit-tag{
  display:inline-flex;align-items:center;gap:4px;
  font-size:.7rem;font-weight:600;padding:2px 9px;border-radius:14px;border:1px solid;
}
.emotion-crit-tag.included{ background:rgba(124,58,237,.07);color:#7c3aed;border-color:rgba(124,58,237,.25); }
.emotion-crit-tag.excluded{ background:var(--bg);color:var(--muted2);border-color:var(--border);text-decoration:line-through;opacity:.6; }
.emotion-none{ font-size:.8rem;color:var(--muted);font-style:italic;padding:8px 0; }
.emotion-insight{
  margin-top:12px;padding:11px 13px;
  background:rgba(124,58,237,.05);border:1px solid rgba(124,58,237,.18);
  border-radius:9px;font-size:.8rem;color:var(--ink2);line-height:1.6;
}
.emotion-insight strong{ color:#7c3aed; }

/* Critères scénario */
.scenario-reset{
  font-size:.73rem;font-weight:600;color:var(--teal);
  background:none;border:none;cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  padding:0;text-decoration:underline;text-underline-offset:2px;
}
.scenario-reset:hover{ color:var(--teal2); }
.sc-crit-list{ display:flex;flex-direction:column;gap:5px;margin-top:10px;clear:both; }
.sc-crit-row{
  display:flex;align-items:center;gap:9px;
  padding:8px 11px;border-radius:8px;
  border:1.5px solid var(--border);background:var(--bg);transition:all .15s;
}
.sc-crit-row.off{ opacity:.45; }
.sc-crit-row.off .sc-crit-name{ text-decoration:line-through; }
.sc-crit-icon{ font-size:.9rem;flex-shrink:0; }
.sc-crit-name{ font-size:.8rem;font-weight:600;color:var(--ink);flex:1; }
.sc-crit-weight{
  font-size:.62rem;background:var(--amber-bg);color:var(--amber);
  padding:2px 5px;border-radius:4px;border:1px solid #f0d080;font-weight:700;flex-shrink:0;
}
.sc-crit-inv{
  font-size:.62rem;background:var(--bg2);color:var(--muted);
  padding:2px 5px;border-radius:4px;border:1px solid var(--border2);font-weight:600;flex-shrink:0;
}
.scenario-summary{
  margin-top:12px;padding:10px 13px;
  background:var(--teal-bg);border:1px solid var(--teal-bd);
  border-radius:9px;font-size:.79rem;color:var(--ink2);line-height:1.6;
}
.scenario-summary strong{ color:var(--teal2); }

/* Mini toggle */
.mini-toggle{ position:relative;width:34px;height:19px;flex-shrink:0; }
.mini-toggle input{ opacity:0;width:0;height:0;position:absolute; }
.mini-toggle-track{
  position:absolute;inset:0;background:var(--border2);border-radius:10px;
  transition:background .18s;cursor:pointer;
}
.mini-toggle input:checked + .mini-toggle-track{ background:var(--teal); }
.mini-toggle-thumb{
  position:absolute;top:2.5px;left:2.5px;
  width:14px;height:14px;border-radius:50%;
  background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.2);
  transition:transform .18s;pointer-events:none;
}
.mini-toggle input:checked ~ .mini-toggle-thumb{ transform:translateX(15px); }

/* Scores scénario (delta) */
.fear-opt-row{ display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border); }
.fear-opt-row:last-child{ border-bottom:none; }
.fear-opt-name{ font-size:.8rem;font-weight:700;flex:1;min-width:0; }
.fear-scores{ display:flex;align-items:center;gap:8px;flex-shrink:0; }
.fear-score-block{ text-align:center; }
.fear-score-val{ font-family:'Lora',serif;font-size:1.1rem;font-weight:700;line-height:1; }
.fear-score-lbl{ font-size:.55rem;color:var(--muted);font-weight:600;letter-spacing:.04em; }
.fear-arrow{ color:var(--muted2);font-size:.9rem; }
.fear-delta{ font-size:.72rem;font-weight:700;padding:2px 6px;border-radius:5px; }
.fear-delta.up{ background:rgba(45,125,90,.1);color:var(--teal); }
.fear-delta.down{ background:rgba(192,57,43,.07);color:var(--red); }
.fear-delta.same{ display:none; }

/* ── TABLEAU BREAKDOWN ───────────────────── */
.bk-table{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:14px;overflow:hidden;box-shadow:var(--shadow);overflow-x:auto;
}
.bk-row{ display:flex;align-items:center;border-bottom:1px solid var(--border); }
.bk-row:last-child{ border-bottom:none; }
.bk-row.hdr{ background:var(--bg);border-bottom:1.5px solid var(--border); }
.bk-row:not(.hdr):hover{ background:var(--bg); }
.bk-cell{ padding:10px 13px;font-size:.79rem; }
.bk-cell.crit-col{
  width:180px;flex-shrink:0;display:flex;
  align-items:center;gap:7px;color:var(--ink);font-weight:600;
}
.bk-cell.hdr-cell{
  color:var(--muted);font-weight:700;font-size:.69rem;
  text-transform:uppercase;letter-spacing:.07em;
}
.bk-cell.opt-col{ flex:1;min-width:90px; }
.opt-cell-in{ display:flex;align-items:center;gap:6px; }
.opt-pill{
  display:inline-flex;align-items:center;justify-content:center;
  width:24px;height:24px;border-radius:6px;
  font-size:.8rem;font-weight:700;flex-shrink:0;
}
.mini-bar{ flex:1;height:4px;background:var(--bg2);border-radius:3px;overflow:hidden; }
.mini-bar-fill{ height:100%;border-radius:3px; }
.inv-tag{
  font-size:.58rem;color:var(--muted);background:var(--bg2);
  padding:1px 4px;border-radius:3px;border:1px solid var(--border2);
}

/* ── NOTES ───────────────────────────────── */
.notes-res{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:14px;overflow:hidden;box-shadow:var(--shadow);
}
.notes-res-head{
  padding:12px 18px;border-bottom:1px solid var(--border);
  font-size:.8rem;font-weight:800;text-transform:uppercase;
  letter-spacing:.09em;color:var(--muted2);background:var(--bg);
}
.notes-res-body{ display:grid; }
.note-col{ padding:15px 18px; }
.note-col-lbl{
  font-size:.65rem;font-weight:800;letter-spacing:.12em;
  text-transform:uppercase;margin-bottom:7px;
}
.note-col-txt{ font-size:.82rem;color:var(--muted);line-height:1.65;font-style:italic; }

/* ── ACTIONS ─────────────────────────────── */
.res-actions{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:28px;padding:20px 0 0;
  border-top:1px solid var(--border);flex-wrap:wrap;gap:10px;
}

/* ── DIVIDER SECTION ─────────────────────── */
.res-divider{
  display:flex;align-items:center;gap:10px;
  margin:20px 0 10px;color:var(--muted2);
}
.res-divider::before,.res-divider::after{
  content:'';flex:1;height:1px;background:var(--border);
}
.res-divider-label{
  font-size:.62rem;font-weight:800;letter-spacing:.12em;
  text-transform:uppercase;white-space:nowrap;
}

/* Fallback score cards (updateScenarioScores) */
.scores-row{ display:none; }
.score-card,.sc-body,.sc-top-band,.sc-main,.rank-badge,
.sc-name,.sc-gauge,.sc-gauge-track,.sc-gauge-fill,
.sc-gauge-label,.sc-num,.sc-denom,.sc-scenario-delta{ display:revert; }
.sc-scenario-delta.same{ display:none; }

/* ── LANG SWITCHER ───────────────────────── */
.lang-switcher{
  position:absolute;top:18px;right:20px;
  display:flex;gap:4px;
  background:var(--bg2);
  border-radius:8px;
  padding:3px;
  border:1px solid var(--border);
}
.lang-btn{
  padding:4px 10px;
  font-size:.72rem;font-weight:700;
  border-radius:6px;border:none;
  background:transparent;color:var(--muted);
  cursor:pointer;transition:all .15s;
  font-family:'Plus Jakarta Sans',sans-serif;
  letter-spacing:.04em;
}
.lang-btn.active{
  background:var(--white);color:var(--teal);
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
}

[data-tip]{position:relative;cursor:help;}
[data-tip]::after{
  content:attr(data-tip);
  position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:var(--ink);color:#fff;
  font-size:.7rem;padding:5px 9px;border-radius:6px;
  white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:100;
}
[data-tip]:hover::after{opacity:1;}

/* ── FEAR TOGGLE ─────────────────────────── */
.fear-box{
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:var(--r);
  margin-bottom:24px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.fear-head{
  display:flex;align-items:center;gap:12px;
  padding:16px 20px;
  cursor:pointer;
  user-select:none;
  transition:background .15s;
}
.fear-head:hover{ background:var(--bg); }
.fear-icon{ font-size:1.4rem; flex-shrink:0; }
.fear-head-text{ flex:1; }
.fear-head-title{
  font-size:.92rem;font-weight:700;color:var(--ink);
  margin-bottom:2px;
}
.fear-head-sub{
  font-size:.75rem;color:var(--muted);line-height:1.4;
}

/* Toggle switch */
.toggle-wrap{
  display:flex;align-items:center;gap:8px;flex-shrink:0;
}
.toggle-label{
  font-size:.75rem;font-weight:600;
  color:var(--muted);transition:color .2s;
  white-space:nowrap;
}
.toggle-label.on{ color:var(--teal); }
.toggle{
  position:relative;width:44px;height:24px;flex-shrink:0;
}
.toggle input{ opacity:0;width:0;height:0;position:absolute; }
.toggle-track{
  position:absolute;inset:0;
  background:var(--border2);border-radius:12px;
  transition:background .2s;cursor:pointer;
}
.toggle input:checked + .toggle-track{ background:var(--teal); }
.toggle-thumb{
  position:absolute;top:3px;left:3px;
  width:18px;height:18px;border-radius:50%;
  background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);
  transition:transform .2s;pointer-events:none;
}
.toggle input:checked ~ .toggle-thumb{ transform:translateX(20px); }

/* Fear body — criteria tags + comparison */
.fear-body{
  border-top:1px solid var(--border);
  padding:16px 20px;
  display:none;
}
.fear-box.open .fear-body{ display:block; }

.fear-crits{
  display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;
}
.fear-crit-tag{
  display:inline-flex;align-items:center;gap:5px;
  font-size:.72rem;font-weight:600;
  padding:3px 10px;border-radius:20px;
  border:1px solid;
}
.fear-crit-tag.active{
  background:rgba(124,58,237,0.08);
  color:#7c3aed;border-color:rgba(124,58,237,0.3);
}
.fear-crit-tag.inactive{
  background:var(--bg);color:var(--muted2);border-color:var(--border);
  text-decoration:line-through;opacity:.6;
}

.fear-comparison{
  display:flex;gap:12px;flex-wrap:wrap;
}
.fear-comparison .fear-opt-row{
  flex:1;min-width:130px;
  flex-direction:column;align-items:flex-start;
}
.fear-comparison .fear-opt-name{
  min-width:unset;margin-bottom:8px;
}
.fear-comparison .fear-scores{
  flex:unset;flex-wrap:wrap;
}
.fear-opt-row{
  background:var(--bg);border-radius:10px;padding:12px 14px;
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
}
.fear-opt-name{
  font-size:.82rem;font-weight:700;min-width:90px;
}
.fear-scores{
  display:flex;align-items:center;gap:8px;flex:1;flex-wrap:wrap;
}
.fear-score-block{
  display:flex;flex-direction:column;align-items:center;
  min-width:64px;
}
.fear-score-val{
  font-family:'Lora',serif;
  font-size:1.5rem;font-weight:700;line-height:1;
}
.fear-score-lbl{
  font-size:.62rem;color:var(--muted);font-weight:500;margin-top:1px;
}
.fear-arrow{
  font-size:1rem;color:var(--muted2);
}
.fear-delta{
  font-size:.78rem;font-weight:700;
  padding:2px 8px;border-radius:6px;
}
.fear-delta.up{
  background:rgba(45,125,90,.08);color:var(--teal);
}
.fear-delta.down{
  background:rgba(192,57,43,.06);color:var(--red);
}
.fear-delta.same{
  background:var(--bg2);color:var(--muted);
}

.fear-insight{
  margin-top:14px;padding:12px 14px;
  background:rgba(124,58,237,0.05);
  border:1px solid rgba(124,58,237,0.18);
  border-radius:10px;
  font-size:.82rem;color:var(--ink2);line-height:1.6;
}
.fear-insight strong{ color:#7c3aed; }

.fear-none{
  font-size:.82rem;color:var(--muted);
  font-style:italic;padding:8px 0;
}

/* ── SCENARIO PANEL ──────────────────────── */
.scenario-box{
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:var(--r);
  margin-bottom:24px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.scenario-head{
  display:flex;align-items:center;gap:12px;
  padding:16px 20px;cursor:pointer;user-select:none;
  transition:background .15s;
}
.scenario-head:hover{ background:var(--bg); }
.scenario-head-icon{ font-size:1.3rem;flex-shrink:0; }
.scenario-head-text{ flex:1; }
.scenario-head-title{ font-size:.92rem;font-weight:700;color:var(--ink);margin-bottom:2px; }
.scenario-head-sub{ font-size:.75rem;color:var(--muted);line-height:1.4; }
.scenario-chevron{ color:var(--muted2);font-size:.8rem;transition:transform .22s; }
.scenario-box.open .scenario-chevron{ transform:rotate(180deg); }

.scenario-body{
  display:none;
  border-top:1px solid var(--border);
  padding:16px 20px 20px;
}
.scenario-box.open .scenario-body{ display:block; }

.scenario-reset{
  font-size:.75rem;font-weight:600;color:var(--teal);
  background:none;border:none;cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  padding:0;text-decoration:underline;text-underline-offset:2px;
  float:right;
}
.scenario-reset:hover{ color:var(--teal2); }

.sc-crit-list{
  display:flex;flex-direction:column;gap:6px;
  margin-top:10px;
  clear:both;
}
.sc-crit-row{
  display:flex;align-items:center;gap:10px;
  padding:9px 12px;border-radius:9px;
  border:1.5px solid var(--border);
  background:var(--bg);
  transition:all .15s;
}
.sc-crit-row.off{
  opacity:.45;
}
.sc-crit-row.off .sc-crit-name{ text-decoration:line-through; }
.sc-crit-icon{ font-size:.95rem;flex-shrink:0; }
.sc-crit-name{ font-size:.82rem;font-weight:600;color:var(--ink);flex:1; }
.sc-crit-weight{
  font-size:.65rem;background:var(--amber-bg);
  color:var(--amber);padding:2px 6px;border-radius:4px;
  border:1px solid #f0d080;font-weight:700;flex-shrink:0;
}
.sc-crit-inv{
  font-size:.65rem;background:var(--bg2);
  color:var(--muted);padding:2px 6px;border-radius:4px;
  border:1px solid var(--border2);font-weight:600;flex-shrink:0;
}

/* Mini toggle — smaller than the fear one */
.mini-toggle{
  position:relative;width:36px;height:20px;flex-shrink:0;
}
.mini-toggle input{ opacity:0;width:0;height:0;position:absolute; }
.mini-toggle-track{
  position:absolute;inset:0;
  background:var(--border2);border-radius:10px;
  transition:background .18s;cursor:pointer;
}
.mini-toggle input:checked + .mini-toggle-track{ background:var(--teal); }
.mini-toggle-thumb{
  position:absolute;top:3px;left:3px;
  width:14px;height:14px;border-radius:50%;
  background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.2);
  transition:transform .18s;pointer-events:none;
}
.mini-toggle input:checked ~ .mini-toggle-thumb{ transform:translateX(16px); }

/* Dynamic score cards */
.sc-num{ transition:color .2s; }
.sc-bar-fill{ transition:width .4s ease,background .2s; }
.sc-scenario-delta{
  display:inline-flex;align-items:center;gap:4px;
  font-size:.72rem;font-weight:700;
  padding:2px 8px;border-radius:6px;margin-left:6px;
  vertical-align:middle;
}
.sc-scenario-delta.up{ background:rgba(45,125,90,.1);color:var(--teal); }
.sc-scenario-delta.down{ background:rgba(192,57,43,.07);color:var(--red); }
.sc-scenario-delta.same{ display:none; }

.scenario-summary{
  margin-top:14px;padding:11px 14px;
  background:var(--teal-bg);border:1px solid var(--teal-bd);
  border-radius:9px;font-size:.8rem;color:var(--ink2);line-height:1.6;
}
.scenario-summary strong{ color:var(--teal); }

/* ══════════════════════════════════════════
   MODIF SWING — Pondération par Swing Weighting
   ══════════════════════════════════════════ */

/* Toggle méthode de pondération */
.method-toggle-bar{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  padding:12px 16px;border-bottom:1px solid var(--border);
  background:var(--bg);
}
.method-lbl{
  font-size:.75rem;font-weight:700;color:var(--ink2);
  margin-right:2px;white-space:nowrap;
}
.method-btn{
  padding:6px 14px;border-radius:20px;
  border:1.5px solid var(--border);
  background:var(--white);color:var(--muted);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.78rem;font-weight:600;cursor:pointer;
  transition:all .18s;
}
.method-btn:hover{border-color:var(--border2);color:var(--ink2);}
.method-btn.active{
  border-color:var(--teal);background:var(--teal-bg);color:var(--teal);
}

/* Encadré info swing */
.swing-info{
  margin:8px 8px 4px;padding:12px 15px;
  background:var(--teal-bg);border:1px solid var(--teal-bd);
  border-radius:var(--r-sm);
  font-size:.8rem;color:var(--ink2);line-height:1.6;
}
.swing-info strong{color:var(--teal);}

/* Item dans la liste swing */
.swing-item{
  display:flex;align-items:center;gap:8px;
  padding:8px 10px;margin:4px 6px;
  border-radius:var(--r-sm);border:1.5px solid var(--border);
  background:var(--white);transition:border-color .15s;
  position:relative;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
.swing-item.swing-first{
  border-color:var(--teal);background:var(--teal-bg);
}
.swing-rank-num{
  width:24px;height:24px;border-radius:50%;flex-shrink:0;margin-top:1px;
  background:var(--teal);color:#fff;
  font-size:.72rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;
}
.swing-first .swing-rank-num{background:var(--ink);}

.swing-item{transition:opacity .15s,box-shadow .1s,transform .12s;}
.swing-item.dragging{opacity:.35;}
.swing-item.drag-over-above{box-shadow:0 -2px 0 0 var(--teal);border-top-color:var(--teal);}
.swing-item.drag-over-below{box-shadow:0 2px 0 0 var(--teal);border-bottom-color:var(--teal);}
/* Feedback visuel pendant le long press (avant que le drag démarre) */
.swing-item.press-holding{
  transform:scale(0.97);
  box-shadow:0 4px 18px rgba(0,0,0,.13);
  border-color:var(--teal-bd);
  position:relative;z-index:10;
}
.swing-ghost{
  position:fixed;z-index:9999;pointer-events:none;
  opacity:.88;border-radius:var(--r-sm);
  box-shadow:0 8px 28px rgba(0,0,0,.18);
  background:var(--white);padding:10px 12px;
  border:1.5px solid var(--teal);
  overflow:hidden;
  display:flex;align-items:center;gap:10px;
}
/* FIN MODIF DRAG AND DROP */

/* Contenu principal swing item */
.swing-item-main{flex:1;min-width:0;}
.swing-item-header{
  display:flex;align-items:center;gap:6px;margin-bottom:8px;
  padding-right:4px;
}
.swing-name-group{
  display:flex;flex-direction:column;
  flex:1;min-width:0;
}
.swing-item-name{font-size:.82rem;font-weight:500;color:var(--ink);}

/* Champs worst/best/points */
.swing-fields{
  display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;
}
.swing-field-group{
  display:flex;flex-direction:column;gap:3px;flex:1;min-width:80px;
}
.swing-field-lbl{
  font-size:.62rem;font-weight:700;color:var(--muted);
  text-transform:uppercase;letter-spacing:.05em;
}
.swing-field-inp{
  padding:6px 10px;border-radius:6px;
  border:1.5px solid var(--border);
  background:var(--white);color:var(--ink);
  font-family:'Plus Jakarta Sans',sans-serif;font-size:.8rem;
  width:100%;outline:none;
  transition:border-color .15s,box-shadow .15s;
}
.swing-field-inp:focus{
  border-color:var(--teal2);
  box-shadow:0 0 0 3px rgba(45,125,90,.12);
}

/* Zone points + badge % */
.swing-points-wrap{
  display:flex;flex-direction:column;gap:3px;flex-shrink:0;
}
.swing-points-inp{
  width:60px;padding:6px 8px;border-radius:6px;
  border:1.5px solid var(--border);text-align:center;
  background:var(--white);color:var(--ink);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.88rem;font-weight:700;outline:none;
  transition:border-color .15s,box-shadow .15s;
}
.swing-points-inp:focus:not([readonly]){
  border-color:var(--teal2);
  box-shadow:0 0 0 3px rgba(45,125,90,.12);
}
.swing-points-inp[readonly]{
  background:var(--teal-bg);border-color:var(--teal-bd);
  color:var(--teal);cursor:default;
}
.swing-weight-tag{
  font-size:.62rem;background:var(--teal-bg);
  color:var(--teal);padding:2px 6px;border-radius:4px;
  border:1px solid var(--teal-bd);font-weight:700;
  text-align:center;
}

/* Badge poids swing dans step 3 */
.swing-wtag{
  font-size:.62rem;background:var(--teal-bg);
  color:var(--teal);padding:2px 6px;border-radius:4px;
  border:1px solid var(--teal-bd);font-weight:700;flex-shrink:0;
}

/* FIN MODIF SWING */

/* ── RESPONSIVE ──────────────────────────── */
@media(max-width:640px){
  .app-header{padding:12px 16px;}
  .main{padding:22px 16px 60px;}
  .intro-how{grid-template-columns:1fr;}
  .sp-step span:not(.sp-num){display:none;}
  .custom-row{grid-template-columns:1fr 1fr;}
  .analysis-body{grid-template-columns:1fr;}
  .an-col:first-child{border-right:none;border-bottom:1px solid var(--border);}
  .notes-res-body{grid-template-columns:1fr!important;}
  .note-col{border-right:none!important;border-bottom:1px solid var(--border);}

  /* Scores cards — rank badge inline on mobile */
  .scores-row{grid-template-columns:1fr!important;}
  .rank-badge{
    position:static;
    display:inline-flex;
    margin-bottom:8px;
  }
  .sc-letter{padding-right:0;}
  .eval-grid{grid-template-columns:1fr!important;}
  .eval-col-name{font-size:.88rem;}

  /* Stepper: shrink buttons, tighten gap */
  .stepper{grid-template-columns:38px 1fr 38px;gap:6px;}
  .stepper-btn{width:38px;height:38px;font-size:1.1rem;}

  /* Prevent pip row from pushing layout */
  .pip-row{gap:3px;}
  .pip{border-radius:3px;}

  /* Notes row single column */
  .notes-row{grid-template-columns:1fr!important;}

  /* Critères sélectionnés — croix centrée à gauche avec l'icône et le titre */
  .sel-item{
    position:relative;
    padding-left:36px;
    padding-right:12px;
  }
  .sel-item .rm-btn{
    position:absolute;
    top:50%;left:10px;
    transform:translateY(-50%);
  }

  /* MODIF SWING — Cacher la poignée de drag sur mobile pour plus d'espace */
  .swing-drag-handle{display:none;}

  /* MODIF SWING — Aligner les boutons de méthode sur mobile */
  .method-lbl {
    flex-basis: 100%;
    text-align: center;
    margin-right: 0;
    margin-bottom: 6px;
  }
  .method-toggle-bar .method-btn { flex-grow: 1; }
}

@media print{
  body{background:#fff;}
  .app-header button,.res-actions,.btn-row{display:none!important;}
  .page{display:none!important;}
  #page-results{display:flex!important;}
}
</style>
</head>
<body>
<div class="app">

<!-- ══════════════════════════ INTRO ══════════════════════════ -->
<div class="page active" id="page-intro">
  <!-- Sélecteur de langue -->
  <div class="lang-switcher">
    <button class="lang-btn active" id="btn-fr" onclick="setLang('fr')">FR</button>
    <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
  </div>
  <div class="intro-wrap">
    <div class="intro-inner">

      <!-- Hibou cartoon animé -->
      <div class="mascot-wrap">
        <lottie-player class="mascot"
          src="owl.json"
          background="transparent"
          speed="1"
          autoplay
          aria-hidden="true">
        </lottie-player>
      </div>

      <div class="intro-badge" data-i18n="badge">✦ Outil d'aide à la décision</div>
      <div class="intro-logo">Lucid<span>.</span></div>
      <div class="intro-tagline" data-i18n="tagline">Comparez vos options avec Lucid et prenez vos décisions en toute confiance.</div>

      <div class="intro-how">
        <div class="how-card">
          <div class="how-num">1</div>
          <div class="how-title" data-i18n="how1_title">Posez votre question</div>
          <div class="how-desc" data-i18n="how1_desc">Formulez votre situation et listez les options à comparer.</div>
        </div>
        <div class="how-card">
          <div class="how-num">2</div>
          <div class="how-title" data-i18n="how2_title">Choisissez vos critères</div>
          <div class="how-desc" data-i18n="how2_desc">Sélectionnez ce qui compte vraiment pour vous.</div>
        </div>
        <div class="how-card">
          <div class="how-num">3</div>
          <div class="how-title" data-i18n="how3_title">Obtenez votre analyse</div>
          <div class="how-desc" data-i18n="how3_desc">Lucid calcule les scores et vous présente un résultat clair.</div>
        </div>
      </div>

      <button class="intro-start-btn" onclick="nav('page-step1')" data-i18n="start_btn">Commencer →</button>
      <p style="margin-top:12px;font-size:.75rem;color:var(--muted2)" data-i18n="footer_note">Gratuit · Aucun compte requis · 100% privé</p>
    </div>
  </div>
</div>

<!-- ══════════════════════════ STEP 1 ══════════════════════════ -->
<div class="page" id="page-step1">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp1"></div>
    <div class="lang-switcher" style="margin-left:auto;position:static">
      <button class="lang-btn active" id="btn-fr2" onclick="setLang('fr')">FR</button>
      <button class="lang-btn" id="btn-en2" onclick="setLang('en')">EN</button>
    </div>
  </div>
  <div class="page-scroll">
  <div class="main">
    <div class="page-eyebrow anim" data-i18n="s1_eyebrow">Étape 1 sur 3</div>
    <div class="page-title anim d1" data-i18n="s1_title">Quelle décision devez-vous prendre ?</div>
    <div class="page-sub anim d2" data-i18n="s1_sub">Formulez votre situation et renseignez les options que vous envisagez.</div>

    <div class="card decision-card anim d2">
      <div class="field" style="margin-bottom:0">
        <label for="inp-dec">📝 Votre décision en une phrase</label>
        <textarea id="inp-dec" rows="2" placeholder="Ex : Dois-je accepter ce nouvel emploi ou rester dans mon poste actuel ?"></textarea>
      </div>
    </div>

    <div class="anim d3">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <label style="font-size:.85rem;font-weight:700;color:var(--ink2)" data-i18n="opt_section_label">🔀 Vos options</label>
        <span id="opt-count-lbl" style="font-size:.75rem;color:var(--muted);background:var(--bg2);padding:3px 10px;border-radius:20px;font-weight:600">2 options</span>
      </div>
      <div class="options-list" id="optBuilder"></div>
      <button class="add-option-btn" id="addOptBtn" onclick="addOption()">
        <div class="add-option-icon">+</div>
        <span data-i18n="opt_add_label">Ajouter une option</span> <span style="color:var(--muted2);font-weight:400" data-i18n="opt_add_max">(max 6)</span>
      </button>
    </div>

    <div class="btn-row anim d4">
      <button class="btn btn-secondary" onclick="nav('page-intro')" data-i18n="back_intro">← Retour</button>
      <button class="btn btn-primary" onclick="validateStep1()" data-i18n="s1_next">Choisir mes critères →</button>
    </div>
  </div>
  </div><!-- /page-scroll -->
</div>

<!-- ══════════════════════════ STEP 2 ══════════════════════════ -->
<div class="page" id="page-step2">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp2"></div>
    <div class="lang-switcher">
      <button class="lang-btn active" id="btn-fr3" onclick="setLang('fr')">FR</button>
      <button class="lang-btn" id="btn-en3" onclick="setLang('en')">EN</button>
    </div>
  </div>
  <div class="page-scroll">
  <div class="main">
    <div class="page-eyebrow" data-i18n="s2_eyebrow">Étape 2 sur 3</div>
    <div class="page-title" data-i18n="s2_title">Qu'est-ce qui compte pour vous ?</div>
    <div class="page-sub" data-i18n="s2_sub">Sélectionnez les critères importants dans votre situation. Vous pouvez en choisir autant que vous voulez.</div>

    <div class="criteria-intro">
      <div class="criteria-intro-icon">💡</div>
      <div data-i18n="s2_hint">Cliquez sur les critères pour les sélectionner. Vous pourrez ensuite ajuster leur <strong>importance</strong> (poids) et choisir si un score élevé est positif ou négatif pour ce critère.</div>
    </div>

    <div class="cat-tabs" id="catTabs"></div>
    <div class="crit-grid" id="critGrid"></div>

    <div class="selected-box">
      <div class="selected-box-head">
        <h3 data-i18n="sel_title">✅ Critères sélectionnés</h3>
        <div class="sel-count" id="crit-badge">0</div>
      </div>
      <div class="sel-list" id="activeList">
        <div class="empty-hint" data-i18n="sel_empty">👆 Sélectionnez au moins 2 critères ci-dessus pour continuer</div>
      </div>
    </div>

    <div class="custom-form" id="customCritBox">
      <div class="custom-form-head" onclick="document.getElementById('customCritBox').classList.toggle('open')">
        <div class="custom-form-title" data-i18n="custom_title">✦ Ajouter un critère personnalisé</div>
        <div class="opt-chevron">▾</div>
      </div>
      <div class="custom-form-body">
        <div class="custom-row">
          <div class="field" style="margin:0"><label data-i18n="custom_name">Nom</label><input type="text" id="cust-name" placeholder="Ex : Impact sur ma famille"></div>
          <div class="field" style="margin:0"><label data-i18n="custom_icon">Icône</label><input type="text" id="cust-icon" placeholder="🎯" style="text-align:center"></div>
          <div class="field" style="margin:0">
            <label data-i18n="custom_cat">Catégorie</label>
            <select id="cust-cat">
              <option>Finance</option><option>Pro</option><option selected>Perso</option><option>Social</option><option>Stratégique</option>
            </select>
          </div>
        </div>
        <button class="btn btn-secondary" style="margin-top:12px;font-size:.8rem;padding:9px 18px" onclick="addCustom()" data-i18n="custom_add">+ Ajouter ce critère</button>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="nav('page-step1')" data-i18n="back">← Retour</button>
      <button class="btn btn-primary" onclick="validateStep2()" data-i18n="s2_next">Évaluer mes options →</button>
    </div>
  </div>
  </div><!-- /page-scroll -->
</div>

<!-- ══════════════════════════ STEP 3 ══════════════════════════ -->
<div class="page" id="page-step3">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp3"></div>
    <div class="lang-switcher">
      <button class="lang-btn active" id="btn-fr4" onclick="setLang('fr')">FR</button>
      <button class="lang-btn" id="btn-en4" onclick="setLang('en')">EN</button>
    </div>
  </div>
  <div class="page-scroll">
  <div class="main">
    <div class="page-eyebrow" data-i18n="s3_eyebrow">Étape 3 sur 3</div>
    <div class="page-title" id="eval-title" data-i18n="s3_title">Notez chaque option</div>
    <div class="page-sub" data-i18n="s3_sub">Pour chaque critère, donnez une note de <strong>1</strong> (très faible) à <strong>10</strong> (excellent) à chaque option. Le score global se met à jour en direct.</div>

    <div class="eval-grid" id="evalGrid"></div>
    <div class="notes-row" id="notesRow"></div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="nav('page-step2')" data-i18n="back">← Retour</button>
      <button class="btn btn-primary" onclick="showResults()" data-i18n="s3_next">Voir mon analyse →</button>
    </div>
  </div>
  </div><!-- /page-scroll -->
</div>

<!-- ══════════════════════════ RESULTS ══════════════════════════ -->
<div class="page" id="page-results">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp4"></div>
    <div class="lang-switcher">
      <button class="lang-btn active" id="btn-fr5" onclick="setLang('fr')">FR</button>
      <button class="lang-btn" id="btn-en5" onclick="setLang('en')">EN</button>
    </div>
  </div>
  <div class="page-scroll" id="resScroll">
    <div id="resContent"></div>
  </div>
</div>

</div>

<script>
/* ─── I18N ───────────────────────────────── */
let LANG = 'fr';

const T = {
  fr: {
    /* Intro */
    badge:       '✦ Outil d\'aide à la décision',
    tagline:     'Comparez vos options avec Lucid et prenez vos décisions en toute confiance.',
    how1_title:  'Posez votre question',
    how1_desc:   'Formulez votre situation et listez les options à comparer.',
    how2_title:  'Choisissez vos critères',
    how2_desc:   'Sélectionnez ce qui compte vraiment pour vous.',
    how3_title:  'Obtenez votre analyse',
    how3_desc:   'Lucid calcule les scores et vous présente un résultat clair.',
    start_btn:   'Commencer →',
    footer_note: 'Gratuit · Aucun compte requis · 100% privé',
    /* Step 1 */
    s1_eyebrow:  'Étape 1 sur 3',
    s1_title:    'Quelle décision devez-vous prendre ?',
    s1_sub:      'Formulez votre situation et renseignez les options que vous envisagez.',
    s1_next:     'Choisir mes critères →',
    back_intro:  '← Retour',
    inp_dec_lbl: '📝 Votre décision en une phrase',
    inp_dec_ph:  'Ex : Dois-je accepter ce nouvel emploi ou rester dans mon poste actuel ?',
    opt_name_lbl:'Nom de l\'option',
    opt_name_ph: 'Ex : Rester à Paris',
    opt_desc_lbl:'Description courte',
    opt_desc_opt:'(optionnel)',
    opt_desc_ph: 'Ex : Stabilité, famille proche…',
    opt_add:     '+ Ajouter une option',
    opt_section_label: '🔀 Vos options',
    opt_add_label: 'Ajouter une option',
    opt_add_max:   '(max 6)',
    err_name:    'Veuillez donner un nom à chaque option.',
    /* Step 2 */
    s2_eyebrow:  'Étape 2 sur 3',
    s2_title:    'Qu\'est-ce qui compte pour vous ?',
    s2_sub:      'Sélectionnez les critères importants dans votre situation. Vous pouvez en choisir autant que vous voulez.',
    s2_hint:     'Cliquez sur les critères pour les sélectionner. Vous pourrez ensuite ajuster leur <strong>importance</strong> (poids) et choisir si un score élevé est positif ou négatif pour ce critère.',
    custom_title:'✦ Ajouter un critère personnalisé',
    custom_name: 'Nom',
    custom_icon: 'Icône',
    custom_cat:  'Catégorie',
    custom_add:  '+ Ajouter ce critère',
    custom_ph:   'Ex : Impact sur ma famille',
    sel_title:   '✅ Critères sélectionnés',
    sel_empty:   '👆 Sélectionnez au moins 2 critères ci-dessus pour continuer',
    back:        '← Retour',
    s2_next:     'Évaluer mes options →',
    err_crit:    'Veuillez sélectionner au moins 2 critères.',
    lbl_importance:'Importance',
    lbl_sens:    'Sens',
    inv_off:     '↑ Normal',
    inv_on:      '↓ Inversé',
    inv_tip_off: 'Actuellement : score élevé = bon',
    inv_tip_on:  'Actuellement : score élevé = mauvais',
    inv_tag:     '↓ inversé',
    /* Step 3 */
    s3_eyebrow:  'Étape 3 sur 3',
    s3_title:    'Notez chaque option',
    s3_sub:      'Pour chaque critère, donnez une note de <strong>1</strong> (très faible) à <strong>10</strong> (excellent) à chaque option. Le score global se met à jour en direct.',
    s3_next:     'Voir mon analyse →',
    notes_ph:    '💭 Notes personnelles sur cette option…',
    notes_lbl:   (ltr, name) => `📝 Notes libres — Option ${ltr} (${name})`,
    /* Results */
    res_eyebrow: '✦ Votre analyse',
    export_pdf:  '🖨️ Exporter en PDF',
    new_decision:'↺ Nouvelle décision',
    back_notes:  '← Modifier mes notes',
    res_tie_title:'Résultat très serré !',
    res_tie_sub: (diff) => `Seulement ${diff} point${diff>1?'s':''} d'écart — les deux premières options sont quasiment équivalentes. Faites confiance à votre intuition.`,
    res_win_sub: (diff) => `Avantage de ${diff} points sur vos critères pondérés. N'oubliez pas de prendre en compte vos notes et votre ressenti.`,
    rank_labels: ['🥇 1ère option','🥈 2ème option','🥉 3ème option'],
    div_scores:  'Scores',
    div_visual:  'Profil visuel',
    div_detail:  'Détail par critère',
    div_synth:   'Synthèse',
    div_notes:   'Notes personnelles',
    div_explore: 'Exploration',
    bk_crit:     'Critère',
    interp_title:'Interprétation personnalisée',
    analysis_title:'Analyse synthétique',
    analysis_badge:'Automatique',
    pros_title:  (name) => `✦ Points forts de "${name}"`,
    cons_title:  '⚠ Points d\'attention',
    no_notes:    'Aucune note',
    notes_head:  '📝 Vos notes personnelles',
    fear_title:  'Et si la peur n\'était pas un facteur ?',
    fear_sub:    'Lucid masque les critères liés au risque et à la prudence pour révéler votre choix sans biais de peur.',
    scenario_title:'Testez vos scénarios',
    scenario_sub:'Activez ou désactivez des critères pour recalculer les scores instantanément.',
    scenario_reset:'Tout réactiver',
    scenario_active:(a,t)=>`${a} / ${t} critères actifs`,
    sc_inv:        '↓ inversé',
    sc_toggle_on:  'Désactiver ce critère',
    sc_toggle_off: 'Activer ce critère',
    /* Scenario insights */
    sc_all_active: `✅ Tous les critères sont actifs — c'est votre analyse complète, sans filtre.`,
    sc_switched:   (dis,newN,gainSign,oldN,s,p1,p2) => `🔄 Sans ${dis}, le classement <strong>s'inverse</strong> : <strong>"${newN}"</strong> passe en tête (${gainSign} pts), devant <strong>"${oldN}"</strong>. Ce${s} critère${s} ${p1} donc un rôle décisif en faveur de l'option initiale.`,
    sc_reduced:    (winN,gapDiff,dis,s,p2) => `⚠️ <strong>"${winN}"</strong> reste en tête, mais son avantage se réduit de <strong>${gapDiff} points</strong> sans ${dis}. Ce${s} critère${s} ${p2} une part importante de son avance — la décision serait plus serrée sans ${s?'eux':'lui'}.`,
    sc_wider:      (winN,extra,dis,s,p3) => `✅ Sans ${dis}, <strong>"${winN}"</strong> se détache encore davantage (+${extra} pts d'écart supplémentaires). Ce${s} critère${s} ${p3} — son avance repose sur d'autres facteurs.`,
    sc_diverge:    (gN,gd,lN,ld,dis,p4) => `📊 Ce scénario révèle une divergence nette : <strong>"${gN}"</strong> gagne +${gd} pts tandis que <strong>"${lN}"</strong> en perd ${ld}. ${dis} ${p4} donc différemment sur chaque option.`,
    sc_nochange:   (dis,max,s,p5) => `📌 Désactiver ${dis} ne change presque rien aux scores (moins de ${max} pts d'écart). Ce${s} critère${s} ${p5} dans cette décision — les autres facteurs portent l'essentiel du résultat.`,
    sc_fallback:   (dis,impN,sign,s,p6) => `🎯 Sans ${dis}, l'option la plus impactée est <strong>"${impN}"</strong> (${sign} pts). Le classement reste identique, mais ce scénario montre à quel point ce${s} critère${s} ${p6} la position de cette option.`,
    /* Fear panel */
    fear_toggle_lbl_on:  '🎭 Critères masqués (liés à la peur)',
    fear_toggle_lbl_off: '🔍 Critères détectés comme liés à la peur',
    fear_none:     "Aucun critère lié à la peur ou au risque n'a été sélectionné dans votre analyse.",
    fear_score_real:'Score réel',
    fear_score_fearless:'Sans peur',
    fear_delta_lbl:(sign,d)=>`${sign}${d} pts sans peur`,
    fear_switched: (fearlessN,normalN) => `💡 Sans les critères de prudence, <strong>"${fearlessN}"</strong> passerait en tête — alors que <strong>"${normalN}"</strong> gagne dans l'analyse complète. Ce que cela révèle : <strong>c'est probablement la peur qui oriente votre décision vers "${normalN}"</strong>. Est-ce un choix voulu ou un réflexe de prudence ?`,
    fear_gains:    (optN,pts) => `💡 Le classement ne change pas, mais <strong>"${optN}"</strong> gagne <strong>${pts} points</strong> une fois la peur mise de côté. Votre intuition profonde lui est plus favorable que vos chiffres actuels ne le montrent.`,
    fear_loses:    (optN,pts) => `💡 Le classement ne change pas, mais <strong>"${optN}"</strong> perd <strong>${pts} points</strong> une fois la peur mise de côté. La prudence vous protège mais pèse aussi sur cette option.`,
    fear_consistent:'💡 Le classement reste identique avec ou sans les critères de peur. Votre décision semble cohérente — elle n\'est pas fortement biaisée par la prudence.',
    /* Step progress */
    sp_labels:   ['Mes options','Mes critères','Mes notes'],
    /* Weights */
    weights:     {1:'×1 Normal', 2:'×2 Important', 3:'×3 Crucial'},
    /* CATS */
    cats:        ['Tous','Finance','Pro','Perso','Social','Stratégique'],
    /* AI prompt lang */
    ai_lang:     'français',
    /* genAnalysis */
    an_score_high: (name,v,w) => `Score élevé sur « ${name} » (${v}/10)${w>1?` — critère d'importance ×${w}`:''}. `,
    an_clear:    (diff) => `Avantage significatif de ${diff} points — la recommandation est claire.`,
    an_tight:    'Résultat serré — d\'autres facteurs non quantifiables peuvent faire la différence.',
    an_runner:   (rName,cName,vR,vW) => `"${rName}" fait mieux sur « ${cName} » (${vR} vs ${vW}).`,
    an_weak:     (cName,v,wName) => `Critère crucial « ${cName} » : score faible pour "${wName}" (${v}/10) — à surveiller.`,
    an_no_cons:  'Pas de faiblesse critique identifiée — l\'option est solide sur tous les critères.',
    /* opt builder */
    opt_label:   (ltr) => `Option ${ltr}`,
    opt_count:   (n) => `${n} option${n>1?'s':''}`,
    /* eval */
    eval_title:  (dec) => `Notez vos options pour : "${dec}"`,
    /* MODIF SWING */
    swing_method_simple: 'Méthode simple',
    swing_method_swing:  '⚖️ Méthode ROC',
    swing_info: 'ℹ️ Classez vos critères du plus (n°1) au moins important. Les poids sont calculés automatiquement via une méthode scientifique (ROC) pour une décroissance naturelle.',
    swing_weight_lbl: 'Poids calculé',
    /* FIN MODIF SWING */
  },
  en: {
    /* Intro */
    badge:       '✦ Decision-making tool',
    tagline:     'Compare your options with Lucid and make decisions with confidence.',
    how1_title:  'State your question',
    how1_desc:   'Describe your situation and list the options to compare.',
    how2_title:  'Choose your criteria',
    how2_desc:   'Select what truly matters to you.',
    how3_title:  'Get your analysis',
    how3_desc:   'Lucid calculates scores and presents a clear result.',
    start_btn:   'Get started →',
    footer_note: 'Free · No account required · 100% private',
    /* Step 1 */
    s1_eyebrow:  'Step 1 of 3',
    s1_title:    'What decision are you facing?',
    s1_sub:      'Describe your situation and enter the options you are considering.',
    s1_next:     'Choose my criteria →',
    back_intro:  '← Back',
    inp_dec_lbl: '📝 Your decision in one sentence',
    inp_dec_ph:  'e.g. Should I accept this new job or stay in my current position?',
    opt_name_lbl:'Option name',
    opt_name_ph: 'e.g. Stay in Paris',
    opt_desc_lbl:'Short description',
    opt_desc_opt:'(optional)',
    opt_desc_ph: 'e.g. Stability, family nearby…',
    opt_add:     '+ Add an option',
    opt_section_label: '🔀 Your options',
    opt_add_label: 'Add an option',
    opt_add_max:   '(max 6)',
    err_name:    'Please give a name to each option.',
    /* Step 2 */
    s2_eyebrow:  'Step 2 of 3',
    s2_title:    'What matters to you?',
    s2_sub:      'Select the criteria that are important in your situation. You can choose as many as you want.',
    s2_hint:     'Click on criteria to select them. You can then adjust their <strong>importance</strong> (weight) and choose whether a high score is positive or negative for that criterion.',
    custom_title:'✦ Add a custom criterion',
    custom_name: 'Name',
    custom_icon: 'Icon',
    custom_cat:  'Category',
    custom_add:  '+ Add this criterion',
    custom_ph:   'e.g. Impact on my family',
    sel_title:   '✅ Selected criteria',
    sel_empty:   '👆 Select at least 2 criteria above to continue',
    back:        '← Back',
    s2_next:     'Evaluate my options →',
    err_crit:    'Please select at least 2 criteria.',
    lbl_importance:'Importance',
    lbl_sens:    'Direction',
    inv_off:     '↑ Normal',
    inv_on:      '↓ Inverted',
    inv_tip_off: 'Currently: high score = good',
    inv_tip_on:  'Currently: high score = bad',
    inv_tag:     '↓ inverted',
    /* Step 3 */
    s3_eyebrow:  'Step 3 of 3',
    s3_title:    'Rate each option',
    s3_sub:      'For each criterion, give a score from <strong>1</strong> (very low) to <strong>10</strong> (excellent) for each option. The overall score updates live.',
    s3_next:     'See my analysis →',
    notes_ph:    '💭 Personal notes on this option…',
    notes_lbl:   (ltr, name) => `📝 Free notes — Option ${ltr} (${name})`,
    /* Results */
    res_eyebrow: '✦ Your analysis',
    export_pdf:  '🖨️ Export as PDF',
    new_decision:'↺ New decision',
    back_notes:  '← Edit my scores',
    res_tie_title:'Very close result!',
    res_tie_sub: (diff) => `Only ${diff} point${diff>1?'s':''} apart — the top two options are nearly equivalent. Trust your instincts.`,
    res_win_sub: (diff) => `${diff}-point advantage on your weighted criteria. Don't forget to factor in your notes and gut feeling.`,
    rank_labels: ['🥇 1st option','🥈 2nd option','🥉 3rd option'],
    div_scores:  'Scores',
    div_visual:  'Visual profile',
    div_detail:  'Criterion breakdown',
    div_synth:   'Summary',
    div_notes:   'Personal notes',
    div_explore: 'Explore further',
    bk_crit:     'Criterion',
    interp_title:'Personalised interpretation',
    analysis_title:'Summary analysis',
    analysis_badge:'Automatic',
    pros_title:  (name) => `✦ Strengths of "${name}"`,
    cons_title:  '⚠ Points of attention',
    no_notes:    'No notes',
    notes_head:  '📝 Your personal notes',
    fear_title:  'What if fear wasn\'t a factor?',
    fear_sub:    'Lucid hides risk and caution-related criteria to reveal your choice without fear bias.',
    scenario_title:'Test your scenarios',
    scenario_sub:'Enable or disable criteria to instantly recalculate scores.',
    scenario_reset:'Re-enable all',
    scenario_active:(a,t)=>`${a} / ${t} active criteria`,
    sc_inv:        '↓ inverted',
    sc_toggle_on:  'Disable this criterion',
    sc_toggle_off: 'Enable this criterion',
    /* Scenario insights */
    sc_all_active: '✅ All criteria are active — this is your complete, unfiltered analysis.',
    sc_switched:   (dis,newN,gainSign,oldN,s,p1,p2) => `🔄 Without ${dis}, the ranking <strong>flips</strong>: <strong>"${newN}"</strong> takes the lead (${gainSign} pts), ahead of <strong>"${oldN}"</strong>. ${s} ${p1} therefore played a decisive role in favour of the original option.`,
    sc_reduced:    (winN,gapDiff,dis,s,p2) => `⚠️ <strong>"${winN}"</strong> stays on top, but its lead shrinks by <strong>${gapDiff} points</strong> without ${dis}. ${s} ${p2} a significant part of its advantage — the decision would be closer without ${LANG==='en'?'it/them':'it/them'}.`,
    sc_wider:      (winN,extra,dis,s,p3) => `✅ Without ${dis}, <strong>"${winN}"</strong> pulls even further ahead (+${extra} pts extra gap). ${s} ${p3} — its lead rests on other factors.`,
    sc_diverge:    (gN,gd,lN,ld,dis,p4) => `📊 This scenario reveals a clear divergence: <strong>"${gN}"</strong> gains +${gd} pts while <strong>"${lN}"</strong> loses ${ld}. ${dis} ${p4} differently on each option.`,
    sc_nochange:   (dis,max,s,p5) => `📌 Disabling ${dis} barely changes the scores (less than ${max} pts difference). ${s} ${p5} — the other factors carry most of the result.`,
    sc_fallback:   (dis,impN,sign,s,p6) => `🎯 Without ${dis}, the most impacted option is <strong>"${impN}"</strong> (${sign} pts). The ranking stays the same, but this scenario shows how much ${s} ${p6} this option's position.`,
    /* Fear panel */
    fear_toggle_lbl_on:  '🎭 Hidden criteria (fear-related)',
    fear_toggle_lbl_off: '🔍 Criteria detected as fear-related',
    fear_none:     'No fear- or risk-related criteria were selected in your analysis.',
    fear_score_real:'Real score',
    fear_score_fearless:'Fear-free',
    fear_delta_lbl:(sign,d)=>`${sign}${d} pts fear-free`,
    fear_switched: (fearlessN,normalN) => `💡 Without caution criteria, <strong>"${fearlessN}"</strong> would take the lead — while <strong>"${normalN}"</strong> wins in the full analysis. What this reveals: <strong>it's likely fear that steers your decision toward "${normalN}"</strong>. Is this a deliberate choice or a reflex of caution?`,
    fear_gains:    (optN,pts) => `💡 The ranking doesn't change, but <strong>"${optN}"</strong> gains <strong>${pts} points</strong> once fear is set aside. Your deeper intuition is more favourable to it than your current numbers show.`,
    fear_loses:    (optN,pts) => `💡 The ranking doesn't change, but <strong>"${optN}"</strong> loses <strong>${pts} points</strong> once fear is set aside. Caution protects you but also weighs on this option.`,
    fear_consistent:'💡 The ranking stays the same with or without fear criteria. Your decision seems consistent — it is not strongly biased by caution.',
    /* Step progress */
    sp_labels:   ['My options','My criteria','My scores'],
    /* Weights */
    weights:     {1:'×1 Normal', 2:'×2 Important', 3:'×3 Critical'},
    /* CATS */
    cats:        ['All','Finance','Work','Personal','Social','Strategic'],
    /* AI prompt lang */
    ai_lang:     'English',
    /* genAnalysis */
    an_score_high: (name,v,w) => `High score on "${name}" (${v}/10)${w>1?` — importance ×${w}`:''}. `,
    an_clear:    (diff) => `Significant ${diff}-point advantage — the recommendation is clear.`,
    an_tight:    'Close result — other non-quantifiable factors may make the difference.',
    an_runner:   (rName,cName,vR,vW) => `"${rName}" performs better on "${cName}" (${vR} vs ${vW}).`,
    an_weak:     (cName,v,wName) => `Critical criterion "${cName}": low score for "${wName}" (${v}/10) — worth monitoring.`,
    an_no_cons:  'No critical weakness identified — the option is solid across all criteria.',
    /* opt builder */
    opt_label:   (ltr) => `Option ${ltr}`,
    opt_count:   (n) => `${n} option${n>1?'s':''}`,
    /* eval */
    eval_title:  (dec) => `Rate your options for: "${dec}"`,
    /* MODIF SWING */
    swing_method_simple: 'Simple method',
    swing_method_swing:  '⚖️ ROC Weighting',
    swing_info: 'ℹ️ Rank your criteria from most (#1) to least important. Weights are automatically calculated using a scientific method (ROC) for a natural decay.',
    swing_weight_lbl: 'Calculated Weight',
    /* FIN MODIF SWING */
  }
};

/* LIB EN — English criterion names */
const LIB_EN = {
  fin_gain: {name:'Financial gain',       hint:'Revenue, salary, profits'},
  fin_risk: {name:'Financial risk',       hint:'Potential losses, debts'},
  roi:      {name:'Return on investment', hint:'ROI in the medium/long term'},
  cost:     {name:'Initial cost',         hint:'Upfront investment'},
  fin_stab: {name:'Financial stability',  hint:'Income security'},
  career:   {name:'Career growth',        hint:'Professional prospects'},
  skills:   {name:'Skill development',    hint:'Learning, upskilling'},
  workload: {name:'Workload',             hint:'Volume and intensity of work'},
  jobsec:   {name:'Job security',         hint:'Stability and sustainability'},
  autonom:  {name:'Autonomy',             hint:'Freedom to act and decide'},
  flex:     {name:'Schedule flexibility', hint:'Remote work, flexible hours'},
  recog:    {name:'Recognition',          hint:'Appreciation, prestige'},
  wellb:    {name:'Personal well-being',  hint:'Happiness, fulfilment'},
  stress:   {name:'Stress level',         hint:'Pressure, anxiety generated'},
  health:   {name:'Health impact',        hint:'Effects on physical/mental health'},
  time:     {name:'Free time',            hint:'Leisure, rest, time for yourself'},
  values:   {name:'Values alignment',     hint:'Coherence with your principles'},
  passion:  {name:'Passion & interest',   hint:'Intrinsic motivation'},
  risk:     {name:'Overall risk',         hint:'Uncertainty, exposure to danger'},
  family:   {name:'Family impact',        hint:'Effects on relationships & family life'},
  social:   {name:'Social life',          hint:'Friendships, social environment'},
  ethics:   {name:'Ethics & values',      hint:'Coherence with your moral convictions'},
  repute:   {name:'Reputation',           hint:'Image, social perception'},
  env:      {name:'Environmental impact', hint:'Ecological footprint'},
  vision:   {name:'Long-term vision',     hint:'Alignment with your 5–10 year goals'},
  innov:    {name:'Innovation',           hint:'Creative potential, disruption'},
  impact:   {name:'Impact & meaning',     hint:'Positive contribution to society'},
  speed:    {name:'Speed of execution',   hint:'Time to results'},
  rev:      {name:'Reversibility',        hint:'Ease of going back'},
  complex:  {name:'Complexity',           hint:'Difficulty of implementation'},
  dep:      {name:'Dependencies',         hint:'Constraints linked to other factors'},
};

function tr(key,...args){
  const val = T[LANG][key];
  if(typeof val === 'function') return val(...args);
  return val ?? T['fr'][key] ?? key;
}

function setLang(lang){
  LANG = lang;
  /* Toggle active button — all headers */
  ['btn-fr','btn-fr2','btn-fr3','btn-fr4','btn-fr5'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.classList.toggle('active',lang==='fr');
  });
  ['btn-en','btn-en2','btn-en3','btn-en4','btn-en5'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.classList.toggle('active',lang==='en');
  });

  /* Update all static data-i18n elements */
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    const val = T[lang][key];
    if(val !== undefined && typeof val === 'string') el.innerHTML = val;
  });

  /* Update placeholders with data-i18n-ph */
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key = el.getAttribute('data-i18n-ph');
    const val = T[lang][key];
    if(val) el.placeholder = val;
  });

  /* Update select label in inp-dec */
  const decLbl = document.querySelector('label[for="inp-dec"]');
  if(decLbl) decLbl.textContent = tr('inp_dec_lbl');
  const decInp = document.getElementById('inp-dec');
  if(decInp) decInp.placeholder = tr('inp_dec_ph');

  /* Update custom form placeholder */
  const custName = document.getElementById('cust-name');
  if(custName) custName.placeholder = tr('custom_ph');

  /* Update CATS & WEIGHTS globals */
  CATS.length = 0;
  tr('cats').forEach(c=>CATS.push(c));
  Object.assign(WEIGHTS, tr('weights'));

  /* Update LIB names/hints if EN */
  LIB.forEach(c=>{
    if(lang==='en' && LIB_EN[c.id]){
      c._name_fr = c._name_fr || c.name;
      c._hint_fr = c._hint_fr || c.hint;
      c.name = LIB_EN[c.id].name;
      c.hint = LIB_EN[c.id].hint;
      c.cat  = ['Finance','Pro','Perso','Social','Stratégique'].indexOf(c.cat) >= 0
        ? ['Finance','Work','Personal','Social','Strategic'][['Finance','Pro','Perso','Social','Stratégique'].indexOf(c.cat)]
        : c.cat;
    } else if(lang==='fr'){
      if(c._name_fr){ c.name = c._name_fr; c.hint = c._hint_fr; }
      c.cat = ['Finance','Work','Personal','Social','Strategic'].indexOf(c.cat) >= 0
        ? ['Finance','Pro','Perso','Social','Stratégique'][['Finance','Work','Personal','Social','Strategic'].indexOf(c.cat)]
        : c.cat;
    }
  });

  /* Also update selected criteria names */
  S.criteria.forEach(c=>{
    const orig = LIB.find(l=>l.id===c.id);
    if(orig){ c.name = orig.name; c.hint = orig.hint; }
  });

  /* Update step progress labels */
  renderStepProgress(getCurrentStep());

  /* Re-render open panels */
  renderOptBuilder();
  if(document.getElementById('page-step2').classList.contains('active')){
    buildCriteriaPage();
  }
  if(document.getElementById('page-step3').classList.contains('active')){
    buildEvalPage();
  }
}

function getCurrentStep(){
  if(document.getElementById('page-step3').classList.contains('active')) return 3;
  if(document.getElementById('page-step2').classList.contains('active')) return 2;
  return 1;
}


/* ─── PALETTE ───────────────────────────── */
const COLORS = [
  {hex:'#2d7d5a',bg:'rgba(45,125,90,0.08)',  border:'rgba(45,125,90,0.3)'  },
  {hex:'#e07040',bg:'rgba(224,112,64,0.08)', border:'rgba(224,112,64,0.3)' },
  {hex:'#7c3aed',bg:'rgba(124,58,237,0.08)', border:'rgba(124,58,237,0.3)' },
  {hex:'#d97706',bg:'rgba(217,119,6,0.08)',  border:'rgba(217,119,6,0.3)'  },
  {hex:'#0891b2',bg:'rgba(8,145,178,0.08)',  border:'rgba(8,145,178,0.3)'  },
  {hex:'#be185d',bg:'rgba(190,24,93,0.08)',  border:'rgba(190,24,93,0.3)'  },
];
const LETTERS = ['A','B','C','D','E','F'];

/* ─── CRITERIA LIBRARY ──────────────────── */
const LIB = [
  {id:'fin_gain', cat:'Finance',     icon:'💰', name:'Gain financier',           hint:'Revenus, salaire, bénéfices',           invert:false, dw:2},
  {id:'fin_risk', cat:'Finance',     icon:'📉', name:'Risque financier',          hint:'Pertes potentielles, dettes',            invert:true,  dw:2},
  {id:'roi',      cat:'Finance',     icon:'📈', name:'Retour sur investissement', hint:'ROI à moyen/long terme',                 invert:false, dw:1},
  {id:'cost',     cat:'Finance',     icon:'🏷️', name:'Coût initial',             hint:'Investissement de départ',               invert:true,  dw:1},
  {id:'fin_stab', cat:'Finance',     icon:'🏦', name:'Stabilité financière',      hint:'Sécurité des revenus',                   invert:false, dw:2},

  {id:'career',   cat:'Pro',         icon:'🚀', name:'Évolution de carrière',     hint:'Perspectives professionnelles',           invert:false, dw:2},
  {id:'skills',   cat:'Pro',         icon:'🧠', name:'Développement compétences', hint:'Apprentissage, montée en compétence',    invert:false, dw:1},
  {id:'workload', cat:'Pro',         icon:'⚡', name:'Charge de travail',         hint:'Volume et intensité du travail',          invert:true,  dw:1},
  {id:'jobsec',   cat:'Pro',         icon:'🛡️', name:"Sécurité de l'emploi",     hint:'Stabilité et pérennité du poste',         invert:false, dw:2},
  {id:'autonom',  cat:'Pro',         icon:'🎯', name:'Autonomie',                 hint:"Liberté d'action et de décision",         invert:false, dw:1},
  {id:'flex',     cat:'Pro',         icon:'⏰', name:'Flexibilité horaire',        hint:'Télétravail, horaires aménageables',      invert:false, dw:1},
  {id:'recog',    cat:'Pro',         icon:'🏅', name:'Reconnaissance',            hint:'Valorisation, prestige',                  invert:false, dw:1},

  {id:'wellb',    cat:'Perso',       icon:'❤️', name:'Bien-être personnel',       hint:'Bonheur, épanouissement',                invert:false, dw:3},
  {id:'stress',   cat:'Perso',       icon:'😤', name:'Niveau de stress',          hint:'Pression, anxiété générée',               invert:true,  dw:2},
  {id:'health',   cat:'Perso',       icon:'🌿', name:'Impact santé',              hint:'Effets sur votre santé physique/mentale', invert:false, dw:2},
  {id:'time',     cat:'Perso',       icon:'⏱️', name:'Temps libre',              hint:'Loisirs, repos, temps pour soi',           invert:false, dw:2},
  {id:'values',   cat:'Perso',       icon:'🧭', name:'Alignement valeurs',        hint:'Cohérence avec vos principes',            invert:false, dw:3},
  {id:'passion',  cat:'Perso',       icon:'🔥', name:'Passion & intérêt',         hint:'Motivation intrinsèque',                  invert:false, dw:2},
  {id:'risk',     cat:'Perso',       icon:'⚠️', name:'Risque global',             hint:'Incertitude, exposition au danger',        invert:true,  dw:2},

  {id:'family',   cat:'Social',      icon:'👨‍👩‍👧', name:'Impact famille',       hint:'Relations avec proches',                  invert:false, dw:2},
  {id:'social',   cat:'Social',      icon:'🤝', name:'Vie sociale',               hint:'Réseau, amis, interactions',              invert:false, dw:1},
  {id:'location', cat:'Social',      icon:'📍', name:'Qualité du lieu de vie',    hint:'Logement, ville, environnement',          invert:false, dw:1},
  {id:'repute',   cat:'Social',      icon:'✨', name:'Réputation / Image',         hint:'Perception des autres',                   invert:false, dw:1},
  {id:'impact',   cat:'Social',      icon:'🌍', name:'Impact sociétal',            hint:'Utilité pour la société',                 invert:false, dw:1},

  {id:'lt',       cat:'Stratégique', icon:'🔭', name:'Vision long terme',          hint:'Bénéfices dans 5–10 ans',                invert:false, dw:2},
  {id:'rev',      cat:'Stratégique', icon:'↩️', name:'Réversibilité',              hint:'Possibilité de revenir en arrière',       invert:false, dw:2},
  {id:'opp',      cat:'Stratégique', icon:'🎲', name:'Opportunité unique',          hint:'Rareté de la chance',                    invert:false, dw:1},
  {id:'complex',  cat:'Stratégique', icon:'🔧', name:'Complexité',                  hint:'Difficulté de mise en œuvre',            invert:true,  dw:1},
  {id:'dep',      cat:'Stratégique', icon:'🔗', name:'Dépendances',                 hint:'Contraintes liées à autres facteurs',    invert:true,  dw:1},
];

const CATS = ['Tous','Finance','Pro','Perso','Social','Stratégique'];
const WEIGHTS = {1:'×1 Normal', 2:'×2 Important', 3:'×3 Crucial'};

/* ─── STATE ─────────────────────────────── */
let S = {
  decision:'',
  options:[{name:'',desc:''},{name:'',desc:''}],
  criteria:[],
  scores:{},
  notes:[],
  currentCat:'Tous',
  weightingMethod:'simple', // MODIF SWING: 'simple' | 'swing'
};

/* ─── NAV ───────────────────────────────── */
function nav(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}

function renderStepProgress(active){
  ['sp1','sp2','sp3','sp4'].forEach((id,i)=>{
    const el=document.getElementById(id); if(!el) return;
    const labels=tr('sp_labels');
    // sp4 = results page: show all steps as done
    const a = id==='sp4' ? 4 : active;
    el.innerHTML=[1,2,3].map(s=>{
      const cls=s<a?'done':s===a?'active':'';
      return `<div class="sp-step ${cls}">
        <div class="sp-num">${s<a?'✓':s}</div>
        <span>${labels[s-1]}</span>
      </div>${s<3?'<div class="sp-arrow">›</div>':''}`;
    }).join('');
  });
}
renderStepProgress(1);

/* ─── STEP 1 ────────────────────────────── */
function initOptions(){ renderOptBuilder(); }

function renderOptBuilder(){
  const b=document.getElementById('optBuilder');
  b.innerHTML='';
  S.options.forEach((opt,i)=>{
    const ltr=LETTERS[i];
    const card=document.createElement('div');
    card.className='opt-card open'; card.id=`opt-card-${i}`;
    card.innerHTML=`
      <div class="opt-card-head" onclick="toggleOpt(${i})">
        <div class="opt-dot" style="background:${COLORS[0].hex}"></div>
        <div class="opt-letter" style="color:${COLORS[0].hex}">${tr('opt_label',ltr)}</div>
        <div class="opt-name-preview" id="opt-prev-${i}">${esc(opt.name)||'—'}</div>
        ${i>=2?`<button class="opt-rm" onclick="event.stopPropagation();removeOpt(${i})" title="Supprimer">✕</button>`:''}
        <div class="opt-chevron">▾</div>
      </div>
      <div class="opt-card-body">
        <div class="field">
          <label>${tr('opt_name_lbl')}</label>
          <input type="text" id="opt-name-${i}" value="${esc(opt.name)}"
            placeholder="${tr('opt_name_ph')}"
            oninput="S.options[${i}].name=this.value;document.getElementById('opt-prev-${i}').textContent=this.value||'—'">
        </div>
        <div class="field" style="margin-bottom:0">
          <label>${tr('opt_desc_lbl')} <span style="font-weight:400;color:var(--muted)">${tr('opt_desc_opt')}</span></label>
          <input type="text" id="opt-desc-${i}" value="${esc(opt.desc)}"
            placeholder="${tr('opt_desc_ph')}"
            oninput="S.options[${i}].desc=this.value">
        </div>
      </div>`;
    b.appendChild(card);
  });
  document.getElementById('opt-count-lbl').textContent=tr('opt_count',S.options.length);
  document.getElementById('addOptBtn').style.display=S.options.length>=6?'none':'flex';
}

function toggleOpt(i){ document.getElementById(`opt-card-${i}`).classList.toggle('open'); }
function addOption(){ if(S.options.length>=6) return; S.options.push({name:'',desc:''}); renderOptBuilder(); }
function removeOpt(i){ if(S.options.length<=2) return; S.options.splice(i,1); renderOptBuilder(); }

function validateStep1(){
  const dec=document.getElementById('inp-dec').value.trim();
  if(!dec){ shake('inp-dec'); return; }
  const allNamed=S.options.every((_,i)=>document.getElementById(`opt-name-${i}`)?.value.trim());
  if(!allNamed){ alert(tr('err_name')); return; }
  S.decision=dec;
  S.options=S.options.map((_,i)=>({
    name:document.getElementById(`opt-name-${i}`).value.trim(),
    desc:document.getElementById(`opt-desc-${i}`).value.trim(),
  }));
  S.notes=S.options.map(()=>'');
  renderStepProgress(2);
  buildCriteriaPage();
  nav('page-step2');
}

initOptions();

/* ─── STEP 2 ────────────────────────────── */
function buildCriteriaPage(){ S.currentCat=tr('cats')[0]; renderCatTabs(); filterGrid(tr('cats')[0]); renderSelList(); }

function renderCatTabs(){
  const t=document.getElementById('catTabs'); t.innerHTML='';
  CATS.forEach(cat=>{
    const b=document.createElement('button');
    b.className='cat-tab'+(cat===S.currentCat?' active':'');
    b.textContent=cat; b.onclick=()=>filterGrid(cat); t.appendChild(b);
  });
}

function filterGrid(cat){
  S.currentCat=cat; renderCatTabs();
  const g=document.getElementById('critGrid'); g.innerHTML='';
  (cat===tr('cats')[0]?LIB:LIB.filter(c=>c.cat===cat)).forEach(c=>{
    const on=S.criteria.some(x=>x.id===c.id);
    const pill=document.createElement('div');
    pill.className='crit-pill'+(on?' on':''); pill.id='pill-'+c.id;
    pill.innerHTML=`
      <div class="crit-check">${on?'✓':''}</div>
      <div class="crit-icon">${c.icon}</div>
      <div><div class="crit-name">${c.name}</div><div class="crit-hint">${c.hint}</div></div>`;
    pill.onclick=()=>toggleCrit(c.id); g.appendChild(pill);
  });
}

function toggleCrit(id){
  const idx=S.criteria.findIndex(c=>c.id===id);
  if(idx!==-1){
    S.criteria.splice(idx,1);
    // MODIF SWING — renormalise les rangs après suppression
    _swingRenorm();
    // FIN MODIF SWING
  } else {
    const c=LIB.find(c=>c.id===id);
    S.criteria.push({
      ...c, weight:c.dw,
      // MODIF SWING
      swingRank:S.criteria.length
      // FIN MODIF SWING
    });
  }
  filterGrid(S.currentCat); renderSelList();
}

function addCustom(){
  const name=document.getElementById('cust-name').value.trim();
  if(!name){shake('cust-name');return;}
  const icon=document.getElementById('cust-icon').value.trim()||'🔹';
  const cat=document.getElementById('cust-cat').value;
  S.criteria.push({
    id:'cust_'+Date.now(),cat,icon,name,
    hint:LANG==='fr'?'Critère personnalisé':'Custom criterion',
    invert:false,weight:1,custom:true,
    // MODIF SWING
    swingRank:S.criteria.length
    // FIN MODIF SWING
  });
  document.getElementById('cust-name').value='';
  document.getElementById('cust-icon').value='';
  renderSelList();
}

function renderSelList(){
  const list=document.getElementById('activeList');
  document.getElementById('crit-badge').textContent=S.criteria.length;

  if(!S.criteria.length){
    list.innerHTML=`<div class="empty-hint">${tr('sel_empty')}</div>`;
    return;
  }

  // MODIF SWING — Toggle méthode de pondération
  const swingActive = S.weightingMethod==='swing';
  const methodBar=`
    <div class="method-toggle-bar">
      <span class="method-lbl">${LANG==='fr'?'Pondération :':'Weighting:'}</span>
      <button class="method-btn${!swingActive?' active':''}" onclick="toggleWeightingMethod('simple')">${tr('swing_method_simple')}</button>
      <button class="method-btn${swingActive?' active':''}" onclick="toggleWeightingMethod('swing')">${tr('swing_method_swing')}</button>
    </div>`;

  if(swingActive){
    list.innerHTML = methodBar + buildSwingHTML();
    _attachSwingDnD(); // MODIF DRAG AND DROP
    return;
  }
  // FIN MODIF SWING

  // Mode simple (original)
  const simpleItems = S.criteria.map(c=>`
    <div class="sel-item">
      <div class="sel-icon">${c.icon}</div>
      <div class="sel-name">${c.name}${c.invert?` <span class="inv-tag" title="${tr('inv_tip_on')}">${tr('inv_tag')}</span>`:''}</div>
      <div class="weight-wrap">
        <label class="weight-lbl">${tr('lbl_importance')}</label>
        <div class="weight-sel-wrap">
          <select class="weight-sel" onchange="setCW('${c.id}',this.value)">
            ${[1,2,3].map(w=>`<option value="${w}"${c.weight===w?' selected':''}>${WEIGHTS[w]}</option>`).join('')}
          </select>
          <span class="weight-chevron">▾</span>
        </div>
      </div>
      <div class="weight-wrap">
        <label class="weight-lbl">${tr('lbl_sens')}</label>
        <button class="inv-btn${c.invert?' on':''}" onclick="toggleInv('${c.id}')"
          title="${c.invert?tr('inv_tip_on'):tr('inv_tip_off')}">
          ${c.invert?tr('inv_on'):tr('inv_off')}
        </button>
      </div>
      <button class="rm-btn" onclick="rmCrit('${c.id}')" title="${LANG==='fr'?'Retirer':'Remove'}">✕</button>
    </div>`).join('');

  list.innerHTML = methodBar + simpleItems;
}

function setCW(id,v){ const c=S.criteria.find(x=>x.id===id); if(c) c.weight=parseInt(v); }
function toggleInv(id){ const c=S.criteria.find(x=>x.id===id); if(c){c.invert=!c.invert;renderSelList();} }

/* ════════════════════════════════════════════
   MODIF SWING — Swing Weighting (SMARTS)
   ════════════════════════════════════════════ */

/** Renormalise les swingRank après ajout/suppression d'un critère.
 *  Garantit que le critère de rang 0 a toujours 100 pts. */
function _swingRenorm(){
  const sorted=[...S.criteria].sort((a,b)=>(a.swingRank??0)-(b.swingRank??0));
  sorted.forEach((c,i)=>{ c.swingRank=i; });
}

/** Active ou désactive le mode Swing. */
function toggleWeightingMethod(method){
  S.weightingMethod=method;
  if(method==='swing'){
    // Initialise les champs swing manquants
    S.criteria.forEach((c,i)=>{
      if(c.swingRank===undefined) c.swingRank=i;
    });
    _swingRenorm();
  }
  renderSelList();
  // Rafraîchit les scores live si on est à l'étape 3
  if(document.getElementById('page-step3').classList.contains('active')){
    S.options.forEach((_,i)=>refreshLive(i));
  }
}

/** Calcule les poids normalisés pour le mode swing (somme = 1). */
function getSwingWeights(){
  const sorted = [...S.criteria].sort((a, b) => (a.swingRank ?? 0) - (b.swingRank ?? 0));
  const N = sorted.length;
  if (N === 0) return [];

  // Pre-calculate sums of 1/k to avoid re-computing (ROC formula)
  const one_over_k = Array.from({ length: N + 1 }, (_, i) => i > 0 ? 1 / i : 0);
  const suffix_sums = Array(N + 2).fill(0);
  for (let i = N; i >= 1; i--) {
    suffix_sums[i] = suffix_sums[i + 1] + one_over_k[i];
  }

  const weights = [];
  sorted.forEach((c, index) => {
    const rank = index + 1; // 1-based rank
    weights.push({
      id: c.id,
      weight: (1 / N) * suffix_sums[rank]
    });
  });
  return weights;
}

/** Construit le HTML de la liste swing (items classables + champs). */
function buildSwingHTML(){
  const sorted = [...S.criteria].sort((a,b)=>(a.swingRank??0)-(b.swingRank??0));
  const swingWeights = getSwingWeights();

  const infoBox=`
    <div class="swing-info">
      ${tr('swing_info')}
    </div>`;

  const items=sorted.map((c,i)=>{
    const isFirst=i===0;
    const weight = swingWeights.find(w => w.id === c.id)?.weight ?? 0;
    const pct = Math.round(weight * 100);
    return `
      <div class="swing-item" id="swing-item-${c.id}" data-id="${c.id}">
        <div class="swing-rank-num">${i+1}</div>
        <div class="swing-item-main">
          <div class="swing-item-header">
            <span style="font-size:.9rem;flex-shrink:0">${c.icon}</span>
            <span class="swing-item-name">${c.name}</span>
            <button class="inv-btn${c.invert?' on':''}" onclick="toggleInv('${c.id}')"
              style="font-size:.6rem;padding:3px 7px;margin-left:auto;flex-shrink:0;"
              title="${c.invert?tr('inv_tip_on'):tr('inv_tip_off')}">
              ${c.invert?tr('inv_on'):tr('inv_off')}
            </button>
          </div>
        </div>
        <div class="swing-weight-tag" style="margin: 0 8px; align-self: center; font-size: .8rem; padding: 4px 8px;">${pct}%</div>
        <button class="rm-btn" onclick="rmCrit('${c.id}')" title="${LANG==='fr'?'Retirer':'Remove'}" style="align-self:center;margin-left:0">✕</button>
      </div>`;
  }).join('');

  return infoBox+items;
}

/* ══════════════════════════════════════════
   MODIF DRAG AND DROP — Glisser-déposer pour le classement swing
   ══════════════════════════════════════════ */

let _dragId  = null;           // id du critère en cours de drag souris
let _touchDragId  = null;      // id du critère en cours de drag tactile
let _touchGhost   = null;      // fantôme affiché sous le doigt
let _touchTargetId= null;      // id de la cible de drop courante
let _touchBefore  = true;      // insérer avant (true) ou après (false) la cible
let _swingTouchListened = false;// flag anti-duplication des listeners document
let _longPressTimer = null;    // timer du long press tactile
let _touchStartX = 0;          // coordonnée X initiale (pour détecter le scroll)
let _touchStartY = 0;          // coordonnée Y initiale

/** Réordonne en déplaçant fromId avant/après toId dans les swingRank. */
function _swingReorder(fromId, toId, before){
  if(fromId===toId) return;
  const sorted=[...S.criteria].sort((a,b)=>(a.swingRank??0)-(b.swingRank??0));
  const fromIdx=sorted.findIndex(c=>c.id===fromId);
  if(fromIdx===-1) return;
  const [moved]=sorted.splice(fromIdx,1);
  const insertAt=before
    ? sorted.findIndex(c=>c.id===toId)
    : sorted.findIndex(c=>c.id===toId)+1;
  if(insertAt<0) return;
  sorted.splice(insertAt,0,moved);
  sorted.forEach((c,i)=>{ c.swingRank=i; });
}

/** Attache les événements drag souris (HTML5) + tactile après chaque rendu swing. */
function _attachSwingDnD(){
  document.querySelectorAll('#activeList .swing-item').forEach(item=>{
    // Drag souris direct sur l'item
    item.addEventListener('mousedown',()=>{
      item.setAttribute('draggable','true');
    });

    item.addEventListener('dragstart',e=>{
      _dragId=item.dataset.id;
      item.classList.add('dragging');
      e.dataTransfer.effectAllowed='move';
    });

    item.addEventListener('dragend',()=>{
      _dragId=null;
      item.removeAttribute('draggable');
      item.classList.remove('dragging');
      document.querySelectorAll('#activeList .swing-item')
        .forEach(el=>el.classList.remove('drag-over-above','drag-over-below'));
    });

    item.addEventListener('dragover',e=>{
      e.preventDefault();
      if(!_dragId||item.dataset.id===_dragId) return;
      const before=e.clientY < item.getBoundingClientRect().top+item.offsetHeight/2;
      document.querySelectorAll('#activeList .swing-item')
        .forEach(el=>el.classList.remove('drag-over-above','drag-over-below'));
      item.classList.add(before?'drag-over-above':'drag-over-below');
    });

    item.addEventListener('dragleave',e=>{
      if(!item.contains(e.relatedTarget))
        item.classList.remove('drag-over-above','drag-over-below');
    });

    item.addEventListener('drop',e=>{
      e.preventDefault();
      if(!_dragId||item.dataset.id===_dragId) return;
      const before=e.clientY < item.getBoundingClientRect().top+item.offsetHeight/2;
      const movedId = _dragId;
      _swingReorder(movedId,item.dataset.id,before);
      renderSelList();
      _animateSwingDrop(movedId);
    });
  });

  /* ─── Drag tactile : long press (350 ms) n'importe où sur la carte ─── */
  document.querySelectorAll('#activeList .swing-item').forEach(item=>{
    // Empêche le menu contextuel (copier/coller) sur appui long sur mobile
    item.addEventListener('contextmenu', e => e.preventDefault());

    item.addEventListener('touchstart',e=>{
      const t=e.touches[0];
      _touchStartX=t.clientX;
      _touchStartY=t.clientY;
      // Capture des coords pour la closure (e.touches peut être recyclé)
      const sx=t.clientX, sy=t.clientY;
      _longPressTimer=setTimeout(()=>{
        item.classList.remove('press-holding');
        _startTouchDrag(item,{clientX:sx,clientY:sy});
      },350);
      item.classList.add('press-holding');
    },{passive:true});

    // Annuler si l'utilisateur relâche avant 350 ms (simple tap)
    item.addEventListener('touchend',()=>{
      if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer=null; }
      item.classList.remove('press-holding');
    },{passive:true});

    // Annuler si l'utilisateur commence à scroller (mouvement > 8px)
    item.addEventListener('touchmove',e=>{
      if(_touchDragId) return; // déjà en drag → géré par le listener document
      const t=e.touches[0];
      if(Math.abs(t.clientX-_touchStartX)>8||Math.abs(t.clientY-_touchStartY)>8){
        if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer=null; }
        item.classList.remove('press-holding');
      }
    },{passive:true});
  });

  // Listeners document ajoutés une seule fois pour toute la session
  if(!_swingTouchListened){
    _swingTouchListened=true;
    document.addEventListener('touchmove',  _swingTouchMove,  {passive:false});
    document.addEventListener('touchend',   _swingTouchEnd,   {passive:false});
    document.addEventListener('touchcancel',_swingTouchEnd,   {passive:false});
  }
}

/** Démarre le drag tactile : crée le fantôme et marque l'item comme dragging. */
function _startTouchDrag(item,touch){
  _touchDragId=item.dataset.id;
  if(navigator.vibrate) navigator.vibrate(30); // retour haptique si dispo
  _touchGhost=item.cloneNode(true);
  _touchGhost.classList.add('swing-ghost');
  _touchGhost.style.width=item.offsetWidth+'px';
  document.body.appendChild(_touchGhost);
  item.classList.add('dragging');
  _touchGhost.style.left=(touch.clientX-20)+'px';
  _touchGhost.style.top =(touch.clientY-item.offsetHeight/2)+'px';
}

/** Applique une animation à l'élément qui vient d'être déposé. */
function _animateSwingDrop(movedId) {
  const movedEl = document.getElementById(`swing-item-${movedId}`);
  if (movedEl) {
    movedEl.classList.add('animate-drop');
    movedEl.addEventListener('animationend', () => {
      movedEl.classList.remove('animate-drop');
    }, { once: true });
  }
}

function _swingTouchMove(e){
  if(!_touchDragId) return;
  e.preventDefault();
  const t=e.touches[0];
  // Déplacer le fantôme
  if(_touchGhost){
    _touchGhost.style.left=(t.clientX-20)+'px';
    _touchGhost.style.top =(t.clientY-30)+'px';
  }
  // Trouver la cible sous le doigt
  _touchTargetId=null; _touchBefore=true;
  document.querySelectorAll('#activeList .swing-item').forEach(el=>{
    el.classList.remove('drag-over-above','drag-over-below');
    if(el.dataset.id===_touchDragId) return;
    const r=el.getBoundingClientRect();
    if(t.clientY>=r.top&&t.clientY<=r.bottom){
      _touchTargetId=el.dataset.id;
      _touchBefore=t.clientY<r.top+r.height/2;
      el.classList.add(_touchBefore?'drag-over-above':'drag-over-below');
    }
  });
}

function _swingTouchEnd(){
  // Toujours annuler le long press si encore en attente
  if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer=null; }
  document.querySelectorAll('#activeList .swing-item')
    .forEach(el=>el.classList.remove('press-holding'));
  if(!_touchDragId) return;
  if(_touchGhost){ _touchGhost.remove(); _touchGhost=null; }
  document.querySelectorAll('#activeList .swing-item')
    .forEach(el=>el.classList.remove('dragging','drag-over-above','drag-over-below'));
  const movedId = _touchDragId;
  if(_touchTargetId){
    _swingReorder(movedId,_touchTargetId,_touchBefore);
    renderSelList();
    _animateSwingDrop(movedId);
  }
  _touchDragId=null; _touchTargetId=null;
}

/* FIN MODIF DRAG AND DROP */

/* FIN MODIF SWING */
function rmCrit(id){
  S.criteria=S.criteria.filter(x=>x.id!==id);
  // MODIF SWING — renormalise les rangs après suppression
  _swingRenorm();
  // FIN MODIF SWING
  const pill=document.getElementById('pill-'+id);
  if(pill){pill.classList.remove('on');pill.querySelector('.crit-check').textContent='';}
  renderSelList();
}

function validateStep2(){
  if(S.criteria.length<2){alert(tr('err_crit'));return;}
  S.criteria.forEach(c=>{
    if(!S.scores[c.id]||S.scores[c.id].length!==S.options.length)
      S.scores[c.id]=S.options.map(()=>5);
  });
  renderStepProgress(3);
  buildEvalPage();
  nav('page-step3');
}

/* ─── STEP 3 ────────────────────────────── */

/* Échelle d'emojis pour le score effectif 1→10 (prend en compte l'inversion) */
const SCORE_EMOJIS = ['😭','😞','😟','😕','😐','🙂','😊','😄','😁','🤩'];
function scoreEmoji(val, invert){
  const eff = invert ? (11 - val) : val;
  return SCORE_EMOJIS[Math.min(10, Math.max(1, eff)) - 1];
}

function buildEvalPage(){
  document.getElementById('eval-title').textContent=
    tr('eval_title', S.decision.substring(0,50)+(S.decision.length>50?'…':''));
  const nOpts=S.options.length;
  const grid=document.getElementById('evalGrid');
  grid.style.gridTemplateColumns=`repeat(${Math.min(nOpts,2)},1fr)`;
  grid.style.width='100%';
  grid.innerHTML='';

  S.options.forEach((opt,oi)=>{
    const col=document.createElement('div');
    col.className='eval-col';

    const items=S.criteria.map(cr=>{
      const v=S.scores[cr.id]?.[oi]??5;
      const inv=cr.invert?`<span class="inv-tag" title="Score élevé = mauvais pour ce critère">↓</span>`:'';
      // MODIF SWING — badge poids adapté au mode
      let wt='';
      if(S.weightingMethod==='swing'){
        const weights=getSwingWeights();
        const pct=Math.round((weights.find(w=>w.id===cr.id)?.weight??0)*100);
        wt=`<span class="swing-wtag">⚖️ ${pct}%</span>`;
      } else if(cr.weight>1){
        wt=`<span class="sl-wtag">×${cr.weight}</span>`;
      }
      // FIN MODIF SWING
      const pips=Array.from({length:10},(_,pi)=>
        `<div class="pip" id="pip-${oi}-${cr.id}-${pi+1}" onclick="setVal(${oi},'${cr.id}',${pi+1})" title="${pi+1}/10"></div>`).join('');
      return `
        <div class="sl-item">
          <div class="sl-head">
            <div class="sl-label">${cr.icon} ${cr.name} ${inv}</div>${wt}
          </div>
          <div class="stepper">
            <button class="stepper-btn" onclick="stepVal(${oi},'${cr.id}',-1)" aria-label="Diminuer">−</button>
            <div class="stepper-track">
              <div class="pip-row">${pips}</div>
              <div class="stepper-val" id="sv-${oi}-${cr.id}">${v}</div>
              <div class="stepper-emoji" id="se-${oi}-${cr.id}">${scoreEmoji(v,cr.invert??false)}</div>
            </div>
            <button class="stepper-btn" onclick="stepVal(${oi},'${cr.id}',+1)" aria-label="Augmenter">+</button>
          </div>
        </div>`;
    }).join('');

    col.innerHTML=`
      <div class="eval-col-head" style="background:${COLORS[0].bg};border-color:${COLORS[0].border}">
        <div class="eval-col-name" style="color:${COLORS[0].hex}">Option ${LETTERS[oi]} — ${esc(opt.name)}</div>
        <div class="eval-live-score">
          <div class="eval-live-num" id="live-${oi}" style="color:${COLORS[0].hex}">—</div>
          <div class="eval-live-label">/ 100</div>
        </div>
      </div>
      <div class="eval-col-body" style="border-color:${COLORS[0].border}">${items}</div>`;

    grid.appendChild(col);
    S.criteria.forEach(cr=>renderStepper(oi,cr.id,S.scores[cr.id]?.[oi]??5,cr.invert??false));
    refreshLive(oi);
  });

  const notesRow=document.getElementById('notesRow');
  notesRow.style.gridTemplateColumns=`repeat(${Math.min(nOpts,3)},1fr)`;
  notesRow.innerHTML=S.options.map((opt,oi)=>`
    <div>
      <span class="notes-lbl" style="color:${COLORS[0].hex}">
        ${tr('notes_lbl', LETTERS[oi], esc(opt.name))}
      </span>
      <textarea id="note-${oi}" rows="3"
        placeholder="${tr('notes_ph')}"
        oninput="S.notes[${oi}]=this.value">${esc(S.notes[oi]||'')}</textarea>
    </div>`).join('');
}

/* ─── STEPPER COLOR ─────────────────────── */
function stepColor(raw, invert){
  const eff=invert?(11-raw):raw;
  const t=(eff-1)/9;
  if(t<0.5){
    const f=t/0.5;
    return `rgb(${Math.round(192+( 90-192)*f)},${Math.round(57+(87-57)*f)},${Math.round(43+(80-43)*f)})`;
  } else {
    const f=(t-0.5)/0.5;
    return `rgb(${Math.round(90+(45-90)*f)},${Math.round(87+(138-87)*f)},${Math.round(80+(78-80)*f)})`;
  }
}

function renderStepper(oi,cid,val,invert){
  const color=stepColor(val,invert);
  const vd=document.getElementById(`sv-${oi}-${cid}`);
  if(vd){vd.textContent=val;vd.style.color=color;}
  const ed=document.getElementById(`se-${oi}-${cid}`);
  if(ed) ed.textContent=scoreEmoji(val,invert);
  for(let pi=1;pi<=10;pi++){
    const pip=document.getElementById(`pip-${oi}-${cid}-${pi}`);
    if(!pip) continue;
    if(pi<=val){
      // Height grows with value for a bar-chart feel
      pip.style.height=(8+pi*1.2)+'px';
      pip.style.background=color;
      pip.style.borderColor=color;
    } else {
      pip.style.height='8px';
      pip.style.background='';
      pip.style.borderColor='';
    }
  }
}

function stepVal(oi,cid,delta){
  if(!S.scores[cid]) S.scores[cid]=S.options.map(()=>5);
  const next=Math.min(10,Math.max(1,(S.scores[cid][oi]??5)+delta));
  S.scores[cid][oi]=next;
  const cr=S.criteria.find(c=>c.id===cid);
  renderStepper(oi,cid,next,cr?.invert??false);
  refreshLive(oi);
}

function setVal(oi,cid,val){
  if(!S.scores[cid]) S.scores[cid]=S.options.map(()=>5);
  S.scores[cid][oi]=val;
  const cr=S.criteria.find(c=>c.id===cid);
  renderStepper(oi,cid,val,cr?.invert??false);
  refreshLive(oi);
}

function calcScore(oi){
  // MODIF SWING — branche Swing Weighting
  if(S.weightingMethod==='swing'){
    const weights=getSwingWeights();
    let tot=0;
    S.criteria.forEach(c=>{
      let v=S.scores[c.id]?.[oi]??5;
      if(c.invert) v=11-v;
      const w=weights.find(x=>x.id===c.id)?.weight??0;
      tot+=v*w;
    });
    return Math.round((tot/10)*100);
  }
  // FIN MODIF SWING
  let tot=0,max=0;
  S.criteria.forEach(c=>{
    let v=S.scores[c.id]?.[oi]??5;
    if(c.invert) v=11-v;
    tot+=v*c.weight; max+=10*c.weight;
  });
  return Math.round((tot/max)*100);
}

function refreshLive(oi){
  const el=document.getElementById(`live-${oi}`);
  if(el) el.textContent=calcScore(oi);
}

/* ─── RESULTS ───────────────────────────── */
function showResults(){
  S.notes=S.options.map((_,i)=>document.getElementById(`note-${i}`)?.value||'');
  buildResults();
  renderStepProgress(4);
  nav('page-results');
  initScenario();
  setTimeout(drawRadar,150);
  generateInterpretation();
}

function buildResults(){
  const scores=S.options.map((_,i)=>calcScore(i));
  const ranked=[...S.options.map((_,i)=>i)].sort((a,b)=>scores[b]-scores[a]);
  const winner=ranked[0], runner=ranked[1];
  const diff=scores[winner]-scores[runner];
  const tie=diff<=4;
  // Couleurs basées sur le rang : gagnant = vert, 2ème = orange, etc.
  resultColors = {};
  ranked.forEach((oi, rank) => { resultColors[oi] = COLORS[rank]; });
  const cW=resultColors[winner];

  // Verdict
  let vstyle,vemoji,vtitle,vsub;
  if(tie){
    vstyle=`background:#fffbea;border-color:#f0d080`;
    vemoji='⚖️';
    vtitle=`<span style="color:var(--amber)">${tr('res_tie_title')}</span>`;
    vsub=tr('res_tie_sub',diff);
  } else {
    vstyle=`background:${cW.bg};border-color:${cW.border}`;
    vemoji='🎯';
    vtitle=`<span style="color:#92700a">"${esc(S.options[winner].name)}" ${LANG==='fr'?'ressort en tête':'comes out on top'}</span>`;
    vsub=tr('res_win_sub',diff);
  }

  // Score cards rectangulaires — une par option, classées
  const ncols = Math.min(S.options.length, 4);
  const scoreCards = ranked.map((oi, rank) => {
    const c = resultColors[oi]; const sc = scores[oi];
    const rankLabels = tr('rank_labels');
    const rankLbl = rank < 3 ? rankLabels[rank] : `#${rank+1}`;
    const r = 22, circ = (2*Math.PI*r).toFixed(2);
    const off = (circ - (sc/100)*circ).toFixed(2);
    // Mini critères — top 4 par score effectif
    const sortedCrits = [...S.criteria].sort((a,b)=>{
      const va = S.scores[a.id]?.[oi]??5; const vb = S.scores[b.id]?.[oi]??5;
      const ea = a.invert?11-va:va; const eb = b.invert?11-vb:vb;
      return (eb*b.weight)-(ea*a.weight);
    }).slice(0,4);
    const miniCrits = sortedCrits.map(cr=>{
      const v = S.scores[cr.id]?.[oi]??5;
      const eff = cr.invert ? 11-v : v;
      return `<div class="sc-mini-crit">
        <span class="sc-mini-crit-name">${cr.icon} ${cr.name}</span>
        <div class="sc-mini-bar"><div class="sc-mini-bar-fill" style="width:${eff*10}%;background:${c.hex}"></div></div>
        <span class="sc-mini-crit-val" style="color:${c.hex}">${v}</span>
      </div>`;
    }).join('');
    return `
      <div class="sc-card${rank===0?' sc-card-winner':''}" style="border-color:${rank===0?c.hex:c.border}">
        <div class="sc-card-accent" style="background:${c.hex}"></div>
        <div class="sc-card-body">
          <div class="sc-card-left">
            <div class="sc-card-top">
              <div class="sc-card-rank" style="background:${c.bg};color:${c.hex};border-color:${c.border}">${rankLbl}</div>
              <div class="sc-card-name">${esc(S.options[oi].name)}</div>
            </div>
            <div class="sc-card-crits">${miniCrits}</div>
          </div>
          <div class="sc-card-gauge">
            <svg viewBox="0 0 52 52" width="52" height="52" style="transform:rotate(-90deg)">
              <circle fill="none" stroke="var(--bg2)" stroke-width="5" cx="26" cy="26" r="${r}"/>
              <circle fill="none" stroke="${c.hex}" stroke-width="5" stroke-linecap="round"
                cx="26" cy="26" r="${r}"
                stroke-dasharray="${circ}" stroke-dashoffset="${off}"
                style="transition:stroke-dashoffset .9s cubic-bezier(.4,0,.2,1)"/>
            </svg>
            <div class="sc-card-gauge-label">
              <div class="sc-card-num" style="color:${c.hex}">${sc}</div>
              <div class="sc-card-den">/100</div>
            </div>
          </div>
        </div>
      </div>`;
  }).join('');

  // Breakdown table
  const bkHeader=`<div class="bk-row hdr">
    <div class="bk-cell crit-col hdr-cell">${tr('bk_crit')}</div>
    ${S.options.map((o,i)=>`<div class="bk-cell opt-col hdr-cell" style="color:${resultColors[i].hex}">${LETTERS[i]}. ${esc(o.name.substring(0,10))}${o.name.length>10?'…':''}</div>`).join('')}
  </div>`;
  const bkRows=S.criteria.map(cr=>{
    const vals=S.options.map((_,i)=>S.scores[cr.id]?.[i]??5);
    const maxV=Math.max(...vals);
    return `<div class="bk-row">
      <div class="bk-cell crit-col">
        ${cr.icon} ${cr.name}
        ${(()=>{
          // MODIF SWING — badge poids dans breakdown
          if(S.weightingMethod==='swing'){
            const weights=getSwingWeights();
            const pct=Math.round((weights.find(w=>w.id===cr.id)?.weight??0)*100);
            return `<span style="font-size:.62rem;background:var(--teal-bg);color:var(--teal);padding:2px 5px;border-radius:3px;border:1px solid var(--teal-bd);font-weight:700">⚖️ ${pct}%</span>`;
          }
          return cr.weight>1?`<span style="font-size:.62rem;background:var(--amber-bg);color:var(--amber);padding:2px 5px;border-radius:3px;border:1px solid #f0d080;font-weight:700">×${cr.weight}</span>`:'';
          // FIN MODIF SWING
        })()}
        ${cr.invert?`<span class="inv-tag">↓</span>`:''}
      </div>
      ${vals.map((v,i)=>{const c=resultColors[i];return `<div class="bk-cell opt-col"><div class="opt-cell-in">
        <div class="opt-pill" style="background:${c.bg};color:${c.hex};font-weight:${v===maxV?700:400}">${v}</div>
        <div class="mini-bar"><div class="mini-bar-fill" style="width:${v*10}%;background:${c.hex}"></div></div>
      </div></div>`;}).join('')}
    </div>`;
  }).join('');

  // Notes
  const hasNotes=S.notes.some(n=>n.trim());
  const notesHTML=hasNotes?`
    <div class="notes-res" style="margin-top:14px">
      <div class="notes-res-head">${tr('notes_head')}</div>
      <div class="notes-res-body" style="grid-template-columns:repeat(${Math.min(S.options.length,3)},1fr)">
        ${S.options.map((o,i)=>`
          <div class="note-col" style="${i<S.options.length-1?'border-right:1px solid var(--border)':''}">
            <div class="note-col-lbl" style="color:${resultColors[i].hex}">${LETTERS[i]}. ${esc(o.name)}</div>
            <div class="note-col-txt">${esc(S.notes[i])||`<em style="color:var(--muted2)">${tr('no_notes')}</em>`}</div>
          </div>`).join('')}
      </div>
    </div>`:'';

  document.getElementById('resContent').innerHTML=`

    <!-- ① EN-TÊTE -->
    <div class="main">
      <div class="page-eyebrow anim">${tr('res_eyebrow')}</div>
      <div class="page-title anim d1">${esc(S.decision)}</div>
      <div class="verdict-inline anim d2" style="background:#fffbea;border:1.5px solid #f0d080">
        <span class="verdict-inline-emoji">${vemoji}</span>
        <div class="verdict-inline-text">
          <div class="verdict-inline-title">${vtitle}</div>
          <div class="verdict-inline-sub" id="interpSub">${vsub}</div>
        </div>
      </div>

      <!-- ② SCORES -->
      <div class="sc-cards-row anim d3" id="scoresRow" style="grid-template-columns:repeat(${ncols},1fr)">${scoreCards}</div>

      <!-- ③ SCÉNARIOS — juste sous les scores -->
      <div class="scenario-panel" id="scenarioBox" style="margin-top:14px">
        <div class="scenario-panel-head" onclick="toggleScenarioBox()">
          <span class="scenario-panel-icon">🎛️</span>
          <div class="scenario-panel-text">
            <div class="scenario-panel-title">${tr('scenario_title')}</div>
            <div class="scenario-panel-sub">${tr('scenario_sub')}</div>
          </div>
          <div class="scenario-panel-chevron">▾</div>
        </div>
        <div class="scenario-panel-body">
          <div class="sc-tabs">
            <button class="sc-tab active" onclick="switchScTab('crits',this)">${LANG==='fr'?'🎚️ Critères':'🎚️ Criteria'}</button>
            <button class="sc-tab" onclick="switchScTab('emotions',this)">${LANG==='fr'?'🫀 Émotions':'🫀 Emotions'}</button>
          </div>
          <div class="sc-tab-content">
            <div class="sc-tab-pane active" id="scPaneCrits"></div>
            <div class="sc-tab-pane" id="scPaneEmotions"></div>
          </div>
        </div>
      </div>

      <!-- ④ Profil visuel -->
      <div class="res-divider" style="margin-top:22px"><span class="res-divider-label">${tr('div_visual')}</span></div>
      <div class="res-section">
        <div class="res-section-body" style="padding:16px 20px 20px">
          <div class="res-radar-wrap">
            <canvas id="radarC" width="480" height="380" style="max-width:100%"></canvas>
          </div>
          <div class="res-radar-legend">
            ${S.options.map((o,i)=>`<span><span class="leg-dot" style="background:${resultColors[i].hex}"></span>${esc(o.name)}</span>`).join('')}
            <button class="radar-help-btn" onclick="var el=document.getElementById('radarHow');el.classList.toggle('open')" title="${LANG==='fr'?'Comment lire ce graphique ?':'How to read this chart?'}">?</button>
          </div>
          <div class="radar-how" id="radarHow">
            <div class="radar-how-title">${LANG==='fr'?'Comment lire ce graphique ?':'How to read this chart?'}</div>
            <div class="radar-how-items">
              <div class="radar-how-item">
                <div class="radar-how-icon">⬡</div>
                <div>${LANG==='fr'
                  ?'Chaque axe représente un critère. <strong>Plus la surface colorée est grande</strong>, meilleure est l\'option sur l\'ensemble des critères.'
                  :'Each axis is a criterion. <strong>The larger the colored area</strong>, the better the option across all criteria.'}</div>
              </div>
              <div class="radar-how-item">
                <div class="radar-how-icon">📍</div>
                <div>${LANG==='fr'
                  ?'Les <strong>points sur chaque axe</strong> indiquent la note de l\'option pour ce critère (de 0 au centre à 10 à l\'extrémité).'
                  :'The <strong>dots on each axis</strong> show the option\'s score for that criterion (0 at center, 10 at edge).'}</div>
              </div>
              <div class="radar-how-item">
                <div class="radar-how-icon">🔀</div>
                <div>${LANG==='fr'
                  ?'Une option peut avoir une <strong>grande surface mais être faible sur un axe</strong> — regardez les creux pour identifier ses faiblesses.'
                  :'An option may have a <strong>large area but dip on one axis</strong> — look for indentations to spot weaknesses.'}</div>
              </div>
              ${S.criteria.some(c=>c.weight>1)?`<div class="radar-how-item">
                <div class="radar-how-icon">⚖️</div>
                <div>${LANG==='fr'
                  ?'Les critères marqués <strong>×2, ×3…</strong> ont plus d\'importance dans le score final, mais tous les axes sont égaux sur ce graphique.'
                  :'Criteria marked <strong>×2, ×3…</strong> carry more weight in the final score, but all axes appear equal on this chart.'}</div>
              </div>`:''}
            </div>
          </div>
        </div>
      </div>

      <!-- ⑤ Tableau -->
      <div class="res-divider"><span class="res-divider-label">${tr('div_detail')}</span></div>
      <div class="bk-table">${bkHeader}${bkRows}</div>

      <!-- ⑥ Notes -->
      ${hasNotes?`<div class="res-divider"><span class="res-divider-label">${tr('div_notes')}</span></div>${notesHTML}`:''}

      <!-- ⑦ Actions -->
      <div class="res-actions">
        <button class="btn btn-secondary" onclick="nav('page-step3')">${tr('back_notes')}</button>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-secondary" onclick="window.print()">${tr('export_pdf')}</button>
          <button class="btn btn-primary" onclick="restart()">${tr('new_decision')}</button>
        </div>
      </div>
    </div>`;
}

/* ─── AI INTERPRETATION ─────────────────── */
async function generateInterpretation(){
  const scores = S.options.map((_,i) => calcScore(i));
  const ranked = [...S.options.map((_,i)=>i)].sort((a,b)=>scores[b]-scores[a]);

  const optionsSummary = S.options.map((o,i) => {
    const critDetails = S.criteria.map(c => {
      const raw = S.scores[c.id]?.[i] ?? 5;
      const eff = c.invert ? 11 - raw : raw;
      return `  - ${c.name} (poids ×${c.weight}${c.invert?' [inversé]':''}): ${raw}/10 → effectif ${eff}/10`;
    }).join('\n');
    return `Option ${LETTERS[i]} — "${o.name}"${o.desc?' ('+o.desc+')':''}
  Score final: ${scores[i]}/100
${critDetails}${S.notes[i]?'\n  Note personnelle: "'+S.notes[i]+'"':''}`;
  }).join('\n\n');

  const rankedNames = ranked.map(i=>`"${S.options[i].name}" (${scores[i]} pts)`).join(' > ');
  const crucialCriteria = S.criteria.filter(c=>c.weight>=2).map(c=>`${c.name} (×${c.weight})`).join(', ') || 'Aucun';

  const promptLang = tr('ai_lang');
  const prompt = LANG === 'en'
  ? `You are a friendly and direct advisor helping people make important decisions.

The user must decide: "${S.decision}"

Results of their multi-criteria analysis:
Ranking: ${rankedNames}

${optionsSummary}

Most important criteria (×2 or ×3): ${crucialCriteria}

Your mission: Write a short interpretive message (3 to 5 sentences) in English, natural and human.
- Compare the options on the points where they diverge most
- Reveal what the numbers actually say about the user's priorities
- Make a nuanced recommendation taking into account the important criteria
- If it's close, say so and point to what matters most
- Write directly, no title, no bullets, no generic intro
- Style: "Option X is stronger on…", "If you value…", "What the numbers reveal here…"
- Use "you", be warm but factual. 3-5 sentences max.`
  : `Tu es un conseiller bienveillant et direct qui aide les gens à prendre des décisions importantes.

L'utilisateur doit décider : "${S.decision}"

Résultats de son analyse multi-critères :
Classement : ${rankedNames}

${optionsSummary}

Critères les plus importants (×2 ou ×3) : ${crucialCriteria}

Ta mission : Rédige un message interprétatif court (3 à 5 phrases) en français, naturel et humain.
- Compare les options sur les points où elles divergent le plus
- Révèle ce que les chiffres disent vraiment sur ses priorités
- Formule une recommandation nuancée tenant compte des critères importants
- Si serré, dis-le et oriente vers ce qui compte le plus
- Écris directement, sans titre, sans bullet, sans intro générique
- Style : "Option X est plus forte sur…", "Si tu accordes de l'importance à…", "Ce que les chiffres révèlent ici…"
- Tutoie, sois chaleureux mais factuel. 3-5 phrases max.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{role:'user', content: prompt}]
      })
    });
    const data = await res.json();
    const text = data?.content?.[0]?.text || null;
    const el = document.getElementById('interpSub');
    if (!el) return;
    if (text) {
      const formatted = text
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/\n\n+/g,' ')
        .replace(/\n/g,' ');
      el.innerHTML = formatted;
    } else { throw new Error(); }
  } catch(e) {
    // Fallback local si l'API échoue
    const scores2 = S.options.map((_,i)=>calcScore(i));
    const ranked2 = [...S.options.map((_,i)=>i)].sort((a,b)=>scores2[b]-scores2[a]);
    const w=ranked2[0], r=ranked2[1];
    const diff=scores2[w]-scores2[r];

    const topW = [...S.criteria].sort((a,b)=>{
      const va=(a.invert?11-(S.scores[a.id]?.[w]??5):(S.scores[a.id]?.[w]??5))*a.weight;
      const vb=(b.invert?11-(S.scores[b.id]?.[w]??5):(S.scores[b.id]?.[w]??5))*b.weight;
      return vb-va;
    })[0];
    const topR = [...S.criteria].sort((a,b)=>{
      const va=(a.invert?11-(S.scores[a.id]?.[r]??5):(S.scores[a.id]?.[r]??5))*a.weight;
      const vb=(b.invert?11-(S.scores[b.id]?.[r]??5):(S.scores[b.id]?.[r]??5))*b.weight;
      return vb-va;
    })[0];

    const msg = diff<=4
      ? (LANG==='en'
          ? `The two options are very close (${scores2[w]} vs ${scores2[r]} pts).`
            +(topW?` "${S.options[w].name}" stands out slightly on <strong>${topW.name}</strong>.`:'')
            +` In this tight call, trust your instincts.`
          : `Les deux options sont très proches (${scores2[w]} vs ${scores2[r]} pts).`
            +(topW?` "${S.options[w].name}" se démarque légèrement sur <strong>${topW.name}</strong>.`:'')
            +` Dans ce cas serré, fais confiance à ton instinct.`)
      : (LANG==='en'
          ? `"${S.options[w].name}" comes out on top with a ${diff}-point lead.`
            +(topW?` Its main strength: <strong>${topW.name}</strong>.`:'')
            +(topR?` "${S.options[r].name}" remains stronger on <strong>${topR.name}</strong> — worth considering if that's a priority.`:'')
          : `"${S.options[w].name}" ressort en tête avec ${diff} points d'avance.`
            +(topW?` Son principal atout : <strong>${topW.name}</strong>.`:'')
            +(topR?` "${S.options[r].name}" reste plus fort sur <strong>${topR.name}</strong> — à peser si c'est une priorité.`:''));

    const el2=document.getElementById('interpSub');
    if(el2) el2.innerHTML = msg;
  }
}

/* ─── SCENARIO PANEL UNIFIÉ ──────────────── */

// Critères actifs dans le scénario
let S_active = new Set();
// Émotion active (null = aucune)
let S_emotion = null;
// Couleurs basées sur le rang (gagnant=vert, 2ème=orange…) — calculé dans buildResults()
let resultColors = {};

// Définition des émotions avec mots-clés
const EMOTIONS = {
  fear:    { ids: new Set(['fin_risk','risk','stress','jobsec','fin_stab','cost','rev','complex','dep','workload']),
             words: /risque|peur|stress|sécurité|securite|danger|incertitude|coût|cout|complexité|complexite|difficulté|difficulte|charge|instabilité|instabilite|anxiété|anxiete/i,
             label: { fr:'😨 Peur', en:'😨 Fear' } },
  urgency: { ids: new Set(['deadline','time','workload','stress']),
             words: /urgence|délai|delai|pression|temps|rapidité|rapidite|vitesse|stress/i,
             label: { fr:'⏱️ Urgence', en:'⏱️ Urgency' } },
  ego:     { ids: new Set(['prestige','status','recog','social','rep']),
             words: /prestige|statut|réputation|reputation|reconnaissance|fierté|fierte|image|ego|status/i,
             label: { fr:'🎭 Ego', en:'🎭 Ego' } },
};

function getEmotionCrits(emotion){
  const def = EMOTIONS[emotion];
  if(!def) return new Set();
  return new Set(S.criteria.filter(c=>{
    if(def.ids.has(c.id)) return true;
    if(c.custom) return def.words.test(c.name);
    return false;
  }).map(c=>c.id));
}

function initScenario(){
  S_active = new Set(S.criteria.map(c=>c.id));
  S_emotion = null;
  renderScenarioBody();
  renderEmotionPane();
}

function toggleScenarioBox(){
  const sb = document.getElementById('scenarioBox');
  if(!sb) return;
  sb.classList.toggle('open');
  const body = sb.querySelector('.scenario-panel-body');
  if(body) body.style.display = sb.classList.contains('open') ? 'block' : 'none';
}

function switchScTab(tab, el){
  document.querySelectorAll('.sc-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.sc-tab-pane').forEach(p=>p.classList.remove('active'));
  const pane = document.getElementById(tab==='crits'?'scPaneCrits':'scPaneEmotions');
  if(pane) pane.classList.add('active');
}

function calcScoreScenario(oi){
  // MODIF SWING
  if(S.weightingMethod==='swing'){
    const weights=getSwingWeights();
    const activeWeights=weights.filter(w=>S_active.has(w.id));
    if(!activeWeights.length) return 0;
    const totalW=activeWeights.reduce((sum,w)=>sum+w.weight,0);
    let tot=0;
    activeWeights.forEach(w=>{
      const c=S.criteria.find(x=>x.id===w.id);
      if(!c) return;
      let v=S.scores[c.id]?.[oi]??5;
      if(c.invert) v=11-v;
      const normW=totalW>0?w.weight/totalW:0;
      tot+=v*normW;
    });
    return Math.round((tot/10)*100);
  }
  // FIN MODIF SWING
  let tot=0, max=0;
  S.criteria.forEach(c=>{
    if(!S_active.has(c.id)) return;
    let v=S.scores[c.id]?.[oi]??5;
    if(c.invert) v=11-v;
    tot+=v*c.weight; max+=10*c.weight;
  });
  if(max===0) return 0;
  return Math.round((tot/max)*100);
}

function calcScoreFiltered(oi, excludeIds){
  // MODIF SWING
  if(S.weightingMethod==='swing'){
    const weights=getSwingWeights();
    const activeWeights=weights.filter(w=>!excludeIds.has(w.id));
    if(!activeWeights.length) return null;
    const totalW=activeWeights.reduce((sum,w)=>sum+w.weight,0);
    let tot=0;
    activeWeights.forEach(w=>{
      const c=S.criteria.find(x=>x.id===w.id);
      if(!c) return;
      let v=S.scores[c.id]?.[oi]??5;
      if(c.invert) v=11-v;
      const normW=totalW>0?w.weight/totalW:0;
      tot+=v*normW;
    });
    return Math.round((tot/10)*100);
  }
  // FIN MODIF SWING
  let tot=0, max=0;
  S.criteria.forEach(c=>{
    if(excludeIds.has(c.id)) return;
    let v=S.scores[c.id]?.[oi]??5;
    if(c.invert) v=11-v;
    tot+=v*c.weight; max+=10*c.weight;
  });
  if(max===0) return null;
  return Math.round((tot/max)*100);
}

function toggleScenarioCrit(id){
  if(S_active.has(id)) S_active.delete(id);
  else S_active.add(id);
  if(S_active.size===0) S_active.add(id);
  renderScenarioBody();
}

function resetScenario(){
  S_active = new Set(S.criteria.map(c=>c.id));
  renderScenarioBody();
}

function renderScenarioBody(){
  const body = document.getElementById('scPaneCrits');
  if(!body) return;
  const activeCount = S_active.size;
  const rows = S.criteria.map(c=>{
    const on = S_active.has(c.id);
    return `
      <div class="sc-crit-row${on?'':' off'}">
        <div class="sc-crit-icon">${c.icon}</div>
        <div class="sc-crit-name">${c.name}</div>
        ${(()=>{
          // MODIF SWING — badge poids dans panneau scénario
          if(S.weightingMethod==='swing'){
            const weights=getSwingWeights();
            const pct=Math.round((weights.find(w=>w.id===c.id)?.weight??0)*100);
            return `<span class="sc-crit-weight" style="background:var(--teal-bg);color:var(--teal);border-color:var(--teal-bd)">⚖️ ${pct}%</span>`;
          }
          return c.weight>1?`<span class="sc-crit-weight">×${c.weight}</span>`:'';
          // FIN MODIF SWING
        })()}
        ${c.invert?`<span class="sc-crit-inv">${tr('sc_inv')}</span>`:''}
        <label class="mini-toggle" title="${on?tr('sc_toggle_on'):tr('sc_toggle_off')}">
          <input type="checkbox" ${on?'checked':''} onchange="toggleScenarioCrit('${c.id}')">
          <div class="mini-toggle-track"></div>
          <div class="mini-toggle-thumb"></div>
        </label>
      </div>`;
  }).join('');

  // Bloc comparaison de scores — identique au comportement émotions
  const allActive = S_active.size === S.criteria.length;
  const baseScores = S.options.map((_,i)=>calcScore(i));
  const scenScores = S.options.map((_,i)=>calcScoreScenario(i));
  const ranked     = [...S.options.map((_,i)=>i)].sort((a,b)=>baseScores[b]-baseScores[a]);
  const scenRanked = [...S.options.map((_,i)=>i)].sort((a,b)=>scenScores[b]-scenScores[a]);
  const switchedWinner = scenRanked[0] !== ranked[0];

  let comparisonBlock = '';
  if(allActive){
    comparisonBlock = `<div class="emotion-none">${LANG==='fr'
      ? 'Aucun critère désélectionné — tous les critères sont inclus.'
      : 'No criteria deselected — all criteria are included.'}</div>`;
  } else {
    const scoreRows = ranked.map(oi=>{
      const c  = resultColors[oi] || COLORS[oi];
      const bs = baseScores[oi];
      const ss = scenScores[oi];
      const d  = ss - bs;
      const cls= d>2?'up':d<-2?'down':'same';
      const sign=d>0?'+':'';
      return `<div class="fear-opt-row">
        <div class="fear-opt-name" style="color:${c.hex}">${LETTERS[oi]}. ${esc(S.options[oi].name)}</div>
        <div class="fear-scores">
          <div class="fear-score-block">
            <div class="fear-score-val" style="color:${c.hex}">${bs}</div>
            <div class="fear-score-lbl">${tr('fear_score_real')}</div>
          </div>
          <div class="fear-arrow">→</div>
          <div class="fear-score-block">
            <div class="fear-score-val" style="color:var(--teal)">${ss}</div>
            <div class="fear-score-lbl">${LANG==='fr'?'Scénario':'Scenario'}</div>
          </div>
          <span class="fear-delta ${cls}">${sign}${d}</span>
        </div>
      </div>`;
    }).join('');

    let insight='';
    if(switchedWinner){
      const nN=esc(S.options[scenRanked[0]].name), oN=esc(S.options[ranked[0]].name);
      insight=`<div class="emotion-insight">💡 ${LANG==='fr'
        ?`Sans ces critères, <strong>"${nN}"</strong> passerait en tête au lieu de <strong>"${oN}"</strong>.`
        :`Without these criteria, <strong>"${nN}"</strong> would take the lead over <strong>"${oN}"</strong>.`}</div>`;
    } else {
      const maxD = ranked.reduce((b,oi)=>{const d=scenScores[oi]-baseScores[oi];return Math.abs(d)>Math.abs(b.d)?{oi,d}:b},{oi:ranked[0],d:0});
      if(Math.abs(maxD.d)>4){
        insight=`<div class="emotion-insight">💡 ${LANG==='fr'
          ?`Le classement reste identique, mais <strong>"${esc(S.options[maxD.oi].name)}"</strong> ${maxD.d>0?'gagne':'perd'} <strong>${Math.abs(maxD.d)} pts</strong> dans ce scénario.`
          :`The ranking stays the same, but <strong>"${esc(S.options[maxD.oi].name)}"</strong> ${maxD.d>0?'gains':'loses'} <strong>${Math.abs(maxD.d)} pts</strong> in this scenario.`}</div>`;
      } else {
        insight=`<div class="emotion-insight">💡 ${LANG==='fr'
          ?'Le classement reste identique — ces critères ont peu d\'impact sur votre décision.'
          :'The ranking stays the same — these criteria have little impact on your decision.'}</div>`;
      }
    }
    comparisonBlock = `<div class="fear-comparison">${scoreRows}</div>${insight}`;
  }

  body.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <span style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em">
        ${tr('scenario_active',activeCount,S.criteria.length)}
      </span>
      <button class="scenario-reset" onclick="resetScenario()">${tr('scenario_reset')}</button>
    </div>
    <div class="sc-crit-list">${rows}</div>
    <div style="margin-top:14px;padding-top:10px;border-top:1px solid var(--border)">${comparisonBlock}</div>`;
}

function renderEmotionPane(){
  const pane = document.getElementById('scPaneEmotions');
  if(!pane) return;

  // Chips émotions
  const chips = Object.entries(EMOTIONS).map(([key,def])=>{
    const crits = [...getEmotionCrits(key)];
    const count = crits.length;
    const label = def.label[LANG]||def.label.fr;
    const active = S_emotion===key;
    return `<div class="emotion-chip${active?' active':''}" onclick="toggleEmotion('${key}')">
      ${label}
      <span class="emotion-chip-count">${count}</span>
    </div>`;
  }).join('');

  pane.innerHTML=`
    <p style="font-size:.75rem;color:var(--muted);margin-bottom:10px;line-height:1.5">
      ${LANG==='fr'
        ? 'Sélectionnez une émotion pour voir comment vos scores changent si ces critères étaient mis de côté.'
        : 'Select an emotion to see how scores change if those criteria were excluded.'}
    </p>
    <div class="emotion-filters">${chips}</div>
    <div id="emotionResult"></div>`;

  renderEmotionResult();
}

function toggleEmotion(key){
  S_emotion = S_emotion===key ? null : key;
  renderEmotionPane();
  updateScenarioScores();
}

function renderEmotionResult(){
  const el = document.getElementById('emotionResult');
  if(!el) return;

  if(!S_emotion){
    el.innerHTML=`<div class="emotion-none">${LANG==='fr'
      ? 'Aucune émotion sélectionnée — tous les critères sont inclus.'
      : 'No emotion selected — all criteria are included.'}</div>`;
    return;
  }

  const emotionIds = getEmotionCrits(S_emotion);
  if(emotionIds.size===0){
    el.innerHTML=`<div class="emotion-none">${LANG==='fr'
      ? 'Aucun critère lié à cette émotion n\'a été sélectionné dans votre analyse.'
      : 'No criteria linked to this emotion were selected in your analysis.'}</div>`;
    return;
  }

  const tags = S.criteria.map(c=>{
    const excluded = emotionIds.has(c.id);
    return `<span class="emotion-crit-tag ${excluded?'excluded':'included'}">${c.icon} ${c.name}${excluded?' ✕':''}</span>`;
  }).join('');

  const normalScores   = S.options.map((_,i)=>calcScore(i));
  const filteredScores = S.options.map((_,i)=>calcScoreFiltered(i,emotionIds));
  const ranked         = [...S.options.map((_,i)=>i)].sort((a,b)=>normalScores[b]-normalScores[a]);
  const filtRanked     = [...S.options.map((_,i)=>i)].sort((a,b)=>(filteredScores[b]??0)-(filteredScores[a]??0));
  const switchedWinner = filtRanked[0] !== ranked[0];

  const rows = ranked.map(oi=>{
    const c  = resultColors[oi] || COLORS[oi];
    const ns = normalScores[oi];
    const fs = filteredScores[oi];
    const d  = fs!==null ? fs-ns : 0;
    const cls= d>2?'up':d<-2?'down':'same';
    const sign=d>0?'+':'';
    return `<div class="fear-opt-row">
      <div class="fear-opt-name" style="color:${c.hex}">${LETTERS[oi]}. ${esc(S.options[oi].name)}</div>
      <div class="fear-scores">
        <div class="fear-score-block">
          <div class="fear-score-val" style="color:${c.hex}">${ns}</div>
          <div class="fear-score-lbl">${tr('fear_score_real')}</div>
        </div>
        ${fs!==null?`
        <div class="fear-arrow">→</div>
        <div class="fear-score-block">
          <div class="fear-score-val" style="color:#7c3aed">${fs}</div>
          <div class="fear-score-lbl">${LANG==='fr'?'Sans émotion':'Emotion-free'}</div>
        </div>
        <span class="fear-delta ${cls}">${sign}${d}</span>`:''}
      </div>
    </div>`;
  }).join('');

  // Insight narratif
  let insight='';
  if(switchedWinner){
    const nN=esc(S.options[filtRanked[0]].name), oN=esc(S.options[ranked[0]].name);
    insight=`<div class="emotion-insight">💡 ${LANG==='fr'
      ?`Sans ces critères, <strong>"${nN}"</strong> passerait en tête — c'est probablement cette émotion qui oriente votre décision vers <strong>"${oN}"</strong>.`
      :`Without these criteria, <strong>"${nN}"</strong> would take the lead — this emotion may be steering your decision toward <strong>"${oN}"</strong>.`}</div>`;
  } else {
    const maxD = ranked.reduce((b,oi)=>{const d=(filteredScores[oi]??0)-normalScores[oi];return Math.abs(d)>Math.abs(b.d)?{oi,d}:b},{oi:ranked[0],d:0});
    if(Math.abs(maxD.d)>4){
      insight=`<div class="emotion-insight">💡 ${LANG==='fr'
        ?`Le classement reste identique, mais <strong>"${esc(S.options[maxD.oi].name)}"</strong> ${maxD.d>0?'gagne':'perd'} <strong>${Math.abs(maxD.d)} pts</strong> sans ces critères.`
        :`The ranking stays the same, but <strong>"${esc(S.options[maxD.oi].name)}"</strong> ${maxD.d>0?'gains':'loses'} <strong>${Math.abs(maxD.d)} pts</strong> without these criteria.`}</div>`;
    } else {
      insight=`<div class="emotion-insight">💡 ${LANG==='fr'
        ?'Le classement reste identique — votre décision n\'est pas fortement influencée par cette émotion.'
        :'The ranking stays the same — your decision is not strongly influenced by this emotion.'}</div>`;
    }
  }

  el.innerHTML=`
    <div class="emotion-crit-tags">${tags}</div>
    <div class="fear-comparison">${rows}</div>
    ${insight}`;
}



function genScenarioInsight(){
  const disabledCrits = S.criteria.filter(c=>!S_active.has(c.id));

  if(disabledCrits.length === 0){
    return tr('sc_all_active');
  }

  const baseScores  = S.options.map((_,i)=>calcScore(i));
  const scenScores  = S.options.map((_,i)=>calcScoreScenario(i));
  const baseRanked  = [...S.options.map((_,i)=>i)].sort((a,b)=>baseScores[b]-baseScores[a]);
  const scenRanked  = [...S.options.map((_,i)=>i)].sort((a,b)=>scenScores[b]-scenScores[a]);

  const baseWinner  = baseRanked[0];
  const scenWinner  = scenRanked[0];
  const switched    = scenWinner !== baseWinner;

  const disabledNames = disabledCrits.map(c=>`<strong>${c.name}</strong>`).join(LANG==='en'?' and ':' et ');
  const plural        = disabledCrits.length > 1;
  const s             = plural ? 's' : '';

  const deltas = S.options.map((_,i)=>({ i, d: scenScores[i]-baseScores[i] }));
  const bigGainer  = deltas.reduce((a,b)=>b.d>a.d?b:a);
  const bigLoser   = deltas.reduce((a,b)=>b.d<a.d?b:a);

  // Cas 1 — classement inversé
  if(switched){
    const newName  = esc(S.options[scenWinner].name);
    const oldName  = esc(S.options[baseWinner].name);
    const gain     = scenScores[scenWinner] - baseScores[scenWinner];
    const gainSign = gain>=0?`+${gain}`:gain;
    const p1 = LANG==='en' ? (plural?'played':'played') : (plural?'jouaient':'jouait');
    return tr('sc_switched', disabledNames, newName, gainSign, oldName, s, p1);
  }

  // Cas 2 — écart réduit
  const baseGap = baseScores[baseWinner] - baseScores[baseRanked[1]];
  const scenGap = scenScores[scenWinner] - scenScores[scenRanked[1]];
  if(scenGap < baseGap && baseGap - scenGap >= 6){
    const gapDiff = baseGap - scenGap;
    const p2 = LANG==='en' ? (plural?'constitute':'constitutes') : (plural?'constituent':'constitue');
    return tr('sc_reduced', esc(S.options[baseWinner].name), gapDiff, disabledNames, s, p2);
  }

  // Cas 3 — écart qui se creuse
  if(scenGap > baseGap + 5){
    const p3 = LANG==='en'
      ? `${plural?'are':'is'} not what drives this option's strength`
      : `ne ${plural?'sont':'est'} pas ce qui fait la force de cette option`;
    return tr('sc_wider', esc(S.options[baseWinner].name), scenGap - baseGap, disabledNames, s, p3);
  }

  // Cas 4 — divergence forte
  if(bigGainer.d >= 8 && bigGainer.i !== bigLoser.i && bigLoser.d <= -8){
    const gN = esc(S.options[bigGainer.i].name);
    const lN = esc(S.options[bigLoser.i].name);
    const p4 = LANG==='en' ? (plural?'weigh':'weighs') : (plural?'pèsent':'pèse');
    return tr('sc_diverge', gN, bigGainer.d, lN, Math.abs(bigLoser.d), disabledNames, p4);
  }

  // Cas 5 — impact faible
  const maxDelta = Math.max(...deltas.map(d=>Math.abs(d.d)));
  if(maxDelta <= 4){
    const p5 = LANG==='en'
      ? `${plural?'are not':'is not'} decisive`
      : `n\u2019est pas déterminant${s}`;
    return tr('sc_nochange', disabledNames, maxDelta+1, s, p5);
  }

  // Cas 6 — fallback
  const mostImpacted = deltas.reduce((a,b)=>Math.abs(b.d)>Math.abs(a.d)?b:a);
  const sign = mostImpacted.d >= 0 ? `+${mostImpacted.d}` : `${mostImpacted.d}`;
  const p6 = LANG==='en'
    ? (plural?'influence':'influences')
    : (plural?'influencent':'influence');
  return tr('sc_fallback', disabledNames, esc(S.options[mostImpacted.i].name), sign, s, p6);
}


function updateScenarioScores(){
  const baseScores = S.options.map((_,i)=>calcScore(i));
  const scenScores = S.options.map((_,i)=>calcScoreScenario(i));
  const scenRanked = [...S.options.map((_,i)=>i)].sort((a,b)=>scenScores[b]-scenScores[a]);
  const allActive  = S_active.size === S.criteria.length && !S_emotion;

  const row = document.getElementById('scoresRow');
  if(!row) return;

  const rankLabels = tr('rank_labels');
  row.innerHTML = scenRanked.map((oi, rank) => {
    const c = resultColors[oi] || COLORS[oi];
    const sc = scenScores[oi];
    const base = baseScores[oi];
    const delta = sc - base;
    const rankLbl = rank < 3 ? rankLabels[rank] : `#${rank+1}`;
    const r = 22, circ = (2*Math.PI*r).toFixed(2);
    const off = (circ - (sc/100)*circ).toFixed(2);
    const deltaTag = allActive ? '' :
      `<div class="sc-card-delta ${delta>2?'up':delta<-2?'down':'same'}">${delta>0?'+':''}${delta} pts</div>`;
    const sortedCrits = [...S.criteria].filter(cr=>S_active.has(cr.id)).sort((a,b)=>{
      const va=S.scores[a.id]?.[oi]??5; const vb=S.scores[b.id]?.[oi]??5;
      const ea=a.invert?11-va:va; const eb=b.invert?11-vb:vb;
      return (eb*b.weight)-(ea*a.weight);
    }).slice(0,4);
    const miniCrits = sortedCrits.map(cr=>{
      const v=S.scores[cr.id]?.[oi]??5; const eff=cr.invert?11-v:v;
      return `<div class="sc-mini-crit">
        <span class="sc-mini-crit-name">${cr.icon} ${cr.name}</span>
        <div class="sc-mini-bar"><div class="sc-mini-bar-fill" style="width:${eff*10}%;background:${c.hex}"></div></div>
        <span class="sc-mini-crit-val" style="color:${c.hex}">${v}</span>
      </div>`;
    }).join('');
    return `
      <div class="sc-card${rank===0?' sc-card-winner':''}" style="border-color:${rank===0?c.hex:c.border}">
        <div class="sc-card-accent" style="background:${c.hex}"></div>
        <div class="sc-card-body">
          <div class="sc-card-left">
            <div class="sc-card-top">
              <div class="sc-card-rank" style="background:${c.bg};color:${c.hex};border-color:${c.border}">${rankLbl}</div>
              <div class="sc-card-name">${esc(S.options[oi].name)}</div>
              ${deltaTag}
            </div>
            <div class="sc-card-crits">${miniCrits}</div>
          </div>
          <div class="sc-card-gauge">
            <svg viewBox="0 0 52 52" width="52" height="52" style="transform:rotate(-90deg)">
              <circle fill="none" stroke="var(--bg2)" stroke-width="5" cx="26" cy="26" r="${r}"/>
              <circle fill="none" stroke="${c.hex}" stroke-width="5" stroke-linecap="round"
                cx="26" cy="26" r="${r}"
                stroke-dasharray="${circ}" stroke-dashoffset="${off}"
                style="transition:stroke-dashoffset .9s cubic-bezier(.4,0,.2,1)"/>
            </svg>
            <div class="sc-card-gauge-label">
              <div class="sc-card-num" style="color:${c.hex}">${sc}</div>
              <div class="sc-card-den">/100</div>
            </div>
          </div>
        </div>
      </div>`;
  }).join('');

  setTimeout(()=>drawRadarScenario(scenScores), 50);
}



function genAnalysis(scores,winner,ranked){
  const wName=S.options[winner].name;
  const pros=[],cons=[];
  const sortW=[...S.criteria].sort((a,b)=>{
    let va=S.scores[a.id]?.[winner]??5,vb=S.scores[b.id]?.[winner]??5;
    if(a.invert)va=11-va;if(b.invert)vb=11-vb;
    return(vb*b.weight)-(va*a.weight);
  });
  sortW.slice(0,2).forEach(c=>{
    const v=S.scores[c.id]?.[winner]??5;
    pros.push(tr('an_score_high',c.name,v,c.weight));
  });
  const diff=scores[ranked[0]]-scores[ranked[1]];
  if(diff>15) pros.push(tr('an_clear',diff));
  else if(diff<=4) pros.push(tr('an_tight'));
  if(ranked.length>1){
    const ru=ranked[1];
    const sortR=[...S.criteria].sort((a,b)=>{
      let va=S.scores[a.id]?.[ru]??5,vb=S.scores[b.id]?.[ru]??5;
      if(a.invert)va=11-va;if(b.invert)vb=11-vb;
      return(vb*b.weight)-(va*a.weight);
    });
    sortR.slice(0,2).forEach(c=>{
      const vW=S.scores[c.id]?.[winner]??5,vR=S.scores[c.id]?.[ru]??5;
      if(vR>vW) cons.push(tr('an_runner',esc(S.options[ru].name),c.name,vR,vW));
    });
  }
  S.criteria.filter(c=>c.weight===3).forEach(c=>{
    const v=S.scores[c.id]?.[winner]??5;
    if(v<5) cons.push(tr('an_weak',c.name,v,esc(wName)));
  });
  if(!cons.length) cons.push(tr('an_no_cons'));
  return{pros:pros.slice(0,3),cons:cons.slice(0,3)};
}


function drawRadar(){ drawRadarScenario(null); }

function drawRadarScenario(overrideScores){
  const canvas = document.getElementById('radarC'); if(!canvas) return;
  const activeCrits = overrideScores
    ? S.criteria.filter(c => S_active.has(c.id))
    : S.criteria;
  if(activeCrits.length < 3){ return; }

  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const cx = W / 2, cy = H / 2;
  const N = activeCrits.length;
  const R = Math.min(W, H) / 2 - 72;
  ctx.clearRect(0, 0, W, H);
  const angle = i => (i / N) * Math.PI * 2 - Math.PI / 2;

  // Grille de fond
  [2,4,6,8,10].forEach(lvl => {
    ctx.beginPath();
    activeCrits.forEach((_, i) => {
      const a = angle(i), r = (lvl / 10) * R;
      i === 0 ? ctx.moveTo(cx + r*Math.cos(a), cy + r*Math.sin(a))
              : ctx.lineTo(cx + r*Math.cos(a), cy + r*Math.sin(a));
    });
    ctx.closePath();
    ctx.strokeStyle = lvl === 10 ? 'rgba(0,0,0,0.13)' : 'rgba(0,0,0,0.06)';
    ctx.lineWidth = lvl === 10 ? 1.5 : 1;
    ctx.stroke();
    // Label de niveau sur l'axe du haut
    const labelR = (lvl / 10) * R;
    ctx.font = '9px Plus Jakarta Sans,sans-serif';
    ctx.textAlign = 'center';
    ctx.fillStyle = 'rgba(0,0,0,0.25)';
    if(lvl % 4 === 0) ctx.fillText(lvl, cx + 4, cy - labelR + 10);
  });

  // Axes radiaux
  activeCrits.forEach((_, i) => {
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + R * Math.cos(angle(i)), cy + R * Math.sin(angle(i)));
    ctx.strokeStyle = 'rgba(0,0,0,0.08)';
    ctx.lineWidth = 1;
    ctx.stroke();
  });

  // Labels critères
  activeCrits.forEach((c, i) => {
    const a = angle(i);
    const dist = R + 48;
    const x = cx + dist * Math.cos(a);
    const y = cy + dist * Math.sin(a);

    // Fond de label pour lisibilité
    const short = c.name.length > 12 ? c.name.substring(0, 11) + '…' : c.name;
    ctx.font = 'bold 11px Plus Jakarta Sans,sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // Icône
    ctx.font = '13px serif';
    ctx.fillText(c.icon, x, y - 8);

    // Nom
    ctx.font = '10px Plus Jakarta Sans,sans-serif';
    ctx.fillStyle = '#555';
    ctx.fillText(short, x, y + 6);

    // Badge poids
    if(c.weight > 1){
      const bx = x + ctx.measureText(short).width / 2 + 8;
      ctx.font = 'bold 9px Plus Jakarta Sans,sans-serif';
      ctx.fillStyle = '#b47d0a';
      ctx.fillText(`×${c.weight}`, bx, y + 6);
    }
  });

  // Polygones par option
  S.options.forEach((_, oi) => {
    const col = resultColors[oi] || COLORS[oi];
    const hex = col.hex.replace('#','');
    const r = parseInt(hex.substring(0,2),16);
    const g = parseInt(hex.substring(2,4),16);
    const b = parseInt(hex.substring(4,6),16);

    // Score effectif (invert pris en compte)
    const pts = activeCrits.map((c, i) => {
      const v = S.scores[c.id]?.[oi] ?? 5;
      const eff = c.invert ? 11 - v : v;
      const rad = (eff / 10) * R;
      return [cx + rad * Math.cos(angle(i)), cy + rad * Math.sin(angle(i))];
    });

    ctx.beginPath();
    pts.forEach(([px, py], i) => i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py));
    ctx.closePath();
    ctx.fillStyle = `rgba(${r},${g},${b},0.10)`;
    ctx.fill();
    ctx.strokeStyle = col.hex;
    ctx.lineWidth = 2;
    ctx.stroke();

    // Points sur chaque axe
    pts.forEach(([px, py]) => {
      ctx.beginPath();
      ctx.arc(px, py, 3.5, 0, Math.PI * 2);
      ctx.fillStyle = col.hex;
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 1.5;
      ctx.stroke();
    });
  });
}


/* ─── UTILS ─────────────────────────────── */
function esc(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function shake(id){
  const el=document.getElementById(id); if(!el) return;
  el.style.borderColor='var(--red)';el.focus();
  setTimeout(()=>el.style.borderColor='',1800);
}
function restart(){
  S={
    decision:'',options:[{name:'',desc:''},{name:'',desc:''}],
    criteria:[],scores:{},notes:[],currentCat:'Tous',
    weightingMethod:'simple' // MODIF SWING — reset méthode
  };
  document.getElementById('inp-dec').value='';
  renderOptBuilder();
  renderStepProgress(1);
  nav('page-intro');
}
</script>
<script src="https://unpkg.com/@lottiefiles/lottie-player@2.0.8/dist/lottie-player.js"></script>
<script>
(function(){
  var player = document.querySelector('lottie-player.mascot');
  if (!player) return;
  player.addEventListener('complete', function() {
    setTimeout(function(){ player.play(); }, 3000);
  });
})();
</script>
</body>
</html>
</html>
</html>
