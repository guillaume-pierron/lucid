<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucid â€” Aide Ã  la dÃ©cision</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Lora:wght@600;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:       #f5f4f0;
  --bg2:      #eceae4;
  --white:    #ffffff;
  --border:   #e2dfd8;
  --border2:  #cdc9c0;
  --ink:      #1a1917;
  --ink2:     #3d3b36;
  --muted:    #8a877f;
  --muted2:   #b8b4ac;
  --teal:     #2d7d5a;
  --teal2:    #389e71;
  --teal-bg:  #eef7f2;
  --teal-bd:  #b6ddc9;
  --green:    #2d8a4e;
  --green-bg: #eaf4ee;
  --red:      #c0392b;
  --red-bg:   #fdecea;
  --amber:    #b8820a;
  --amber-bg: #fef6e4;
  --r:        14px;
  --r-sm:     9px;
  --shadow:   0 2px 12px rgba(0,0,0,0.07);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.1);
}

/* â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;overflow-x:hidden;}
body{
  background:var(--bg);
  color:var(--ink);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:15px;
  line-height:1.6;
  min-height:100vh;
  overflow-x:hidden;
}

/* â”€â”€ PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page{display:none;min-height:100vh;flex-direction:column;}
.page.active{display:flex;}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-header{
  background:var(--white);
  border-bottom:1px solid var(--border);
  padding:14px 28px;
  display:flex;align-items:center;gap:16px;
  position:sticky;top:0;z-index:50;
  box-shadow:0 1px 4px rgba(0,0,0,0.05);
}
.logo{
  font-family:'Lora',serif;
  font-size:1.3rem;font-weight:700;
  color:var(--ink);
  letter-spacing:-.02em;
  display:flex;align-items:center;gap:6px;
}
.logo-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--teal);
  display:inline-block;
}

/* Step progress in header */
.step-progress{
  margin-left:auto;
  display:flex;align-items:center;gap:0;
}
.sp-step{
  display:flex;align-items:center;gap:7px;
  padding:6px 14px;border-radius:30px;
  font-size:.75rem;font-weight:600;
  color:var(--muted);
  transition:all .2s;
}
.sp-step.active{background:var(--teal-bg);color:var(--teal);}
.sp-step.done{color:var(--muted2);}
.sp-num{
  width:22px;height:22px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:.72rem;font-weight:700;
  background:var(--bg2);color:var(--muted);
  flex-shrink:0;transition:all .2s;
}
.sp-step.active .sp-num{background:var(--teal);color:#fff;}
.sp-step.done .sp-num{background:var(--green);color:#fff;}
.sp-arrow{color:var(--muted2);font-size:.75rem;padding:0 2px;}

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{
  flex:1;
  padding:36px 28px 72px;
  max-width:960px;
  margin:0 auto;
  width:100%;
}

/* â”€â”€ ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes up{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none}}
.anim{animation:up .4s ease both;}
.d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.16s}.d4{animation-delay:.22s}

/* â”€â”€ TYPOGRAPHY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-eyebrow{
  display:inline-flex;align-items:center;gap:6px;
  font-size:.72rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;
  color:var(--teal);background:var(--teal-bg);
  padding:4px 12px;border-radius:20px;border:1px solid var(--teal-bd);
  margin-bottom:14px;
}
.page-title{
  font-family:'Lora',serif;
  font-size:clamp(1.7rem,3.5vw,2.4rem);
  font-weight:700;line-height:1.2;
  color:var(--ink);margin-bottom:8px;
}
.page-sub{
  font-size:.93rem;color:var(--muted);
  line-height:1.65;max-width:520px;margin-bottom:32px;
}

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{
  background:var(--white);
  border:1px solid var(--border);
  border-radius:var(--r);
  box-shadow:var(--shadow);
}

/* â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field{margin-bottom:18px;}
.field>label{
  display:block;font-size:.78rem;font-weight:700;
  color:var(--ink2);margin-bottom:6px;letter-spacing:.02em;
}
input[type=text],textarea,select{
  width:100%;
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:var(--r-sm);
  color:var(--ink);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.95rem;padding:12px 14px;
  outline:none;resize:none;appearance:none;
  transition:border-color .18s,box-shadow .18s;
}
input[type=text]:focus,textarea:focus,select:focus{
  border-color:var(--teal2);
  box-shadow:0 0 0 3px rgba(45,125,90,.12);
}
input[type=text]::placeholder,textarea::placeholder{color:var(--muted2);}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.88rem;font-weight:600;
  padding:11px 22px;border-radius:var(--r-sm);
  border:none;cursor:pointer;
  transition:all .18s;
  display:inline-flex;align-items:center;gap:7px;
}
.btn-primary{background:var(--teal);color:#fff;}
.btn-primary:hover{background:var(--teal2);transform:translateY(-1px);box-shadow:0 6px 20px rgba(45,125,90,.25);}
.btn-secondary{background:var(--white);color:var(--ink2);border:1.5px solid var(--border);}
.btn-secondary:hover{border-color:var(--border2);background:var(--bg);}
.btn-row{display:flex;align-items:center;justify-content:space-between;margin-top:32px;gap:12px;}

/* â”€â”€ INTRO PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#page-intro{ background:var(--white); }

.intro-wrap{
  width:100%;
  min-height:100dvh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:32px 20px;
  box-sizing:border-box;
}
.intro-inner{
  display:flex;flex-direction:column;
  align-items:center;
  text-align:center;
  width:100%;
  max-width:600px;
}
.intro-badge{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--teal-bg);color:var(--teal);
  border:1px solid var(--teal-bd);
  font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;
  padding:4px 12px;border-radius:20px;margin-bottom:14px;
  animation:up .5s ease both;flex-shrink:0;
}
.intro-logo{
  font-family:'Lora',serif;
  font-size:clamp(2.8rem,9vw,6.5rem);
  font-weight:700;color:var(--ink);line-height:1;
  margin-bottom:10px;flex-shrink:0;
  animation:up .5s .08s ease both;
}
.intro-logo span{color:var(--teal);}
.intro-tagline{
  font-size:clamp(.88rem,2vw,1.1rem);color:var(--muted);
  font-weight:400;max-width:420px;margin:0 auto 20px;
  animation:up .5s .16s ease both;flex-shrink:0;
}
.intro-how{
  display:grid;grid-template-columns:repeat(3,1fr);
  gap:10px;width:100%;margin:0 auto 24px;
  animation:up .5s .24s ease both;flex-shrink:0;
}
.how-card{
  background:var(--bg);border:1px solid var(--border);
  border-radius:var(--r);padding:14px 10px;
  text-align:center;
}
.how-num{
  width:28px;height:28px;border-radius:50%;
  background:var(--teal);color:#fff;
  font-size:.75rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;
  margin:0 auto 8px;
}
.how-title{font-size:.8rem;font-weight:700;color:var(--ink);margin-bottom:3px;}
.how-desc{font-size:.7rem;color:var(--muted);line-height:1.4;}
.intro-start-btn{
  animation:up .5s .32s ease both;
  font-size:1rem;padding:14px 40px;border-radius:12px;
  background:var(--teal);color:#fff;
  border:none;font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;
  cursor:pointer;transition:all .2s;flex-shrink:0;
  box-shadow:0 4px 16px rgba(45,125,90,.3);
  width:100%;max-width:320px;
}
.intro-start-btn:hover{background:var(--teal2);transform:translateY(-2px);box-shadow:0 10px 28px rgba(45,125,90,.35);}

/* On very small screens, hide how-cards description text */
@media(max-height:640px){
  .how-desc{display:none;}
  .how-card{padding:10px 8px;}
  .intro-how{margin-bottom:16px;}
  .intro-tagline{margin-bottom:14px;}
}

/* â”€â”€ AI INTERPRETATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.interp-box{
  background:var(--white);
  border:1.5px solid var(--teal-bd);
  border-radius:var(--r);
  margin-bottom:24px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.interp-head{
  display:flex;align-items:center;gap:10px;
  padding:13px 18px;
  background:var(--teal-bg);
  border-bottom:1px solid var(--teal-bd);
}
.interp-head-title{font-size:.88rem;font-weight:700;color:var(--teal);}
.interp-badge{
  font-size:.62rem;font-weight:700;letter-spacing:.08em;
  background:var(--teal);color:#fff;
  padding:2px 8px;border-radius:5px;text-transform:uppercase;
}
.interp-body{padding:20px 22px;}
.interp-text{
  font-size:.95rem;color:var(--ink2);line-height:1.75;
  font-weight:400;
}
.interp-text strong{color:var(--ink);font-weight:700;}

/* Loading skeleton */
.interp-loading{
  display:flex;flex-direction:column;gap:10px;padding:20px 22px;
}
.skel{
  height:14px;border-radius:6px;
  background:linear-gradient(90deg,var(--bg) 25%,var(--bg2) 50%,var(--bg) 75%);
  background-size:200% 100%;
  animation:shimmer 1.4s infinite;
}
.skel.w100{width:100%;}
.skel.w80{width:80%;}
.skel.w60{width:60%;}
@keyframes shimmer{from{background-position:200% 0}to{background-position:-200% 0}}

/* â”€â”€ STEP 1 â€” OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.decision-card{
  padding:24px;margin-bottom:20px;
}
.options-list{display:flex;flex-direction:column;gap:12px;margin-bottom:14px;}
.opt-card{border-radius:var(--r);overflow:hidden;border:1.5px solid var(--border);background:var(--white);box-shadow:var(--shadow);}
.opt-card-head{
  display:flex;align-items:center;gap:10px;
  padding:13px 16px;cursor:pointer;user-select:none;
  background:var(--bg);border-bottom:1px solid var(--border);
  transition:background .15s;
}
.opt-card-head:hover{background:var(--bg2);}
.opt-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.opt-letter{
  font-size:.72rem;font-weight:800;letter-spacing:.1em;text-transform:uppercase;
}
.opt-name-preview{
  margin-left:auto;font-size:.82rem;color:var(--muted);
  max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.opt-chevron{color:var(--muted2);font-size:.75rem;transition:transform .2s;margin-left:6px;}
.opt-card.open .opt-chevron{transform:rotate(180deg);}
.opt-card-body{padding:16px;display:none;}
.opt-card.open .opt-card-body{display:block;}
.opt-rm{
  width:26px;height:26px;border-radius:7px;
  background:transparent;border:1px solid var(--border);
  color:var(--muted);cursor:pointer;font-size:.8rem;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;
  flex-shrink:0;
}
.opt-rm:hover{background:var(--red-bg);border-color:var(--red);color:var(--red);}

.add-option-btn{
  width:100%;display:flex;align-items:center;gap:10px;
  background:var(--white);border:1.5px dashed var(--border2);
  border-radius:var(--r);padding:14px 18px;
  cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.85rem;font-weight:600;color:var(--muted);
  transition:all .18s;
}
.add-option-btn:hover{border-color:var(--teal2);color:var(--teal);background:var(--teal-bg);}
.add-option-icon{
  width:28px;height:28px;border-radius:8px;
  background:var(--bg);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;transition:all .18s;
}
.add-option-btn:hover .add-option-icon{background:var(--teal);color:#fff;border-color:var(--teal);}

/* â”€â”€ STEP 2 â€” CRITERIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.criteria-intro{
  background:var(--amber-bg);border:1px solid #f0d080;
  border-radius:var(--r);padding:14px 18px;
  margin-bottom:22px;
  display:flex;align-items:flex-start;gap:10px;
  font-size:.85rem;color:var(--amber);line-height:1.5;
}
.criteria-intro-icon{font-size:1.1rem;flex-shrink:0;margin-top:1px;}

.cat-tabs{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:18px;}
.cat-tab{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:30px;color:var(--muted);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.78rem;font-weight:600;
  padding:6px 14px;cursor:pointer;transition:all .15s;
}
.cat-tab:hover{border-color:var(--border2);color:var(--ink2);}
.cat-tab.active{border-color:var(--teal);color:var(--teal);background:var(--teal-bg);}

.crit-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:8px;margin-bottom:22px;
}
.crit-pill{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r-sm);padding:11px 13px;
  cursor:pointer;transition:all .15s;
  display:flex;align-items:flex-start;gap:9px;user-select:none;
}
.crit-pill:hover{border-color:var(--border2);box-shadow:var(--shadow);}
.crit-pill.on{border-color:var(--teal);background:var(--teal-bg);box-shadow:0 0 0 1px var(--teal);}
.crit-check{
  width:18px;height:18px;border-radius:5px;
  background:var(--bg);border:1.5px solid var(--border2);
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;flex-shrink:0;margin-top:1px;transition:all .15s;
}
.crit-pill.on .crit-check{background:var(--teal);border-color:var(--teal);color:#fff;}
.crit-icon{font-size:.95rem;flex-shrink:0;margin-top:1px;}
.crit-name{font-size:.82rem;font-weight:600;color:var(--ink);}
.crit-hint{font-size:.7rem;color:var(--muted);margin-top:2px;line-height:1.4;}

.custom-form{
  background:var(--bg);border:1.5px dashed var(--border2);
  border-radius:var(--r);padding:18px;margin-bottom:22px;
}
.custom-form-title{
  font-size:.82rem;font-weight:700;color:var(--ink2);margin-bottom:14px;
  display:flex;align-items:center;gap:6px;
}
.custom-row{display:grid;grid-template-columns:1fr 70px 1fr;gap:10px;align-items:end;}

/* Selected criteria box */
.selected-box{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);overflow:hidden;
}
.selected-box-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 18px;border-bottom:1px solid var(--border);
  background:var(--bg);
}
.selected-box-head h3{font-size:.85rem;font-weight:700;color:var(--ink2);}
.sel-count{
  background:var(--teal);color:#fff;
  font-size:.7rem;font-weight:700;padding:2px 9px;border-radius:20px;
}
.sel-list{padding:6px;}
.sel-item{
  display:flex;align-items:center;gap:8px;
  padding:9px 12px;border-radius:8px;transition:background .12s;
}
.sel-item:hover{background:var(--bg);}
.sel-icon{font-size:.9rem;flex-shrink:0;}
.sel-name{font-size:.82rem;font-weight:500;color:var(--ink);flex:1;}
.inv-tag{
  font-size:.63rem;background:var(--amber-bg);
  color:var(--amber);padding:2px 6px;border-radius:4px;
  border:1px solid #f0d080;font-weight:600;
}
.weight-sel{
  padding:4px 8px;font-size:.72rem;border-radius:6px;
  background:var(--bg);border:1.5px solid var(--border);
  color:var(--ink2);cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;font-weight:600;
}
.inv-btn{
  font-size:.63rem;padding:4px 8px;
  background:var(--bg);border:1.5px solid var(--border);
  border-radius:5px;color:var(--muted);cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  white-space:nowrap;font-weight:600;transition:all .12s;
}
.inv-btn.on{border-color:var(--amber);color:var(--amber);background:var(--amber-bg);}
.rm-btn{
  width:24px;height:24px;border-radius:6px;
  background:transparent;border:1.5px solid var(--border);
  color:var(--muted);cursor:pointer;font-size:.75rem;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;font-family:'Plus Jakarta Sans',sans-serif;transition:all .12s;
}
.rm-btn:hover{background:var(--red-bg);border-color:var(--red);color:var(--red);}
.empty-hint{text-align:center;padding:28px;color:var(--muted);font-size:.85rem;}

/* â”€â”€ STEP 3 â€” EVALUATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.eval-grid{display:grid;gap:16px;}
.eval-col{}
.eval-col-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 18px;border-radius:12px 12px 0 0;
  border:1.5px solid;border-bottom:none;
}
.eval-col-name{font-size:1rem;font-weight:700;}
.eval-live-score{
  display:flex;flex-direction:column;align-items:flex-end;
}
.eval-live-num{
  font-family:'Lora',serif;
  font-size:1.6rem;font-weight:700;line-height:1;
}
.eval-live-label{font-size:.62rem;color:var(--muted);font-weight:500;}

.eval-col-body{border:1.5px solid;border-top:none;border-radius:0 0 12px 12px;overflow:hidden;background:var(--white);}

/* Stepper */
.sl-item{padding:14px 16px;border-bottom:1px solid var(--border);}
.sl-item:last-child{border-bottom:none;}
.sl-head{display:flex;align-items:center;gap:6px;margin-bottom:12px;}
.sl-label{font-size:.8rem;font-weight:600;color:var(--ink);flex:1;}
.sl-wtag{
  font-size:.62rem;background:var(--amber-bg);
  color:var(--amber);padding:2px 6px;border-radius:4px;
  border:1px solid #f0d080;font-weight:700;flex-shrink:0;
}

.stepper{
  display:grid;grid-template-columns:44px 1fr 44px;
  align-items:center;gap:10px;
}
.stepper-btn{
  width:44px;height:44px;border-radius:10px;
  border:1.5px solid var(--border);
  background:var(--bg);color:var(--ink2);
  font-size:1.3rem;font-weight:300;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-family:'Plus Jakarta Sans',sans-serif;
  transition:all .15s;flex-shrink:0;
  touch-action:manipulation;user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.stepper-btn:hover{border-color:var(--border2);background:var(--bg2);}
.stepper-btn:active{transform:scale(.90);background:var(--border);}

.stepper-track{display:flex;flex-direction:column;align-items:center;gap:7px;}

.pip-row{display:flex;gap:4px;align-items:flex-end;width:100%;height:20px;}
.pip{
  flex:1;border-radius:4px;
  background:var(--bg2);border:1px solid var(--border);
  transition:background .18s,height .18s,border-color .18s;
  min-height:8px;
}

.stepper-val{
  font-family:'Lora',serif;
  font-size:1.5rem;font-weight:700;line-height:1;
  transition:color .18s;min-width:28px;text-align:center;
}

/* â”€â”€ NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notes-row{display:grid;gap:14px;margin-top:20px;}
.notes-lbl{
  font-size:.75rem;font-weight:700;color:var(--ink2);margin-bottom:6px;display:block;
}

/* â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.res-decision-banner{
  background:var(--white);border:1px solid var(--border);
  border-radius:var(--r);padding:20px 24px;
  margin-bottom:24px;
  display:flex;align-items:center;gap:14px;
  box-shadow:var(--shadow);
}
.res-dec-icon{font-size:1.6rem;flex-shrink:0;}
.res-dec-label{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:3px;}
.res-dec-text{font-size:1rem;font-weight:600;color:var(--ink);}

.verdict-strip{
  border-radius:var(--r);padding:20px 24px;
  display:flex;align-items:flex-start;gap:16px;
  margin-bottom:24px;border:1.5px solid;
  box-shadow:var(--shadow);
}
.verdict-icon{font-size:1.8rem;flex-shrink:0;margin-top:2px;}
.verdict-title{font-family:'Lora',serif;font-size:1.25rem;font-weight:700;margin-bottom:4px;}
.verdict-sub{font-size:.85rem;color:var(--muted);line-height:1.55;}

.scores-row{display:grid;gap:12px;margin-bottom:24px;}
.score-card{
  background:var(--white);border-radius:var(--r);
  padding:20px 22px;border:1.5px solid var(--border);
  position:relative;overflow:hidden;
  box-shadow:var(--shadow);transition:box-shadow .15s;
}
.score-card:hover{box-shadow:var(--shadow-lg);}
.score-card.rank-1{border-width:2px;}
.rank-badge{
  position:absolute;top:14px;right:14px;
  font-size:.68rem;font-weight:700;
  padding:3px 10px;border-radius:20px;
  letter-spacing:.06em;
  white-space:nowrap;
}
.sc-letter{
  font-size:.7rem;font-weight:800;letter-spacing:.1em;text-transform:uppercase;
  margin-bottom:4px;
  /* Leave room for the absolute badge on desktop */
  padding-right:110px;
}
.sc-name{font-family:'Lora',serif;font-size:1.25rem;font-weight:700;color:var(--ink);margin-bottom:4px;}
.sc-desc{font-size:.78rem;color:var(--muted);margin-bottom:16px;}
.sc-score-row{display:flex;align-items:flex-end;gap:5px;margin-bottom:10px;}
.sc-num{font-family:'Lora',serif;font-size:2.8rem;font-weight:700;line-height:1;}
.sc-denom{font-size:.8rem;color:var(--muted);margin-bottom:6px;font-weight:500;}
.sc-bar{height:8px;background:var(--bg2);border-radius:4px;overflow:hidden;margin-bottom:14px;}
.sc-bar-fill{height:100%;border-radius:4px;transition:width 1s ease;}

/* Breakdown */
.section-title{
  font-family:'Lora',serif;
  font-size:1.1rem;font-weight:700;color:var(--ink);
  margin-bottom:14px;padding-bottom:12px;
  border-bottom:1.5px solid var(--border);
}
.bk-table{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);overflow:hidden;margin-bottom:24px;
  box-shadow:var(--shadow);overflow-x:auto;
}
.bk-row{display:flex;align-items:center;border-bottom:1px solid var(--border);}
.bk-row:last-child{border-bottom:none;}
.bk-row.hdr{background:var(--bg);border-bottom:1.5px solid var(--border);}
.bk-row:not(.hdr):hover{background:var(--bg);}
.bk-cell{padding:12px 14px;font-size:.8rem;}
.bk-cell.crit-col{width:190px;flex-shrink:0;display:flex;align-items:center;gap:7px;color:var(--ink);font-weight:600;}
.bk-cell.hdr-cell{color:var(--muted);font-weight:700;font-size:.72rem;text-transform:uppercase;letter-spacing:.06em;}
.bk-cell.opt-col{flex:1;min-width:90px;}
.opt-cell-in{display:flex;align-items:center;gap:7px;}
.opt-pill{
  display:inline-flex;align-items:center;justify-content:center;
  width:26px;height:26px;border-radius:7px;
  font-size:.82rem;font-weight:700;flex-shrink:0;
}
.mini-bar{flex:1;height:6px;background:var(--bg2);border-radius:3px;overflow:hidden;}
.mini-bar-fill{height:100%;border-radius:3px;}

/* Radar */
.radar-section{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);padding:22px;margin-bottom:24px;
  box-shadow:var(--shadow);
}
.radar-section h3{font-family:'Lora',serif;font-size:1.1rem;font-weight:700;color:var(--ink);margin-bottom:18px;}
.radar-legend{display:flex;flex-wrap:wrap;gap:14px;margin-top:14px;font-size:.8rem;color:var(--muted);}
.leg-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:5px;}

/* Analysis */
.analysis-box{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);overflow:hidden;margin-bottom:24px;
  box-shadow:var(--shadow);
}
.analysis-head{
  padding:14px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:9px;background:var(--bg);
}
.analysis-head h3{font-size:.88rem;font-weight:700;color:var(--ink);}
.ai-badge{
  font-size:.65rem;font-weight:700;letter-spacing:.08em;
  background:var(--teal-bg);color:var(--teal);
  padding:3px 9px;border-radius:5px;text-transform:uppercase;
  border:1px solid var(--teal-bd);
}
.analysis-body{display:grid;grid-template-columns:1fr 1fr;gap:0;}
.an-col{padding:18px;}
.an-col:first-child{border-right:1px solid var(--border);}
.an-col h4{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px;}
.an-col.pros h4{color:var(--green);}
.an-col.cons h4{color:var(--red);}
.an-item{display:flex;gap:8px;font-size:.82rem;color:var(--ink2);line-height:1.55;margin-bottom:8px;}
.an-dot{width:6px;height:6px;border-radius:50%;margin-top:6px;flex-shrink:0;}
.pros .an-dot{background:var(--green);}
.cons .an-dot{background:var(--red);}

/* Notes result */
.notes-res{background:var(--white);border:1.5px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:24px;box-shadow:var(--shadow);}
.notes-res-head{padding:13px 18px;border-bottom:1px solid var(--border);font-size:.85rem;font-weight:700;color:var(--ink);background:var(--bg);}
.notes-res-body{display:grid;}
.note-col{padding:14px 18px;border-right:1px solid var(--border);}
.note-col:last-child{border-right:none;}
.note-col-lbl{font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px;}
.note-col-txt{font-size:.83rem;color:var(--muted);line-height:1.6;font-style:italic;}

.res-actions{display:flex;align-items:center;justify-content:space-between;margin-top:32px;padding-top:20px;border-top:1px solid var(--border);flex-wrap:wrap;gap:10px;}

/* â”€â”€ TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-tip]{position:relative;cursor:help;}
[data-tip]::after{
  content:attr(data-tip);
  position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:var(--ink);color:#fff;
  font-size:.7rem;padding:5px 9px;border-radius:6px;
  white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:100;
}
[data-tip]:hover::after{opacity:1;}

/* â”€â”€ FEAR TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fear-box{
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:var(--r);
  margin-bottom:24px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.fear-head{
  display:flex;align-items:center;gap:12px;
  padding:16px 20px;
  cursor:pointer;
  user-select:none;
  transition:background .15s;
}
.fear-head:hover{ background:var(--bg); }
.fear-icon{ font-size:1.4rem; flex-shrink:0; }
.fear-head-text{ flex:1; }
.fear-head-title{
  font-size:.92rem;font-weight:700;color:var(--ink);
  margin-bottom:2px;
}
.fear-head-sub{
  font-size:.75rem;color:var(--muted);line-height:1.4;
}

/* Toggle switch */
.toggle-wrap{
  display:flex;align-items:center;gap:8px;flex-shrink:0;
}
.toggle-label{
  font-size:.75rem;font-weight:600;
  color:var(--muted);transition:color .2s;
  white-space:nowrap;
}
.toggle-label.on{ color:var(--teal); }
.toggle{
  position:relative;width:44px;height:24px;flex-shrink:0;
}
.toggle input{ opacity:0;width:0;height:0;position:absolute; }
.toggle-track{
  position:absolute;inset:0;
  background:var(--border2);border-radius:12px;
  transition:background .2s;cursor:pointer;
}
.toggle input:checked + .toggle-track{ background:var(--teal); }
.toggle-thumb{
  position:absolute;top:3px;left:3px;
  width:18px;height:18px;border-radius:50%;
  background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);
  transition:transform .2s;pointer-events:none;
}
.toggle input:checked ~ .toggle-thumb{ transform:translateX(20px); }

/* Fear body â€” criteria tags + comparison */
.fear-body{
  border-top:1px solid var(--border);
  padding:16px 20px;
  display:none;
}
.fear-box.open .fear-body{ display:block; }

.fear-crits{
  display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;
}
.fear-crit-tag{
  display:inline-flex;align-items:center;gap:5px;
  font-size:.72rem;font-weight:600;
  padding:3px 10px;border-radius:20px;
  border:1px solid;
}
.fear-crit-tag.active{
  background:rgba(124,58,237,0.08);
  color:#7c3aed;border-color:rgba(124,58,237,0.3);
}
.fear-crit-tag.inactive{
  background:var(--bg);color:var(--muted2);border-color:var(--border);
  text-decoration:line-through;opacity:.6;
}

.fear-comparison{
  display:grid;gap:10px;
}
.fear-opt-row{
  background:var(--bg);border-radius:10px;padding:12px 14px;
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
}
.fear-opt-name{
  font-size:.82rem;font-weight:700;min-width:90px;
}
.fear-scores{
  display:flex;align-items:center;gap:8px;flex:1;flex-wrap:wrap;
}
.fear-score-block{
  display:flex;flex-direction:column;align-items:center;
  min-width:64px;
}
.fear-score-val{
  font-family:'Lora',serif;
  font-size:1.5rem;font-weight:700;line-height:1;
}
.fear-score-lbl{
  font-size:.62rem;color:var(--muted);font-weight:500;margin-top:1px;
}
.fear-arrow{
  font-size:1rem;color:var(--muted2);
}
.fear-delta{
  font-size:.78rem;font-weight:700;
  padding:2px 8px;border-radius:6px;
}
.fear-delta.up{
  background:rgba(45,125,90,.08);color:var(--teal);
}
.fear-delta.down{
  background:rgba(192,57,43,.06);color:var(--red);
}
.fear-delta.same{
  background:var(--bg2);color:var(--muted);
}

.fear-insight{
  margin-top:14px;padding:12px 14px;
  background:rgba(124,58,237,0.05);
  border:1px solid rgba(124,58,237,0.18);
  border-radius:10px;
  font-size:.82rem;color:var(--ink2);line-height:1.6;
}
.fear-insight strong{ color:#7c3aed; }

.fear-none{
  font-size:.82rem;color:var(--muted);
  font-style:italic;padding:8px 0;
}

/* â”€â”€ SCENARIO PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scenario-box{
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:var(--r);
  margin-bottom:24px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.scenario-head{
  display:flex;align-items:center;gap:12px;
  padding:16px 20px;cursor:pointer;user-select:none;
  transition:background .15s;
}
.scenario-head:hover{ background:var(--bg); }
.scenario-head-icon{ font-size:1.3rem;flex-shrink:0; }
.scenario-head-text{ flex:1; }
.scenario-head-title{ font-size:.92rem;font-weight:700;color:var(--ink);margin-bottom:2px; }
.scenario-head-sub{ font-size:.75rem;color:var(--muted);line-height:1.4; }
.scenario-chevron{ color:var(--muted2);font-size:.8rem;transition:transform .22s; }
.scenario-box.open .scenario-chevron{ transform:rotate(180deg); }

.scenario-body{
  display:none;
  border-top:1px solid var(--border);
  padding:16px 20px 20px;
}
.scenario-box.open .scenario-body{ display:block; }

.scenario-reset{
  font-size:.75rem;font-weight:600;color:var(--teal);
  background:none;border:none;cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  padding:0;text-decoration:underline;text-underline-offset:2px;
  float:right;
}
.scenario-reset:hover{ color:var(--teal2); }

.sc-crit-list{
  display:flex;flex-direction:column;gap:6px;
  margin-top:10px;
  clear:both;
}
.sc-crit-row{
  display:flex;align-items:center;gap:10px;
  padding:9px 12px;border-radius:9px;
  border:1.5px solid var(--border);
  background:var(--bg);
  transition:all .15s;
}
.sc-crit-row.off{
  opacity:.45;
}
.sc-crit-row.off .sc-crit-name{ text-decoration:line-through; }
.sc-crit-icon{ font-size:.95rem;flex-shrink:0; }
.sc-crit-name{ font-size:.82rem;font-weight:600;color:var(--ink);flex:1; }
.sc-crit-weight{
  font-size:.65rem;background:var(--amber-bg);
  color:var(--amber);padding:2px 6px;border-radius:4px;
  border:1px solid #f0d080;font-weight:700;flex-shrink:0;
}
.sc-crit-inv{
  font-size:.65rem;background:var(--bg2);
  color:var(--muted);padding:2px 6px;border-radius:4px;
  border:1px solid var(--border2);font-weight:600;flex-shrink:0;
}

/* Mini toggle â€” smaller than the fear one */
.mini-toggle{
  position:relative;width:36px;height:20px;flex-shrink:0;
}
.mini-toggle input{ opacity:0;width:0;height:0;position:absolute; }
.mini-toggle-track{
  position:absolute;inset:0;
  background:var(--border2);border-radius:10px;
  transition:background .18s;cursor:pointer;
}
.mini-toggle input:checked + .mini-toggle-track{ background:var(--teal); }
.mini-toggle-thumb{
  position:absolute;top:3px;left:3px;
  width:14px;height:14px;border-radius:50%;
  background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.2);
  transition:transform .18s;pointer-events:none;
}
.mini-toggle input:checked ~ .mini-toggle-thumb{ transform:translateX(16px); }

/* Dynamic score cards */
.sc-num{ transition:color .2s; }
.sc-bar-fill{ transition:width .4s ease,background .2s; }
.sc-scenario-delta{
  display:inline-flex;align-items:center;gap:4px;
  font-size:.72rem;font-weight:700;
  padding:2px 8px;border-radius:6px;margin-left:6px;
  vertical-align:middle;
}
.sc-scenario-delta.up{ background:rgba(45,125,90,.1);color:var(--teal); }
.sc-scenario-delta.down{ background:rgba(192,57,43,.07);color:var(--red); }
.sc-scenario-delta.same{ display:none; }

.scenario-summary{
  margin-top:14px;padding:11px 14px;
  background:var(--teal-bg);border:1px solid var(--teal-bd);
  border-radius:9px;font-size:.8rem;color:var(--ink2);line-height:1.6;
}
.scenario-summary strong{ color:var(--teal); }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:640px){
  .app-header{padding:12px 16px;}
  .main{padding:22px 16px 60px;}
  .intro-how{grid-template-columns:1fr;}
  .sp-step span:not(.sp-num){display:none;}
  .custom-row{grid-template-columns:1fr 1fr;}
  .analysis-body{grid-template-columns:1fr;}
  .an-col:first-child{border-right:none;border-bottom:1px solid var(--border);}
  .notes-res-body{grid-template-columns:1fr!important;}
  .note-col{border-right:none!important;border-bottom:1px solid var(--border);}

  /* Scores cards â€” rank badge inline on mobile */
  .scores-row{grid-template-columns:1fr!important;}
  .rank-badge{
    position:static;
    display:inline-flex;
    margin-bottom:8px;
  }
  .sc-letter{padding-right:0;}
  .eval-grid{grid-template-columns:1fr!important;}
  .eval-col-name{font-size:.88rem;}

  /* Stepper: shrink buttons, tighten gap */
  .stepper{grid-template-columns:38px 1fr 38px;gap:6px;}
  .stepper-btn{width:38px;height:38px;font-size:1.1rem;}

  /* Prevent pip row from pushing layout */
  .pip-row{gap:3px;}
  .pip{border-radius:3px;}

  /* Notes row single column */
  .notes-row{grid-template-columns:1fr!important;}
}

@media print{
  body{background:#fff;}
  .app-header button,.res-actions,.btn-row{display:none!important;}
  .page{display:none!important;}
  #page-results{display:flex!important;}
}
</style>
</head>
<body>
<div class="app">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INTRO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-intro">
  <div class="intro-wrap">
    <div class="intro-inner">
      <div class="intro-badge">âœ¦ Outil d'aide Ã  la dÃ©cision</div>
      <div class="intro-logo">Lucid<span>.</span></div>
      <div class="intro-tagline">Comparez vos options avec Lucid et prenez vos dÃ©cisions en toute confiance.</div>

      <div class="intro-how">
        <div class="how-card">
          <div class="how-num">1</div>
          <div class="how-title">Posez votre question</div>
          <div class="how-desc">DÃ©crivez votre dÃ©cision et listez vos options Ã  comparer.</div>
        </div>
        <div class="how-card">
          <div class="how-num">2</div>
          <div class="how-title">Choisissez vos critÃ¨res</div>
          <div class="how-desc">SÃ©lectionnez ce qui compte vraiment pour vous.</div>
        </div>
        <div class="how-card">
          <div class="how-num">3</div>
          <div class="how-title">Obtenez votre analyse</div>
          <div class="how-desc">Lucid calcule les scores et vous prÃ©sente un rÃ©sultat clair.</div>
        </div>
      </div>

      <button class="intro-start-btn" onclick="nav('page-step1')">Commencer â†’</button>
      <p style="margin-top:12px;font-size:.75rem;color:var(--muted2)">Gratuit Â· Aucun compte requis Â· 100% privÃ©</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 1 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-step1">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp1"></div>
  </div>
  <div class="main">
    <div class="page-eyebrow anim">Ã‰tape 1 sur 3</div>
    <div class="page-title anim d1">Quelle dÃ©cision devez-vous prendre ?</div>
    <div class="page-sub anim d2">Formulez votre situation et renseignez les options que vous envisagez.</div>

    <div class="card decision-card anim d2">
      <div class="field" style="margin-bottom:0">
        <label for="inp-dec">ğŸ“ Votre dÃ©cision en une phrase</label>
        <textarea id="inp-dec" rows="2" placeholder="Ex : Dois-je accepter ce nouvel emploi ou rester dans mon poste actuel ?"></textarea>
      </div>
    </div>

    <div class="anim d3">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <label style="font-size:.85rem;font-weight:700;color:var(--ink2)">ğŸ”€ Vos options</label>
        <span id="opt-count-lbl" style="font-size:.75rem;color:var(--muted);background:var(--bg2);padding:3px 10px;border-radius:20px;font-weight:600">2 options</span>
      </div>
      <div class="options-list" id="optBuilder"></div>
      <button class="add-option-btn" id="addOptBtn" onclick="addOption()">
        <div class="add-option-icon">+</div>
        Ajouter une option <span style="color:var(--muted2);font-weight:400">(max 6)</span>
      </button>
    </div>

    <div class="btn-row anim d4">
      <button class="btn btn-secondary" onclick="nav('page-intro')">â† Retour</button>
      <button class="btn btn-primary" onclick="validateStep1()">Choisir mes critÃ¨res â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 2 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-step2">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp2"></div>
  </div>
  <div class="main">
    <div class="page-eyebrow">Ã‰tape 2 sur 3</div>
    <div class="page-title">Qu'est-ce qui compte pour vous ?</div>
    <div class="page-sub">SÃ©lectionnez les critÃ¨res importants dans votre situation. Vous pouvez en choisir autant que vous voulez.</div>

    <div class="criteria-intro">
      <div class="criteria-intro-icon">ğŸ’¡</div>
      <div>Cliquez sur les critÃ¨res pour les sÃ©lectionner. Vous pourrez ensuite ajuster leur <strong>importance</strong> (poids) et choisir si un score Ã©levÃ© est positif ou nÃ©gatif pour ce critÃ¨re.</div>
    </div>

    <div class="cat-tabs" id="catTabs"></div>
    <div class="crit-grid" id="critGrid"></div>

    <div class="custom-form">
      <div class="custom-form-title">âœ¦ Ajouter un critÃ¨re personnalisÃ©</div>
      <div class="custom-row">
        <div class="field" style="margin:0"><label>Nom</label><input type="text" id="cust-name" placeholder="Ex : Impact sur ma famille"></div>
        <div class="field" style="margin:0"><label>IcÃ´ne</label><input type="text" id="cust-icon" placeholder="ğŸ¯" style="text-align:center"></div>
        <div class="field" style="margin:0">
          <label>CatÃ©gorie</label>
          <select id="cust-cat">
            <option>Finance</option><option>Pro</option><option selected>Perso</option><option>Social</option><option>StratÃ©gique</option>
          </select>
        </div>
      </div>
      <button class="btn btn-secondary" style="margin-top:12px;font-size:.8rem;padding:9px 18px" onclick="addCustom()">+ Ajouter ce critÃ¨re</button>
    </div>

    <div class="selected-box">
      <div class="selected-box-head">
        <h3>âœ… CritÃ¨res sÃ©lectionnÃ©s</h3>
        <div class="sel-count" id="crit-badge">0</div>
      </div>
      <div class="sel-list" id="activeList">
        <div class="empty-hint">ğŸ‘† SÃ©lectionnez au moins 2 critÃ¨res ci-dessus pour continuer</div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="nav('page-step1')">â† Retour</button>
      <button class="btn btn-primary" onclick="validateStep2()">Ã‰valuer mes options â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 3 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-step3">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp3"></div>
  </div>
  <div class="main">
    <div class="page-eyebrow">Ã‰tape 3 sur 3</div>
    <div class="page-title" id="eval-title">Notez chaque option</div>
    <div class="page-sub">Pour chaque critÃ¨re, donnez une note de <strong>1</strong> (trÃ¨s faible) Ã  <strong>10</strong> (excellent) Ã  chaque option. Le score global se met Ã  jour en direct.</div>

    <div class="eval-grid" id="evalGrid"></div>
    <div class="notes-row" id="notesRow"></div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="nav('page-step2')">â† Retour</button>
      <button class="btn btn-primary" onclick="showResults()">Voir mon analyse â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-results">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn btn-secondary" style="font-size:.82rem" onclick="window.print()">ğŸ–¨ï¸ Exporter en PDF</button>
      <button class="btn btn-primary" style="font-size:.82rem" onclick="restart()">â†º Nouvelle dÃ©cision</button>
    </div>
  </div>
  <div class="main" id="resContent"></div>
</div>

</div>

<script>
/* â”€â”€â”€ PALETTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const COLORS = [
  {hex:'#2d7d5a',bg:'rgba(45,125,90,0.08)',  border:'rgba(45,125,90,0.3)'  },
  {hex:'#e07040',bg:'rgba(224,112,64,0.08)', border:'rgba(224,112,64,0.3)' },
  {hex:'#7c3aed',bg:'rgba(124,58,237,0.08)', border:'rgba(124,58,237,0.3)' },
  {hex:'#d97706',bg:'rgba(217,119,6,0.08)',  border:'rgba(217,119,6,0.3)'  },
  {hex:'#0891b2',bg:'rgba(8,145,178,0.08)',  border:'rgba(8,145,178,0.3)'  },
  {hex:'#be185d',bg:'rgba(190,24,93,0.08)',  border:'rgba(190,24,93,0.3)'  },
];
const LETTERS = ['A','B','C','D','E','F'];

/* â”€â”€â”€ CRITERIA LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LIB = [
  {id:'fin_gain', cat:'Finance',     icon:'ğŸ’°', name:'Gain financier',           hint:'Revenus, salaire, bÃ©nÃ©fices',           invert:false, dw:2},
  {id:'fin_risk', cat:'Finance',     icon:'ğŸ“‰', name:'Risque financier',          hint:'Pertes potentielles, dettes',            invert:true,  dw:2},
  {id:'roi',      cat:'Finance',     icon:'ğŸ“ˆ', name:'Retour sur investissement', hint:'ROI Ã  moyen/long terme',                 invert:false, dw:1},
  {id:'cost',     cat:'Finance',     icon:'ğŸ·ï¸', name:'CoÃ»t initial',             hint:'Investissement de dÃ©part',               invert:true,  dw:1},
  {id:'fin_stab', cat:'Finance',     icon:'ğŸ¦', name:'StabilitÃ© financiÃ¨re',      hint:'SÃ©curitÃ© des revenus',                   invert:false, dw:2},

  {id:'career',   cat:'Pro',         icon:'ğŸš€', name:'Ã‰volution de carriÃ¨re',     hint:'Perspectives professionnelles',           invert:false, dw:2},
  {id:'skills',   cat:'Pro',         icon:'ğŸ§ ', name:'DÃ©veloppement compÃ©tences', hint:'Apprentissage, montÃ©e en compÃ©tence',    invert:false, dw:1},
  {id:'workload', cat:'Pro',         icon:'âš¡', name:'Charge de travail',         hint:'Volume et intensitÃ© du travail',          invert:true,  dw:1},
  {id:'jobsec',   cat:'Pro',         icon:'ğŸ›¡ï¸', name:"SÃ©curitÃ© de l'emploi",     hint:'StabilitÃ© et pÃ©rennitÃ© du poste',         invert:false, dw:2},
  {id:'autonom',  cat:'Pro',         icon:'ğŸ¯', name:'Autonomie',                 hint:"LibertÃ© d'action et de dÃ©cision",         invert:false, dw:1},
  {id:'flex',     cat:'Pro',         icon:'â°', name:'FlexibilitÃ© horaire',        hint:'TÃ©lÃ©travail, horaires amÃ©nageables',      invert:false, dw:1},
  {id:'recog',    cat:'Pro',         icon:'ğŸ…', name:'Reconnaissance',            hint:'Valorisation, prestige',                  invert:false, dw:1},

  {id:'wellb',    cat:'Perso',       icon:'â¤ï¸', name:'Bien-Ãªtre personnel',       hint:'Bonheur, Ã©panouissement',                invert:false, dw:3},
  {id:'stress',   cat:'Perso',       icon:'ğŸ˜¤', name:'Niveau de stress',          hint:'Pression, anxiÃ©tÃ© gÃ©nÃ©rÃ©e',               invert:true,  dw:2},
  {id:'health',   cat:'Perso',       icon:'ğŸŒ¿', name:'Impact santÃ©',              hint:'Effets sur votre santÃ© physique/mentale', invert:false, dw:2},
  {id:'time',     cat:'Perso',       icon:'â±ï¸', name:'Temps libre',              hint:'Loisirs, repos, temps pour soi',           invert:false, dw:2},
  {id:'values',   cat:'Perso',       icon:'ğŸ§­', name:'Alignement valeurs',        hint:'CohÃ©rence avec vos principes',            invert:false, dw:3},
  {id:'passion',  cat:'Perso',       icon:'ğŸ”¥', name:'Passion & intÃ©rÃªt',         hint:'Motivation intrinsÃ¨que',                  invert:false, dw:2},
  {id:'risk',     cat:'Perso',       icon:'âš ï¸', name:'Risque global',             hint:'Incertitude, exposition au danger',        invert:true,  dw:2},

  {id:'family',   cat:'Social',      icon:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', name:'Impact famille',       hint:'Relations avec proches',                  invert:false, dw:2},
  {id:'social',   cat:'Social',      icon:'ğŸ¤', name:'Vie sociale',               hint:'RÃ©seau, amis, interactions',              invert:false, dw:1},
  {id:'location', cat:'Social',      icon:'ğŸ“', name:'QualitÃ© du lieu de vie',    hint:'Logement, ville, environnement',          invert:false, dw:1},
  {id:'repute',   cat:'Social',      icon:'âœ¨', name:'RÃ©putation / Image',         hint:'Perception des autres',                   invert:false, dw:1},
  {id:'impact',   cat:'Social',      icon:'ğŸŒ', name:'Impact sociÃ©tal',            hint:'UtilitÃ© pour la sociÃ©tÃ©',                 invert:false, dw:1},

  {id:'lt',       cat:'StratÃ©gique', icon:'ğŸ”­', name:'Vision long terme',          hint:'BÃ©nÃ©fices dans 5â€“10 ans',                invert:false, dw:2},
  {id:'rev',      cat:'StratÃ©gique', icon:'â†©ï¸', name:'RÃ©versibilitÃ©',              hint:'PossibilitÃ© de revenir en arriÃ¨re',       invert:false, dw:2},
  {id:'opp',      cat:'StratÃ©gique', icon:'ğŸ²', name:'OpportunitÃ© unique',          hint:'RaretÃ© de la chance',                    invert:false, dw:1},
  {id:'complex',  cat:'StratÃ©gique', icon:'ğŸ”§', name:'ComplexitÃ©',                  hint:'DifficultÃ© de mise en Å“uvre',            invert:true,  dw:1},
  {id:'dep',      cat:'StratÃ©gique', icon:'ğŸ”—', name:'DÃ©pendances',                 hint:'Contraintes liÃ©es Ã  autres facteurs',    invert:true,  dw:1},
];

const CATS = ['Tous','Finance','Pro','Perso','Social','StratÃ©gique'];
const WEIGHTS = {1:'Ã—1 Normal', 2:'Ã—2 Important', 3:'Ã—3 Crucial'};

/* â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let S = {
  decision:'',
  options:[{name:'',desc:''},{name:'',desc:''}],
  criteria:[],
  scores:{},
  notes:[],
  currentCat:'Tous',
};

/* â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function nav(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}

function renderStepProgress(active){
  ['sp1','sp2','sp3'].forEach((id,i)=>{
    const el=document.getElementById(id); if(!el) return;
    const labels=['Mes options','Mes critÃ¨res','Mes notes'];
    el.innerHTML=[1,2,3].map(s=>{
      const cls=s<active?'done':s===active?'active':'';
      return `<div class="sp-step ${cls}">
        <div class="sp-num">${s<active?'âœ“':s}</div>
        <span>${labels[s-1]}</span>
      </div>${s<3?'<div class="sp-arrow">â€º</div>':''}`;
    }).join('');
  });
}
renderStepProgress(1);

/* â”€â”€â”€ STEP 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initOptions(){ renderOptBuilder(); }

function renderOptBuilder(){
  const b=document.getElementById('optBuilder');
  b.innerHTML='';
  S.options.forEach((opt,i)=>{
    const c=COLORS[i], ltr=LETTERS[i];
    const card=document.createElement('div');
    card.className='opt-card open'; card.id=`opt-card-${i}`;
    card.innerHTML=`
      <div class="opt-card-head" onclick="toggleOpt(${i})">
        <div class="opt-dot" style="background:${c.hex}"></div>
        <div class="opt-letter" style="color:${c.hex}">Option ${ltr}</div>
        <div class="opt-name-preview" id="opt-prev-${i}">${esc(opt.name)||'â€”'}</div>
        ${i>=2?`<button class="opt-rm" onclick="event.stopPropagation();removeOpt(${i})" title="Supprimer">âœ•</button>`:''}
        <div class="opt-chevron">â–¾</div>
      </div>
      <div class="opt-card-body">
        <div class="field">
          <label>Nom de l'option</label>
          <input type="text" id="opt-name-${i}" value="${esc(opt.name)}"
            placeholder="Ex : Rester Ã  Paris"
            oninput="S.options[${i}].name=this.value;document.getElementById('opt-prev-${i}').textContent=this.value||'â€”'">
        </div>
        <div class="field" style="margin-bottom:0">
          <label>Description courte <span style="font-weight:400;color:var(--muted)">(optionnel)</span></label>
          <input type="text" id="opt-desc-${i}" value="${esc(opt.desc)}"
            placeholder="Ex : StabilitÃ©, famille procheâ€¦"
            oninput="S.options[${i}].desc=this.value">
        </div>
      </div>`;
    b.appendChild(card);
  });
  document.getElementById('opt-count-lbl').textContent=`${S.options.length} option${S.options.length>1?'s':''}`;
  document.getElementById('addOptBtn').style.display=S.options.length>=6?'none':'flex';
}

function toggleOpt(i){ document.getElementById(`opt-card-${i}`).classList.toggle('open'); }
function addOption(){ if(S.options.length>=6) return; S.options.push({name:'',desc:''}); renderOptBuilder(); }
function removeOpt(i){ if(S.options.length<=2) return; S.options.splice(i,1); renderOptBuilder(); }

function validateStep1(){
  const dec=document.getElementById('inp-dec').value.trim();
  if(!dec){ shake('inp-dec'); return; }
  const allNamed=S.options.every((_,i)=>document.getElementById(`opt-name-${i}`)?.value.trim());
  if(!allNamed){ alert('Veuillez donner un nom Ã  chaque option.'); return; }
  S.decision=dec;
  S.options=S.options.map((_,i)=>({
    name:document.getElementById(`opt-name-${i}`).value.trim(),
    desc:document.getElementById(`opt-desc-${i}`).value.trim(),
  }));
  S.notes=S.options.map(()=>'');
  renderStepProgress(2);
  buildCriteriaPage();
  nav('page-step2');
}

initOptions();

/* â”€â”€â”€ STEP 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildCriteriaPage(){ renderCatTabs(); filterGrid('Tous'); renderSelList(); }

function renderCatTabs(){
  const t=document.getElementById('catTabs'); t.innerHTML='';
  CATS.forEach(cat=>{
    const b=document.createElement('button');
    b.className='cat-tab'+(cat===S.currentCat?' active':'');
    b.textContent=cat; b.onclick=()=>filterGrid(cat); t.appendChild(b);
  });
}

function filterGrid(cat){
  S.currentCat=cat; renderCatTabs();
  const g=document.getElementById('critGrid'); g.innerHTML='';
  (cat==='Tous'?LIB:LIB.filter(c=>c.cat===cat)).forEach(c=>{
    const on=S.criteria.some(x=>x.id===c.id);
    const pill=document.createElement('div');
    pill.className='crit-pill'+(on?' on':''); pill.id='pill-'+c.id;
    pill.innerHTML=`
      <div class="crit-check">${on?'âœ“':''}</div>
      <div class="crit-icon">${c.icon}</div>
      <div><div class="crit-name">${c.name}</div><div class="crit-hint">${c.hint}</div></div>`;
    pill.onclick=()=>toggleCrit(c.id); g.appendChild(pill);
  });
}

function toggleCrit(id){
  const idx=S.criteria.findIndex(c=>c.id===id);
  if(idx!==-1) S.criteria.splice(idx,1);
  else { const c=LIB.find(c=>c.id===id); S.criteria.push({...c,weight:c.dw}); }
  filterGrid(S.currentCat); renderSelList();
}

function addCustom(){
  const name=document.getElementById('cust-name').value.trim();
  if(!name){shake('cust-name');return;}
  const icon=document.getElementById('cust-icon').value.trim()||'ğŸ”¹';
  const cat=document.getElementById('cust-cat').value;
  S.criteria.push({id:'cust_'+Date.now(),cat,icon,name,hint:'CritÃ¨re personnalisÃ©',invert:false,weight:1,custom:true});
  document.getElementById('cust-name').value='';
  document.getElementById('cust-icon').value='';
  renderSelList();
}

function renderSelList(){
  const list=document.getElementById('activeList');
  document.getElementById('crit-badge').textContent=S.criteria.length;
  if(!S.criteria.length){
    list.innerHTML='<div class="empty-hint">ğŸ‘† SÃ©lectionnez au moins 2 critÃ¨res ci-dessus pour continuer</div>';
    return;
  }
  list.innerHTML='';
  S.criteria.forEach(c=>{
    const item=document.createElement('div'); item.className='sel-item';
    item.innerHTML=`
      <div class="sel-icon">${c.icon}</div>
      <div class="sel-name">${c.name}${c.invert?` <span class="inv-tag" title="Score Ã©levÃ© = mauvais pour ce critÃ¨re">â†“ inversÃ©</span>`:''}</div>
      <label style="font-size:.72rem;color:var(--muted);margin-right:4px;white-space:nowrap">Importance</label>
      <select class="weight-sel" onchange="setCW('${c.id}',this.value)">
        ${[1,2,3].map(w=>`<option value="${w}"${c.weight===w?' selected':''}>${WEIGHTS[w]}</option>`).join('')}
      </select>
      <button class="inv-btn${c.invert?' on':''}" onclick="toggleInv('${c.id}')"
        title="${c.invert?'Actuellement : score Ã©levÃ© = mauvais':'Actuellement : score Ã©levÃ© = bon'}">
        ${c.invert?'â†“ InversÃ©':'â†‘ Normal'}
      </button>
      <button class="rm-btn" onclick="rmCrit('${c.id}')" title="Retirer ce critÃ¨re">âœ•</button>`;
    list.appendChild(item);
  });
}

function setCW(id,v){ const c=S.criteria.find(x=>x.id===id); if(c) c.weight=parseInt(v); }
function toggleInv(id){ const c=S.criteria.find(x=>x.id===id); if(c){c.invert=!c.invert;renderSelList();} }
function rmCrit(id){
  S.criteria=S.criteria.filter(x=>x.id!==id);
  const pill=document.getElementById('pill-'+id);
  if(pill){pill.classList.remove('on');pill.querySelector('.crit-check').textContent='';}
  renderSelList();
}

function validateStep2(){
  if(S.criteria.length<2){alert('Veuillez sÃ©lectionner au moins 2 critÃ¨res.');return;}
  S.criteria.forEach(c=>{
    if(!S.scores[c.id]||S.scores[c.id].length!==S.options.length)
      S.scores[c.id]=S.options.map(()=>5);
  });
  renderStepProgress(3);
  buildEvalPage();
  nav('page-step3');
}

/* â”€â”€â”€ STEP 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildEvalPage(){
  document.getElementById('eval-title').textContent=
    `Notez vos options pour : "${S.decision.substring(0,50)}${S.decision.length>50?'â€¦':''}"`;

  const nOpts=S.options.length;
  const grid=document.getElementById('evalGrid');
  grid.style.gridTemplateColumns=`repeat(${Math.min(nOpts,2)},1fr)`;
  grid.style.width='100%';
  grid.innerHTML='';

  S.options.forEach((opt,oi)=>{
    const c=COLORS[oi];
    const col=document.createElement('div');
    col.className='eval-col';

    const items=S.criteria.map(cr=>{
      const v=S.scores[cr.id]?.[oi]??5;
      const inv=cr.invert?`<span class="inv-tag" title="Score Ã©levÃ© = mauvais pour ce critÃ¨re">â†“</span>`:'';
      const wt=cr.weight>1?`<span class="sl-wtag">Ã—${cr.weight}</span>`:'';
      const pips=Array.from({length:10},(_,pi)=>
        `<div class="pip" id="pip-${oi}-${cr.id}-${pi+1}"></div>`).join('');
      return `
        <div class="sl-item">
          <div class="sl-head">
            <div class="sl-label">${cr.icon} ${cr.name} ${inv}</div>${wt}
          </div>
          <div class="stepper">
            <button class="stepper-btn" onclick="stepVal(${oi},'${cr.id}',-1)" aria-label="Diminuer">âˆ’</button>
            <div class="stepper-track">
              <div class="pip-row">${pips}</div>
              <div class="stepper-val" id="sv-${oi}-${cr.id}">${v}</div>
            </div>
            <button class="stepper-btn" onclick="stepVal(${oi},'${cr.id}',+1)" aria-label="Augmenter">+</button>
          </div>
        </div>`;
    }).join('');

    col.innerHTML=`
      <div class="eval-col-head" style="background:${c.bg};border-color:${c.border}">
        <div class="eval-col-name" style="color:${c.hex}">Option ${LETTERS[oi]} â€” ${esc(opt.name)}</div>
        <div class="eval-live-score">
          <div class="eval-live-num" id="live-${oi}" style="color:${c.hex}">â€”</div>
          <div class="eval-live-label">/ 100</div>
        </div>
      </div>
      <div class="eval-col-body" style="border-color:${c.border}">${items}</div>`;

    grid.appendChild(col);
    S.criteria.forEach(cr=>renderStepper(oi,cr.id,S.scores[cr.id]?.[oi]??5,cr.invert??false));
    refreshLive(oi);
  });

  const notesRow=document.getElementById('notesRow');
  notesRow.style.gridTemplateColumns=`repeat(${Math.min(nOpts,3)},1fr)`;
  notesRow.innerHTML=S.options.map((opt,oi)=>`
    <div>
      <span class="notes-lbl" style="color:${COLORS[oi].hex}">
        ğŸ“ Notes libres â€” Option ${LETTERS[oi]} (${esc(opt.name)})
      </span>
      <textarea id="note-${oi}" rows="3"
        placeholder="Vos rÃ©flexions, intuitions, ce que les chiffres ne disent pasâ€¦"
        oninput="S.notes[${oi}]=this.value">${esc(S.notes[oi]||'')}</textarea>
    </div>`).join('');
}

/* â”€â”€â”€ STEPPER COLOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function stepColor(raw, invert){
  const eff=invert?(11-raw):raw;
  const t=(eff-1)/9;
  if(t<0.5){
    const f=t/0.5;
    return `rgb(${Math.round(192+( 90-192)*f)},${Math.round(57+(87-57)*f)},${Math.round(43+(80-43)*f)})`;
  } else {
    const f=(t-0.5)/0.5;
    return `rgb(${Math.round(90+(45-90)*f)},${Math.round(87+(138-87)*f)},${Math.round(80+(78-80)*f)})`;
  }
}

function renderStepper(oi,cid,val,invert){
  const color=stepColor(val,invert);
  const vd=document.getElementById(`sv-${oi}-${cid}`);
  if(vd){vd.textContent=val;vd.style.color=color;}
  for(let pi=1;pi<=10;pi++){
    const pip=document.getElementById(`pip-${oi}-${cid}-${pi}`);
    if(!pip) continue;
    if(pi<=val){
      // Height grows with value for a bar-chart feel
      pip.style.height=(8+pi*1.2)+'px';
      pip.style.background=color;
      pip.style.borderColor=color;
    } else {
      pip.style.height='8px';
      pip.style.background='';
      pip.style.borderColor='';
    }
  }
}

function stepVal(oi,cid,delta){
  if(!S.scores[cid]) S.scores[cid]=S.options.map(()=>5);
  const next=Math.min(10,Math.max(1,(S.scores[cid][oi]??5)+delta));
  S.scores[cid][oi]=next;
  const cr=S.criteria.find(c=>c.id===cid);
  renderStepper(oi,cid,next,cr?.invert??false);
  refreshLive(oi);
}

function calcScore(oi){
  let tot=0,max=0;
  S.criteria.forEach(c=>{
    let v=S.scores[c.id]?.[oi]??5;
    if(c.invert) v=11-v;
    tot+=v*c.weight; max+=10*c.weight;
  });
  return Math.round((tot/max)*100);
}

function refreshLive(oi){
  const el=document.getElementById(`live-${oi}`);
  if(el) el.textContent=calcScore(oi);
}

/* â”€â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showResults(){
  S.notes=S.options.map((_,i)=>document.getElementById(`note-${i}`)?.value||'');
  buildResults();
  nav('page-results');
  initScenario();
  setTimeout(drawRadar,150);
  generateInterpretation();
}

function buildResults(){
  const scores=S.options.map((_,i)=>calcScore(i));
  const ranked=[...S.options.map((_,i)=>i)].sort((a,b)=>scores[b]-scores[a]);
  const winner=ranked[0], runner=ranked[1];
  const diff=scores[winner]-scores[runner];
  const tie=diff<=4;
  const cW=COLORS[winner];

  // Verdict
  let vstyle,vemoji,vtitle,vsub;
  if(tie){
    vstyle=`background:#fffbea;border-color:#f0d080`;
    vemoji='âš–ï¸';
    vtitle=`<span style="color:var(--amber)">RÃ©sultat trÃ¨s serrÃ© !</span>`;
    vsub=`Seulement ${diff} point${diff>1?'s':''} d'Ã©cart â€” les deux premiÃ¨res options sont quasiment Ã©quivalentes. Faites confiance Ã  votre intuition.`;
  } else {
    vstyle=`background:${cW.bg};border-color:${cW.border}`;
    vemoji='ğŸ¯';
    vtitle=`<span style="color:${cW.hex}">"${esc(S.options[winner].name)}" ressort en tÃªte</span>`;
    vsub=`Avantage de ${diff} points sur vos critÃ¨res pondÃ©rÃ©s. N'oubliez pas de prendre en compte vos notes et votre ressenti.`;
  }

  // Score cards (ranked)
  const ncols=Math.min(S.options.length,3);
  const scoreCards=ranked.map((oi,rank)=>{
    const c=COLORS[oi]; const sc=scores[oi];
    const rankLabels=['ğŸ¥‡ 1Ã¨re option','ğŸ¥ˆ 2Ã¨me option','ğŸ¥‰ 3Ã¨me option'];
    const rankBadge=rank<3?`<div class="rank-badge" style="background:${c.bg};color:${c.hex};border:1px solid ${c.border}">${rankLabels[rank]}</div>`:'';
    const miniCrits=S.criteria.slice(0,4).map(cr=>{
      const v=S.scores[cr.id]?.[oi]??5;
      return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:.75rem">
        <span style="width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--muted)">${cr.icon} ${cr.name}</span>
        <div style="flex:1;height:5px;background:var(--bg2);border-radius:3px;overflow:hidden">
          <div style="height:100%;width:${v*10}%;background:${c.hex};border-radius:3px"></div>
        </div>
        <span style="width:16px;text-align:right;color:var(--ink2);font-weight:600">${v}</span>
      </div>`;
    }).join('');
    return `
      <div class="score-card${rank===0?' rank-1':''}" style="border-color:${rank===0?c.hex:c.border}">
        ${rankBadge}
        <div class="sc-letter" style="color:${c.hex}">Option ${LETTERS[oi]}</div>        <div class="sc-name">${esc(S.options[oi].name)}</div>
        ${S.options[oi].desc?`<div class="sc-desc">${esc(S.options[oi].desc)}</div>`:''}
        <div class="sc-score-row">
          <div class="sc-num" style="color:${c.hex}">${sc}</div>
          <div class="sc-denom">/100</div>
        </div>
        <div class="sc-bar"><div class="sc-bar-fill" style="width:${sc}%;background:${c.hex}"></div></div>
        ${miniCrits}
      </div>`;
  }).join('');

  // Breakdown
  const bkHeader=`<div class="bk-row hdr">
    <div class="bk-cell crit-col hdr-cell">CritÃ¨re</div>
    ${S.options.map((o,i)=>`<div class="bk-cell opt-col hdr-cell" style="color:${COLORS[i].hex}">${LETTERS[i]}. ${esc(o.name.substring(0,10))}${o.name.length>10?'â€¦':''}</div>`).join('')}
  </div>`;
  const bkRows=S.criteria.map(cr=>{
    const vals=S.options.map((_,i)=>S.scores[cr.id]?.[i]??5);
    const maxV=Math.max(...vals);
    return `<div class="bk-row">
      <div class="bk-cell crit-col">
        ${cr.icon} ${cr.name}
        ${cr.weight>1?`<span style="font-size:.62rem;background:var(--amber-bg);color:var(--amber);padding:2px 5px;border-radius:3px;border:1px solid #f0d080;font-weight:700">Ã—${cr.weight}</span>`:''}
        ${cr.invert?`<span class="inv-tag">â†“</span>`:''}
      </div>
      ${vals.map((v,i)=>{
        const c=COLORS[i];
        return `<div class="bk-cell opt-col"><div class="opt-cell-in">
          <div class="opt-pill" style="background:${c.bg};color:${c.hex};font-weight:${v===maxV?700:400}">${v}</div>
          <div class="mini-bar"><div class="mini-bar-fill" style="width:${v*10}%;background:${c.hex}"></div></div>
        </div></div>`;
      }).join('')}
    </div>`;
  }).join('');

  // Analysis
  const an=genAnalysis(scores,winner,ranked);

  // Notes
  const hasNotes=S.notes.some(n=>n.trim());
  const notesHTML=hasNotes?`
    <div class="notes-res">
      <div class="notes-res-head">ğŸ“ Vos notes personnelles</div>
      <div class="notes-res-body" style="grid-template-columns:repeat(${Math.min(S.options.length,3)},1fr)">
        ${S.options.map((o,i)=>`
          <div class="note-col" style="${i<S.options.length-1?'border-right:1px solid var(--border)':''}">
            <div class="note-col-lbl" style="color:${COLORS[i].hex}">${LETTERS[i]}. ${esc(o.name)}</div>
            <div class="note-col-txt">${esc(S.notes[i])||'<em style="color:var(--muted2)">Aucune note</em>'}</div>
          </div>`).join('')}
      </div>
    </div>`:'';

  document.getElementById('resContent').innerHTML=`
    <div class="res-decision-banner">
      <div class="res-dec-icon">ğŸ¤”</div>
      <div>
        <div class="res-dec-label">Votre dÃ©cision</div>
        <div class="res-dec-text">${esc(S.decision)}</div>
      </div>
    </div>

    <div class="verdict-strip" style="${vstyle}">
      <div class="verdict-icon">${vemoji}</div>
      <div>
        <div class="verdict-title">${vtitle}</div>
        <div class="verdict-sub">${vsub}</div>
      </div>
    </div>

    <div class="interp-box">
      <div class="interp-head">
        <span>ğŸ’¬</span>
        <div class="interp-head-title">InterprÃ©tation personnalisÃ©e</div>
        <div class="interp-badge">IA</div>
      </div>
      <div id="interpContent">
        <div class="interp-loading">
          <div class="skel w100"></div>
          <div class="skel w80"></div>
          <div class="skel w100"></div>
          <div class="skel w60"></div>
        </div>
      </div>
    </div>

    <div class="fear-box" id="fearBox">
      <div class="fear-head" onclick="toggleFearBox()">
        <div class="fear-icon">ğŸ«€</div>
        <div class="fear-head-text">
          <div class="fear-head-title">Et si la peur n'Ã©tait pas un facteur ?</div>
          <div class="fear-head-sub">Lucid masque les critÃ¨res liÃ©s au risque et Ã  la prudence pour rÃ©vÃ©ler votre choix sans biais de peur.</div>
        </div>
        <div class="toggle-wrap">
          <span class="toggle-label" id="fearToggleLabel">Non</span>
          <label class="toggle">
            <input type="checkbox" id="fearToggle" onchange="onFearToggle(this.checked)" onclick="event.stopPropagation()">
            <div class="toggle-track"></div>
            <div class="toggle-thumb"></div>
          </label>
        </div>
      </div>
      <div class="fear-body" id="fearBody"></div>
    </div>

    <div class="scenario-box" id="scenarioBox">
      <div class="scenario-head" onclick="toggleScenarioBox()">
        <div class="scenario-head-icon">ğŸ›ï¸</div>
        <div class="scenario-head-text">
          <div class="scenario-head-title">Testez vos scÃ©narios</div>
          <div class="scenario-head-sub">Activez ou dÃ©sactivez des critÃ¨res pour recalculer les scores instantanÃ©ment.</div>
        </div>
        <div class="scenario-chevron">â–¾</div>
      </div>
      <div class="scenario-body" id="scenarioBody"></div>
    </div>

    <div class="scores-row" id="scoresRow" style="grid-template-columns:repeat(${ncols},1fr)">${scoreCards}</div>

    <div class="radar-section">
      <h3>ğŸ•¸ï¸ Profil visuel des options</h3>
      <canvas id="radarC" width="480" height="360" style="max-width:100%"></canvas>
      <div class="radar-legend">
        ${S.options.map((o,i)=>`<span><span class="leg-dot" style="background:${COLORS[i].hex}"></span>${esc(o.name)}</span>`).join('')}
      </div>
    </div>

    <div class="section-title">ğŸ“Š DÃ©tail des scores par critÃ¨re</div>
    <div class="bk-table">${bkHeader}${bkRows}</div>

    <div class="analysis-box">
      <div class="analysis-head">
        <span>ğŸ§ </span>
        <h3>Analyse synthÃ©tique</h3>
        <div class="ai-badge">Automatique</div>
      </div>
      <div class="analysis-body">
        <div class="an-col pros">
          <h4>âœ¦ Points forts de "${esc(S.options[winner].name)}"</h4>
          ${an.pros.map(p=>`<div class="an-item"><div class="an-dot"></div><span>${p}</span></div>`).join('')}
        </div>
        <div class="an-col cons">
          <h4>âš  Points d'attention</h4>
          ${an.cons.map(p=>`<div class="an-item"><div class="an-dot"></div><span>${p}</span></div>`).join('')}
        </div>
      </div>
    </div>

    ${notesHTML}

    <div class="res-actions">
      <button class="btn btn-secondary" onclick="nav('page-step3')">â† Modifier mes notes</button>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ Exporter en PDF</button>
        <button class="btn btn-primary" onclick="restart()">â†º Nouvelle dÃ©cision</button>
      </div>
    </div>`;
}

/* â”€â”€â”€ AI INTERPRETATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function generateInterpretation(){
  const scores = S.options.map((_,i) => calcScore(i));
  const ranked = [...S.options.map((_,i)=>i)].sort((a,b)=>scores[b]-scores[a]);

  const optionsSummary = S.options.map((o,i) => {
    const critDetails = S.criteria.map(c => {
      const raw = S.scores[c.id]?.[i] ?? 5;
      const eff = c.invert ? 11 - raw : raw;
      return `  - ${c.name} (poids Ã—${c.weight}${c.invert?' [inversÃ©]':''}): ${raw}/10 â†’ effectif ${eff}/10`;
    }).join('\n');
    return `Option ${LETTERS[i]} â€” "${o.name}"${o.desc?' ('+o.desc+')':''}
  Score final: ${scores[i]}/100
${critDetails}${S.notes[i]?'\n  Note personnelle: "'+S.notes[i]+'"':''}`;
  }).join('\n\n');

  const rankedNames = ranked.map(i=>`"${S.options[i].name}" (${scores[i]} pts)`).join(' > ');
  const crucialCriteria = S.criteria.filter(c=>c.weight>=2).map(c=>`${c.name} (Ã—${c.weight})`).join(', ') || 'Aucun';

  const prompt = `Tu es un conseiller bienveillant et direct qui aide les gens Ã  prendre des dÃ©cisions importantes.

L'utilisateur doit dÃ©cider : "${S.decision}"

RÃ©sultats de son analyse multi-critÃ¨res :
Classement : ${rankedNames}

${optionsSummary}

CritÃ¨res les plus importants (Ã—2 ou Ã—3) : ${crucialCriteria}

Ta mission : RÃ©dige un message interprÃ©tatif court (3 Ã  5 phrases) en franÃ§ais, naturel et humain.
- Compare les options sur les points oÃ¹ elles divergent le plus
- RÃ©vÃ¨le ce que les chiffres disent vraiment sur ses prioritÃ©s
- Formule une recommandation nuancÃ©e tenant compte des critÃ¨res importants
- Si serrÃ©, dis-le et oriente vers ce qui compte le plus
- Ã‰cris directement, sans titre, sans bullet, sans intro gÃ©nÃ©rique
- Style : "Option X est plus forte surâ€¦", "Si tu accordes de l'importance Ã â€¦", "Ce que les chiffres rÃ©vÃ¨lent iciâ€¦"
- Tutoie, sois chaleureux mais factuel. 3-5 phrases max.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{role:'user', content: prompt}]
      })
    });
    const data = await res.json();
    const text = data?.content?.[0]?.text || null;
    const el = document.getElementById('interpContent');
    if (!el) return;
    if (text) {
      const formatted = text
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/\n\n/g,'</p><p>')
        .replace(/\n/g,'<br>');
      el.innerHTML=`<div class="interp-body"><div class="interp-text"><p>${formatted}</p></div></div>`;
    } else { throw new Error(); }
  } catch(e) {
    // Fallback local si l'API Ã©choue
    const scores2 = S.options.map((_,i)=>calcScore(i));
    const ranked2 = [...S.options.map((_,i)=>i)].sort((a,b)=>scores2[b]-scores2[a]);
    const w=ranked2[0], r=ranked2[1];
    const diff=scores2[w]-scores2[r];

    const topW = [...S.criteria].sort((a,b)=>{
      const va=(a.invert?11-(S.scores[a.id]?.[w]??5):(S.scores[a.id]?.[w]??5))*a.weight;
      const vb=(b.invert?11-(S.scores[b.id]?.[w]??5):(S.scores[b.id]?.[w]??5))*b.weight;
      return vb-va;
    })[0];
    const topR = [...S.criteria].sort((a,b)=>{
      const va=(a.invert?11-(S.scores[a.id]?.[r]??5):(S.scores[a.id]?.[r]??5))*a.weight;
      const vb=(b.invert?11-(S.scores[b.id]?.[r]??5):(S.scores[b.id]?.[r]??5))*b.weight;
      return vb-va;
    })[0];

    const msg = diff<=4
      ? `Les deux options sont trÃ¨s proches (${scores2[w]} vs ${scores2[r]} pts).`
        +(topW?` "${S.options[w].name}" se dÃ©marque lÃ©gÃ¨rement sur <strong>${topW.name}</strong>.`:'')
        +` Dans ce cas serrÃ©, fais confiance Ã  ton instinct.`
      : `"${S.options[w].name}" ressort en tÃªte avec ${diff} points d'avance.`
        +(topW?` Son principal atout : <strong>${topW.name}</strong>.`:'')
        +(topR?` "${S.options[r].name}" reste plus fort sur <strong>${topR.name}</strong> â€” Ã  peser si c'est une prioritÃ©.`:'');

    const el=document.getElementById('interpContent');
    if(el) el.innerHTML=`<div class="interp-body"><div class="interp-text"><p>${msg}</p></div></div>`;
  }
}

/* â”€â”€â”€ SCENARIO PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// Set des IDs de critÃ¨res actifs dans le scÃ©nario (tous actifs par dÃ©faut)
let S_active = new Set();

function initScenario(){
  S_active = new Set(S.criteria.map(c=>c.id));
  renderScenarioBody();
}

function toggleScenarioBox(){
  document.getElementById('scenarioBox').classList.toggle('open');
}

function calcScoreScenario(oi){
  let tot=0, max=0;
  S.criteria.forEach(c=>{
    if(!S_active.has(c.id)) return;
    let v=S.scores[c.id]?.[oi]??5;
    if(c.invert) v=11-v;
    tot+=v*c.weight; max+=10*c.weight;
  });
  if(max===0) return 0;
  return Math.round((tot/max)*100);
}

function toggleScenarioCrit(id){
  if(S_active.has(id)) S_active.delete(id);
  else S_active.add(id);
  // Toujours au moins 1 critÃ¨re actif
  if(S_active.size===0) S_active.add(id);
  renderScenarioBody();
  updateScenarioScores();
}

function resetScenario(){
  S_active = new Set(S.criteria.map(c=>c.id));
  renderScenarioBody();
  updateScenarioScores();
}

function renderScenarioBody(){
  const body = document.getElementById('scenarioBody');
  if(!body) return;
  const activeCount = S_active.size;
  const rows = S.criteria.map(c=>{
    const on = S_active.has(c.id);
    return `
      <div class="sc-crit-row${on?'':' off'}">
        <div class="sc-crit-icon">${c.icon}</div>
        <div class="sc-crit-name">${c.name}</div>
        ${c.weight>1?`<span class="sc-crit-weight">Ã—${c.weight}</span>`:''}
        ${c.invert?`<span class="sc-crit-inv">â†“ inversÃ©</span>`:''}
        <label class="mini-toggle" title="${on?'DÃ©sactiver':'Activer'} ce critÃ¨re">
          <input type="checkbox" ${on?'checked':''} onchange="toggleScenarioCrit('${c.id}')">
          <div class="mini-toggle-track"></div>
          <div class="mini-toggle-thumb"></div>
        </label>
      </div>`;
  }).join('');

  const insight = genScenarioInsight();

  body.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2px">
      <span style="font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em">
        ${activeCount} / ${S.criteria.length} critÃ¨res actifs
      </span>
      <button class="scenario-reset" onclick="resetScenario()">Tout rÃ©activer</button>
    </div>
    <div class="sc-crit-list">${rows}</div>
    <div class="scenario-summary">${insight}</div>`;
}

function genScenarioInsight(){
  const disabledCrits = S.criteria.filter(c=>!S_active.has(c.id));

  // Aucun critÃ¨re dÃ©sactivÃ© â€” analyse complÃ¨te
  if(disabledCrits.length === 0){
    return `âœ… Tous les critÃ¨res sont actifs â€” c'est votre analyse complÃ¨te, sans filtre.`;
  }

  const baseScores  = S.options.map((_,i)=>calcScore(i));
  const scenScores  = S.options.map((_,i)=>calcScoreScenario(i));
  const baseRanked  = [...S.options.map((_,i)=>i)].sort((a,b)=>baseScores[b]-baseScores[a]);
  const scenRanked  = [...S.options.map((_,i)=>i)].sort((a,b)=>scenScores[b]-scenScores[a]);

  const baseWinner  = baseRanked[0];
  const scenWinner  = scenRanked[0];
  const switched    = scenWinner !== baseWinner;

  const disabledNames = disabledCrits.map(c=>`<strong>${c.name}</strong>`).join(' et ');
  const plural        = disabledCrits.length > 1;

  // Trouver l'option la plus impactÃ©e (+ ou -)
  const deltas = S.options.map((_,i)=>({ i, d: scenScores[i]-baseScores[i] }));
  const bigGainer  = deltas.reduce((a,b)=>b.d>a.d?b:a);
  const bigLoser   = deltas.reduce((a,b)=>b.d<a.d?b:a);

  // Cas 1 â€” le classement s'inverse
  if(switched){
    const newName  = S.options[scenWinner].name;
    const oldName  = S.options[baseWinner].name;
    const gain     = scenScores[scenWinner] - baseScores[scenWinner];
    const gainSign = gain>=0?`+${gain}`:gain;
    return `ğŸ”„ Sans ${disabledNames}, le classement <strong>s'inverse</strong> : <strong>"${esc(newName)}"</strong> passe en tÃªte (${gainSign} pts), devant <strong>"${esc(oldName)}"</strong>. Ce${plural?'s':''} critÃ¨re${plural?'s':''} ${plural?'jouaient':'jouait'} donc un rÃ´le dÃ©cisif en faveur de l'option initiale.`;
  }

  // Cas 2 â€” mÃªme gagnant mais Ã©cart significativement rÃ©duit
  const baseGap = baseScores[baseWinner] - baseScores[baseRanked[1]];
  const scenGap = scenScores[scenWinner] - scenScores[scenRanked[1]];
  if(scenGap < baseGap && baseGap - scenGap >= 6){
    const gapDiff = baseGap - scenGap;
    return `âš ï¸ <strong>"${esc(S.options[baseWinner].name)}"</strong> reste en tÃªte, mais son avantage se rÃ©duit de <strong>${gapDiff} points</strong> sans ${disabledNames}. Ce${plural?'s':''} critÃ¨re${plural?'s':''} ${plural?'constituent':'constitue'} une part importante de son avance â€” la dÃ©cision serait plus serrÃ©e sans ${plural?'eux':'lui'}.`;
  }

  // Cas 3 â€” mÃªme gagnant, Ã©cart qui se creuse
  if(scenGap > baseGap + 5){
    return `âœ… Sans ${disabledNames}, <strong>"${esc(S.options[baseWinner].name)}"</strong> se dÃ©tache encore davantage (+${scenGap - baseGap} pts d'Ã©cart supplÃ©mentaires). Ce${plural?'s':''} critÃ¨re${plural?'s':''} ne ${plural?'sont':'est'} pas ce qui fait la force de cette option â€” son avance repose sur d'autres facteurs.`;
  }

  // Cas 4 â€” une option gagne beaucoup, une autre perd beaucoup
  if(bigGainer.d >= 8 && bigGainer.i !== bigLoser.i && bigLoser.d <= -8){
    const gName = S.options[bigGainer.i].name;
    const lName = S.options[bigLoser.i].name;
    return `ğŸ“Š Ce scÃ©nario rÃ©vÃ¨le une divergence nette : <strong>"${esc(gName)}"</strong> gagne +${bigGainer.d} pts tandis que <strong>"${esc(lName)}"</strong> en perd ${Math.abs(bigLoser.d)}. ${disabledNames} ${plural?'pÃ¨sent':'pÃ¨se'} donc diffÃ©remment sur chaque option.`;
  }

  // Cas 5 â€” impact faible sur tous
  const maxDelta = Math.max(...deltas.map(d=>Math.abs(d.d)));
  if(maxDelta <= 4){
    return `ğŸ“Œ DÃ©sactiver ${disabledNames} ne change presque rien aux scores (moins de ${maxDelta+1} pts d'Ã©cart). ${plural?'Ces critÃ¨res ne sont pas':'Ce critÃ¨re n\u2019est pas'} dÃ©terminant${plural?'s':''} dans cette dÃ©cision â€” les autres facteurs portent l'essentiel du rÃ©sultat.`;
  }

  // Cas 6 â€” fallback gÃ©nÃ©rique mais enrichi
  const mostImpacted = deltas.reduce((a,b)=>Math.abs(b.d)>Math.abs(a.d)?b:a);
  const sign = mostImpacted.d >= 0 ? `+${mostImpacted.d}` : `${mostImpacted.d}`;
  return `ğŸ¯ Sans ${disabledNames}, l'option la plus impactÃ©e est <strong>"${esc(S.options[mostImpacted.i].name)}"</strong> (${sign} pts). Le classement reste identique, mais ce scÃ©nario montre Ã  quel point ${plural?'ces critÃ¨res influencent':'ce critÃ¨re influence'} la position de cette option.`;
}


function updateScenarioScores(){
  const baseScores  = S.options.map((_,i)=>calcScore(i));
  const scenScores  = S.options.map((_,i)=>calcScoreScenario(i));
  const scenRanked  = [...S.options.map((_,i)=>i)].sort((a,b)=>scenScores[b]-scenScores[a]);
  const baseRanked  = [...S.options.map((_,i)=>i)].sort((a,b)=>baseScores[b]-baseScores[a]);
  const allActive   = S_active.size === S.criteria.length;

  const row = document.getElementById('scoresRow');
  if(!row) return;

  // Rebuild score cards with updated values
  const ncols = Math.min(S.options.length,3);
  row.style.gridTemplateColumns=`repeat(${ncols},1fr)`;

  // Re-rank by scenario scores
  const rankLabels=['ğŸ¥‡ 1Ã¨re option','ğŸ¥ˆ 2Ã¨me option','ğŸ¥‰ 3Ã¨me option'];
  row.innerHTML = scenRanked.map((oi,rank)=>{
    const c = COLORS[oi];
    const sc = scenScores[oi];
    const base = baseScores[oi];
    const delta = sc - base;
    const deltaHTML = allActive ? '' :
      `<span class="sc-scenario-delta ${delta>2?'up':delta<-2?'down':'same'}">
        ${delta>0?'+':''}${delta} pts
      </span>`;

    const rankBadge = rank<3
      ? `<div class="rank-badge" style="background:${c.bg};color:${c.hex};border:1px solid ${c.border}">${rankLabels[rank]}</div>`
      : '';

    const miniCrits = [...S_active].map(id=>{
      const cr = S.criteria.find(x=>x.id===id); if(!cr) return '';
      const v = S.scores[cr.id]?.[oi]??5;
      return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:.75rem">
        <span style="width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--muted)">${cr.icon} ${cr.name}</span>
        <div style="flex:1;height:5px;background:var(--bg2);border-radius:3px;overflow:hidden">
          <div style="height:100%;width:${v*10}%;background:${c.hex};border-radius:3px"></div>
        </div>
        <span style="width:16px;text-align:right;color:var(--ink2);font-weight:600">${v}</span>
      </div>`;
    }).slice(0,4).join('');

    return `
      <div class="score-card${rank===0?' rank-1':''}" style="border-color:${rank===0?c.hex:c.border}">
        ${rankBadge}
        <div class="sc-letter" style="color:${c.hex}">Option ${LETTERS[oi]}</div>
        <div class="sc-name">${esc(S.options[oi].name)}</div>
        ${S.options[oi].desc?`<div class="sc-desc">${esc(S.options[oi].desc)}</div>`:''}
        <div class="sc-score-row">
          <div class="sc-num" style="color:${c.hex}">${sc}</div>
          <div class="sc-denom">/100</div>
          ${deltaHTML}
        </div>
        <div class="sc-bar"><div class="sc-bar-fill" style="width:${sc}%;background:${c.hex}"></div></div>
        ${miniCrits}
      </div>`;
  }).join('');

  // Redraw radar with scenario scores
  setTimeout(()=>drawRadarScenario(scenScores),50);

  // Refresh narrative insight in panel
  const insightEl = document.querySelector('#scenarioBody .scenario-summary');
  if(insightEl) insightEl.innerHTML = genScenarioInsight();
}

/* â”€â”€â”€ FEAR TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// IDs de critÃ¨res considÃ©rÃ©s comme "liÃ©s Ã  la peur/prudence"
// Ces critÃ¨res sont dÃ©tectÃ©s silencieusement, l'utilisateur ne les nomme jamais
const FEAR_IDS = new Set([
  'fin_risk',  // Risque financier
  'risk',      // Risque global
  'stress',    // Niveau de stress
  'jobsec',    // SÃ©curitÃ© de l'emploi
  'fin_stab',  // StabilitÃ© financiÃ¨re
  'cost',      // CoÃ»t initial
  'rev',       // RÃ©versibilitÃ©
  'complex',   // ComplexitÃ©
  'dep',       // DÃ©pendances
  'workload',  // Charge de travail
]);

// DÃ©tecte aussi les critÃ¨res custom qui contiennent des mots-clÃ©s de peur
function isFearCrit(c){
  if(FEAR_IDS.has(c.id)) return true;
  if(c.custom){
    const fearWords=/risque|peur|stress|sÃ©curitÃ©|securite|danger|incertitude|coÃ»t|cout|complexitÃ©|complexite|difficultÃ©|difficulte|charge|instabilitÃ©|instabilite|anxiÃ©tÃ©|anxiete/i;
    return fearWords.test(c.name);
  }
  return false;
}

function calcScoreFiltered(oi, excludeIds){
  let tot=0, max=0;
  S.criteria.forEach(c=>{
    if(excludeIds.has(c.id)) return;
    let v=S.scores[c.id]?.[oi]??5;
    if(c.invert) v=11-v;
    tot+=v*c.weight; max+=10*c.weight;
  });
  if(max===0) return null;
  return Math.round((tot/max)*100);
}

function toggleFearBox(){
  document.getElementById('fearBox').classList.toggle('open');
}

function onFearToggle(checked){
  document.getElementById('fearBox').classList.add('open');
  document.getElementById('fearToggleLabel').textContent = checked ? 'Oui' : 'Non';
  document.getElementById('fearToggleLabel').className = 'toggle-label' + (checked ? ' on' : '');
  renderFearBody(checked);
}

function renderFearBody(active){
  const fearCrits = S.criteria.filter(isFearCrit);
  const fearIds   = new Set(fearCrits.map(c=>c.id));
  const body      = document.getElementById('fearBody');

  if(fearCrits.length === 0){
    body.innerHTML=`<div class="fear-none">Aucun critÃ¨re liÃ© Ã  la peur ou au risque n'a Ã©tÃ© sÃ©lectionnÃ© dans votre analyse.</div>`;
    return;
  }

  // Tags des critÃ¨res dÃ©tectÃ©s
  const allTags = S.criteria.map(c=>{
    const isFear = isFearCrit(c);
    const cls = (!active || !isFear) ? 'active' : 'inactive';
    return `<span class="fear-crit-tag ${cls}">${c.icon} ${c.name}${isFear&&active?' âœ•':''}</span>`;
  }).join('');

  // Scores normaux vs sans peur
  const normalScores = S.options.map((_,i)=>calcScore(i));
  const fearlessScores = S.options.map((_,i)=>active?calcScoreFiltered(i,fearIds):null);

  const ranked = [...S.options.map((_,i)=>i)].sort((a,b)=>normalScores[b]-normalScores[a]);
  const fearlessRanked = active
    ? [...S.options.map((_,i)=>i)].sort((a,b)=>(fearlessScores[b]??0)-(fearlessScores[a]??0))
    : null;

  const winnerNormal    = ranked[0];
  const winnerFearless  = fearlessRanked?.[0];
  const switchedWinner  = active && winnerFearless !== winnerNormal;

  // Lignes de comparaison par option
  const rows = ranked.map(oi=>{
    const c = COLORS[oi];
    const ns = normalScores[oi];
    const fs = fearlessScores?.[oi] ?? null;
    let deltaHTML = '';
    if(active && fs !== null){
      const d = fs - ns;
      const cls = d > 2 ? 'up' : d < -2 ? 'down' : 'same';
      const sign = d > 0 ? '+' : '';
      deltaHTML = `<span class="fear-delta ${cls}">${sign}${d} pts sans peur</span>`;
    }
    return `
      <div class="fear-opt-row">
        <div class="fear-opt-name" style="color:${c.hex}">${LETTERS[oi]}. ${esc(S.options[oi].name)}</div>
        <div class="fear-scores">
          <div class="fear-score-block">
            <div class="fear-score-val" style="color:${c.hex}">${ns}</div>
            <div class="fear-score-lbl">Score rÃ©el</div>
          </div>
          ${active && fs!==null ? `
          <div class="fear-arrow">â†’</div>
          <div class="fear-score-block">
            <div class="fear-score-val" style="color:#7c3aed">${fs}</div>
            <div class="fear-score-lbl">Sans peur</div>
          </div>
          ${deltaHTML}` : ''}
        </div>
      </div>`;
  }).join('');

  // Insight narratif
  let insight = '';
  if(active){
    if(switchedWinner){
      insight=`<div class="fear-insight">
        ğŸ’¡ Sans les critÃ¨res de prudence, <strong>"${esc(S.options[winnerFearless].name)}"</strong> passerait en tÃªte â€” 
        alors que <strong>"${esc(S.options[winnerNormal].name)}"</strong> gagne dans l'analyse complÃ¨te.
        Ce que cela rÃ©vÃ¨le : <strong>c'est probablement la peur qui oriente votre dÃ©cision vers "${esc(S.options[winnerNormal].name)}"</strong>.
        Est-ce un choix voulu ou un rÃ©flexe de prudence ?
      </div>`;
    } else {
      const maxDelta = ranked.reduce((best,oi)=>{
        const d = (fearlessScores[oi]??0) - normalScores[oi];
        return Math.abs(d) > Math.abs(best.d) ? {oi,d} : best;
      },{oi:ranked[0],d:0});

      if(Math.abs(maxDelta.d) > 5){
        const dir = maxDelta.d > 0 ? 'gagne' : 'perd';
        insight=`<div class="fear-insight">
          ğŸ’¡ Le classement ne change pas, mais <strong>"${esc(S.options[maxDelta.oi].name)}"</strong>
          ${dir} <strong>${Math.abs(maxDelta.d)} points</strong> une fois la peur mise de cÃ´tÃ©.
          ${maxDelta.d > 0
            ? `Votre intuition profonde lui est plus favorable que vos chiffres actuels ne le montrent.`
            : `La prudence vous protÃ¨ge mais pÃ¨se aussi sur cette option.`}
        </div>`;
      } else {
        insight=`<div class="fear-insight">
          ğŸ’¡ Le classement reste identique avec ou sans les critÃ¨res de peur.
          Votre dÃ©cision semble cohÃ©rente â€” elle n'est pas fortement biaisÃ©e par la prudence.
        </div>`;
      }
    }
  }

  body.innerHTML=`
    <div style="font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;">
      ${active ? 'ğŸ­ CritÃ¨res masquÃ©s (liÃ©s Ã  la peur)' : 'ğŸ” CritÃ¨res dÃ©tectÃ©s comme liÃ©s Ã  la peur'}
    </div>
    <div class="fear-crits">${allTags}</div>
    <div class="fear-comparison">${rows}</div>
    ${insight}`;
}

function genAnalysis(scores,winner,ranked){
  const wName=S.options[winner].name;
  const pros=[],cons=[];
  const sortW=[...S.criteria].sort((a,b)=>{
    let va=S.scores[a.id]?.[winner]??5,vb=S.scores[b.id]?.[winner]??5;
    if(a.invert)va=11-va;if(b.invert)vb=11-vb;
    return(vb*b.weight)-(va*a.weight);
  });
  sortW.slice(0,2).forEach(c=>{
    const v=S.scores[c.id]?.[winner]??5;
    pros.push(`Score Ã©levÃ© sur Â« ${c.name} Â» (${v}/10)${c.weight>1?` â€” critÃ¨re d'importance Ã—${c.weight}`:''}.`);
  });
  const diff=scores[ranked[0]]-scores[ranked[1]];
  if(diff>15) pros.push(`Avantage significatif de ${diff} points â€” la recommandation est claire.`);
  else if(diff<=4) pros.push(`RÃ©sultat serrÃ© â€” d'autres facteurs non quantifiables peuvent faire la diffÃ©rence.`);
  if(ranked.length>1){
    const ru=ranked[1];
    const sortR=[...S.criteria].sort((a,b)=>{
      let va=S.scores[a.id]?.[ru]??5,vb=S.scores[b.id]?.[ru]??5;
      if(a.invert)va=11-va;if(b.invert)vb=11-vb;
      return(vb*b.weight)-(va*a.weight);
    });
    sortR.slice(0,2).forEach(c=>{
      const vW=S.scores[c.id]?.[winner]??5,vR=S.scores[c.id]?.[ru]??5;
      if(vR>vW) cons.push(`"${esc(S.options[ru].name)}" fait mieux sur Â« ${c.name} Â» (${vR} vs ${vW}).`);
    });
  }
  S.criteria.filter(c=>c.weight===3).forEach(c=>{
    const v=S.scores[c.id]?.[winner]??5;
    if(v<5) cons.push(`CritÃ¨re crucial Â« ${c.name} Â» : score faible pour "${esc(wName)}" (${v}/10) â€” Ã  surveiller.`);
  });
  if(!cons.length) cons.push(`Pas de faiblesse critique identifiÃ©e â€” l'option est solide sur tous les critÃ¨res.`);
  return{pros:pros.slice(0,3),cons:cons.slice(0,3)};
}

/* â”€â”€â”€ RADAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function drawRadar(){ drawRadarScenario(null); }

function drawRadarScenario(overrideScores){
  const canvas=document.getElementById('radarC'); if(!canvas) return;
  // Only draw axes for active criteria in scenario mode
  const activeCrits = overrideScores
    ? S.criteria.filter(c=>S_active.has(c.id))
    : S.criteria;
  if(activeCrits.length<3) return;

  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height,cx=W/2,cy=H/2;
  const N=activeCrits.length;
  const R=Math.min(W,H)/2-64;
  ctx.clearRect(0,0,W,H);
  const angle=i=>(i/N)*Math.PI*2-Math.PI/2;

  // Grid
  [2,4,6,8,10].forEach(lvl=>{
    ctx.beginPath();
    activeCrits.forEach((_,i)=>{
      const a=angle(i),r=(lvl/10)*R;
      i===0?ctx.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a)):ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));
    });
    ctx.closePath();
    ctx.strokeStyle='rgba(0,0,0,0.07)';ctx.lineWidth=1;ctx.stroke();
  });
  activeCrits.forEach((_,i)=>{
    ctx.beginPath();ctx.moveTo(cx,cy);
    ctx.lineTo(cx+R*Math.cos(angle(i)),cy+R*Math.sin(angle(i)));
    ctx.strokeStyle='rgba(0,0,0,0.08)';ctx.lineWidth=1;ctx.stroke();
  });

  // Labels
  ctx.font='11px Plus Jakarta Sans,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  activeCrits.forEach((c,i)=>{
    const a=angle(i),x=cx+(R+44)*Math.cos(a),y=cy+(R+44)*Math.sin(a);
    ctx.fillStyle='#8a877f';
    ctx.fillText(c.icon,x,y-6);
    const short=c.name.length>13?c.name.substring(0,12)+'â€¦':c.name;
    ctx.fillText(short,x,y+8);
  });

  // Polygons â€” per-criteria raw score on active axes
  S.options.forEach((_,oi)=>{
    const col=COLORS[oi];
    ctx.beginPath();
    activeCrits.forEach((c,i)=>{
      const v=S.scores[c.id]?.[oi]??5,a=angle(i),r=(v/10)*R;
      i===0?ctx.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a)):ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));
    });
    ctx.closePath();
    const hex=col.hex.replace('#','');
    const r=parseInt(hex.substring(0,2),16),g=parseInt(hex.substring(2,4),16),b=parseInt(hex.substring(4,6),16);
    ctx.fillStyle=`rgba(${r},${g},${b},0.12)`;ctx.fill();
    ctx.strokeStyle=col.hex;ctx.lineWidth=2.5;ctx.stroke();
  });
}


/* â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function esc(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function shake(id){
  const el=document.getElementById(id); if(!el) return;
  el.style.borderColor='var(--red)';el.focus();
  setTimeout(()=>el.style.borderColor='',1800);
}
function restart(){
  S={decision:'',options:[{name:'',desc:''},{name:'',desc:''}],criteria:[],scores:{},notes:[],currentCat:'Tous'};
  document.getElementById('inp-dec').value='';
  renderOptBuilder();
  renderStepProgress(1);
  nav('page-intro');
}
</script>
</body>
</html>

