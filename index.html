<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucid â€” Aide Ã  la dÃ©cision</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Lora:wght@600;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:       #f5f4f0;
  --bg2:      #eceae4;
  --white:    #ffffff;
  --border:   #e2dfd8;
  --border2:  #cdc9c0;
  --ink:      #1a1917;
  --ink2:     #3d3b36;
  --muted:    #8a877f;
  --muted2:   #b8b4ac;
  --teal:     #2d7d5a;
  --teal2:    #389e71;
  --teal-bg:  #eef7f2;
  --teal-bd:  #b6ddc9;
  --green:    #2d8a4e;
  --green-bg: #eaf4ee;
  --red:      #c0392b;
  --red-bg:   #fdecea;
  --amber:    #b8820a;
  --amber-bg: #fef6e4;
  --r:        14px;
  --r-sm:     9px;
  --shadow:   0 2px 12px rgba(0,0,0,0.07);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.1);
}

/* â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;overflow-x:hidden;}
body{
  background:var(--bg);
  color:var(--ink);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:15px;
  line-height:1.6;
  min-height:100vh;
  overflow-x:hidden;
}

/* â”€â”€ PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page{display:none;min-height:100vh;flex-direction:column;}
.page.active{display:flex;}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-header{
  background:var(--white);
  border-bottom:1px solid var(--border);
  padding:14px 28px;
  display:flex;align-items:center;
  position:sticky;top:0;z-index:50;
  box-shadow:0 1px 4px rgba(0,0,0,0.05);
}
.app-header .step-progress{
  position:absolute;left:50%;transform:translateX(-50%);
}
.app-header .lang-switcher{
  margin-left:auto;position:static;
}
.logo{
  font-family:'Lora',serif;
  font-size:1.3rem;font-weight:700;
  color:var(--ink);
  letter-spacing:-.02em;
  display:flex;align-items:center;gap:6px;
}
.logo-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--teal);
  display:inline-block;
}

/* Step progress in header */
.step-progress{
  margin-left:auto;
  display:flex;align-items:center;gap:0;
}
.sp-step{
  display:flex;align-items:center;gap:7px;
  padding:6px 14px;border-radius:30px;
  font-size:.75rem;font-weight:600;
  color:var(--muted);
  transition:all .2s;
}
.sp-step.active{background:var(--teal-bg);color:var(--teal);}
.sp-step.done{color:var(--muted2);}
.sp-num{
  width:22px;height:22px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:.72rem;font-weight:700;
  background:var(--bg2);color:var(--muted);
  flex-shrink:0;transition:all .2s;
}
.sp-step.active .sp-num{background:var(--teal);color:#fff;}
.sp-step.done .sp-num{background:var(--green);color:#fff;}
.sp-arrow{color:var(--muted2);font-size:.75rem;padding:0 2px;}

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{
  flex:1;
  padding:36px 28px 72px;
  max-width:960px;
  margin:0 auto;
  width:100%;
}

/* â”€â”€ ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes up{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none}}
.anim{animation:up .4s ease both;}
.d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.16s}.d4{animation-delay:.22s}

/* â”€â”€ TYPOGRAPHY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-eyebrow{
  display:inline-flex;align-items:center;gap:6px;
  font-size:.72rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;
  color:var(--teal);background:var(--teal-bg);
  padding:4px 12px;border-radius:20px;border:1px solid var(--teal-bd);
  margin-bottom:14px;
}
.page-title{
  font-family:'Lora',serif;
  font-size:clamp(1.7rem,3.5vw,2.4rem);
  font-weight:700;line-height:1.2;
  color:var(--ink);margin-bottom:8px;
}
.page-sub{
  font-size:.93rem;color:var(--muted);
  line-height:1.65;max-width:520px;margin-bottom:32px;
}

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{
  background:var(--white);
  border:1px solid var(--border);
  border-radius:var(--r);
  box-shadow:var(--shadow);
}

/* â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field{margin-bottom:18px;}
.field>label{
  display:block;font-size:.78rem;font-weight:700;
  color:var(--ink2);margin-bottom:6px;letter-spacing:.02em;
}
input[type=text],textarea,select{
  width:100%;
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:var(--r-sm);
  color:var(--ink);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.95rem;padding:12px 14px;
  outline:none;resize:none;appearance:none;
  transition:border-color .18s,box-shadow .18s;
}
input[type=text]:focus,textarea:focus,select:focus{
  border-color:var(--teal2);
  box-shadow:0 0 0 3px rgba(45,125,90,.12);
}
input[type=text]::placeholder,textarea::placeholder{color:var(--muted2);}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.88rem;font-weight:600;
  padding:11px 22px;border-radius:var(--r-sm);
  border:none;cursor:pointer;
  transition:all .18s;
  display:inline-flex;align-items:center;gap:7px;
}
.btn-primary{background:var(--teal);color:#fff;}
.btn-primary:hover{background:var(--teal2);transform:translateY(-1px);box-shadow:0 6px 20px rgba(45,125,90,.25);}
.btn-secondary{background:var(--white);color:var(--ink2);border:1.5px solid var(--border);}
.btn-secondary:hover{border-color:var(--border2);background:var(--bg);}
.btn-row{display:flex;align-items:center;justify-content:space-between;margin-top:32px;gap:12px;}

/* â”€â”€ MASCOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mascot-wrap{
  margin-bottom:18px;
  animation:up .5s ease both;
}
.mascot{
  width:100px;height:auto;
  animation:mascot-float 3.2s ease-in-out infinite;
  overflow:visible;
}
.mascot-shadow{
  animation:mascot-shadow 3.2s ease-in-out infinite;
}

.mascot-blink{
  animation:blink-anim 5s ease-in-out infinite;
}

@keyframes mascot-float{
  0%,100%{ transform:translateY(0); }
  50%     { transform:translateY(-7px); }
}
@keyframes mascot-shadow{
  0%,100%{ transform:scaleX(1);   opacity:.7; }
  50%     { transform:scaleX(.75); opacity:.35; }
}

@keyframes blink-anim{
  0%,88%,94%,100%{ opacity:0; }
  90%,92%        { opacity:1; }
}

/* â”€â”€ INTRO PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#page-intro{ background:var(--white); }

.intro-wrap{
  width:100%;
  min-height:100dvh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:32px 20px;
  box-sizing:border-box;
}
.intro-inner{
  display:flex;flex-direction:column;
  align-items:center;
  text-align:center;
  width:100%;
  max-width:600px;
}
.intro-badge{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--teal-bg);color:var(--teal);
  border:1px solid var(--teal-bd);
  font-size:.72rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;
  padding:4px 12px;border-radius:20px;margin-bottom:14px;
  animation:up .5s ease both;flex-shrink:0;
}
.intro-logo{
  font-family:'Lora',serif;
  font-size:clamp(2.8rem,9vw,6.5rem);
  font-weight:700;color:var(--ink);line-height:1;
  margin-bottom:10px;flex-shrink:0;
  animation:up .5s .08s ease both;
}
.intro-logo span{color:var(--teal);}
.intro-tagline{
  font-size:clamp(.88rem,2vw,1.1rem);color:var(--muted);
  font-weight:400;max-width:420px;margin:0 auto 20px;
  animation:up .5s .16s ease both;flex-shrink:0;
}
.intro-how{
  display:grid;grid-template-columns:repeat(3,1fr);
  gap:10px;width:100%;margin:0 auto 24px;
  animation:up .5s .24s ease both;flex-shrink:0;
}
.how-card{
  background:var(--bg);border:1px solid var(--border);
  border-radius:var(--r);padding:14px 10px;
  text-align:center;
}
.how-num{
  width:28px;height:28px;border-radius:50%;
  background:var(--teal);color:#fff;
  font-size:.75rem;font-weight:700;
  display:flex;align-items:center;justify-content:center;
  margin:0 auto 8px;
}
.how-title{font-size:.8rem;font-weight:700;color:var(--ink);margin-bottom:3px;}
.how-desc{font-size:.7rem;color:var(--muted);line-height:1.4;}
.intro-start-btn{
  animation:up .5s .32s ease both;
  font-size:1rem;padding:14px 40px;border-radius:12px;
  background:var(--teal);color:#fff;
  border:none;font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;
  cursor:pointer;transition:all .2s;flex-shrink:0;
  box-shadow:0 4px 16px rgba(45,125,90,.3);
  width:100%;max-width:320px;
}
.intro-start-btn:hover{background:var(--teal2);transform:translateY(-2px);box-shadow:0 10px 28px rgba(45,125,90,.35);}

/* On very small screens, hide how-cards description text */
@media(max-height:640px){
  .how-desc{display:none;}
  .how-card{padding:10px 8px;}
  .intro-how{margin-bottom:16px;}
  .intro-tagline{margin-bottom:14px;}
}

/* â”€â”€ AI INTERPRETATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.interp-box{
  background:var(--white);
  border:1.5px solid var(--teal-bd);
  border-radius:var(--r);
  margin-bottom:24px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.interp-head{
  display:flex;align-items:center;gap:10px;
  padding:13px 18px;
  background:var(--teal-bg);
  border-bottom:1px solid var(--teal-bd);
}
.interp-head-title{font-size:.88rem;font-weight:700;color:var(--teal);}
.interp-badge{
  font-size:.62rem;font-weight:700;letter-spacing:.08em;
  background:var(--teal);color:#fff;
  padding:2px 8px;border-radius:5px;text-transform:uppercase;
}
.interp-body{padding:20px 22px;}
.interp-text{
  font-size:.95rem;color:var(--ink2);line-height:1.75;
  font-weight:400;
}
.interp-text strong{color:var(--ink);font-weight:700;}

/* Loading skeleton */
.interp-loading{
  display:flex;flex-direction:column;gap:10px;padding:20px 22px;
}
.skel{
  height:14px;border-radius:6px;
  background:linear-gradient(90deg,var(--bg) 25%,var(--bg2) 50%,var(--bg) 75%);
  background-size:200% 100%;
  animation:shimmer 1.4s infinite;
}
.skel.w100{width:100%;}
.skel.w80{width:80%;}
.skel.w60{width:60%;}
@keyframes shimmer{from{background-position:200% 0}to{background-position:-200% 0}}

/* â”€â”€ STEP 1 â€” OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.decision-card{
  padding:24px;margin-bottom:20px;
  position:relative;overflow:visible;
}
.options-list{display:flex;flex-direction:column;gap:12px;margin-bottom:14px;}
.opt-card{border-radius:var(--r);overflow:hidden;border:1.5px solid var(--border);background:var(--white);box-shadow:var(--shadow);}
.opt-card-head{
  display:flex;align-items:center;gap:10px;
  padding:13px 16px;cursor:pointer;user-select:none;
  background:var(--bg);border-bottom:1px solid var(--border);
  transition:background .15s;
}
.opt-card-head:hover{background:var(--bg2);}
.opt-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.opt-letter{
  font-size:.72rem;font-weight:800;letter-spacing:.1em;text-transform:uppercase;
}
.opt-name-preview{
  margin-left:auto;font-size:.82rem;color:var(--muted);
  max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.opt-chevron{color:var(--muted2);font-size:.75rem;transition:transform .2s;margin-left:6px;}
.opt-card.open .opt-chevron{transform:rotate(180deg);}
.opt-card-body{padding:16px;display:none;}
.opt-card.open .opt-card-body{display:block;}
.opt-rm{
  width:26px;height:26px;border-radius:7px;
  background:transparent;border:1px solid var(--border);
  color:var(--muted);cursor:pointer;font-size:.8rem;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;
  flex-shrink:0;
}
.opt-rm:hover{background:var(--red-bg);border-color:var(--red);color:var(--red);}

.add-option-btn{
  width:100%;display:flex;align-items:center;gap:10px;
  background:var(--white);border:1.5px dashed var(--border2);
  border-radius:var(--r);padding:14px 18px;
  cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.85rem;font-weight:600;color:var(--muted);
  transition:all .18s;
}
.add-option-btn:hover{border-color:var(--teal2);color:var(--teal);background:var(--teal-bg);}
.add-option-icon{
  width:28px;height:28px;border-radius:8px;
  background:var(--bg);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;transition:all .18s;
}
.add-option-btn:hover .add-option-icon{background:var(--teal);color:#fff;border-color:var(--teal);}

/* â”€â”€ STEP 2 â€” CRITERIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.criteria-intro{
  background:var(--amber-bg);border:1px solid #f0d080;
  border-radius:var(--r);padding:14px 18px;
  margin-bottom:22px;
  display:flex;align-items:flex-start;gap:10px;
  font-size:.85rem;color:var(--amber);line-height:1.5;
}
.criteria-intro-icon{font-size:1.1rem;flex-shrink:0;margin-top:1px;}

.cat-tabs{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:18px;}
.cat-tab{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:30px;color:var(--muted);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:.78rem;font-weight:600;
  padding:6px 14px;cursor:pointer;transition:all .15s;
}
.cat-tab:hover{border-color:var(--border2);color:var(--ink2);}
.cat-tab.active{border-color:var(--teal);color:var(--teal);background:var(--teal-bg);}

.crit-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:8px;margin-bottom:22px;
}
.crit-pill{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r-sm);padding:11px 13px;
  cursor:pointer;transition:all .15s;
  display:flex;align-items:flex-start;gap:9px;user-select:none;
}
.crit-pill:hover{border-color:var(--border2);box-shadow:var(--shadow);}
.crit-pill.on{border-color:var(--teal);background:var(--teal-bg);box-shadow:0 0 0 1px var(--teal);}
.crit-check{
  width:18px;height:18px;border-radius:5px;
  background:var(--bg);border:1.5px solid var(--border2);
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;flex-shrink:0;margin-top:1px;transition:all .15s;
}
.crit-pill.on .crit-check{background:var(--teal);border-color:var(--teal);color:#fff;}
.crit-icon{font-size:.95rem;flex-shrink:0;margin-top:1px;}
.crit-name{font-size:.82rem;font-weight:600;color:var(--ink);}
.crit-hint{font-size:.7rem;color:var(--muted);margin-top:2px;line-height:1.4;}

.custom-form{
  background:var(--bg);border:1.5px dashed var(--border2);
  border-radius:var(--r);padding:18px;margin-bottom:22px;
}
.custom-form-title{
  font-size:.82rem;font-weight:700;color:var(--ink2);margin-bottom:14px;
  display:flex;align-items:center;gap:6px;
}
.custom-row{display:grid;grid-template-columns:1fr 70px 1fr;gap:10px;align-items:end;}

/* Selected criteria box */
.selected-box{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);overflow:hidden;
}
.selected-box-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 18px;border-bottom:1px solid var(--border);
  background:var(--bg);
}
.selected-box-head h3{font-size:.85rem;font-weight:700;color:var(--ink2);}
.sel-count{
  background:var(--teal);color:#fff;
  font-size:.7rem;font-weight:700;padding:2px 9px;border-radius:20px;
}
.sel-list{padding:6px;}
.sel-item{
  display:flex;align-items:center;gap:8px;
  padding:9px 12px;border-radius:8px;transition:background .12s;
  flex-wrap:wrap;
}
.sel-item:hover{background:var(--bg);}
.sel-icon{font-size:.9rem;flex-shrink:0;}
.sel-name{font-size:.82rem;font-weight:500;color:var(--ink);flex:1;min-width:80px;}
.inv-tag{
  font-size:.63rem;background:var(--amber-bg);
  color:var(--amber);padding:2px 6px;border-radius:4px;
  border:1px solid #f0d080;font-weight:600;
  flex-shrink:0;white-space:nowrap;
}
.weight-wrap{
  display:flex;flex-direction:column;gap:2px;flex-shrink:0;
}
.weight-lbl{
  font-size:.62rem;font-weight:700;
  color:var(--muted);letter-spacing:.05em;
  text-transform:uppercase;
}
.weight-sel-wrap{
  position:relative;display:flex;align-items:center;
}
.weight-sel{
  padding:4px 22px 4px 8px;font-size:.72rem;border-radius:6px;
  background:var(--bg);border:1.5px solid var(--border);
  color:var(--ink2);cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;font-weight:600;
  flex-shrink:0;
  appearance:none;-webkit-appearance:none;
}
.weight-chevron{
  position:absolute;right:6px;
  font-size:.6rem;color:var(--muted);
  pointer-events:none;line-height:1;
}
.inv-btn{
  font-size:.63rem;padding:4px 8px;
  background:var(--bg);border:1.5px solid var(--border);
  border-radius:5px;color:var(--muted);cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  white-space:nowrap;font-weight:600;transition:all .12s;
  flex-shrink:0;
  align-self:flex-end;
}
.inv-btn.on{border-color:var(--amber);color:var(--amber);background:var(--amber-bg);}
.rm-btn{
  width:24px;height:24px;border-radius:6px;
  background:transparent;border:1.5px solid var(--border);
  color:var(--muted);cursor:pointer;font-size:.75rem;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;font-family:'Plus Jakarta Sans',sans-serif;transition:all .12s;
}
.rm-btn:hover{background:var(--red-bg);border-color:var(--red);color:var(--red);}
.empty-hint{text-align:center;padding:28px;color:var(--muted);font-size:.85rem;}

/* â”€â”€ STEP 3 â€” EVALUATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.eval-grid{display:grid;gap:16px;}
.eval-col{}
.eval-col-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 18px;border-radius:12px 12px 0 0;
  border:1.5px solid;border-bottom:none;
}
.eval-col-name{font-size:1rem;font-weight:700;}
.eval-live-score{
  display:flex;flex-direction:column;align-items:flex-end;
}
.eval-live-num{
  font-family:'Lora',serif;
  font-size:1.6rem;font-weight:700;line-height:1;
}
.eval-live-label{font-size:.62rem;color:var(--muted);font-weight:500;}

.eval-col-body{border:1.5px solid;border-top:none;border-radius:0 0 12px 12px;overflow:hidden;background:var(--white);}

/* Stepper */
.sl-item{padding:14px 16px;border-bottom:1px solid var(--border);}
.sl-item:last-child{border-bottom:none;}
.sl-head{display:flex;align-items:center;gap:6px;margin-bottom:12px;}
.sl-label{font-size:.8rem;font-weight:600;color:var(--ink);flex:1;}
.sl-wtag{
  font-size:.62rem;background:var(--amber-bg);
  color:var(--amber);padding:2px 6px;border-radius:4px;
  border:1px solid #f0d080;font-weight:700;flex-shrink:0;
}

.stepper{
  display:grid;grid-template-columns:44px 1fr 44px;
  align-items:center;gap:10px;
}
.stepper-btn{
  width:44px;height:44px;border-radius:10px;
  border:1.5px solid var(--border);
  background:var(--bg);color:var(--ink2);
  font-size:1.3rem;font-weight:300;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-family:'Plus Jakarta Sans',sans-serif;
  transition:all .15s;flex-shrink:0;
  touch-action:manipulation;user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.stepper-btn:hover{border-color:var(--border2);background:var(--bg2);}
.stepper-btn:active{transform:scale(.90);background:var(--border);}

.stepper-track{display:flex;flex-direction:column;align-items:center;gap:7px;}

.pip-row{display:flex;gap:4px;align-items:flex-end;width:100%;height:20px;}
.pip{
  flex:1;border-radius:4px;
  background:var(--bg2);border:1px solid var(--border);
  transition:background .15s,height .15s,border-color .15s,transform .1s;
  min-height:8px;
  cursor:pointer;
}
.pip:hover{
  transform:scaleY(1.25);
  background:var(--border2);
  border-color:var(--muted);
}

.stepper-val{
  font-family:'Lora',serif;
  font-size:1.5rem;font-weight:700;line-height:1;
  transition:color .18s;min-width:28px;text-align:center;
}

/* â”€â”€ NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notes-row{display:grid;gap:14px;margin-top:20px;}
.notes-lbl{
  font-size:.75rem;font-weight:700;color:var(--ink2);margin-bottom:6px;display:block;
}

/* â”€â”€ RESULTS HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.res-header{ margin-bottom:32px; }
.res-header .page-eyebrow{ margin-bottom:12px; }
.res-decision-title{
  font-family:'Lora',serif;
  font-size:clamp(1.5rem,3vw,2.1rem);
  font-weight:700;line-height:1.25;
  color:var(--ink);max-width:680px;
  padding-bottom:18px;
  border-bottom:2px solid var(--border);
}

/* â”€â”€ VERDICT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.verdict-strip{
  border-radius:var(--r);padding:22px 26px;
  display:flex;align-items:center;gap:18px;
  margin-bottom:12px;border:1.5px solid;
  box-shadow:var(--shadow);
}
.verdict-icon{font-size:2.2rem;flex-shrink:0;}
.verdict-title{
  font-family:'Lora',serif;
  font-size:1.3rem;font-weight:700;margin-bottom:5px;
}
.verdict-sub{font-size:.86rem;color:var(--muted);line-height:1.6;}

/* verdict intÃ©grÃ© dans le header rÃ©sultats */
.verdict-inline{
  display:flex;align-items:center;gap:14px;
  border-radius:10px;padding:14px 18px;
  margin-top:14px;
}
.verdict-inline-emoji{font-size:1.6rem;flex-shrink:0;}
.verdict-inline-title{
  font-family:'Lora',serif;
  font-size:1.05rem;font-weight:700;margin-bottom:3px;
}
.verdict-inline-sub{font-size:.82rem;color:var(--muted);line-height:1.5;}

/* â”€â”€ SECTION DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.res-divider{
  display:flex;align-items:center;gap:10px;
  margin:32px 0 16px;
}
.res-divider-label{
  font-size:.65rem;font-weight:800;
  letter-spacing:.14em;text-transform:uppercase;
  color:var(--muted2);white-space:nowrap;
}
.res-divider::before,.res-divider::after{
  content:'';flex:1;height:1px;background:var(--border);
}

/* â”€â”€ SCORE CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scores-row{display:grid;gap:14px;margin-bottom:0;}
.score-card{
  background:var(--white);
  border-radius:var(--r);
  border:1.5px solid var(--border);
  overflow:hidden;
  box-shadow:var(--shadow);
  transition:box-shadow .2s, transform .2s;
  display:flex;flex-direction:column;
}
.score-card:hover{ box-shadow:var(--shadow-lg); transform:translateY(-2px); }
.score-card.rank-1{ border-width:2px; }
.sc-accent{ display:none; }

.sc-body{ padding:0; display:flex; flex-direction:column; flex:1; }

/* Bande colorÃ©e tout en haut */
.sc-top-band{
  height:6px; width:100%; flex-shrink:0;
}

/* Zone principale */
.sc-main{
  display:flex; align-items:center; padding:16px 16px 12px; gap:12px;
}

/* Bloc score (Ã  droite) */
.sc-score-block{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  flex-shrink:0;
  background:var(--bg);
  border-radius:10px;
  padding:10px 14px;
  min-width:68px;
}
.sc-num{
  font-family:'Lora',serif; font-size:2rem;
  font-weight:700; line-height:1; transition:color .2s;
}
.sc-denom{
  font-size:.6rem; color:var(--muted); font-weight:600;
  letter-spacing:.04em; margin-top:2px;
}

/* Contenu gauche */
.sc-content{ flex:1; min-width:0; }

.rank-badge{
  display:inline-flex; align-items:center;
  font-size:.6rem; font-weight:700;
  padding:2px 8px; border-radius:20px;
  letter-spacing:.05em; margin-bottom:6px;
  white-space:nowrap;
}
.sc-name{
  font-family:'Lora',serif; font-size:1rem; font-weight:700;
  color:var(--ink); line-height:1.25; margin-bottom:2px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.sc-desc{
  font-size:.72rem; color:var(--muted); line-height:1.4;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* Barre de progression en bas */
.sc-bar-row{ padding:0; }
.sc-bar{
  height:4px; background:var(--bg2);
  overflow:hidden;
}
.sc-bar-fill{ height:100%; transition:width .9s cubic-bezier(.4,0,.2,1), background .2s; }

.sc-mini-crits{ display:none; }
.sc-score-row{ display:none; }
.sc-mini-row{ display:flex; align-items:center; gap:8px; font-size:.73rem; }
.sc-mini-name{
  width:110px; flex-shrink:0; overflow:hidden;
  text-overflow:ellipsis; white-space:nowrap; color:var(--muted);
}
.sc-mini-bar-wrap{ flex:1; height:4px; background:var(--bg2); border-radius:2px; overflow:hidden; }
.sc-mini-bar-fill{ height:100%; border-radius:2px; }
.sc-mini-val{ width:18px; text-align:right; color:var(--ink2); font-weight:700; flex-shrink:0; }

/* â”€â”€ TOOL PILLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tool-pills{
  display:grid;grid-template-columns:1fr 1fr;gap:10px;
  margin-bottom:0;
}
.tool-pill{
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  box-shadow:var(--shadow);
  transition:box-shadow .15s;
}
.tool-pill:hover{ box-shadow:var(--shadow-lg); }
.tool-pill-head{
  display:flex;align-items:center;gap:10px;
  padding:12px 14px;
  cursor:pointer;user-select:none;
  transition:background .15s;
}
.tool-pill-head:hover{ background:var(--bg); }
.tool-pill-icon{ font-size:1.2rem;flex-shrink:0; }
.tool-pill-text{ flex:1;min-width:0; }
.tool-pill-title{
  font-size:.82rem;font-weight:700;color:var(--ink);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.tool-pill-sub{
  font-size:.68rem;color:var(--muted);line-height:1.3;margin-top:1px;
}
.tool-pill-body{
  display:none;
  border-top:1px solid var(--border);
  padding:14px 16px 16px;
}
.tool-pill.open .scenario-chevron{ transform:rotate(180deg); }
@media(max-width:560px){
  .tool-pills{ grid-template-columns:1fr; }
}


/* â”€â”€ RADAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.radar-section{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);padding:24px;box-shadow:var(--shadow);
}
.radar-section h3{
  font-family:'Lora',serif;font-size:1rem;
  font-weight:700;color:var(--ink);margin-bottom:16px;
}
.radar-canvas-wrap{display:flex;justify-content:center;}
.radar-legend{
  display:flex;flex-wrap:wrap;gap:16px;margin-top:16px;
  font-size:.78rem;color:var(--ink2);font-weight:500;justify-content:center;
}
.leg-dot{
  width:9px;height:9px;border-radius:50%;
  display:inline-block;margin-right:5px;vertical-align:middle;
}

/* â”€â”€ BREAKDOWN TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-title{
  font-family:'Lora',serif;font-size:1rem;font-weight:700;
  color:var(--ink);margin-bottom:14px;
  padding-bottom:12px;border-bottom:1.5px solid var(--border);
}
.bk-table{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow);overflow-x:auto;
}
.bk-row{display:flex;align-items:center;border-bottom:1px solid var(--border);}
.bk-row:last-child{border-bottom:none;}
.bk-row.hdr{background:var(--bg);border-bottom:1.5px solid var(--border);}
.bk-row:not(.hdr):hover{background:var(--bg);}
.bk-cell{padding:11px 14px;font-size:.8rem;}
.bk-cell.crit-col{
  width:180px;flex-shrink:0;display:flex;
  align-items:center;gap:7px;color:var(--ink);font-weight:600;
}
.bk-cell.hdr-cell{
  color:var(--muted);font-weight:700;
  font-size:.7rem;text-transform:uppercase;letter-spacing:.07em;
}
.bk-cell.opt-col{flex:1;min-width:90px;}
.opt-cell-in{display:flex;align-items:center;gap:7px;}
.opt-pill{
  display:inline-flex;align-items:center;justify-content:center;
  width:26px;height:26px;border-radius:7px;
  font-size:.82rem;font-weight:700;flex-shrink:0;
}
.mini-bar{flex:1;height:5px;background:var(--bg2);border-radius:3px;overflow:hidden;}
.mini-bar-fill{height:100%;border-radius:3px;}

/* â”€â”€ ANALYSIS BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.analysis-box{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow);
}
.analysis-head{
  padding:14px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:9px;background:var(--bg);
}
.analysis-head h3{font-size:.88rem;font-weight:700;color:var(--ink);}
.ai-badge{
  font-size:.62rem;font-weight:700;letter-spacing:.08em;
  background:var(--teal-bg);color:var(--teal);
  padding:2px 8px;border-radius:5px;text-transform:uppercase;
  border:1px solid var(--teal-bd);
}
.analysis-body{display:grid;grid-template-columns:1fr 1fr;}
.an-col{padding:18px 20px;}
.an-col:first-child{border-right:1px solid var(--border);}
.an-col h4{
  font-size:.7rem;font-weight:800;text-transform:uppercase;
  letter-spacing:.1em;margin-bottom:14px;
}
.an-col.pros h4{color:var(--green);}
.an-col.cons h4{color:var(--red);}
.an-item{
  display:flex;gap:9px;font-size:.83rem;
  color:var(--ink2);line-height:1.6;margin-bottom:10px;
}
.an-dot{width:6px;height:6px;border-radius:50%;margin-top:7px;flex-shrink:0;}
.pros .an-dot{background:var(--green);}
.cons .an-dot{background:var(--red);}

/* â”€â”€ NOTES RESULT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notes-res{
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow);
}
.notes-res-head{
  padding:13px 20px;border-bottom:1px solid var(--border);
  font-size:.85rem;font-weight:700;color:var(--ink);background:var(--bg);
}
.notes-res-body{display:grid;}
.note-col{padding:16px 20px;}
.note-col-lbl{
  font-size:.68rem;font-weight:800;
  letter-spacing:.12em;text-transform:uppercase;margin-bottom:8px;
}
.note-col-txt{font-size:.84rem;color:var(--muted);line-height:1.65;font-style:italic;}

/* â”€â”€ RES ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.res-actions{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:36px;padding-top:22px;
  border-top:1px solid var(--border);
  flex-wrap:wrap;gap:10px;
}



/* â”€â”€ LANG SWITCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lang-switcher{
  position:absolute;top:18px;right:20px;
  display:flex;gap:4px;
  background:var(--bg2);
  border-radius:8px;
  padding:3px;
  border:1px solid var(--border);
}
.lang-btn{
  padding:4px 10px;
  font-size:.72rem;font-weight:700;
  border-radius:6px;border:none;
  background:transparent;color:var(--muted);
  cursor:pointer;transition:all .15s;
  font-family:'Plus Jakarta Sans',sans-serif;
  letter-spacing:.04em;
}
.lang-btn.active{
  background:var(--white);color:var(--teal);
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
}

[data-tip]{position:relative;cursor:help;}
[data-tip]::after{
  content:attr(data-tip);
  position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
  background:var(--ink);color:#fff;
  font-size:.7rem;padding:5px 9px;border-radius:6px;
  white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:100;
}
[data-tip]:hover::after{opacity:1;}

/* â”€â”€ FEAR TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fear-box{
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:var(--r);
  margin-bottom:24px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.fear-head{
  display:flex;align-items:center;gap:12px;
  padding:16px 20px;
  cursor:pointer;
  user-select:none;
  transition:background .15s;
}
.fear-head:hover{ background:var(--bg); }
.fear-icon{ font-size:1.4rem; flex-shrink:0; }
.fear-head-text{ flex:1; }
.fear-head-title{
  font-size:.92rem;font-weight:700;color:var(--ink);
  margin-bottom:2px;
}
.fear-head-sub{
  font-size:.75rem;color:var(--muted);line-height:1.4;
}

/* Toggle switch */
.toggle-wrap{
  display:flex;align-items:center;gap:8px;flex-shrink:0;
}
.toggle-label{
  font-size:.75rem;font-weight:600;
  color:var(--muted);transition:color .2s;
  white-space:nowrap;
}
.toggle-label.on{ color:var(--teal); }
.toggle{
  position:relative;width:44px;height:24px;flex-shrink:0;
}
.toggle input{ opacity:0;width:0;height:0;position:absolute; }
.toggle-track{
  position:absolute;inset:0;
  background:var(--border2);border-radius:12px;
  transition:background .2s;cursor:pointer;
}
.toggle input:checked + .toggle-track{ background:var(--teal); }
.toggle-thumb{
  position:absolute;top:3px;left:3px;
  width:18px;height:18px;border-radius:50%;
  background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);
  transition:transform .2s;pointer-events:none;
}
.toggle input:checked ~ .toggle-thumb{ transform:translateX(20px); }

/* Fear body â€” criteria tags + comparison */
.fear-body{
  border-top:1px solid var(--border);
  padding:16px 20px;
  display:none;
}
.fear-box.open .fear-body{ display:block; }

.fear-crits{
  display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;
}
.fear-crit-tag{
  display:inline-flex;align-items:center;gap:5px;
  font-size:.72rem;font-weight:600;
  padding:3px 10px;border-radius:20px;
  border:1px solid;
}
.fear-crit-tag.active{
  background:rgba(124,58,237,0.08);
  color:#7c3aed;border-color:rgba(124,58,237,0.3);
}
.fear-crit-tag.inactive{
  background:var(--bg);color:var(--muted2);border-color:var(--border);
  text-decoration:line-through;opacity:.6;
}

.fear-comparison{
  display:grid;gap:10px;
}
.fear-opt-row{
  background:var(--bg);border-radius:10px;padding:12px 14px;
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;
}
.fear-opt-name{
  font-size:.82rem;font-weight:700;min-width:90px;
}
.fear-scores{
  display:flex;align-items:center;gap:8px;flex:1;flex-wrap:wrap;
}
.fear-score-block{
  display:flex;flex-direction:column;align-items:center;
  min-width:64px;
}
.fear-score-val{
  font-family:'Lora',serif;
  font-size:1.5rem;font-weight:700;line-height:1;
}
.fear-score-lbl{
  font-size:.62rem;color:var(--muted);font-weight:500;margin-top:1px;
}
.fear-arrow{
  font-size:1rem;color:var(--muted2);
}
.fear-delta{
  font-size:.78rem;font-weight:700;
  padding:2px 8px;border-radius:6px;
}
.fear-delta.up{
  background:rgba(45,125,90,.08);color:var(--teal);
}
.fear-delta.down{
  background:rgba(192,57,43,.06);color:var(--red);
}
.fear-delta.same{
  background:var(--bg2);color:var(--muted);
}

.fear-insight{
  margin-top:14px;padding:12px 14px;
  background:rgba(124,58,237,0.05);
  border:1px solid rgba(124,58,237,0.18);
  border-radius:10px;
  font-size:.82rem;color:var(--ink2);line-height:1.6;
}
.fear-insight strong{ color:#7c3aed; }

.fear-none{
  font-size:.82rem;color:var(--muted);
  font-style:italic;padding:8px 0;
}

/* â”€â”€ SCENARIO PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scenario-box{
  background:var(--white);
  border:1.5px solid var(--border);
  border-radius:var(--r);
  margin-bottom:24px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.scenario-head{
  display:flex;align-items:center;gap:12px;
  padding:16px 20px;cursor:pointer;user-select:none;
  transition:background .15s;
}
.scenario-head:hover{ background:var(--bg); }
.scenario-head-icon{ font-size:1.3rem;flex-shrink:0; }
.scenario-head-text{ flex:1; }
.scenario-head-title{ font-size:.92rem;font-weight:700;color:var(--ink);margin-bottom:2px; }
.scenario-head-sub{ font-size:.75rem;color:var(--muted);line-height:1.4; }
.scenario-chevron{ color:var(--muted2);font-size:.8rem;transition:transform .22s; }
.scenario-box.open .scenario-chevron{ transform:rotate(180deg); }

.scenario-body{
  display:none;
  border-top:1px solid var(--border);
  padding:16px 20px 20px;
}
.scenario-box.open .scenario-body{ display:block; }

.scenario-reset{
  font-size:.75rem;font-weight:600;color:var(--teal);
  background:none;border:none;cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  padding:0;text-decoration:underline;text-underline-offset:2px;
  float:right;
}
.scenario-reset:hover{ color:var(--teal2); }

.sc-crit-list{
  display:flex;flex-direction:column;gap:6px;
  margin-top:10px;
  clear:both;
}
.sc-crit-row{
  display:flex;align-items:center;gap:10px;
  padding:9px 12px;border-radius:9px;
  border:1.5px solid var(--border);
  background:var(--bg);
  transition:all .15s;
}
.sc-crit-row.off{
  opacity:.45;
}
.sc-crit-row.off .sc-crit-name{ text-decoration:line-through; }
.sc-crit-icon{ font-size:.95rem;flex-shrink:0; }
.sc-crit-name{ font-size:.82rem;font-weight:600;color:var(--ink);flex:1; }
.sc-crit-weight{
  font-size:.65rem;background:var(--amber-bg);
  color:var(--amber);padding:2px 6px;border-radius:4px;
  border:1px solid #f0d080;font-weight:700;flex-shrink:0;
}
.sc-crit-inv{
  font-size:.65rem;background:var(--bg2);
  color:var(--muted);padding:2px 6px;border-radius:4px;
  border:1px solid var(--border2);font-weight:600;flex-shrink:0;
}

/* Mini toggle â€” smaller than the fear one */
.mini-toggle{
  position:relative;width:36px;height:20px;flex-shrink:0;
}
.mini-toggle input{ opacity:0;width:0;height:0;position:absolute; }
.mini-toggle-track{
  position:absolute;inset:0;
  background:var(--border2);border-radius:10px;
  transition:background .18s;cursor:pointer;
}
.mini-toggle input:checked + .mini-toggle-track{ background:var(--teal); }
.mini-toggle-thumb{
  position:absolute;top:3px;left:3px;
  width:14px;height:14px;border-radius:50%;
  background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.2);
  transition:transform .18s;pointer-events:none;
}
.mini-toggle input:checked ~ .mini-toggle-thumb{ transform:translateX(16px); }

/* Dynamic score cards */
.sc-num{ transition:color .2s; }
.sc-bar-fill{ transition:width .4s ease,background .2s; }
.sc-scenario-delta{
  display:inline-flex;align-items:center;gap:4px;
  font-size:.72rem;font-weight:700;
  padding:2px 8px;border-radius:6px;margin-left:6px;
  vertical-align:middle;
}
.sc-scenario-delta.up{ background:rgba(45,125,90,.1);color:var(--teal); }
.sc-scenario-delta.down{ background:rgba(192,57,43,.07);color:var(--red); }
.sc-scenario-delta.same{ display:none; }

.scenario-summary{
  margin-top:14px;padding:11px 14px;
  background:var(--teal-bg);border:1px solid var(--teal-bd);
  border-radius:9px;font-size:.8rem;color:var(--ink2);line-height:1.6;
}
.scenario-summary strong{ color:var(--teal); }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:640px){
  .app-header{padding:12px 16px;}
  .main{padding:22px 16px 60px;}
  .intro-how{grid-template-columns:1fr;}
  .sp-step span:not(.sp-num){display:none;}
  .custom-row{grid-template-columns:1fr 1fr;}
  .analysis-body{grid-template-columns:1fr;}
  .an-col:first-child{border-right:none;border-bottom:1px solid var(--border);}
  .notes-res-body{grid-template-columns:1fr!important;}
  .note-col{border-right:none!important;border-bottom:1px solid var(--border);}

  /* Scores cards â€” rank badge inline on mobile */
  .scores-row{grid-template-columns:1fr!important;}
  .rank-badge{
    position:static;
    display:inline-flex;
    margin-bottom:8px;
  }
  .sc-letter{padding-right:0;}
  .eval-grid{grid-template-columns:1fr!important;}
  .eval-col-name{font-size:.88rem;}

  /* Stepper: shrink buttons, tighten gap */
  .stepper{grid-template-columns:38px 1fr 38px;gap:6px;}
  .stepper-btn{width:38px;height:38px;font-size:1.1rem;}

  /* Prevent pip row from pushing layout */
  .pip-row{gap:3px;}
  .pip{border-radius:3px;}

  /* Notes row single column */
  .notes-row{grid-template-columns:1fr!important;}

  /* CritÃ¨res sÃ©lectionnÃ©s â€” croix centrÃ©e Ã  gauche avec l'icÃ´ne et le titre */
  .sel-item{
    position:relative;
    padding-left:36px;
    padding-right:12px;
  }
  .rm-btn{
    position:absolute;
    top:50%;left:10px;
    transform:translateY(-50%);
  }
}

@media print{
  body{background:#fff;}
  .app-header button,.res-actions,.btn-row{display:none!important;}
  .page{display:none!important;}
  #page-results{display:flex!important;}
}
</style>
</head>
<body>
<div class="app">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INTRO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-intro">
  <!-- SÃ©lecteur de langue -->
  <div class="lang-switcher">
    <button class="lang-btn active" id="btn-fr" onclick="setLang('fr')">FR</button>
    <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
  </div>
  <div class="intro-wrap">
    <div class="intro-inner">

      <!-- Hibou cartoon animÃ© -->
      <div class="mascot-wrap">
        <svg class="mascot" viewBox="0 0 100 110" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">

          <!-- Ombre -->
          <ellipse cx="50" cy="106" rx="22" ry="4" fill="rgba(0,0,0,0.07)" class="mascot-shadow"/>

          <!-- Corps super rond et dodu -->
          <ellipse cx="50" cy="76" rx="28" ry="30" fill="#2d7d5a"/>

          <!-- Ventre doux -->
          <ellipse cx="50" cy="82" rx="18" ry="20" fill="#c8ead9"/>
          <ellipse cx="50" cy="86" rx="12" ry="13" fill="#eef7f2"/>

          <!-- TÃªte grosse et ronde -->
          <ellipse cx="50" cy="42" rx="26" ry="25" fill="#2d7d5a"/>

          <!-- Aigrettes moelleuses -->
          <path d="M34 24 Q28 8 36 5 Q40 16 38 23Z" fill="#1a4d38"/>
          <path d="M66 24 Q72 8 64 5 Q60 16 62 23Z" fill="#1a4d38"/>

          <!-- Yeux trÃ¨s grands et kawaii -->
          <circle cx="37" cy="42" r="14" fill="white"/>
          <circle cx="63" cy="42" r="14" fill="white"/>
          <circle cx="37" cy="42" r="9" fill="#389e71"/>
          <circle cx="63" cy="42" r="9" fill="#389e71"/>
          <circle cx="37" cy="42" r="5.5" fill="#0a0a0a" class="pupil-l"/>
          <circle cx="63" cy="42" r="5.5" fill="#0a0a0a" class="pupil-r"/>
          <circle cx="39.5" cy="39.5" r="2.2" fill="white"/>
          <circle cx="65.5" cy="39.5" r="2.2" fill="white"/>
          <circle cx="35" cy="44.5" r=".9" fill="white" opacity=".6"/>
          <circle cx="61" cy="44.5" r=".9" fill="white" opacity=".6"/>

          <!-- Clignement -->
          <g class="mascot-blink" style="opacity:0">
            <ellipse cx="37" cy="42" rx="14" ry="8" fill="#2d7d5a"/>
            <ellipse cx="63" cy="42" rx="14" ry="8" fill="#2d7d5a"/>
          </g>

          <!-- Petites joues rondes -->
          <ellipse cx="24" cy="52" rx="7" ry="5" fill="#c8ead9" opacity=".5"/>
          <ellipse cx="76" cy="52" rx="7" ry="5" fill="#c8ead9" opacity=".5"/>

          <!-- Bec petit et mignon -->
          <path d="M45 54 Q50 60 55 54 Q53 50 50 51 Q47 50 45 54Z" fill="#f0a830"/>

          <!-- Petites pattes -->
          <path d="M38 103 Q34 108 30 106" stroke="#f0a830" stroke-width="2.5" fill="none" stroke-linecap="round"/>
          <path d="M38 103 Q36 109 32 110" stroke="#f0a830" stroke-width="2.5" fill="none" stroke-linecap="round"/>
          <path d="M38 103 Q38 110 36 112" stroke="#f0a830" stroke-width="2.5" fill="none" stroke-linecap="round"/>
          <path d="M62 103 Q66 108 70 106" stroke="#f0a830" stroke-width="2.5" fill="none" stroke-linecap="round"/>
          <path d="M62 103 Q64 109 68 110" stroke="#f0a830" stroke-width="2.5" fill="none" stroke-linecap="round"/>
          <path d="M62 103 Q62 110 64 112" stroke="#f0a830" stroke-width="2.5" fill="none" stroke-linecap="round"/>

        </svg>
      </div>

      <div class="intro-badge" data-i18n="badge">âœ¦ Outil d'aide Ã  la dÃ©cision</div>
      <div class="intro-logo">Lucid<span>.</span></div>
      <div class="intro-tagline" data-i18n="tagline">Comparez vos options avec Lucid et prenez vos dÃ©cisions en toute confiance.</div>

      <div class="intro-how">
        <div class="how-card">
          <div class="how-num">1</div>
          <div class="how-title" data-i18n="how1_title">Posez votre question</div>
          <div class="how-desc" data-i18n="how1_desc">Formulez votre situation et listez les options Ã  comparer.</div>
        </div>
        <div class="how-card">
          <div class="how-num">2</div>
          <div class="how-title" data-i18n="how2_title">Choisissez vos critÃ¨res</div>
          <div class="how-desc" data-i18n="how2_desc">SÃ©lectionnez ce qui compte vraiment pour vous.</div>
        </div>
        <div class="how-card">
          <div class="how-num">3</div>
          <div class="how-title" data-i18n="how3_title">Obtenez votre analyse</div>
          <div class="how-desc" data-i18n="how3_desc">Lucid calcule les scores et vous prÃ©sente un rÃ©sultat clair.</div>
        </div>
      </div>

      <button class="intro-start-btn" onclick="nav('page-step1')" data-i18n="start_btn">Commencer â†’</button>
      <p style="margin-top:12px;font-size:.75rem;color:var(--muted2)" data-i18n="footer_note">Gratuit Â· Aucun compte requis Â· 100% privÃ©</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 1 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-step1">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp1"></div>
    <div class="lang-switcher" style="margin-left:auto;position:static">
      <button class="lang-btn active" id="btn-fr2" onclick="setLang('fr')">FR</button>
      <button class="lang-btn" id="btn-en2" onclick="setLang('en')">EN</button>
    </div>
  </div>
  <div class="main">
    <div class="page-eyebrow anim" data-i18n="s1_eyebrow">Ã‰tape 1 sur 3</div>
    <div class="page-title anim d1" data-i18n="s1_title">Quelle dÃ©cision devez-vous prendre ?</div>
    <div class="page-sub anim d2" data-i18n="s1_sub">Formulez votre situation et renseignez les options que vous envisagez.</div>

    <div class="card decision-card anim d2">
      <div class="field" style="margin-bottom:0">
        <label for="inp-dec">ğŸ“ Votre dÃ©cision en une phrase</label>
        <textarea id="inp-dec" rows="2" placeholder="Ex : Dois-je accepter ce nouvel emploi ou rester dans mon poste actuel ?"></textarea>
      </div>
    </div>

    <div class="anim d3">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <label style="font-size:.85rem;font-weight:700;color:var(--ink2)" data-i18n="opt_section_label">ğŸ”€ Vos options</label>
        <span id="opt-count-lbl" style="font-size:.75rem;color:var(--muted);background:var(--bg2);padding:3px 10px;border-radius:20px;font-weight:600">2 options</span>
      </div>
      <div class="options-list" id="optBuilder"></div>
      <button class="add-option-btn" id="addOptBtn" onclick="addOption()">
        <div class="add-option-icon">+</div>
        <span data-i18n="opt_add_label">Ajouter une option</span> <span style="color:var(--muted2);font-weight:400" data-i18n="opt_add_max">(max 6)</span>
      </button>
    </div>

    <div class="btn-row anim d4">
      <button class="btn btn-secondary" onclick="nav('page-intro')" data-i18n="back_intro">â† Retour</button>
      <button class="btn btn-primary" onclick="validateStep1()" data-i18n="s1_next">Choisir mes critÃ¨res â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 2 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-step2">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp2"></div>
    <div class="lang-switcher">
      <button class="lang-btn active" id="btn-fr3" onclick="setLang('fr')">FR</button>
      <button class="lang-btn" id="btn-en3" onclick="setLang('en')">EN</button>
    </div>
  </div>
  <div class="main">
    <div class="page-eyebrow" data-i18n="s2_eyebrow">Ã‰tape 2 sur 3</div>
    <div class="page-title" data-i18n="s2_title">Qu'est-ce qui compte pour vous ?</div>
    <div class="page-sub" data-i18n="s2_sub">SÃ©lectionnez les critÃ¨res importants dans votre situation. Vous pouvez en choisir autant que vous voulez.</div>

    <div class="criteria-intro">
      <div class="criteria-intro-icon">ğŸ’¡</div>
      <div data-i18n="s2_hint">Cliquez sur les critÃ¨res pour les sÃ©lectionner. Vous pourrez ensuite ajuster leur <strong>importance</strong> (poids) et choisir si un score Ã©levÃ© est positif ou nÃ©gatif pour ce critÃ¨re.</div>
    </div>

    <div class="cat-tabs" id="catTabs"></div>
    <div class="crit-grid" id="critGrid"></div>

    <div class="custom-form">
      <div class="custom-form-title" data-i18n="custom_title">âœ¦ Ajouter un critÃ¨re personnalisÃ©</div>
      <div class="custom-row">
        <div class="field" style="margin:0"><label data-i18n="custom_name">Nom</label><input type="text" id="cust-name" placeholder="Ex : Impact sur ma famille"></div>
        <div class="field" style="margin:0"><label data-i18n="custom_icon">IcÃ´ne</label><input type="text" id="cust-icon" placeholder="ğŸ¯" style="text-align:center"></div>
        <div class="field" style="margin:0">
          <label data-i18n="custom_cat">CatÃ©gorie</label>
          <select id="cust-cat">
            <option>Finance</option><option>Pro</option><option selected>Perso</option><option>Social</option><option>StratÃ©gique</option>
          </select>
        </div>
      </div>
      <button class="btn btn-secondary" style="margin-top:12px;font-size:.8rem;padding:9px 18px" onclick="addCustom()" data-i18n="custom_add">+ Ajouter ce critÃ¨re</button>
    </div>

    <div class="selected-box">
      <div class="selected-box-head">
        <h3 data-i18n="sel_title">âœ… CritÃ¨res sÃ©lectionnÃ©s</h3>
        <div class="sel-count" id="crit-badge">0</div>
      </div>
      <div class="sel-list" id="activeList">
        <div class="empty-hint" data-i18n="sel_empty">ğŸ‘† SÃ©lectionnez au moins 2 critÃ¨res ci-dessus pour continuer</div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="nav('page-step1')" data-i18n="back">â† Retour</button>
      <button class="btn btn-primary" onclick="validateStep2()" data-i18n="s2_next">Ã‰valuer mes options â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 3 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-step3">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp3"></div>
    <div class="lang-switcher">
      <button class="lang-btn active" id="btn-fr4" onclick="setLang('fr')">FR</button>
      <button class="lang-btn" id="btn-en4" onclick="setLang('en')">EN</button>
    </div>
  </div>
  <div class="main">
    <div class="page-eyebrow" data-i18n="s3_eyebrow">Ã‰tape 3 sur 3</div>
    <div class="page-title" id="eval-title" data-i18n="s3_title">Notez chaque option</div>
    <div class="page-sub" data-i18n="s3_sub">Pour chaque critÃ¨re, donnez une note de <strong>1</strong> (trÃ¨s faible) Ã  <strong>10</strong> (excellent) Ã  chaque option. Le score global se met Ã  jour en direct.</div>

    <div class="eval-grid" id="evalGrid"></div>
    <div class="notes-row" id="notesRow"></div>

    <div class="btn-row">
      <button class="btn btn-secondary" onclick="nav('page-step2')" data-i18n="back">â† Retour</button>
      <button class="btn btn-primary" onclick="showResults()" data-i18n="s3_next">Voir mon analyse â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-results">
  <div class="app-header">
    <div class="logo"><div class="logo-dot"></div>Lucid</div>
    <div class="step-progress" id="sp4"></div>
    <div class="lang-switcher">
      <button class="lang-btn active" id="btn-fr5" onclick="setLang('fr')">FR</button>
      <button class="lang-btn" id="btn-en5" onclick="setLang('en')">EN</button>
    </div>
  </div>
  <div class="main" id="resContent"></div>
</div>

</div>

<script>
/* â”€â”€â”€ I18N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let LANG = 'fr';

const T = {
  fr: {
    /* Intro */
    badge:       'âœ¦ Outil d\'aide Ã  la dÃ©cision',
    tagline:     'Comparez vos options avec Lucid et prenez vos dÃ©cisions en toute confiance.',
    how1_title:  'Posez votre question',
    how1_desc:   'Formulez votre situation et listez les options Ã  comparer.',
    how2_title:  'Choisissez vos critÃ¨res',
    how2_desc:   'SÃ©lectionnez ce qui compte vraiment pour vous.',
    how3_title:  'Obtenez votre analyse',
    how3_desc:   'Lucid calcule les scores et vous prÃ©sente un rÃ©sultat clair.',
    start_btn:   'Commencer â†’',
    footer_note: 'Gratuit Â· Aucun compte requis Â· 100% privÃ©',
    /* Step 1 */
    s1_eyebrow:  'Ã‰tape 1 sur 3',
    s1_title:    'Quelle dÃ©cision devez-vous prendre ?',
    s1_sub:      'Formulez votre situation et renseignez les options que vous envisagez.',
    s1_next:     'Choisir mes critÃ¨res â†’',
    back_intro:  'â† Retour',
    inp_dec_lbl: 'ğŸ“ Votre dÃ©cision en une phrase',
    inp_dec_ph:  'Ex : Dois-je accepter ce nouvel emploi ou rester dans mon poste actuel ?',
    opt_name_lbl:'Nom de l\'option',
    opt_name_ph: 'Ex : Rester Ã  Paris',
    opt_desc_lbl:'Description courte',
    opt_desc_opt:'(optionnel)',
    opt_desc_ph: 'Ex : StabilitÃ©, famille procheâ€¦',
    opt_add:     '+ Ajouter une option',
    opt_section_label: 'ğŸ”€ Vos options',
    opt_add_label: 'Ajouter une option',
    opt_add_max:   '(max 6)',
    err_name:    'Veuillez donner un nom Ã  chaque option.',
    /* Step 2 */
    s2_eyebrow:  'Ã‰tape 2 sur 3',
    s2_title:    'Qu\'est-ce qui compte pour vous ?',
    s2_sub:      'SÃ©lectionnez les critÃ¨res importants dans votre situation. Vous pouvez en choisir autant que vous voulez.',
    s2_hint:     'Cliquez sur les critÃ¨res pour les sÃ©lectionner. Vous pourrez ensuite ajuster leur <strong>importance</strong> (poids) et choisir si un score Ã©levÃ© est positif ou nÃ©gatif pour ce critÃ¨re.',
    custom_title:'âœ¦ Ajouter un critÃ¨re personnalisÃ©',
    custom_name: 'Nom',
    custom_icon: 'IcÃ´ne',
    custom_cat:  'CatÃ©gorie',
    custom_add:  '+ Ajouter ce critÃ¨re',
    custom_ph:   'Ex : Impact sur ma famille',
    sel_title:   'âœ… CritÃ¨res sÃ©lectionnÃ©s',
    sel_empty:   'ğŸ‘† SÃ©lectionnez au moins 2 critÃ¨res ci-dessus pour continuer',
    back:        'â† Retour',
    s2_next:     'Ã‰valuer mes options â†’',
    err_crit:    'Veuillez sÃ©lectionner au moins 2 critÃ¨res.',
    lbl_importance:'Importance',
    lbl_sens:    'Sens',
    inv_off:     'â†‘ Normal',
    inv_on:      'â†“ InversÃ©',
    inv_tip_off: 'Actuellement : score Ã©levÃ© = bon',
    inv_tip_on:  'Actuellement : score Ã©levÃ© = mauvais',
    inv_tag:     'â†“ inversÃ©',
    /* Step 3 */
    s3_eyebrow:  'Ã‰tape 3 sur 3',
    s3_title:    'Notez chaque option',
    s3_sub:      'Pour chaque critÃ¨re, donnez une note de <strong>1</strong> (trÃ¨s faible) Ã  <strong>10</strong> (excellent) Ã  chaque option. Le score global se met Ã  jour en direct.',
    s3_next:     'Voir mon analyse â†’',
    notes_ph:    'ğŸ’­ Notes personnelles sur cette optionâ€¦',
    notes_lbl:   (ltr, name) => `ğŸ“ Notes libres â€” Option ${ltr} (${name})`,
    /* Results */
    res_eyebrow: 'âœ¦ Votre analyse',
    export_pdf:  'ğŸ–¨ï¸ Exporter en PDF',
    new_decision:'â†º Nouvelle dÃ©cision',
    back_notes:  'â† Modifier mes notes',
    res_tie_title:'RÃ©sultat trÃ¨s serrÃ© !',
    res_tie_sub: (diff) => `Seulement ${diff} point${diff>1?'s':''} d'Ã©cart â€” les deux premiÃ¨res options sont quasiment Ã©quivalentes. Faites confiance Ã  votre intuition.`,
    res_win_sub: (diff) => `Avantage de ${diff} points sur vos critÃ¨res pondÃ©rÃ©s. N'oubliez pas de prendre en compte vos notes et votre ressenti.`,
    rank_labels: ['ğŸ¥‡ 1Ã¨re option','ğŸ¥ˆ 2Ã¨me option','ğŸ¥‰ 3Ã¨me option'],
    div_scores:  'Scores',
    div_visual:  'Profil visuel',
    div_detail:  'DÃ©tail par critÃ¨re',
    div_synth:   'SynthÃ¨se',
    div_notes:   'Notes personnelles',
    div_explore: 'Exploration',
    bk_crit:     'CritÃ¨re',
    interp_title:'InterprÃ©tation personnalisÃ©e',
    analysis_title:'Analyse synthÃ©tique',
    analysis_badge:'Automatique',
    pros_title:  (name) => `âœ¦ Points forts de "${name}"`,
    cons_title:  'âš  Points d\'attention',
    no_notes:    'Aucune note',
    notes_head:  'ğŸ“ Vos notes personnelles',
    fear_title:  'Et si la peur n\'Ã©tait pas un facteur ?',
    fear_sub:    'Lucid masque les critÃ¨res liÃ©s au risque et Ã  la prudence pour rÃ©vÃ©ler votre choix sans biais de peur.',
    scenario_title:'Testez vos scÃ©narios',
    scenario_sub:'Activez ou dÃ©sactivez des critÃ¨res pour recalculer les scores instantanÃ©ment.',
    scenario_reset:'Tout rÃ©activer',
    scenario_active:(a,t)=>`${a} / ${t} critÃ¨res actifs`,
    sc_inv:        'â†“ inversÃ©',
    sc_toggle_on:  'DÃ©sactiver ce critÃ¨re',
    sc_toggle_off: 'Activer ce critÃ¨re',
    /* Scenario insights */
    sc_all_active: `âœ… Tous les critÃ¨res sont actifs â€” c'est votre analyse complÃ¨te, sans filtre.`,
    sc_switched:   (dis,newN,gainSign,oldN,s,p1,p2) => `ğŸ”„ Sans ${dis}, le classement <strong>s'inverse</strong> : <strong>"${newN}"</strong> passe en tÃªte (${gainSign} pts), devant <strong>"${oldN}"</strong>. Ce${s} critÃ¨re${s} ${p1} donc un rÃ´le dÃ©cisif en faveur de l'option initiale.`,
    sc_reduced:    (winN,gapDiff,dis,s,p2) => `âš ï¸ <strong>"${winN}"</strong> reste en tÃªte, mais son avantage se rÃ©duit de <strong>${gapDiff} points</strong> sans ${dis}. Ce${s} critÃ¨re${s} ${p2} une part importante de son avance â€” la dÃ©cision serait plus serrÃ©e sans ${s?'eux':'lui'}.`,
    sc_wider:      (winN,extra,dis,s,p3) => `âœ… Sans ${dis}, <strong>"${winN}"</strong> se dÃ©tache encore davantage (+${extra} pts d'Ã©cart supplÃ©mentaires). Ce${s} critÃ¨re${s} ${p3} â€” son avance repose sur d'autres facteurs.`,
    sc_diverge:    (gN,gd,lN,ld,dis,p4) => `ğŸ“Š Ce scÃ©nario rÃ©vÃ¨le une divergence nette : <strong>"${gN}"</strong> gagne +${gd} pts tandis que <strong>"${lN}"</strong> en perd ${ld}. ${dis} ${p4} donc diffÃ©remment sur chaque option.`,
    sc_nochange:   (dis,max,s,p5) => `ğŸ“Œ DÃ©sactiver ${dis} ne change presque rien aux scores (moins de ${max} pts d'Ã©cart). Ce${s} critÃ¨re${s} ${p5} dans cette dÃ©cision â€” les autres facteurs portent l'essentiel du rÃ©sultat.`,
    sc_fallback:   (dis,impN,sign,s,p6) => `ğŸ¯ Sans ${dis}, l'option la plus impactÃ©e est <strong>"${impN}"</strong> (${sign} pts). Le classement reste identique, mais ce scÃ©nario montre Ã  quel point ce${s} critÃ¨re${s} ${p6} la position de cette option.`,
    /* Fear panel */
    fear_toggle_lbl_on:  'ğŸ­ CritÃ¨res masquÃ©s (liÃ©s Ã  la peur)',
    fear_toggle_lbl_off: 'ğŸ” CritÃ¨res dÃ©tectÃ©s comme liÃ©s Ã  la peur',
    fear_none:     "Aucun critÃ¨re liÃ© Ã  la peur ou au risque n'a Ã©tÃ© sÃ©lectionnÃ© dans votre analyse.",
    fear_score_real:'Score rÃ©el',
    fear_score_fearless:'Sans peur',
    fear_delta_lbl:(sign,d)=>`${sign}${d} pts sans peur`,
    fear_switched: (fearlessN,normalN) => `ğŸ’¡ Sans les critÃ¨res de prudence, <strong>"${fearlessN}"</strong> passerait en tÃªte â€” alors que <strong>"${normalN}"</strong> gagne dans l'analyse complÃ¨te. Ce que cela rÃ©vÃ¨le : <strong>c'est probablement la peur qui oriente votre dÃ©cision vers "${normalN}"</strong>. Est-ce un choix voulu ou un rÃ©flexe de prudence ?`,
    fear_gains:    (optN,pts) => `ğŸ’¡ Le classement ne change pas, mais <strong>"${optN}"</strong> gagne <strong>${pts} points</strong> une fois la peur mise de cÃ´tÃ©. Votre intuition profonde lui est plus favorable que vos chiffres actuels ne le montrent.`,
    fear_loses:    (optN,pts) => `ğŸ’¡ Le classement ne change pas, mais <strong>"${optN}"</strong> perd <strong>${pts} points</strong> une fois la peur mise de cÃ´tÃ©. La prudence vous protÃ¨ge mais pÃ¨se aussi sur cette option.`,
    fear_consistent:'ğŸ’¡ Le classement reste identique avec ou sans les critÃ¨res de peur. Votre dÃ©cision semble cohÃ©rente â€” elle n\'est pas fortement biaisÃ©e par la prudence.',
    /* Step progress */
    sp_labels:   ['Mes options','Mes critÃ¨res','Mes notes'],
    /* Weights */
    weights:     {1:'Ã—1 Normal', 2:'Ã—2 Important', 3:'Ã—3 Crucial'},
    /* CATS */
    cats:        ['Tous','Finance','Pro','Perso','Social','StratÃ©gique'],
    /* AI prompt lang */
    ai_lang:     'franÃ§ais',
    /* genAnalysis */
    an_score_high: (name,v,w) => `Score Ã©levÃ© sur Â« ${name} Â» (${v}/10)${w>1?` â€” critÃ¨re d'importance Ã—${w}`:''}. `,
    an_clear:    (diff) => `Avantage significatif de ${diff} points â€” la recommandation est claire.`,
    an_tight:    'RÃ©sultat serrÃ© â€” d\'autres facteurs non quantifiables peuvent faire la diffÃ©rence.',
    an_runner:   (rName,cName,vR,vW) => `"${rName}" fait mieux sur Â« ${cName} Â» (${vR} vs ${vW}).`,
    an_weak:     (cName,v,wName) => `CritÃ¨re crucial Â« ${cName} Â» : score faible pour "${wName}" (${v}/10) â€” Ã  surveiller.`,
    an_no_cons:  'Pas de faiblesse critique identifiÃ©e â€” l\'option est solide sur tous les critÃ¨res.',
    /* opt builder */
    opt_label:   (ltr) => `Option ${ltr}`,
    opt_count:   (n) => `${n} option${n>1?'s':''}`,
    /* eval */
    eval_title:  (dec) => `Notez vos options pour : "${dec}"`,
  },
  en: {
    /* Intro */
    badge:       'âœ¦ Decision-making tool',
    tagline:     'Compare your options with Lucid and make decisions with confidence.',
    how1_title:  'State your question',
    how1_desc:   'Describe your situation and list the options to compare.',
    how2_title:  'Choose your criteria',
    how2_desc:   'Select what truly matters to you.',
    how3_title:  'Get your analysis',
    how3_desc:   'Lucid calculates scores and presents a clear result.',
    start_btn:   'Get started â†’',
    footer_note: 'Free Â· No account required Â· 100% private',
    /* Step 1 */
    s1_eyebrow:  'Step 1 of 3',
    s1_title:    'What decision are you facing?',
    s1_sub:      'Describe your situation and enter the options you are considering.',
    s1_next:     'Choose my criteria â†’',
    back_intro:  'â† Back',
    inp_dec_lbl: 'ğŸ“ Your decision in one sentence',
    inp_dec_ph:  'e.g. Should I accept this new job or stay in my current position?',
    opt_name_lbl:'Option name',
    opt_name_ph: 'e.g. Stay in Paris',
    opt_desc_lbl:'Short description',
    opt_desc_opt:'(optional)',
    opt_desc_ph: 'e.g. Stability, family nearbyâ€¦',
    opt_add:     '+ Add an option',
    opt_section_label: 'ğŸ”€ Your options',
    opt_add_label: 'Add an option',
    opt_add_max:   '(max 6)',
    err_name:    'Please give a name to each option.',
    /* Step 2 */
    s2_eyebrow:  'Step 2 of 3',
    s2_title:    'What matters to you?',
    s2_sub:      'Select the criteria that are important in your situation. You can choose as many as you want.',
    s2_hint:     'Click on criteria to select them. You can then adjust their <strong>importance</strong> (weight) and choose whether a high score is positive or negative for that criterion.',
    custom_title:'âœ¦ Add a custom criterion',
    custom_name: 'Name',
    custom_icon: 'Icon',
    custom_cat:  'Category',
    custom_add:  '+ Add this criterion',
    custom_ph:   'e.g. Impact on my family',
    sel_title:   'âœ… Selected criteria',
    sel_empty:   'ğŸ‘† Select at least 2 criteria above to continue',
    back:        'â† Back',
    s2_next:     'Evaluate my options â†’',
    err_crit:    'Please select at least 2 criteria.',
    lbl_importance:'Importance',
    lbl_sens:    'Direction',
    inv_off:     'â†‘ Normal',
    inv_on:      'â†“ Inverted',
    inv_tip_off: 'Currently: high score = good',
    inv_tip_on:  'Currently: high score = bad',
    inv_tag:     'â†“ inverted',
    /* Step 3 */
    s3_eyebrow:  'Step 3 of 3',
    s3_title:    'Rate each option',
    s3_sub:      'For each criterion, give a score from <strong>1</strong> (very low) to <strong>10</strong> (excellent) for each option. The overall score updates live.',
    s3_next:     'See my analysis â†’',
    notes_ph:    'ğŸ’­ Personal notes on this optionâ€¦',
    notes_lbl:   (ltr, name) => `ğŸ“ Free notes â€” Option ${ltr} (${name})`,
    /* Results */
    res_eyebrow: 'âœ¦ Your analysis',
    export_pdf:  'ğŸ–¨ï¸ Export as PDF',
    new_decision:'â†º New decision',
    back_notes:  'â† Edit my scores',
    res_tie_title:'Very close result!',
    res_tie_sub: (diff) => `Only ${diff} point${diff>1?'s':''} apart â€” the top two options are nearly equivalent. Trust your instincts.`,
    res_win_sub: (diff) => `${diff}-point advantage on your weighted criteria. Don't forget to factor in your notes and gut feeling.`,
    rank_labels: ['ğŸ¥‡ 1st option','ğŸ¥ˆ 2nd option','ğŸ¥‰ 3rd option'],
    div_scores:  'Scores',
    div_visual:  'Visual profile',
    div_detail:  'Criterion breakdown',
    div_synth:   'Summary',
    div_notes:   'Personal notes',
    div_explore: 'Explore further',
    bk_crit:     'Criterion',
    interp_title:'Personalised interpretation',
    analysis_title:'Summary analysis',
    analysis_badge:'Automatic',
    pros_title:  (name) => `âœ¦ Strengths of "${name}"`,
    cons_title:  'âš  Points of attention',
    no_notes:    'No notes',
    notes_head:  'ğŸ“ Your personal notes',
    fear_title:  'What if fear wasn\'t a factor?',
    fear_sub:    'Lucid hides risk and caution-related criteria to reveal your choice without fear bias.',
    scenario_title:'Test your scenarios',
    scenario_sub:'Enable or disable criteria to instantly recalculate scores.',
    scenario_reset:'Re-enable all',
    scenario_active:(a,t)=>`${a} / ${t} active criteria`,
    sc_inv:        'â†“ inverted',
    sc_toggle_on:  'Disable this criterion',
    sc_toggle_off: 'Enable this criterion',
    /* Scenario insights */
    sc_all_active: 'âœ… All criteria are active â€” this is your complete, unfiltered analysis.',
    sc_switched:   (dis,newN,gainSign,oldN,s,p1,p2) => `ğŸ”„ Without ${dis}, the ranking <strong>flips</strong>: <strong>"${newN}"</strong> takes the lead (${gainSign} pts), ahead of <strong>"${oldN}"</strong>. ${s} ${p1} therefore played a decisive role in favour of the original option.`,
    sc_reduced:    (winN,gapDiff,dis,s,p2) => `âš ï¸ <strong>"${winN}"</strong> stays on top, but its lead shrinks by <strong>${gapDiff} points</strong> without ${dis}. ${s} ${p2} a significant part of its advantage â€” the decision would be closer without ${LANG==='en'?'it/them':'it/them'}.`,
    sc_wider:      (winN,extra,dis,s,p3) => `âœ… Without ${dis}, <strong>"${winN}"</strong> pulls even further ahead (+${extra} pts extra gap). ${s} ${p3} â€” its lead rests on other factors.`,
    sc_diverge:    (gN,gd,lN,ld,dis,p4) => `ğŸ“Š This scenario reveals a clear divergence: <strong>"${gN}"</strong> gains +${gd} pts while <strong>"${lN}"</strong> loses ${ld}. ${dis} ${p4} differently on each option.`,
    sc_nochange:   (dis,max,s,p5) => `ğŸ“Œ Disabling ${dis} barely changes the scores (less than ${max} pts difference). ${s} ${p5} â€” the other factors carry most of the result.`,
    sc_fallback:   (dis,impN,sign,s,p6) => `ğŸ¯ Without ${dis}, the most impacted option is <strong>"${impN}"</strong> (${sign} pts). The ranking stays the same, but this scenario shows how much ${s} ${p6} this option's position.`,
    /* Fear panel */
    fear_toggle_lbl_on:  'ğŸ­ Hidden criteria (fear-related)',
    fear_toggle_lbl_off: 'ğŸ” Criteria detected as fear-related',
    fear_none:     'No fear- or risk-related criteria were selected in your analysis.',
    fear_score_real:'Real score',
    fear_score_fearless:'Fear-free',
    fear_delta_lbl:(sign,d)=>`${sign}${d} pts fear-free`,
    fear_switched: (fearlessN,normalN) => `ğŸ’¡ Without caution criteria, <strong>"${fearlessN}"</strong> would take the lead â€” while <strong>"${normalN}"</strong> wins in the full analysis. What this reveals: <strong>it's likely fear that steers your decision toward "${normalN}"</strong>. Is this a deliberate choice or a reflex of caution?`,
    fear_gains:    (optN,pts) => `ğŸ’¡ The ranking doesn't change, but <strong>"${optN}"</strong> gains <strong>${pts} points</strong> once fear is set aside. Your deeper intuition is more favourable to it than your current numbers show.`,
    fear_loses:    (optN,pts) => `ğŸ’¡ The ranking doesn't change, but <strong>"${optN}"</strong> loses <strong>${pts} points</strong> once fear is set aside. Caution protects you but also weighs on this option.`,
    fear_consistent:'ğŸ’¡ The ranking stays the same with or without fear criteria. Your decision seems consistent â€” it is not strongly biased by caution.',
    /* Step progress */
    sp_labels:   ['My options','My criteria','My scores'],
    /* Weights */
    weights:     {1:'Ã—1 Normal', 2:'Ã—2 Important', 3:'Ã—3 Critical'},
    /* CATS */
    cats:        ['All','Finance','Work','Personal','Social','Strategic'],
    /* AI prompt lang */
    ai_lang:     'English',
    /* genAnalysis */
    an_score_high: (name,v,w) => `High score on "${name}" (${v}/10)${w>1?` â€” importance Ã—${w}`:''}. `,
    an_clear:    (diff) => `Significant ${diff}-point advantage â€” the recommendation is clear.`,
    an_tight:    'Close result â€” other non-quantifiable factors may make the difference.',
    an_runner:   (rName,cName,vR,vW) => `"${rName}" performs better on "${cName}" (${vR} vs ${vW}).`,
    an_weak:     (cName,v,wName) => `Critical criterion "${cName}": low score for "${wName}" (${v}/10) â€” worth monitoring.`,
    an_no_cons:  'No critical weakness identified â€” the option is solid across all criteria.',
    /* opt builder */
    opt_label:   (ltr) => `Option ${ltr}`,
    opt_count:   (n) => `${n} option${n>1?'s':''}`,
    /* eval */
    eval_title:  (dec) => `Rate your options for: "${dec}"`,
  }
};

/* LIB EN â€” English criterion names */
const LIB_EN = {
  fin_gain: {name:'Financial gain',       hint:'Revenue, salary, profits'},
  fin_risk: {name:'Financial risk',       hint:'Potential losses, debts'},
  roi:      {name:'Return on investment', hint:'ROI in the medium/long term'},
  cost:     {name:'Initial cost',         hint:'Upfront investment'},
  fin_stab: {name:'Financial stability',  hint:'Income security'},
  career:   {name:'Career growth',        hint:'Professional prospects'},
  skills:   {name:'Skill development',    hint:'Learning, upskilling'},
  workload: {name:'Workload',             hint:'Volume and intensity of work'},
  jobsec:   {name:'Job security',         hint:'Stability and sustainability'},
  autonom:  {name:'Autonomy',             hint:'Freedom to act and decide'},
  flex:     {name:'Schedule flexibility', hint:'Remote work, flexible hours'},
  recog:    {name:'Recognition',          hint:'Appreciation, prestige'},
  wellb:    {name:'Personal well-being',  hint:'Happiness, fulfilment'},
  stress:   {name:'Stress level',         hint:'Pressure, anxiety generated'},
  health:   {name:'Health impact',        hint:'Effects on physical/mental health'},
  time:     {name:'Free time',            hint:'Leisure, rest, time for yourself'},
  values:   {name:'Values alignment',     hint:'Coherence with your principles'},
  passion:  {name:'Passion & interest',   hint:'Intrinsic motivation'},
  risk:     {name:'Overall risk',         hint:'Uncertainty, exposure to danger'},
  family:   {name:'Family impact',        hint:'Effects on relationships & family life'},
  social:   {name:'Social life',          hint:'Friendships, social environment'},
  ethics:   {name:'Ethics & values',      hint:'Coherence with your moral convictions'},
  repute:   {name:'Reputation',           hint:'Image, social perception'},
  env:      {name:'Environmental impact', hint:'Ecological footprint'},
  vision:   {name:'Long-term vision',     hint:'Alignment with your 5â€“10 year goals'},
  innov:    {name:'Innovation',           hint:'Creative potential, disruption'},
  impact:   {name:'Impact & meaning',     hint:'Positive contribution to society'},
  speed:    {name:'Speed of execution',   hint:'Time to results'},
  rev:      {name:'Reversibility',        hint:'Ease of going back'},
  complex:  {name:'Complexity',           hint:'Difficulty of implementation'},
  dep:      {name:'Dependencies',         hint:'Constraints linked to other factors'},
};

function tr(key,...args){
  const val = T[LANG][key];
  if(typeof val === 'function') return val(...args);
  return val ?? T['fr'][key] ?? key;
}

function setLang(lang){
  LANG = lang;
  /* Toggle active button â€” all headers */
  ['btn-fr','btn-fr2','btn-fr3','btn-fr4','btn-fr5'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.classList.toggle('active',lang==='fr');
  });
  ['btn-en','btn-en2','btn-en3','btn-en4','btn-en5'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.classList.toggle('active',lang==='en');
  });

  /* Update all static data-i18n elements */
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    const val = T[lang][key];
    if(val !== undefined && typeof val === 'string') el.innerHTML = val;
  });

  /* Update placeholders with data-i18n-ph */
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key = el.getAttribute('data-i18n-ph');
    const val = T[lang][key];
    if(val) el.placeholder = val;
  });

  /* Update select label in inp-dec */
  const decLbl = document.querySelector('label[for="inp-dec"]');
  if(decLbl) decLbl.textContent = tr('inp_dec_lbl');
  const decInp = document.getElementById('inp-dec');
  if(decInp) decInp.placeholder = tr('inp_dec_ph');

  /* Update custom form placeholder */
  const custName = document.getElementById('cust-name');
  if(custName) custName.placeholder = tr('custom_ph');

  /* Update CATS & WEIGHTS globals */
  CATS.length = 0;
  tr('cats').forEach(c=>CATS.push(c));
  Object.assign(WEIGHTS, tr('weights'));

  /* Update LIB names/hints if EN */
  LIB.forEach(c=>{
    if(lang==='en' && LIB_EN[c.id]){
      c._name_fr = c._name_fr || c.name;
      c._hint_fr = c._hint_fr || c.hint;
      c.name = LIB_EN[c.id].name;
      c.hint = LIB_EN[c.id].hint;
      c.cat  = ['Finance','Pro','Perso','Social','StratÃ©gique'].indexOf(c.cat) >= 0
        ? ['Finance','Work','Personal','Social','Strategic'][['Finance','Pro','Perso','Social','StratÃ©gique'].indexOf(c.cat)]
        : c.cat;
    } else if(lang==='fr'){
      if(c._name_fr){ c.name = c._name_fr; c.hint = c._hint_fr; }
      c.cat = ['Finance','Work','Personal','Social','Strategic'].indexOf(c.cat) >= 0
        ? ['Finance','Pro','Perso','Social','StratÃ©gique'][['Finance','Work','Personal','Social','Strategic'].indexOf(c.cat)]
        : c.cat;
    }
  });

  /* Also update selected criteria names */
  S.criteria.forEach(c=>{
    const orig = LIB.find(l=>l.id===c.id);
    if(orig){ c.name = orig.name; c.hint = orig.hint; }
  });

  /* Update step progress labels */
  renderStepProgress(getCurrentStep());

  /* Re-render open panels */
  renderOptBuilder();
  if(document.getElementById('page-step2').classList.contains('active')){
    buildCriteriaPage();
  }
  if(document.getElementById('page-step3').classList.contains('active')){
    buildEvalPage();
  }
}

function getCurrentStep(){
  if(document.getElementById('page-step3').classList.contains('active')) return 3;
  if(document.getElementById('page-step2').classList.contains('active')) return 2;
  return 1;
}


/* â”€â”€â”€ PALETTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const COLORS = [
  {hex:'#2d7d5a',bg:'rgba(45,125,90,0.08)',  border:'rgba(45,125,90,0.3)'  },
  {hex:'#e07040',bg:'rgba(224,112,64,0.08)', border:'rgba(224,112,64,0.3)' },
  {hex:'#7c3aed',bg:'rgba(124,58,237,0.08)', border:'rgba(124,58,237,0.3)' },
  {hex:'#d97706',bg:'rgba(217,119,6,0.08)',  border:'rgba(217,119,6,0.3)'  },
  {hex:'#0891b2',bg:'rgba(8,145,178,0.08)',  border:'rgba(8,145,178,0.3)'  },
  {hex:'#be185d',bg:'rgba(190,24,93,0.08)',  border:'rgba(190,24,93,0.3)'  },
];
const LETTERS = ['A','B','C','D','E','F'];

/* â”€â”€â”€ CRITERIA LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LIB = [
  {id:'fin_gain', cat:'Finance',     icon:'ğŸ’°', name:'Gain financier',           hint:'Revenus, salaire, bÃ©nÃ©fices',           invert:false, dw:2},
  {id:'fin_risk', cat:'Finance',     icon:'ğŸ“‰', name:'Risque financier',          hint:'Pertes potentielles, dettes',            invert:true,  dw:2},
  {id:'roi',      cat:'Finance',     icon:'ğŸ“ˆ', name:'Retour sur investissement', hint:'ROI Ã  moyen/long terme',                 invert:false, dw:1},
  {id:'cost',     cat:'Finance',     icon:'ğŸ·ï¸', name:'CoÃ»t initial',             hint:'Investissement de dÃ©part',               invert:true,  dw:1},
  {id:'fin_stab', cat:'Finance',     icon:'ğŸ¦', name:'StabilitÃ© financiÃ¨re',      hint:'SÃ©curitÃ© des revenus',                   invert:false, dw:2},

  {id:'career',   cat:'Pro',         icon:'ğŸš€', name:'Ã‰volution de carriÃ¨re',     hint:'Perspectives professionnelles',           invert:false, dw:2},
  {id:'skills',   cat:'Pro',         icon:'ğŸ§ ', name:'DÃ©veloppement compÃ©tences', hint:'Apprentissage, montÃ©e en compÃ©tence',    invert:false, dw:1},
  {id:'workload', cat:'Pro',         icon:'âš¡', name:'Charge de travail',         hint:'Volume et intensitÃ© du travail',          invert:true,  dw:1},
  {id:'jobsec',   cat:'Pro',         icon:'ğŸ›¡ï¸', name:"SÃ©curitÃ© de l'emploi",     hint:'StabilitÃ© et pÃ©rennitÃ© du poste',         invert:false, dw:2},
  {id:'autonom',  cat:'Pro',         icon:'ğŸ¯', name:'Autonomie',                 hint:"LibertÃ© d'action et de dÃ©cision",         invert:false, dw:1},
  {id:'flex',     cat:'Pro',         icon:'â°', name:'FlexibilitÃ© horaire',        hint:'TÃ©lÃ©travail, horaires amÃ©nageables',      invert:false, dw:1},
  {id:'recog',    cat:'Pro',         icon:'ğŸ…', name:'Reconnaissance',            hint:'Valorisation, prestige',                  invert:false, dw:1},

  {id:'wellb',    cat:'Perso',       icon:'â¤ï¸', name:'Bien-Ãªtre personnel',       hint:'Bonheur, Ã©panouissement',                invert:false, dw:3},
  {id:'stress',   cat:'Perso',       icon:'ğŸ˜¤', name:'Niveau de stress',          hint:'Pression, anxiÃ©tÃ© gÃ©nÃ©rÃ©e',               invert:true,  dw:2},
  {id:'health',   cat:'Perso',       icon:'ğŸŒ¿', name:'Impact santÃ©',              hint:'Effets sur votre santÃ© physique/mentale', invert:false, dw:2},
  {id:'time',     cat:'Perso',       icon:'â±ï¸', name:'Temps libre',              hint:'Loisirs, repos, temps pour soi',           invert:false, dw:2},
  {id:'values',   cat:'Perso',       icon:'ğŸ§­', name:'Alignement valeurs',        hint:'CohÃ©rence avec vos principes',            invert:false, dw:3},
  {id:'passion',  cat:'Perso',       icon:'ğŸ”¥', name:'Passion & intÃ©rÃªt',         hint:'Motivation intrinsÃ¨que',                  invert:false, dw:2},
  {id:'risk',     cat:'Perso',       icon:'âš ï¸', name:'Risque global',             hint:'Incertitude, exposition au danger',        invert:true,  dw:2},

  {id:'family',   cat:'Social',      icon:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', name:'Impact famille',       hint:'Relations avec proches',                  invert:false, dw:2},
  {id:'social',   cat:'Social',      icon:'ğŸ¤', name:'Vie sociale',               hint:'RÃ©seau, amis, interactions',              invert:false, dw:1},
  {id:'location', cat:'Social',      icon:'ğŸ“', name:'QualitÃ© du lieu de vie',    hint:'Logement, ville, environnement',          invert:false, dw:1},
  {id:'repute',   cat:'Social',      icon:'âœ¨', name:'RÃ©putation / Image',         hint:'Perception des autres',                   invert:false, dw:1},
  {id:'impact',   cat:'Social',      icon:'ğŸŒ', name:'Impact sociÃ©tal',            hint:'UtilitÃ© pour la sociÃ©tÃ©',                 invert:false, dw:1},

  {id:'lt',       cat:'StratÃ©gique', icon:'ğŸ”­', name:'Vision long terme',          hint:'BÃ©nÃ©fices dans 5â€“10 ans',                invert:false, dw:2},
  {id:'rev',      cat:'StratÃ©gique', icon:'â†©ï¸', name:'RÃ©versibilitÃ©',              hint:'PossibilitÃ© de revenir en arriÃ¨re',       invert:false, dw:2},
  {id:'opp',      cat:'StratÃ©gique', icon:'ğŸ²', name:'OpportunitÃ© unique',          hint:'RaretÃ© de la chance',                    invert:false, dw:1},
  {id:'complex',  cat:'StratÃ©gique', icon:'ğŸ”§', name:'ComplexitÃ©',                  hint:'DifficultÃ© de mise en Å“uvre',            invert:true,  dw:1},
  {id:'dep',      cat:'StratÃ©gique', icon:'ğŸ”—', name:'DÃ©pendances',                 hint:'Contraintes liÃ©es Ã  autres facteurs',    invert:true,  dw:1},
];

const CATS = ['Tous','Finance','Pro','Perso','Social','StratÃ©gique'];
const WEIGHTS = {1:'Ã—1 Normal', 2:'Ã—2 Important', 3:'Ã—3 Crucial'};

/* â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let S = {
  decision:'',
  options:[{name:'',desc:''},{name:'',desc:''}],
  criteria:[],
  scores:{},
  notes:[],
  currentCat:'Tous',
};

/* â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function nav(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}

function renderStepProgress(active){
  ['sp1','sp2','sp3','sp4'].forEach((id,i)=>{
    const el=document.getElementById(id); if(!el) return;
    const labels=tr('sp_labels');
    // sp4 = results page: show all steps as done
    const a = id==='sp4' ? 4 : active;
    el.innerHTML=[1,2,3].map(s=>{
      const cls=s<a?'done':s===a?'active':'';
      return `<div class="sp-step ${cls}">
        <div class="sp-num">${s<a?'âœ“':s}</div>
        <span>${labels[s-1]}</span>
      </div>${s<3?'<div class="sp-arrow">â€º</div>':''}`;
    }).join('');
  });
}
renderStepProgress(1);

/* â”€â”€â”€ STEP 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initOptions(){ renderOptBuilder(); }

function renderOptBuilder(){
  const b=document.getElementById('optBuilder');
  b.innerHTML='';
  S.options.forEach((opt,i)=>{
    const c=COLORS[i], ltr=LETTERS[i];
    const card=document.createElement('div');
    card.className='opt-card open'; card.id=`opt-card-${i}`;
    card.innerHTML=`
      <div class="opt-card-head" onclick="toggleOpt(${i})">
        <div class="opt-dot" style="background:${c.hex}"></div>
        <div class="opt-letter" style="color:${c.hex}">${tr('opt_label',ltr)}</div>
        <div class="opt-name-preview" id="opt-prev-${i}">${esc(opt.name)||'â€”'}</div>
        ${i>=2?`<button class="opt-rm" onclick="event.stopPropagation();removeOpt(${i})" title="Supprimer">âœ•</button>`:''}
        <div class="opt-chevron">â–¾</div>
      </div>
      <div class="opt-card-body">
        <div class="field">
          <label>${tr('opt_name_lbl')}</label>
          <input type="text" id="opt-name-${i}" value="${esc(opt.name)}"
            placeholder="${tr('opt_name_ph')}"
            oninput="S.options[${i}].name=this.value;document.getElementById('opt-prev-${i}').textContent=this.value||'â€”'">
        </div>
        <div class="field" style="margin-bottom:0">
          <label>${tr('opt_desc_lbl')} <span style="font-weight:400;color:var(--muted)">${tr('opt_desc_opt')}</span></label>
          <input type="text" id="opt-desc-${i}" value="${esc(opt.desc)}"
            placeholder="${tr('opt_desc_ph')}"
            oninput="S.options[${i}].desc=this.value">
        </div>
      </div>`;
    b.appendChild(card);
  });
  document.getElementById('opt-count-lbl').textContent=tr('opt_count',S.options.length);
  document.getElementById('addOptBtn').style.display=S.options.length>=6?'none':'flex';
}

function toggleOpt(i){ document.getElementById(`opt-card-${i}`).classList.toggle('open'); }
function addOption(){ if(S.options.length>=6) return; S.options.push({name:'',desc:''}); renderOptBuilder(); }
function removeOpt(i){ if(S.options.length<=2) return; S.options.splice(i,1); renderOptBuilder(); }

function validateStep1(){
  const dec=document.getElementById('inp-dec').value.trim();
  if(!dec){ shake('inp-dec'); return; }
  const allNamed=S.options.every((_,i)=>document.getElementById(`opt-name-${i}`)?.value.trim());
  if(!allNamed){ alert(tr('err_name')); return; }
  S.decision=dec;
  S.options=S.options.map((_,i)=>({
    name:document.getElementById(`opt-name-${i}`).value.trim(),
    desc:document.getElementById(`opt-desc-${i}`).value.trim(),
  }));
  S.notes=S.options.map(()=>'');
  renderStepProgress(2);
  buildCriteriaPage();
  nav('page-step2');
}

initOptions();

/* â”€â”€â”€ STEP 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildCriteriaPage(){ S.currentCat=tr('cats')[0]; renderCatTabs(); filterGrid(tr('cats')[0]); renderSelList(); }

function renderCatTabs(){
  const t=document.getElementById('catTabs'); t.innerHTML='';
  CATS.forEach(cat=>{
    const b=document.createElement('button');
    b.className='cat-tab'+(cat===S.currentCat?' active':'');
    b.textContent=cat; b.onclick=()=>filterGrid(cat); t.appendChild(b);
  });
}

function filterGrid(cat){
  S.currentCat=cat; renderCatTabs();
  const g=document.getElementById('critGrid'); g.innerHTML='';
  (cat===tr('cats')[0]?LIB:LIB.filter(c=>c.cat===cat)).forEach(c=>{
    const on=S.criteria.some(x=>x.id===c.id);
    const pill=document.createElement('div');
    pill.className='crit-pill'+(on?' on':''); pill.id='pill-'+c.id;
    pill.innerHTML=`
      <div class="crit-check">${on?'âœ“':''}</div>
      <div class="crit-icon">${c.icon}</div>
      <div><div class="crit-name">${c.name}</div><div class="crit-hint">${c.hint}</div></div>`;
    pill.onclick=()=>toggleCrit(c.id); g.appendChild(pill);
  });
}

function toggleCrit(id){
  const idx=S.criteria.findIndex(c=>c.id===id);
  if(idx!==-1) S.criteria.splice(idx,1);
  else { const c=LIB.find(c=>c.id===id); S.criteria.push({...c,weight:c.dw}); }
  filterGrid(S.currentCat); renderSelList();
}

function addCustom(){
  const name=document.getElementById('cust-name').value.trim();
  if(!name){shake('cust-name');return;}
  const icon=document.getElementById('cust-icon').value.trim()||'ğŸ”¹';
  const cat=document.getElementById('cust-cat').value;
  S.criteria.push({id:'cust_'+Date.now(),cat,icon,name,hint:'CritÃ¨re personnalisÃ©',invert:false,weight:1,custom:true});
  document.getElementById('cust-name').value='';
  document.getElementById('cust-icon').value='';
  renderSelList();
}

function renderSelList(){
  const list=document.getElementById('activeList');
  document.getElementById('crit-badge').textContent=S.criteria.length;
  if(!S.criteria.length){
    list.innerHTML=`<div class="empty-hint">${tr('sel_empty')}</div>`;
    return;
  }
  list.innerHTML='';
  S.criteria.forEach(c=>{
    const item=document.createElement('div'); item.className='sel-item';
    item.innerHTML=`
      <div class="sel-icon">${c.icon}</div>
      <div class="sel-name">${c.name}${c.invert?` <span class="inv-tag" title="${tr('inv_tip_on')}">${tr('inv_tag')}</span>`:''}</div>
      <div class="weight-wrap">
        <label class="weight-lbl">${tr('lbl_importance')}</label>
        <div class="weight-sel-wrap">
          <select class="weight-sel" onchange="setCW('${c.id}',this.value)">
            ${[1,2,3].map(w=>`<option value="${w}"${c.weight===w?' selected':''}>${WEIGHTS[w]}</option>`).join('')}
          </select>
          <span class="weight-chevron">â–¾</span>
        </div>
      </div>
      <div class="weight-wrap">
        <label class="weight-lbl">${tr('lbl_sens')}</label>
        <button class="inv-btn${c.invert?' on':''}" onclick="toggleInv('${c.id}')"
          title="${c.invert?tr('inv_tip_on'):tr('inv_tip_off')}">
          ${c.invert?tr('inv_on'):tr('inv_off')}
        </button>
      </div>
      <button class="rm-btn" onclick="rmCrit('${c.id}')" title="Retirer ce critÃ¨re">âœ•</button>`;
    list.appendChild(item);
  });
}

function setCW(id,v){ const c=S.criteria.find(x=>x.id===id); if(c) c.weight=parseInt(v); }
function toggleInv(id){ const c=S.criteria.find(x=>x.id===id); if(c){c.invert=!c.invert;renderSelList();} }
function rmCrit(id){
  S.criteria=S.criteria.filter(x=>x.id!==id);
  const pill=document.getElementById('pill-'+id);
  if(pill){pill.classList.remove('on');pill.querySelector('.crit-check').textContent='';}
  renderSelList();
}

function validateStep2(){
  if(S.criteria.length<2){alert(tr('err_crit'));return;}
  S.criteria.forEach(c=>{
    if(!S.scores[c.id]||S.scores[c.id].length!==S.options.length)
      S.scores[c.id]=S.options.map(()=>5);
  });
  renderStepProgress(3);
  buildEvalPage();
  nav('page-step3');
}

/* â”€â”€â”€ STEP 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildEvalPage(){
  document.getElementById('eval-title').textContent=
    tr('eval_title', S.decision.substring(0,50)+(S.decision.length>50?'â€¦':''));
  const nOpts=S.options.length;
  const grid=document.getElementById('evalGrid');
  grid.style.gridTemplateColumns=`repeat(${Math.min(nOpts,2)},1fr)`;
  grid.style.width='100%';
  grid.innerHTML='';

  S.options.forEach((opt,oi)=>{
    const c=COLORS[oi];
    const col=document.createElement('div');
    col.className='eval-col';

    const items=S.criteria.map(cr=>{
      const v=S.scores[cr.id]?.[oi]??5;
      const inv=cr.invert?`<span class="inv-tag" title="Score Ã©levÃ© = mauvais pour ce critÃ¨re">â†“</span>`:'';
      const wt=cr.weight>1?`<span class="sl-wtag">Ã—${cr.weight}</span>`:'';
      const pips=Array.from({length:10},(_,pi)=>
        `<div class="pip" id="pip-${oi}-${cr.id}-${pi+1}" onclick="setVal(${oi},'${cr.id}',${pi+1})" title="${pi+1}/10"></div>`).join('');
      return `
        <div class="sl-item">
          <div class="sl-head">
            <div class="sl-label">${cr.icon} ${cr.name} ${inv}</div>${wt}
          </div>
          <div class="stepper">
            <button class="stepper-btn" onclick="stepVal(${oi},'${cr.id}',-1)" aria-label="Diminuer">âˆ’</button>
            <div class="stepper-track">
              <div class="pip-row">${pips}</div>
              <div class="stepper-val" id="sv-${oi}-${cr.id}">${v}</div>
            </div>
            <button class="stepper-btn" onclick="stepVal(${oi},'${cr.id}',+1)" aria-label="Augmenter">+</button>
          </div>
        </div>`;
    }).join('');

    col.innerHTML=`
      <div class="eval-col-head" style="background:${c.bg};border-color:${c.border}">
        <div class="eval-col-name" style="color:${c.hex}">Option ${LETTERS[oi]} â€” ${esc(opt.name)}</div>
        <div class="eval-live-score">
          <div class="eval-live-num" id="live-${oi}" style="color:${c.hex}">â€”</div>
          <div class="eval-live-label">/ 100</div>
        </div>
      </div>
      <div class="eval-col-body" style="border-color:${c.border}">${items}</div>`;

    grid.appendChild(col);
    S.criteria.forEach(cr=>renderStepper(oi,cr.id,S.scores[cr.id]?.[oi]??5,cr.invert??false));
    refreshLive(oi);
  });

  const notesRow=document.getElementById('notesRow');
  notesRow.style.gridTemplateColumns=`repeat(${Math.min(nOpts,3)},1fr)`;
  notesRow.innerHTML=S.options.map((opt,oi)=>`
    <div>
      <span class="notes-lbl" style="color:${COLORS[oi].hex}">
        ğŸ“ ${tr('notes_lbl', LETTERS[oi], esc(opt.name))}
      </span>
      <textarea id="note-${oi}" rows="3"
        placeholder="${tr('notes_ph')}"
        oninput="S.notes[${oi}]=this.value">${esc(S.notes[oi]||'')}</textarea>
    </div>`).join('');
}

/* â”€â”€â”€ STEPPER COLOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function stepColor(raw, invert){
  const eff=invert?(11-raw):raw;
  const t=(eff-1)/9;
  if(t<0.5){
    const f=t/0.5;
    return `rgb(${Math.round(192+( 90-192)*f)},${Math.round(57+(87-57)*f)},${Math.round(43+(80-43)*f)})`;
  } else {
    const f=(t-0.5)/0.5;
    return `rgb(${Math.round(90+(45-90)*f)},${Math.round(87+(138-87)*f)},${Math.round(80+(78-80)*f)})`;
  }
}

function renderStepper(oi,cid,val,invert){
  const color=stepColor(val,invert);
  const vd=document.getElementById(`sv-${oi}-${cid}`);
  if(vd){vd.textContent=val;vd.style.color=color;}
  for(let pi=1;pi<=10;pi++){
    const pip=document.getElementById(`pip-${oi}-${cid}-${pi}`);
    if(!pip) continue;
    if(pi<=val){
      // Height grows with value for a bar-chart feel
      pip.style.height=(8+pi*1.2)+'px';
      pip.style.background=color;
      pip.style.borderColor=color;
    } else {
      pip.style.height='8px';
      pip.style.background='';
      pip.style.borderColor='';
    }
  }
}

function stepVal(oi,cid,delta){
  if(!S.scores[cid]) S.scores[cid]=S.options.map(()=>5);
  const next=Math.min(10,Math.max(1,(S.scores[cid][oi]??5)+delta));
  S.scores[cid][oi]=next;
  const cr=S.criteria.find(c=>c.id===cid);
  renderStepper(oi,cid,next,cr?.invert??false);
  refreshLive(oi);
}

function setVal(oi,cid,val){
  if(!S.scores[cid]) S.scores[cid]=S.options.map(()=>5);
  S.scores[cid][oi]=val;
  const cr=S.criteria.find(c=>c.id===cid);
  renderStepper(oi,cid,val,cr?.invert??false);
  refreshLive(oi);
}

function calcScore(oi){
  let tot=0,max=0;
  S.criteria.forEach(c=>{
    let v=S.scores[c.id]?.[oi]??5;
    if(c.invert) v=11-v;
    tot+=v*c.weight; max+=10*c.weight;
  });
  return Math.round((tot/max)*100);
}

function refreshLive(oi){
  const el=document.getElementById(`live-${oi}`);
  if(el) el.textContent=calcScore(oi);
}

/* â”€â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showResults(){
  S.notes=S.options.map((_,i)=>document.getElementById(`note-${i}`)?.value||'');
  buildResults();
  renderStepProgress(4);
  nav('page-results');
  initScenario();
  setTimeout(drawRadar,150);
  generateInterpretation();
}

function buildResults(){
  const scores=S.options.map((_,i)=>calcScore(i));
  const ranked=[...S.options.map((_,i)=>i)].sort((a,b)=>scores[b]-scores[a]);
  const winner=ranked[0], runner=ranked[1];
  const diff=scores[winner]-scores[runner];
  const tie=diff<=4;
  const cW=COLORS[winner];

  // Verdict
  let vstyle,vemoji,vtitle,vsub;
  if(tie){
    vstyle=`background:#fffbea;border-color:#f0d080`;
    vemoji='âš–ï¸';
    vtitle=`<span style="color:var(--amber)">${tr('res_tie_title')}</span>`;
    vsub=tr('res_tie_sub',diff);
  } else {
    vstyle=`background:${cW.bg};border-color:${cW.border}`;
    vemoji='ğŸ¯';
    vtitle=`<span style="color:${cW.hex}">"${esc(S.options[winner].name)}" ${LANG==='fr'?'ressort en tÃªte':'comes out on top'}</span>`;
    vsub=tr('res_win_sub',diff);
  }

  // Score cards (ranked)
  const ncols=Math.min(S.options.length,3);
  const scoreCards=ranked.map((oi,rank)=>{
    const c=COLORS[oi]; const sc=scores[oi];
    const rankLabels=tr('rank_labels');
    const rankBadge=rank<3?`<div class="rank-badge" style="background:${c.bg};color:${c.hex};border:1px solid ${c.border}">${rankLabels[rank]}</div>`:'';
    const miniCrits=S.criteria.slice(0,4).map(cr=>{
      const v=S.scores[cr.id]?.[oi]??5;
      return `<div class="sc-mini-row">
        <span class="sc-mini-name">${cr.icon} ${cr.name}</span>
        <div class="sc-mini-bar-wrap"><div class="sc-mini-bar-fill" style="width:${v*10}%;background:${c.hex}"></div></div>
        <span class="sc-mini-val">${v}</span>
      </div>`;
    }).join('');
    return `
      <div class="score-card${rank===0?' rank-1':''}" style="border-color:${rank===0?c.hex:c.border}">
        <div class="sc-body">
          <div class="sc-top-band" style="background:${c.hex}"></div>
          <div class="sc-main">
            <div class="sc-content">
              ${rankBadge}
              <div class="sc-name">${esc(S.options[oi].name)}</div>
              ${S.options[oi].desc?`<div class="sc-desc">${esc(S.options[oi].desc)}</div>`:''}
            </div>
            <div class="sc-score-block">
              <div class="sc-num" style="color:${c.hex}">${sc}</div>
              <div class="sc-denom">/100</div>
            </div>
          </div>
          <div class="sc-bar-row">
            <div class="sc-bar"><div class="sc-bar-fill" style="width:${sc}%;background:${c.hex}"></div></div>
          </div>
        </div>
      </div>`;
  }).join('');

  // Breakdown
  const bkHeader=`<div class="bk-row hdr">
    <div class="bk-cell crit-col hdr-cell">${tr('bk_crit')}</div>
    ${S.options.map((o,i)=>`<div class="bk-cell opt-col hdr-cell" style="color:${COLORS[i].hex}">${LETTERS[i]}. ${esc(o.name.substring(0,10))}${o.name.length>10?'â€¦':''}</div>`).join('')}
  </div>`;
  const bkRows=S.criteria.map(cr=>{
    const vals=S.options.map((_,i)=>S.scores[cr.id]?.[i]??5);
    const maxV=Math.max(...vals);
    return `<div class="bk-row">
      <div class="bk-cell crit-col">
        ${cr.icon} ${cr.name}
        ${cr.weight>1?`<span style="font-size:.62rem;background:var(--amber-bg);color:var(--amber);padding:2px 5px;border-radius:3px;border:1px solid #f0d080;font-weight:700">Ã—${cr.weight}</span>`:''}
        ${cr.invert?`<span class="inv-tag">â†“</span>`:''}
      </div>
      ${vals.map((v,i)=>{
        const c=COLORS[i];
        return `<div class="bk-cell opt-col"><div class="opt-cell-in">
          <div class="opt-pill" style="background:${c.bg};color:${c.hex};font-weight:${v===maxV?700:400}">${v}</div>
          <div class="mini-bar"><div class="mini-bar-fill" style="width:${v*10}%;background:${c.hex}"></div></div>
        </div></div>`;
      }).join('')}
    </div>`;
  }).join('');


  // Notes
  // Analysis
  const an=genAnalysis(scores,winner,ranked);

  const hasNotes=S.notes.some(n=>n.trim());
  const notesHTML=hasNotes?`
    <div class="notes-res">
      <div class="notes-res-head">${tr('notes_head')}</div>
      <div class="notes-res-body" style="grid-template-columns:repeat(${Math.min(S.options.length,3)},1fr)">
        ${S.options.map((o,i)=>`
          <div class="note-col" style="${i<S.options.length-1?'border-right:1px solid var(--border)':''}">
            <div class="note-col-lbl" style="color:${COLORS[i].hex}">${LETTERS[i]}. ${esc(o.name)}</div>
            <div class="note-col-txt">${esc(S.notes[i])||`<em style="color:var(--muted2)">${tr('no_notes')}</em>`}</div>
          </div>`).join('')}
      </div>
    </div>`:'';

  document.getElementById('resContent').innerHTML=`

    <!-- â‘  EN-TÃŠTE + VERDICT COMPACT -->
    <div class="res-header">
      <div class="page-eyebrow">${tr('res_eyebrow')}</div>
      <div class="res-decision-title">${esc(S.decision)}</div>
      <div class="verdict-inline" style="background:${vstyle.includes('fffbea')?'#fffbea':cW.bg};border:1.5px solid ${vstyle.includes('fffbea')?'#f0d080':cW.border}">
        <span class="verdict-inline-emoji">${vemoji}</span>
        <div class="verdict-inline-text">
          <div class="verdict-inline-title">${vtitle}</div>
          <div class="verdict-inline-sub">${vsub}</div>
        </div>
      </div>
    </div>

    <!-- â‘¡ OUTILS EN PILLS CÃ”TE Ã€ CÃ”TE -->
    <div class="tool-pills">

      <!-- Peur -->
      <div class="tool-pill" id="fearBox">
        <div class="tool-pill-head" onclick="toggleFearBox()">
          <div class="tool-pill-icon">ğŸ«€</div>
          <div class="tool-pill-text">
            <div class="tool-pill-title">${tr('fear_title')}</div>
            <div class="tool-pill-sub">${tr('fear_sub')}</div>
          </div>
          <div class="toggle-wrap" style="margin-left:8px">
            <span class="toggle-label" id="fearToggleLabel">${LANG==='fr'?'Non':'Off'}</span>
            <label class="toggle" style="width:36px;height:20px">
              <input type="checkbox" id="fearToggle" onchange="onFearToggle(this.checked)" onclick="event.stopPropagation()">
              <div class="toggle-track"></div>
              <div class="toggle-thumb" style="width:14px;height:14px;top:3px;left:3px"></div>
            </label>
          </div>
        </div>
        <div class="tool-pill-body" id="fearBody"></div>
      </div>

      <!-- ScÃ©narios -->
      <div class="tool-pill" id="scenarioBox">
        <div class="tool-pill-head" onclick="toggleScenarioBox()">
          <div class="tool-pill-icon">ğŸ›ï¸</div>
          <div class="tool-pill-text">
            <div class="tool-pill-title">${tr('scenario_title')}</div>
            <div class="tool-pill-sub">${tr('scenario_sub')}</div>
          </div>
          <div class="scenario-chevron" style="color:var(--muted2);font-size:.8rem;margin-left:8px">â–¾</div>
        </div>
        <div class="tool-pill-body scenario-body" id="scenarioBody"></div>
      </div>

    </div>

    <!-- â‘¢ SCORES -->
    <div class="res-divider" style="margin-top:24px"><span class="res-divider-label">${tr('div_scores')}</span></div>
    <div class="scores-row" id="scoresRow" style="grid-template-columns:repeat(${ncols},1fr)">${scoreCards}</div>

    <!-- â‘£ INTERPRÃ‰TATION IA -->
    <div class="interp-box" style="margin-top:20px">
      <div class="interp-head">
        <span>ğŸ’¬</span>
        <div class="interp-head-title">${tr('interp_title')}</div>
        <div class="interp-badge">IA</div>
      </div>
      <div id="interpContent">
        <div class="interp-loading">
          <div class="skel w100"></div>
          <div class="skel w80"></div>
          <div class="skel w100"></div>
          <div class="skel w60"></div>
        </div>
      </div>
    </div>

    <!-- â‘¤ PROFIL VISUEL -->
    <div class="res-divider" style="margin-top:32px"><span class="res-divider-label">${tr('div_visual')}</span></div>
    <div class="radar-section">
      <div style="display:flex;justify-content:center">
        <canvas id="radarC" width="480" height="360" style="max-width:100%"></canvas>
      </div>
      <div class="radar-legend">
        ${S.options.map((o,i)=>`<span><span class="leg-dot" style="background:${COLORS[i].hex}"></span>${esc(o.name)}</span>`).join('')}
      </div>
    </div>

    <!-- â‘¥ DÃ‰TAIL PAR CRITÃˆRE -->
    <div class="res-divider"><span class="res-divider-label">${tr('div_detail')}</span></div>
    <div class="bk-table">${bkHeader}${bkRows}</div>

    <!-- â‘¦ NOTES PERSONNELLES -->
    ${hasNotes?`<div class="res-divider"><span class="res-divider-label">${tr('div_notes')}</span></div>${notesHTML}`:''}

    <!-- â‘§ ACTIONS -->
    <div class="res-actions">
      <button class="btn btn-secondary" onclick="nav('page-step3')">${tr('back_notes')}</button>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="window.print()">${tr('export_pdf')}</button>
        <button class="btn btn-primary" onclick="restart()">${tr('new_decision')}</button>
      </div>
    </div>`;
}

/* â”€â”€â”€ AI INTERPRETATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function generateInterpretation(){
  const scores = S.options.map((_,i) => calcScore(i));
  const ranked = [...S.options.map((_,i)=>i)].sort((a,b)=>scores[b]-scores[a]);

  const optionsSummary = S.options.map((o,i) => {
    const critDetails = S.criteria.map(c => {
      const raw = S.scores[c.id]?.[i] ?? 5;
      const eff = c.invert ? 11 - raw : raw;
      return `  - ${c.name} (poids Ã—${c.weight}${c.invert?' [inversÃ©]':''}): ${raw}/10 â†’ effectif ${eff}/10`;
    }).join('\n');
    return `Option ${LETTERS[i]} â€” "${o.name}"${o.desc?' ('+o.desc+')':''}
  Score final: ${scores[i]}/100
${critDetails}${S.notes[i]?'\n  Note personnelle: "'+S.notes[i]+'"':''}`;
  }).join('\n\n');

  const rankedNames = ranked.map(i=>`"${S.options[i].name}" (${scores[i]} pts)`).join(' > ');
  const crucialCriteria = S.criteria.filter(c=>c.weight>=2).map(c=>`${c.name} (Ã—${c.weight})`).join(', ') || 'Aucun';

  const promptLang = tr('ai_lang');
  const prompt = LANG === 'en'
  ? `You are a friendly and direct advisor helping people make important decisions.

The user must decide: "${S.decision}"

Results of their multi-criteria analysis:
Ranking: ${rankedNames}

${optionsSummary}

Most important criteria (Ã—2 or Ã—3): ${crucialCriteria}

Your mission: Write a short interpretive message (3 to 5 sentences) in English, natural and human.
- Compare the options on the points where they diverge most
- Reveal what the numbers actually say about the user's priorities
- Make a nuanced recommendation taking into account the important criteria
- If it's close, say so and point to what matters most
- Write directly, no title, no bullets, no generic intro
- Style: "Option X is stronger onâ€¦", "If you valueâ€¦", "What the numbers reveal hereâ€¦"
- Use "you", be warm but factual. 3-5 sentences max.`
  : `Tu es un conseiller bienveillant et direct qui aide les gens Ã  prendre des dÃ©cisions importantes.

L'utilisateur doit dÃ©cider : "${S.decision}"

RÃ©sultats de son analyse multi-critÃ¨res :
Classement : ${rankedNames}

${optionsSummary}

CritÃ¨res les plus importants (Ã—2 ou Ã—3) : ${crucialCriteria}

Ta mission : RÃ©dige un message interprÃ©tatif court (3 Ã  5 phrases) en franÃ§ais, naturel et humain.
- Compare les options sur les points oÃ¹ elles divergent le plus
- RÃ©vÃ¨le ce que les chiffres disent vraiment sur ses prioritÃ©s
- Formule une recommandation nuancÃ©e tenant compte des critÃ¨res importants
- Si serrÃ©, dis-le et oriente vers ce qui compte le plus
- Ã‰cris directement, sans titre, sans bullet, sans intro gÃ©nÃ©rique
- Style : "Option X est plus forte surâ€¦", "Si tu accordes de l'importance Ã â€¦", "Ce que les chiffres rÃ©vÃ¨lent iciâ€¦"
- Tutoie, sois chaleureux mais factuel. 3-5 phrases max.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{role:'user', content: prompt}]
      })
    });
    const data = await res.json();
    const text = data?.content?.[0]?.text || null;
    const el = document.getElementById('interpContent');
    if (!el) return;
    if (text) {
      const formatted = text
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/\n\n/g,'</p><p>')
        .replace(/\n/g,'<br>');
      el.innerHTML=`<div class="interp-body"><div class="interp-text"><p>${formatted}</p></div></div>`;
    } else { throw new Error(); }
  } catch(e) {
    // Fallback local si l'API Ã©choue
    const scores2 = S.options.map((_,i)=>calcScore(i));
    const ranked2 = [...S.options.map((_,i)=>i)].sort((a,b)=>scores2[b]-scores2[a]);
    const w=ranked2[0], r=ranked2[1];
    const diff=scores2[w]-scores2[r];

    const topW = [...S.criteria].sort((a,b)=>{
      const va=(a.invert?11-(S.scores[a.id]?.[w]??5):(S.scores[a.id]?.[w]??5))*a.weight;
      const vb=(b.invert?11-(S.scores[b.id]?.[w]??5):(S.scores[b.id]?.[w]??5))*b.weight;
      return vb-va;
    })[0];
    const topR = [...S.criteria].sort((a,b)=>{
      const va=(a.invert?11-(S.scores[a.id]?.[r]??5):(S.scores[a.id]?.[r]??5))*a.weight;
      const vb=(b.invert?11-(S.scores[b.id]?.[r]??5):(S.scores[b.id]?.[r]??5))*b.weight;
      return vb-va;
    })[0];

    const msg = diff<=4
      ? (LANG==='en'
          ? `The two options are very close (${scores2[w]} vs ${scores2[r]} pts).`
            +(topW?` "${S.options[w].name}" stands out slightly on <strong>${topW.name}</strong>.`:'')
            +` In this tight call, trust your instincts.`
          : `Les deux options sont trÃ¨s proches (${scores2[w]} vs ${scores2[r]} pts).`
            +(topW?` "${S.options[w].name}" se dÃ©marque lÃ©gÃ¨rement sur <strong>${topW.name}</strong>.`:'')
            +` Dans ce cas serrÃ©, fais confiance Ã  ton instinct.`)
      : (LANG==='en'
          ? `"${S.options[w].name}" comes out on top with a ${diff}-point lead.`
            +(topW?` Its main strength: <strong>${topW.name}</strong>.`:'')
            +(topR?` "${S.options[r].name}" remains stronger on <strong>${topR.name}</strong> â€” worth considering if that's a priority.`:'')
          : `"${S.options[w].name}" ressort en tÃªte avec ${diff} points d'avance.`
            +(topW?` Son principal atout : <strong>${topW.name}</strong>.`:'')
            +(topR?` "${S.options[r].name}" reste plus fort sur <strong>${topR.name}</strong> â€” Ã  peser si c'est une prioritÃ©.`:'')); 

    const el=document.getElementById('interpContent');
    if(el) el.innerHTML=`<div class="interp-body"><div class="interp-text"><p>${msg}</p></div></div>`;
  }
}

/* â”€â”€â”€ SCENARIO PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// Set des IDs de critÃ¨res actifs dans le scÃ©nario (tous actifs par dÃ©faut)
let S_active = new Set();

function initScenario(){
  S_active = new Set(S.criteria.map(c=>c.id));
  renderScenarioBody();
}

function toggleScenarioBox(){
  const sb = document.getElementById('scenarioBox');
  if(!sb) return;
  const opening = !sb.classList.contains('open');
  _setPillOpen('scenarioBox', opening);
  if(opening) _setPillOpen('fearBox', false);
}

function calcScoreScenario(oi){
  let tot=0, max=0;
  S.criteria.forEach(c=>{
    if(!S_active.has(c.id)) return;
    let v=S.scores[c.id]?.[oi]??5;
    if(c.invert) v=11-v;
    tot+=v*c.weight; max+=10*c.weight;
  });
  if(max===0) return 0;
  return Math.round((tot/max)*100);
}

function toggleScenarioCrit(id){
  if(S_active.has(id)) S_active.delete(id);
  else S_active.add(id);
  // Toujours au moins 1 critÃ¨re actif
  if(S_active.size===0) S_active.add(id);
  renderScenarioBody();
  updateScenarioScores();
}

function resetScenario(){
  S_active = new Set(S.criteria.map(c=>c.id));
  renderScenarioBody();
  updateScenarioScores();
}

function renderScenarioBody(){
  const body = document.getElementById('scenarioBody');
  if(!body) return;
  const activeCount = S_active.size;
  const rows = S.criteria.map(c=>{
    const on = S_active.has(c.id);
    return `
      <div class="sc-crit-row${on?'':' off'}">
        <div class="sc-crit-icon">${c.icon}</div>
        <div class="sc-crit-name">${c.name}</div>
        ${c.weight>1?`<span class="sc-crit-weight">Ã—${c.weight}</span>`:''}
        ${c.invert?`<span class="sc-crit-inv">${tr('sc_inv')}</span>`:''}
        <label class="mini-toggle" title="${on?tr('sc_toggle_on'):tr('sc_toggle_off')}">
          <input type="checkbox" ${on?'checked':''} onchange="toggleScenarioCrit('${c.id}')">
          <div class="mini-toggle-track"></div>
          <div class="mini-toggle-thumb"></div>
        </label>
      </div>`;
  }).join('');

  const insight = genScenarioInsight();

  body.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2px">
      <span style="font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em">
        ${tr('scenario_active',activeCount,S.criteria.length)}
      </span>
      <button class="scenario-reset" onclick="resetScenario()">${tr('scenario_reset')}</button>
    </div>
    <div class="sc-crit-list">${rows}</div>
    <div class="scenario-summary">${insight}</div>`;
}

function genScenarioInsight(){
  const disabledCrits = S.criteria.filter(c=>!S_active.has(c.id));

  if(disabledCrits.length === 0){
    return tr('sc_all_active');
  }

  const baseScores  = S.options.map((_,i)=>calcScore(i));
  const scenScores  = S.options.map((_,i)=>calcScoreScenario(i));
  const baseRanked  = [...S.options.map((_,i)=>i)].sort((a,b)=>baseScores[b]-baseScores[a]);
  const scenRanked  = [...S.options.map((_,i)=>i)].sort((a,b)=>scenScores[b]-scenScores[a]);

  const baseWinner  = baseRanked[0];
  const scenWinner  = scenRanked[0];
  const switched    = scenWinner !== baseWinner;

  const disabledNames = disabledCrits.map(c=>`<strong>${c.name}</strong>`).join(LANG==='en'?' and ':' et ');
  const plural        = disabledCrits.length > 1;
  const s             = plural ? 's' : '';

  const deltas = S.options.map((_,i)=>({ i, d: scenScores[i]-baseScores[i] }));
  const bigGainer  = deltas.reduce((a,b)=>b.d>a.d?b:a);
  const bigLoser   = deltas.reduce((a,b)=>b.d<a.d?b:a);

  // Cas 1 â€” classement inversÃ©
  if(switched){
    const newName  = esc(S.options[scenWinner].name);
    const oldName  = esc(S.options[baseWinner].name);
    const gain     = scenScores[scenWinner] - baseScores[scenWinner];
    const gainSign = gain>=0?`+${gain}`:gain;
    const p1 = LANG==='en' ? (plural?'played':'played') : (plural?'jouaient':'jouait');
    return tr('sc_switched', disabledNames, newName, gainSign, oldName, s, p1);
  }

  // Cas 2 â€” Ã©cart rÃ©duit
  const baseGap = baseScores[baseWinner] - baseScores[baseRanked[1]];
  const scenGap = scenScores[scenWinner] - scenScores[scenRanked[1]];
  if(scenGap < baseGap && baseGap - scenGap >= 6){
    const gapDiff = baseGap - scenGap;
    const p2 = LANG==='en' ? (plural?'constitute':'constitutes') : (plural?'constituent':'constitue');
    return tr('sc_reduced', esc(S.options[baseWinner].name), gapDiff, disabledNames, s, p2);
  }

  // Cas 3 â€” Ã©cart qui se creuse
  if(scenGap > baseGap + 5){
    const p3 = LANG==='en'
      ? `${plural?'are':'is'} not what drives this option's strength`
      : `ne ${plural?'sont':'est'} pas ce qui fait la force de cette option`;
    return tr('sc_wider', esc(S.options[baseWinner].name), scenGap - baseGap, disabledNames, s, p3);
  }

  // Cas 4 â€” divergence forte
  if(bigGainer.d >= 8 && bigGainer.i !== bigLoser.i && bigLoser.d <= -8){
    const gN = esc(S.options[bigGainer.i].name);
    const lN = esc(S.options[bigLoser.i].name);
    const p4 = LANG==='en' ? (plural?'weigh':'weighs') : (plural?'pÃ¨sent':'pÃ¨se');
    return tr('sc_diverge', gN, bigGainer.d, lN, Math.abs(bigLoser.d), disabledNames, p4);
  }

  // Cas 5 â€” impact faible
  const maxDelta = Math.max(...deltas.map(d=>Math.abs(d.d)));
  if(maxDelta <= 4){
    const p5 = LANG==='en'
      ? `${plural?'are not':'is not'} decisive`
      : `n\u2019est pas dÃ©terminant${s}`;
    return tr('sc_nochange', disabledNames, maxDelta+1, s, p5);
  }

  // Cas 6 â€” fallback
  const mostImpacted = deltas.reduce((a,b)=>Math.abs(b.d)>Math.abs(a.d)?b:a);
  const sign = mostImpacted.d >= 0 ? `+${mostImpacted.d}` : `${mostImpacted.d}`;
  const p6 = LANG==='en'
    ? (plural?'influence':'influences')
    : (plural?'influencent':'influence');
  return tr('sc_fallback', disabledNames, esc(S.options[mostImpacted.i].name), sign, s, p6);
}


function updateScenarioScores(){
  const baseScores  = S.options.map((_,i)=>calcScore(i));
  const scenScores  = S.options.map((_,i)=>calcScoreScenario(i));
  const scenRanked  = [...S.options.map((_,i)=>i)].sort((a,b)=>scenScores[b]-scenScores[a]);
  const baseRanked  = [...S.options.map((_,i)=>i)].sort((a,b)=>baseScores[b]-baseScores[a]);
  const allActive   = S_active.size === S.criteria.length;

  const row = document.getElementById('scoresRow');
  if(!row) return;

  // Rebuild score cards with updated values
  const ncols = Math.min(S.options.length,3);
  row.style.gridTemplateColumns=`repeat(${ncols},1fr)`;

  // Re-rank by scenario scores
  const rankLabels=tr('rank_labels');
  row.innerHTML = scenRanked.map((oi,rank)=>{
    const c = COLORS[oi];
    const sc = scenScores[oi];
    const base = baseScores[oi];
    const delta = sc - base;
    const deltaHTML = allActive ? '' :
      `<span class="sc-scenario-delta ${delta>2?'up':delta<-2?'down':'same'}">
        ${delta>0?'+':''}${delta} pts
      </span>`;

    const rankBadge = rank<3
      ? `<div class="rank-badge" style="background:${c.bg};color:${c.hex};border:1px solid ${c.border}">${rankLabels[rank]}</div>`
      : '';

    const miniCrits = [...S_active].map(id=>{
      const cr = S.criteria.find(x=>x.id===id); if(!cr) return '';
      const v = S.scores[cr.id]?.[oi]??5;
      return `<div class="sc-mini-row">
        <span class="sc-mini-name">${cr.icon} ${cr.name}</span>
        <div class="sc-mini-bar-wrap"><div class="sc-mini-bar-fill" style="width:${v*10}%;background:${c.hex}"></div></div>
        <span class="sc-mini-val">${v}</span>
      </div>`;
    }).slice(0,4).join('');

    return `
      <div class="score-card${rank===0?' rank-1':''}" style="border-color:${rank===0?c.hex:c.border}">
        <div class="sc-body">
          <div class="sc-top-band" style="background:${c.hex}"></div>
          <div class="sc-main">
            <div class="sc-content">
              ${rankBadge}
              <div class="sc-name">${esc(S.options[oi].name)}</div>
              ${S.options[oi].desc?`<div class="sc-desc">${esc(S.options[oi].desc)}</div>`:''}
              ${deltaHTML}
            </div>
            <div class="sc-score-block">
              <div class="sc-num" style="color:${c.hex}">${sc}</div>
              <div class="sc-denom">/100</div>
            </div>
          </div>
          <div class="sc-bar-row">
            <div class="sc-bar"><div class="sc-bar-fill" style="width:${sc}%;background:${c.hex}"></div></div>
          </div>
        </div>
      </div>`;
  }).join('');

  // Redraw radar with scenario scores
  setTimeout(()=>drawRadarScenario(scenScores),50);

  // Refresh narrative insight in panel
  const insightEl = document.querySelector('#scenarioBody .scenario-summary');
  if(insightEl) insightEl.innerHTML = genScenarioInsight();
}

/* â”€â”€â”€ FEAR TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// IDs de critÃ¨res considÃ©rÃ©s comme "liÃ©s Ã  la peur/prudence"
// Ces critÃ¨res sont dÃ©tectÃ©s silencieusement, l'utilisateur ne les nomme jamais
const FEAR_IDS = new Set([
  'fin_risk',  // Risque financier
  'risk',      // Risque global
  'stress',    // Niveau de stress
  'jobsec',    // SÃ©curitÃ© de l'emploi
  'fin_stab',  // StabilitÃ© financiÃ¨re
  'cost',      // CoÃ»t initial
  'rev',       // RÃ©versibilitÃ©
  'complex',   // ComplexitÃ©
  'dep',       // DÃ©pendances
  'workload',  // Charge de travail
]);

// DÃ©tecte aussi les critÃ¨res custom qui contiennent des mots-clÃ©s de peur
function isFearCrit(c){
  if(FEAR_IDS.has(c.id)) return true;
  if(c.custom){
    const fearWords=/risque|peur|stress|sÃ©curitÃ©|securite|danger|incertitude|coÃ»t|cout|complexitÃ©|complexite|difficultÃ©|difficulte|charge|instabilitÃ©|instabilite|anxiÃ©tÃ©|anxiete/i;
    return fearWords.test(c.name);
  }
  return false;
}

function calcScoreFiltered(oi, excludeIds){
  let tot=0, max=0;
  S.criteria.forEach(c=>{
    if(excludeIds.has(c.id)) return;
    let v=S.scores[c.id]?.[oi]??5;
    if(c.invert) v=11-v;
    tot+=v*c.weight; max+=10*c.weight;
  });
  if(max===0) return null;
  return Math.round((tot/max)*100);
}

function _setPillOpen(id, open){
  const el = document.getElementById(id);
  if(!el) return;
  if(open) el.classList.add('open'); else el.classList.remove('open');
  const body = el.querySelector('.tool-pill-body');
  if(body) body.style.display = open ? 'block' : 'none';
}

function toggleFearBox(){
  const fb = document.getElementById('fearBox');
  if(!fb) return;
  const opening = !fb.classList.contains('open');
  _setPillOpen('fearBox', opening);
  if(opening) _setPillOpen('scenarioBox', false);
}

function onFearToggle(checked){
  _setPillOpen('fearBox', true);
  _setPillOpen('scenarioBox', false);
  document.getElementById('fearToggleLabel').textContent = checked ? (LANG==='fr'?'Oui':'On') : (LANG==='fr'?'Non':'Off');
  document.getElementById('fearToggleLabel').className = 'toggle-label' + (checked ? ' on' : '');
  renderFearBody(checked);
}

function renderFearBody(active){
  const fearCrits = S.criteria.filter(isFearCrit);
  const fearIds   = new Set(fearCrits.map(c=>c.id));
  const body      = document.getElementById('fearBody');

  if(fearCrits.length === 0){
    body.innerHTML=`<div class="fear-none">${tr('fear_none')}</div>`;
    return;
  }

  const allTags = S.criteria.map(c=>{
    const isFear = isFearCrit(c);
    const cls = (!active || !isFear) ? 'active' : 'inactive';
    return `<span class="fear-crit-tag ${cls}">${c.icon} ${c.name}${isFear&&active?' âœ•':''}</span>`;
  }).join('');

  const normalScores   = S.options.map((_,i)=>calcScore(i));
  const fearlessScores = S.options.map((_,i)=>active?calcScoreFiltered(i,fearIds):null);

  const ranked         = [...S.options.map((_,i)=>i)].sort((a,b)=>normalScores[b]-normalScores[a]);
  const fearlessRanked = active
    ? [...S.options.map((_,i)=>i)].sort((a,b)=>(fearlessScores[b]??0)-(fearlessScores[a]??0))
    : null;

  const winnerNormal   = ranked[0];
  const winnerFearless = fearlessRanked?.[0];
  const switchedWinner = active && winnerFearless !== winnerNormal;

  const rows = ranked.map(oi=>{
    const c  = COLORS[oi];
    const ns = normalScores[oi];
    const fs = fearlessScores?.[oi] ?? null;
    let deltaHTML = '';
    if(active && fs !== null){
      const d    = fs - ns;
      const cls  = d > 2 ? 'up' : d < -2 ? 'down' : 'same';
      const sign = d > 0 ? '+' : '';
      deltaHTML  = `<span class="fear-delta ${cls}">${tr('fear_delta_lbl',sign,d)}</span>`;
    }
    return `
      <div class="fear-opt-row">
        <div class="fear-opt-name" style="color:${c.hex}">${LETTERS[oi]}. ${esc(S.options[oi].name)}</div>
        <div class="fear-scores">
          <div class="fear-score-block">
            <div class="fear-score-val" style="color:${c.hex}">${ns}</div>
            <div class="fear-score-lbl">${tr('fear_score_real')}</div>
          </div>
          ${active && fs!==null ? `
          <div class="fear-arrow">â†’</div>
          <div class="fear-score-block">
            <div class="fear-score-val" style="color:#7c3aed">${fs}</div>
            <div class="fear-score-lbl">${tr('fear_score_fearless')}</div>
          </div>
          ${deltaHTML}` : ''}
        </div>
      </div>`;
  }).join('');

  let insight = '';
  if(active){
    if(switchedWinner){
      insight = `<div class="fear-insight">${tr('fear_switched', esc(S.options[winnerFearless].name), esc(S.options[winnerNormal].name))}</div>`;
    } else {
      const maxDelta = ranked.reduce((best,oi)=>{
        const d = (fearlessScores[oi]??0) - normalScores[oi];
        return Math.abs(d) > Math.abs(best.d) ? {oi,d} : best;
      },{oi:ranked[0],d:0});

      if(Math.abs(maxDelta.d) > 5){
        const optN = esc(S.options[maxDelta.oi].name);
        const pts  = Math.abs(maxDelta.d);
        insight = `<div class="fear-insight">${maxDelta.d > 0 ? tr('fear_gains',optN,pts) : tr('fear_loses',optN,pts)}</div>`;
      } else {
        insight = `<div class="fear-insight">${tr('fear_consistent')}</div>`;
      }
    }
  }

  body.innerHTML=`
    <div style="font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;">
      ${active ? tr('fear_toggle_lbl_on') : tr('fear_toggle_lbl_off')}
    </div>
    <div class="fear-crits">${allTags}</div>
    <div class="fear-comparison">${rows}</div>
    ${insight}`;
}

function genAnalysis(scores,winner,ranked){
  const wName=S.options[winner].name;
  const pros=[],cons=[];
  const sortW=[...S.criteria].sort((a,b)=>{
    let va=S.scores[a.id]?.[winner]??5,vb=S.scores[b.id]?.[winner]??5;
    if(a.invert)va=11-va;if(b.invert)vb=11-vb;
    return(vb*b.weight)-(va*a.weight);
  });
  sortW.slice(0,2).forEach(c=>{
    const v=S.scores[c.id]?.[winner]??5;
    pros.push(tr('an_score_high',c.name,v,c.weight));
  });
  const diff=scores[ranked[0]]-scores[ranked[1]];
  if(diff>15) pros.push(tr('an_clear',diff));
  else if(diff<=4) pros.push(tr('an_tight'));
  if(ranked.length>1){
    const ru=ranked[1];
    const sortR=[...S.criteria].sort((a,b)=>{
      let va=S.scores[a.id]?.[ru]??5,vb=S.scores[b.id]?.[ru]??5;
      if(a.invert)va=11-va;if(b.invert)vb=11-vb;
      return(vb*b.weight)-(va*a.weight);
    });
    sortR.slice(0,2).forEach(c=>{
      const vW=S.scores[c.id]?.[winner]??5,vR=S.scores[c.id]?.[ru]??5;
      if(vR>vW) cons.push(tr('an_runner',esc(S.options[ru].name),c.name,vR,vW));
    });
  }
  S.criteria.filter(c=>c.weight===3).forEach(c=>{
    const v=S.scores[c.id]?.[winner]??5;
    if(v<5) cons.push(tr('an_weak',c.name,v,esc(wName)));
  });
  if(!cons.length) cons.push(tr('an_no_cons'));
  return{pros:pros.slice(0,3),cons:cons.slice(0,3)};
}


function drawRadar(){ drawRadarScenario(null); }

function drawRadarScenario(overrideScores){
  const canvas=document.getElementById('radarC'); if(!canvas) return;
  // Only draw axes for active criteria in scenario mode
  const activeCrits = overrideScores
    ? S.criteria.filter(c=>S_active.has(c.id))
    : S.criteria;
  if(activeCrits.length<3) return;

  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height,cx=W/2,cy=H/2;
  const N=activeCrits.length;
  const R=Math.min(W,H)/2-64;
  ctx.clearRect(0,0,W,H);
  const angle=i=>(i/N)*Math.PI*2-Math.PI/2;

  // Grid
  [2,4,6,8,10].forEach(lvl=>{
    ctx.beginPath();
    activeCrits.forEach((_,i)=>{
      const a=angle(i),r=(lvl/10)*R;
      i===0?ctx.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a)):ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));
    });
    ctx.closePath();
    ctx.strokeStyle='rgba(0,0,0,0.07)';ctx.lineWidth=1;ctx.stroke();
  });
  activeCrits.forEach((_,i)=>{
    ctx.beginPath();ctx.moveTo(cx,cy);
    ctx.lineTo(cx+R*Math.cos(angle(i)),cy+R*Math.sin(angle(i)));
    ctx.strokeStyle='rgba(0,0,0,0.08)';ctx.lineWidth=1;ctx.stroke();
  });

  // Labels
  ctx.font='11px Plus Jakarta Sans,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  activeCrits.forEach((c,i)=>{
    const a=angle(i),x=cx+(R+44)*Math.cos(a),y=cy+(R+44)*Math.sin(a);
    ctx.fillStyle='#8a877f';
    ctx.fillText(c.icon,x,y-6);
    const short=c.name.length>13?c.name.substring(0,12)+'â€¦':c.name;
    ctx.fillText(short,x,y+8);
  });

  // Polygons â€” per-criteria raw score on active axes
  S.options.forEach((_,oi)=>{
    const col=COLORS[oi];
    ctx.beginPath();
    activeCrits.forEach((c,i)=>{
      const v=S.scores[c.id]?.[oi]??5,a=angle(i),r=(v/10)*R;
      i===0?ctx.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a)):ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));
    });
    ctx.closePath();
    const hex=col.hex.replace('#','');
    const r=parseInt(hex.substring(0,2),16),g=parseInt(hex.substring(2,4),16),b=parseInt(hex.substring(4,6),16);
    ctx.fillStyle=`rgba(${r},${g},${b},0.12)`;ctx.fill();
    ctx.strokeStyle=col.hex;ctx.lineWidth=2.5;ctx.stroke();
  });
}


/* â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function esc(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function shake(id){
  const el=document.getElementById(id); if(!el) return;
  el.style.borderColor='var(--red)';el.focus();
  setTimeout(()=>el.style.borderColor='',1800);
}
function restart(){
  S={decision:'',options:[{name:'',desc:''},{name:'',desc:''}],criteria:[],scores:{},notes:[],currentCat:'Tous'};
  document.getElementById('inp-dec').value='';
  renderOptBuilder();
  renderStepProgress(1);
  nav('page-intro');
}
</script>
</body>
</html>


